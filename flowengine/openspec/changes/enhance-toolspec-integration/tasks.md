# 实施任务清单

## Phase 1: ToolSpec 数据模型对齐

### 1.1 后端数据模型
- [ ] 1.1.1 创建 `ToolService` 和 `Tool` Rust 结构体 (`fdl-tools/src/models.rs`)
- [ ] 1.1.2 实现 `ToolArgs`、`TypeDef`、`ParamDef` 数据结构
- [ ] 1.1.3 添加数据库迁移脚本 (`tool_services`, `tools` 表)
- [ ] 1.1.4 实现 PostgreSQL 存储层 (`fdl-tools/src/postgres_tools.rs`)
- [ ] 1.1.5 扩展 ManagedToolRegistry 支持新数据模型

### 1.2 后端 API
- [ ] 1.2.1 新增 `/api/v1/services` CRUD 端点
- [ ] 1.2.2 扩展 `/api/v1/tools` 支持完整 ToolArgs
- [ ] 1.2.3 实现工具参数验证中间件
- [ ] 1.2.4 添加 OpenAPI 文档注解

### 1.3 数据迁移
- [ ] 1.3.1 编写旧格式到新格式的迁移脚本
- [ ] 1.3.2 实现迁移状态检查 API
- [ ] 1.3.3 测试迁移脚本（包括回滚）

## Phase 2: GML 求值器完善

### 2.1 语法解析器
- [ ] 2.1.1 编写 GML Pest 语法定义 (`fdl-gml/src/gml.pest`)
- [ ] 2.1.2 实现 AST 数据结构 (`fdl-gml/src/ast.rs`)
- [ ] 2.1.3 实现解析器 (`fdl-gml/src/parser.rs`)
- [ ] 2.1.4 添加解析器单元测试

### 2.2 核心求值
- [ ] 2.2.1 实现基础表达式求值（字面量、变量引用、算术运算）
- [ ] 2.2.2 实现逻辑和比较运算
- [ ] 2.2.3 实现条件表达式（三元运算符）
- [ ] 2.2.4 实现 CASE 表达式
- [ ] 2.2.5 实现对象构造和数组构造
- [ ] 2.2.6 实现展开语法 (`...obj`)

### 2.3 数组原型方法
- [ ] 2.3.1 实现 `map`, `filter` 方法
- [ ] 2.3.2 实现 `proj` 方法
- [ ] 2.3.3 实现聚合方法 (`sum`, `avg`, `min`, `max`, `length`)
- [ ] 2.3.4 实现 `group`, `collap` 方法
- [ ] 2.3.5 实现 `sort`, `reverse`, `distinct` 方法
- [ ] 2.3.6 实现 `flat`, `expand`, `chunk` 方法
- [ ] 2.3.7 实现 `some`, `every`, `includes` 方法
- [ ] 2.3.8 实现 `join`, `concat`, `push`, `slice` 方法

### 2.4 对象和字符串方法
- [ ] 2.4.1 实现对象 `proj` 方法
- [ ] 2.4.2 实现字符串 `toLowerCase`, `toUpperCase`, `length` 方法
- [ ] 2.4.3 实现时间 `offset` 方法

### 2.5 高级特性
- [ ] 2.5.1 实现 `$` 临时变量支持
- [ ] 2.5.2 实现 `this` 作用域引用
- [ ] 2.5.3 实现 `return` 语句
- [ ] 2.5.4 实现模板字符串插值

### 2.6 测试
- [ ] 2.6.1 编写 GML 规范中所有示例的测试用例
- [ ] 2.6.2 边界条件和错误处理测试
- [ ] 2.6.3 性能基准测试

## Phase 3: FDL 规范完善

### 3.1 节点执行增强
- [ ] 3.1.1 实现 `only` 条件执行逻辑
- [ ] 3.1.2 实现 `fail` 错误跳转节点
- [ ] 3.1.3 实现 `sets` 全局变量更新
- [ ] 3.1.4 实现参数自动绑定（tenantId, buCode）

### 3.2 画布增强
- [ ] 3.2.1 PropertyPanel 支持 `only` 条件编辑
- [ ] 3.2.2 PropertyPanel 支持 `fail` 节点选择
- [ ] 3.2.3 PropertyPanel 支持 `sets` 表达式编辑
- [ ] 3.2.4 实现 `args.defs` 类型定义编辑器

### 3.3 类型定义可视化
- [ ] 3.3.1 创建 TypeDefEditor 组件
- [ ] 3.3.2 创建 FieldDefEditor 组件
- [ ] 3.3.3 集成到 Flow 级别的参数面板

## Phase 4: 工具管理 UI 重构

### 4.1 服务管理模块
- [ ] 4.1.1 创建 ServiceList 组件
- [ ] 4.1.2 创建 ServiceForm 组件（支持各类型配置）
- [ ] 4.1.3 创建 ServiceToolList 组件
- [ ] 4.1.4 实现服务启用/禁用功能

### 4.2 工具管理模块
- [ ] 4.2.1 创建 ToolList 组件
- [ ] 4.2.2 创建 ToolArgsEditor 组件
- [ ] 4.2.3 创建 ToolTester 组件
- [ ] 4.2.4 实现工具搜索和过滤

### 4.3 数据源管理模块
- [ ] 4.3.1 创建 DatasourceForm 组件（连接配置）
- [ ] 4.3.2 创建 SchemaExplorer 组件（表结构浏览）
- [ ] 4.3.3 创建 ConnectionTester 组件
- [ ] 4.3.4 实现 CQL 查询构建器（可选）

### 4.4 UDF 管理模块
- [ ] 4.4.1 创建 UDFList 组件
- [ ] 4.4.2 集成 Monaco Editor 作为代码编辑器
- [ ] 4.4.3 创建 UDFTester 组件
- [ ] 4.4.4 实现参数签名编辑

### 4.5 集成与导航
- [ ] 4.5.1 重构 ToolsPage 使用 Tab 导航
- [ ] 4.5.2 添加面包屑导航
- [ ] 4.5.3 实现跨模块搜索

## Phase 5: 节点类型扩展

### 5.1 ExecNode 增强
- [ ] 5.1.1 创建 ToolSelector 组件
- [ ] 5.1.2 集成 ToolSelector 到 ExecNode 属性面板
- [ ] 5.1.3 实现参数自动映射
- [ ] 5.1.4 实现工具参数提示

### 5.2 新节点类型
- [ ] 5.2.1 创建 OSSNode（对象存储操作）
- [ ] 5.2.2 创建 MQNode（消息队列操作）
- [ ] 5.2.3 创建 MailNode（邮件发送）
- [ ] 5.2.4 创建 SMSNode（短信发送）
- [ ] 5.2.5 创建 ServiceNode（微服务调用）

### 5.3 现有节点增强
- [ ] 5.3.1 AgentNode 添加工具绑定配置
- [ ] 5.3.2 MCPNode 完善 MCP 协议集成
- [ ] 5.3.3 更新 NodePalette 包含新节点

### 5.4 类型定义更新
- [ ] 5.4.1 扩展 FlowNodeType 类型
- [ ] 5.4.2 添加新节点的数据接口
- [ ] 5.4.3 更新 nodeTypeConfigs 配置

## Phase 6: 执行器优化

### 6.1 并行调度器
- [ ] 6.1.1 实现拓扑排序算法 (`fdl-executor/src/topology.rs`)
- [ ] 6.1.2 实现并行调度器 (`fdl-executor/src/parallel.rs`)
- [ ] 6.1.3 添加并行度配置
- [ ] 6.1.4 实现优雅降级（资源不足时顺序执行）

### 6.2 子流程执行
- [ ] 6.2.1 实现 `each` 节点迭代执行
- [ ] 6.2.2 实现 `loop` 节点条件循环
- [ ] 6.2.3 实现变量作用域隔离
- [ ] 6.2.4 支持子流程中的 break/continue（如果需要）

### 6.3 状态持久化
- [ ] 6.3.1 实现执行快照保存
- [ ] 6.3.2 实现断点恢复机制
- [ ] 6.3.3 实现历史记录查询 API

### 6.4 性能优化
- [ ] 6.4.1 GML 解析结果缓存
- [ ] 6.4.2 工具调用连接池复用
- [ ] 6.4.3 添加执行性能指标收集

## Phase 7: 工具发现机制

### 7.1 OpenAPI 导入
- [ ] 7.1.1 实现 OpenAPI 3.0 解析器
- [ ] 7.1.2 实现 Swagger 2.0 兼容层
- [ ] 7.1.3 创建导入向导 UI
- [ ] 7.1.4 实现端点到工具的映射

### 7.2 数据库元数据发现
- [ ] 7.2.1 实现 PostgreSQL 表结构获取
- [ ] 7.2.2 实现 MySQL 表结构获取
- [ ] 7.2.3 实现 MongoDB 集合结构获取（字段推断）
- [ ] 7.2.4 自动生成 CRUD 工具定义

### 7.3 MCP 服务发现
- [ ] 7.3.1 实现 MCP 服务连接
- [ ] 7.3.2 获取可用工具列表
- [ ] 7.3.3 同步工具定义到本地

## Phase 8: 测试与文档

### 8.1 单元测试
- [ ] 8.1.1 GML 求值器完整测试套件
- [ ] 8.1.2 工具管理 API 测试
- [ ] 8.1.3 并行调度器测试
- [ ] 8.1.4 前端组件测试

### 8.2 集成测试
- [ ] 8.2.1 端到端流程执行测试
- [ ] 8.2.2 工具调用链测试
- [ ] 8.2.3 数据迁移测试

### 8.3 文档
- [ ] 8.3.1 更新 API 文档
- [ ] 8.3.2 编写工具管理用户指南
- [ ] 8.3.3 编写 GML 函数参考手册
- [ ] 8.3.4 更新 FDL 规范文档（标记已实现功能）

## 依赖关系说明

```
Phase 1 (数据模型)
    │
    ├─► Phase 2 (GML 求值器) ─► Phase 6.1 (并行调度)
    │                              │
    │                              ▼
    │                         Phase 6.2 (子流程)
    │                              │
    │                              ▼
    │                         Phase 6.3 (状态持久化)
    │
    ├─► Phase 3 (FDL 规范)
    │
    ├─► Phase 4 (工具管理 UI)
    │       │
    │       ▼
    │   Phase 5 (节点扩展)
    │
    └─► Phase 7 (工具发现) ─► Phase 8 (测试文档)
```

**可并行的工作流**:
- Phase 2 和 Phase 4 可并行进行
- Phase 3 和 Phase 5 可并行进行
- Phase 7 依赖 Phase 1 完成后可独立开始
