# 实施任务清单

## 1. 项目基础设施

- [ ] 1.1 初始化 Vite + React + TypeScript 项目
- [ ] 1.2 配置 ESLint + Prettier 代码规范
- [ ] 1.3 安装核心依赖（React Flow, Monaco Editor, Zustand, js-yaml）
- [ ] 1.4 配置 Tailwind CSS 样式框架
- [ ] 1.5 建立项目目录结构

## 2. FDL 解析器包 (packages/fdl-parser)

- [ ] 2.1 创建解析器包脚手架和类型定义
- [ ] 2.2 实现 FDL YAML 解析器 - 基础结构解析
- [ ] 2.3 实现 FDL YAML 解析器 - 节点类型识别
- [ ] 2.4 实现 FDL YAML 解析器 - 参数解析（args, with, only, sets）
- [ ] 2.5 实现 FDL YAML 解析器 - 子流程解析（each/loop 内部节点）
- [ ] 2.6 实现 FDL YAML 序列化器 - Flow Model → YAML
- [ ] 2.7 编写解析器单元测试
- [ ] 2.8 编写序列化器单元测试

## 3. GML 编辑器支持

- [ ] 3.1 定义 GML 词法规则（关键字、操作符、字面量）
- [ ] 3.2 实现 GML 语法高亮 Monaco 语言配置
- [ ] 3.3 实现 GML 基础智能补全（关键字、内置函数）
- [ ] 3.4 实现 GML 上下文变量补全
- [ ] 3.5 实现 GML 原型方法补全（数组/对象/字符串方法）
- [ ] 3.6 实现 GML 悬浮提示（函数签名）
- [ ] 3.7 编写 GML 编辑器组件

## 4. 状态管理

- [ ] 4.1 设计 Flow Model 数据结构
- [ ] 4.2 实现 flowStore - 流程状态管理
- [ ] 4.3 实现 editorStore - 编辑器状态管理
- [ ] 4.4 实现 Flow Model ↔ React Flow 节点/边转换
- [ ] 4.5 实现双向同步 Hook (useFlowSync)

## 5. 流程画布

- [ ] 5.1 实现 FlowCanvas 基础组件（React Flow 集成）
- [ ] 5.2 实现画布工具栏（缩放、适应、网格切换）
- [ ] 5.3 实现画布小地图
- [ ] 5.4 实现节点拖拽创建
- [ ] 5.5 实现连接线绘制和验证规则
- [ ] 5.6 实现自动布局算法（Dagre）
- [ ] 5.7 实现撤销/重做功能

## 6. 节点组件

- [ ] 6.1 实现 BaseNode 基础节点组件
- [ ] 6.2 实现 ExecNode 工具调用节点
- [ ] 6.3 实现 MappingNode 数据映射节点
- [ ] 6.4 实现 ConditionNode 条件跳转节点
- [ ] 6.5 实现 SwitchNode 多分支跳转节点
- [ ] 6.6 实现 DelayNode 延迟执行节点
- [ ] 6.7 实现 EachNode 集合遍历节点（含子流程容器）
- [ ] 6.8 实现 LoopNode 条件循环节点（含子流程容器）
- [ ] 6.9 实现节点连接端口（handles）

## 7. 节点编辑面板

- [ ] 7.1 实现 PropertyPanel 属性编辑面板框架
- [ ] 7.2 实现通用字段编辑器（name, desp）
- [ ] 7.3 实现 exec URI 编辑器
- [ ] 7.4 实现 GML 表达式编辑器集成（args, with, only, sets）
- [ ] 7.5 实现 next/then/else/fail 目标节点选择器
- [ ] 7.6 实现 case 列表编辑器（多分支节点）
- [ ] 7.7 实现 wait 时间编辑器
- [ ] 7.8 实现 each/loop vars 编辑器

## 8. 节点面板

- [ ] 8.1 实现 NodePalette 节点调色板组件
- [ ] 8.2 实现节点拖拽预览
- [ ] 8.3 实现节点搜索过滤
- [ ] 8.4 实现节点分类展示

## 9. YAML 编辑器

- [ ] 9.1 实现 YamlEditor 组件（Monaco YAML 模式）
- [ ] 9.2 实现 YAML 语法错误提示
- [ ] 9.3 实现 YAML ↔ 可视化实时同步
- [ ] 9.4 实现同步冲突处理和错误恢复

## 10. 流程参数编辑

- [ ] 10.1 实现流程元信息编辑（name, desp）
- [ ] 10.2 实现 args.in 输入参数编辑
- [ ] 10.3 实现 args.out 输出参数编辑
- [ ] 10.4 实现 args.defs 类型定义编辑
- [ ] 10.5 实现 vars 全局变量编辑

## 11. 应用集成

- [ ] 11.1 实现主应用布局（三栏：节点面板 | 画布 | 属性面板）
- [ ] 11.2 实现 YAML/可视化 视图切换
- [ ] 11.3 实现文件导入/导出功能
- [ ] 11.4 实现快捷键绑定
- [ ] 11.5 实现深色/浅色主题切换

## 12. 流程执行引擎 (packages/fdl-runtime)

- [ ] 12.1 创建执行引擎包脚手架和类型定义
- [ ] 12.2 实现 GML 表达式求值器 - 基础表达式（字面量、变量引用、运算符）
- [ ] 12.3 实现 GML 表达式求值器 - 复合表达式（三元、CASE）
- [ ] 12.4 实现 GML 表达式求值器 - 数组原型方法
- [ ] 12.5 实现 GML 表达式求值器 - 对象/字符串原型方法
- [ ] 12.6 实现执行上下文管理（变量作用域、上下文变量绑定）
- [ ] 12.7 实现节点调度器（拓扑排序、并行执行）
- [ ] 12.8 实现工具调用节点执行（Mock 数据生成）
- [ ] 12.9 实现数据映射节点执行
- [ ] 12.10 实现条件跳转/多分支节点执行
- [ ] 12.11 实现延迟执行节点
- [ ] 12.12 实现集合遍历节点（子流程迭代）
- [ ] 12.13 实现条件循环节点
- [ ] 12.14 实现 Web Worker 封装和消息通信
- [ ] 12.15 实现 Runtime Controller（启动/暂停/停止）
- [ ] 12.16 编写执行引擎单元测试

## 13. 版本历史管理

- [ ] 13.1 实现 IndexedDB 存储服务（versionDB）
- [ ] 13.2 实现版本数据模型和 CRUD 操作
- [ ] 13.3 实现自动保存机制（防抖 5 秒）
- [ ] 13.4 实现手动保存版本（带描述）
- [ ] 13.5 实现版本列表组件（VersionHistory）
- [ ] 13.6 实现版本对比 Diff 算法
- [ ] 13.7 实现版本对比视图组件（VersionDiff）
- [ ] 13.8 实现版本回滚功能
- [ ] 13.9 实现版本导出功能
- [ ] 13.10 实现存储清理策略（100 版本上限）
- [ ] 13.11 实现 LocalStorage 降级方案
- [ ] 13.12 实现 versionStore 状态管理

## 14. 流程调试器

- [ ] 14.1 实现 debugStore 调试状态管理
- [ ] 14.2 实现断点数据模型（节点断点、条件断点）
- [ ] 14.3 实现断点管理器组件（BreakpointManager）
- [ ] 14.4 实现调试工具栏组件（DebugToolbar）
- [ ] 14.5 实现节点执行状态可视化（画布节点着色）
- [ ] 14.6 实现单步执行控制（步进、步入、步出）
- [ ] 14.7 实现变量监视面板（VariableWatch）
- [ ] 14.8 实现自定义监视表达式
- [ ] 14.9 实现执行日志组件（ExecutionLog）
- [ ] 14.10 实现执行轨迹记录和回放
- [ ] 14.11 实现调用栈视图（CallStack）- 用于子流程
- [ ] 14.12 实现调试快捷键绑定（F5, F10, F11 等）
- [ ] 14.13 实现异常断点（执行出错自动暂停）

## 15. Agent 能力实现

- [ ] 15.1 实现 Agent 节点组件（AgentNode）
- [ ] 15.2 实现 Agent 节点属性编辑面板
- [ ] 15.3 实现 Agent 节点执行（Mock LLM 响应）
- [ ] 15.4 实现 Agent 工具绑定（引用流程中的 exec 节点）
- [ ] 15.5 实现 Guardrail 节点组件（GuardrailNode）
- [ ] 15.6 实现 Guardrail 节点属性编辑面板
- [ ] 15.7 实现 Guardrail 校验逻辑（PII、Jailbreak、Moderation）
- [ ] 15.8 实现自定义 GML 校验规则
- [ ] 15.9 实现人工审批节点组件（ApprovalNode）
- [ ] 15.10 实现人工审批对话框和交互
- [ ] 15.11 实现审批超时机制
- [ ] 15.12 实现 MCP 节点组件（MCPNode）
- [ ] 15.13 实现 MCP Server 连接器
- [ ] 15.14 实现 MCP 工具发现和调用
- [ ] 15.15 实现 MCP Mock 模式
- [ ] 15.16 实现 Handoff 节点组件（HandoffNode）
- [ ] 15.17 实现 Agent 流程移交执行
- [ ] 15.18 实现循环移交检测
- [ ] 15.19 实现 Agent 节点 FDL 解析器扩展
- [ ] 15.20 编写 Agent 节点单元测试

## 16. 测试与文档

- [ ] 16.1 编写组件单元测试
- [ ] 16.2 编写执行引擎单元测试
- [ ] 16.3 编写 E2E 测试（基础流程创建场景）
- [ ] 16.4 编写 E2E 测试（调试场景）
- [ ] 16.5 编写 E2E 测试（Agent 节点场景）
- [ ] 16.6 编写用户使用文档
- [ ] 16.7 编写开发者文档

## 依赖关系

```
1 (基础设施)
    ↓
2 (FDL 解析器) ─────────────────┐
    ↓                           │
3 (GML 编辑器) ─┐               │
    ↓          │               │
4 (状态管理) ←─┴───────────────┤
    ↓                           │
5 (流程画布) ←──────────────────┤
    ↓                           │
6 (节点组件) ←──────────────────┘
    ↓
7 (节点编辑面板) ← 3 (GML 编辑器)
    ↓
8 (节点面板)
    ↓
9 (YAML 编辑器) ← 2 (FDL 解析器)
    ↓
10 (流程参数编辑)
    ↓
11 (应用集成)
    ↓
12 (执行引擎) ← 2 (FDL 解析器) + 3 (GML 求值器)
    ↓
13 (版本管理) ← 4 (状态管理)
    ↓
14 (调试器) ← 12 (执行引擎) + 5 (流程画布)
    ↓
15 (Agent 能力) ← 6 (节点组件) + 12 (执行引擎) + 2 (FDL 解析器)
    ↓
16 (测试与文档)
```

## 并行化建议

以下任务组可以并行开发：

1. **第一组**（基础层）：2.1-2.5（解析器）+ 3.1-3.6（GML 语法）
2. **第二组**（组件层）：6.1-6.9（节点组件）+ 5.1-5.6（画布）
3. **第三组**（编辑器层）：7.1-7.8（属性面板）+ 8.1-8.4（节点面板）
4. **第四组**（运行时层）：12.1-12.13（执行引擎）+ 13.1-13.11（版本管理）
5. **第五组**（调试层）：14.1-14.13（调试器）可在执行引擎完成后开始
6. **第六组**（Agent 层）：15.1-15.20（Agent 能力）可在节点组件和执行引擎完成后开始，其中：
   - Agent/Guardrail/Approval/MCP/Handoff 节点组件可并行开发
   - Agent 执行逻辑依赖执行引擎完成
