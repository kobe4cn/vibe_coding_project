# Search box and button spacing
_Exported on 2026/1/2 at GMT+9 0:23:06 from Cursor (2.2.44)_

---

**User**

搜索框和搜索按钮太近了 代码应该在 @project_alpha/a2ui_frontend/ 目录下

---

**Cursor**


查找搜索框和搜索按钮的代码，准备增加它们之间的间距。



查看相关文件，了解当前样式设置：



将搜索框和搜索按钮之间的间距从 `var(--space-4)` (16px) 增加到 `var(--space-6)` (24px)。


```html
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ticket System - A2UI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <style>
      :root {
        /* MotherDuck Theme Colors */
        --color-primary: #FFD93D;
        --color-primary-hover: #FFE566;
        --color-secondary: #1E3A5F;
        --color-accent: #D5E8F0;

        /* Functional Colors */
        --color-success: #10B981;
        --color-warning: #F59E0B;
        --color-error: #EF4444;
        --color-info: #3B82F6;

        /* Neutral Colors */
        --color-white: #FFFFFF;
        --color-gray-50: #F9FAFB;
        --color-gray-100: #F3F4F6;
        --color-gray-200: #E5E7EB;
        --color-gray-300: #D1D5DB;
        --color-gray-400: #9CA3AF;
        --color-gray-500: #6B7280;
        --color-gray-600: #4B5563;
        --color-gray-700: #374151;
        --color-gray-800: #1F2937;
        --color-gray-900: #111827;

        /* Typography */
        --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
        --font-mono: 'JetBrains Mono', monospace;

        /* Font Sizes */
        --text-xs: 12px;
        --text-sm: 14px;
        --text-base: 16px;
        --text-lg: 18px;
        --text-xl: 20px;
        --text-2xl: 24px;
        --text-3xl: 30px;
        --text-4xl: 36px;

        /* Spacing */
        --space-1: 4px;
        --space-2: 8px;
        --space-3: 12px;
        --space-4: 16px;
        --space-5: 20px;
        --space-6: 24px;
        --space-8: 32px;
        --space-10: 40px;
        --space-12: 48px;

        /* Border Radius */
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-xl: 16px;
        --radius-full: 9999px;

        /* Shadows */
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

        /* Transitions */
        --transition-fast: 150ms ease;
        --transition-normal: 200ms ease;
        --transition-slow: 300ms ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-sans);
        font-size: var(--text-base);
        line-height: 1.5;
        color: var(--color-gray-900);
        background-color: var(--color-gray-50);
        min-height: 100vh;
      }

      #app {
        min-height: 100vh;
      }

      /* Loading state */
      .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        gap: var(--space-4);
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--color-gray-200);
        border-top-color: var(--color-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* A2UI Component Styles */
      a2ui-surface {
        display: block;
        min-height: 100vh;
      }

      /* Navigation */
      [data-component="nav-header"] {
        background: var(--color-white);
        border-bottom: 1px solid var(--color-gray-200);
        padding: var(--space-4) var(--space-6);
        position: sticky;
        top: 0;
        z-index: 50;
      }

      /* Cards */
      a2ui-card {
        background: var(--color-white);
        border: 1px solid var(--color-gray-200);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        box-shadow: var(--shadow-md);
        transition: box-shadow var(--transition-normal), transform var(--transition-normal);
      }

      a2ui-card:hover {
        box-shadow: var(--shadow-lg);
      }

      /* Buttons */
      a2ui-button {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-md);
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition-fast);
        border: 1px solid transparent;
      }

      a2ui-button[data-variant="primary"] {
        background: var(--color-primary);
        color: var(--color-secondary);
      }

      a2ui-button[data-variant="primary"]:hover {
        background: var(--color-primary-hover);
        box-shadow: var(--shadow-md);
      }

      a2ui-button[data-variant="secondary"] {
        background: transparent;
        border-color: var(--color-gray-300);
        color: var(--color-gray-700);
      }

      a2ui-button[data-variant="secondary"]:hover {
        background: var(--color-gray-100);
        border-color: var(--color-primary);
      }

      a2ui-button[data-variant="danger"] {
        background: transparent;
        border-color: var(--color-error);
        color: var(--color-error);
      }

      a2ui-button[data-variant="danger"]:hover {
        background: var(--color-error);
        color: var(--color-white);
      }

      /* Small button variant for filters */
      a2ui-button[data-size="small"] {
        padding: var(--space-1) var(--space-3);
        font-size: var(--text-sm);
        border-radius: var(--radius-full);
      }

      /* Search row styling */
      #tickets-search-row {
        gap: var(--space-6);
      }

      #tickets-search-row a2ui-textfield {
        flex: 1;
      }

      /* Filter row styling */
      #tickets-status-filters,
      #tickets-priority-filters {
        gap: var(--space-2);
        flex-wrap: wrap;
      }

      #tickets-status-filters a2ui-button,
      #tickets-priority-filters a2ui-button {
        padding: var(--space-1) var(--space-3);
        font-size: var(--text-sm);
        border-radius: var(--radius-full);
        background: var(--color-gray-100);
        color: var(--color-gray-700);
        border: 1px solid var(--color-gray-300);
      }

      #tickets-status-filters a2ui-button:hover,
      #tickets-priority-filters a2ui-button:hover {
        background: var(--color-primary);
        color: var(--color-secondary);
        border-color: var(--color-primary);
      }

      /* Text Fields */
      a2ui-textfield {
        display: block;
      }

      a2ui-textfield input,
      a2ui-textfield textarea {
        width: 100%;
        padding: var(--space-3) var(--space-4);
        border: 1px solid var(--color-gray-300);
        border-radius: var(--radius-md);
        font-family: inherit;
        font-size: var(--text-base);
        transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
      }

      a2ui-textfield input:focus,
      a2ui-textfield textarea:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
      }

      /* Text styles */
      a2ui-text[data-usage-hint="h1"] {
        font-size: var(--text-4xl);
        font-weight: 700;
        color: var(--color-gray-900);
      }

      a2ui-text[data-usage-hint="h2"] {
        font-size: var(--text-2xl);
        font-weight: 600;
        color: var(--color-gray-900);
      }

      a2ui-text[data-usage-hint="h3"] {
        font-size: var(--text-xl);
        font-weight: 600;
        color: var(--color-gray-900);
      }

      a2ui-text[data-usage-hint="h4"] {
        font-size: var(--text-sm);
        font-weight: 500;
        color: var(--color-gray-500);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      /* Status badges */
      [data-status="open"] {
        background: var(--color-info);
        color: white;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
        font-weight: 500;
      }

      [data-status="in_progress"] {
        background: var(--color-warning);
        color: white;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
        font-weight: 500;
      }

      [data-status="completed"] {
        background: var(--color-success);
        color: white;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
        font-weight: 500;
      }

      [data-status="cancelled"] {
        background: var(--color-gray-400);
        color: white;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
        font-weight: 500;
      }

      /* Priority badges */
      [data-priority="low"] {
        background: var(--color-gray-200);
        color: var(--color-gray-700);
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
      }

      [data-priority="medium"] {
        background: var(--color-info);
        color: white;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
      }

      [data-priority="high"] {
        background: var(--color-warning);
        color: white;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
      }

      [data-priority="urgent"] {
        background: var(--color-error);
        color: white;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
      }

      /* Layout */
      a2ui-column {
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
      }

      a2ui-row {
        display: flex;
        flex-direction: row;
        gap: var(--space-4);
        align-items: center;
      }

      a2ui-row[data-distribution="spaceBetween"] {
        justify-content: space-between;
      }

      a2ui-row[data-distribution="center"] {
        justify-content: center;
      }

      a2ui-row[data-distribution="end"] {
        justify-content: flex-end;
      }

      a2ui-column[data-alignment="center"] {
        align-items: center;
      }

      /* List */
      a2ui-list {
        display: flex;
        gap: var(--space-3);
      }

      a2ui-list[data-direction="vertical"] {
        flex-direction: column;
      }

      a2ui-list[data-direction="horizontal"] {
        flex-direction: row;
        flex-wrap: wrap;
      }

      /* Divider */
      a2ui-divider {
        height: 1px;
        background: var(--color-gray-200);
        margin: var(--space-4) 0;
      }

      /* Icon */
      a2ui-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      a2ui-icon .material-icons {
        font-size: 24px;
        color: inherit;
      }

      /* Main content area */
      .main-content {
        max-width: 1280px;
        margin: 0 auto;
        padding: var(--space-8) var(--space-6);
      }

      /* Responsive */
      @media (max-width: 768px) {
        :root {
          --text-4xl: 28px;
          --text-3xl: 24px;
          --text-2xl: 20px;
        }

        .main-content {
          padding: var(--space-4);
        }

        a2ui-row {
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>加载中...</p>
      </div>
    </div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>

```


已将搜索框和搜索按钮之间的间距从 `var(--space-4)` (16px) 增加到 `var(--space-6)` (24px)。刷新页面即可看到效果。

修改位置在：

```206:213:project_alpha/a2ui_frontend/client/index.html
      /* Search row styling */
      #tickets-search-row {
        gap: var(--space-6);
      }

      #tickets-search-row a2ui-textfield {
        flex: 1;
      }
```

如果还需要更大间距，可以改为 `var(--space-8)` (32px)。

```html
      /* Search row styling */
      #tickets-search-row {
        gap: var(--space-6);
      }

      #tickets-search-row a2ui-textfield {
        flex: 1;
      }
```

---

**User**

好像没有改变

---

**Cursor**


检查样式是否正确应用。查看渲染逻辑，确认选择器是否匹配：



问题在于 `a2ui-row` 是 LitElement，使用 Shadow DOM，外部 CSS 无法直接覆盖其内部样式。`a2ui-row` 的默认 `gap` 是 16px。需要在组件内部处理这个间距。检查并修改 `renderer.ts`：



`a2ui-row` 使用 Shadow DOM，外部 CSS 无法覆盖。在组件内部为 `tickets-search-row` 添加特殊样式：


```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    return html`
      <a2ui-button id=${id} @click=${handleClick}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      // Update data model with new value
      const textProp = props.text as BoundValue;
      if (textProp && 'path' in textProp) {
        // Note: This would need proper two-way binding implementation
        console.log(`TextField ${id} changed to: ${target.value}`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host(#tickets-search-row) {
      gap: 24px;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```


已在 `a2ui-row` 组件内部添加针对 `tickets-search-row` 的样式。由于组件使用 Shadow DOM，外部 CSS 无法覆盖，需要在组件内部处理。

检查是否有 lint 错误：



这些 lint 错误是 TypeScript 类型检查问题，不影响运行时。修改已完成。

已在 `a2ui-row` 组件内部添加针对 `tickets-search-row` 的样式，将间距从 16px 增加到 24px：

```427:445:project_alpha/a2ui_frontend/client/src/renderer.ts
@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host(#tickets-search-row) {
      gap: 24px;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;
```

由于 Vite 开发服务器会自动重新编译，刷新页面即可看到搜索框和搜索按钮之间的间距已增加到 24px。如果仍未生效，请尝试硬刷新（Ctrl+Shift+R 或 Cmd+Shift+R）。

```typescript
@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host(#tickets-search-row) {
      gap: 24px;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;
```

---

**User**

没有任何作用

---

**Cursor**


检查并修复。`:host(#id)` 语法可能无效。改用属性选择器或 CSS 变量：



`:host(#id)` 在 Shadow DOM 中可能无效。改用属性选择器：


```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    return html`
      <a2ui-button id=${id} @click=${handleClick}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      // Update data model with new value
      const textProp = props.text as BoundValue;
      if (textProp && 'path' in textProp) {
        // Note: This would need proper two-way binding implementation
        console.log(`TextField ${id} changed to: ${target.value}`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([id="tickets-search-row"]) {
      gap: 24px;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```


已将选择器从 `:host(#tickets-search-row)` 改为 `:host([id="tickets-search-row"])`，这样可正确匹配 ID 属性。

如果仍未生效，改用 CSS 变量。检查是否还有其他问题：



已修复选择器语法。如果仍未生效，改为在渲染时添加 data 属性。先尝试另一种方法：为特定行添加 data 属性：


```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    return html`
      <a2ui-button id=${id} @click=${handleClick}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      // Update data model with new value
      const textProp = props.text as BoundValue;
      if (textProp && 'path' in textProp) {
        // Note: This would need proper two-way binding implementation
        console.log(`TextField ${id} changed to: ${target.value}`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([id="tickets-search-row"]) {
      gap: 24px;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    return html`
      <a2ui-button id=${id} @click=${handleClick}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      // Update data model with new value
      const textProp = props.text as BoundValue;
      if (textProp && 'path' in textProp) {
        // Note: This would need proper two-way binding implementation
        console.log(`TextField ${id} changed to: ${target.value}`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 24px;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```


已改为使用 data 属性，更可靠：

1. 在 `renderRow` 中，当 ID 为 `tickets-search-row` 时添加 `data-search-row="true"` 属性
2. 在样式中使用 `:host([data-search-row="true"])` 来匹配并设置更大的间距

这样可确保样式正确应用。刷新页面后，搜索框和搜索按钮之间的间距应为 24px。

如果仍未生效，请检查浏览器开发者工具，确认：
- `a2ui-row` 元素是否有 `data-search-row="true"` 属性
- 样式是否被应用

修改后的代码：

```188:202:project_alpha/a2ui_frontend/client/src/renderer.ts
  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }
```

```427:445:project_alpha/a2ui_frontend/client/src/renderer.ts
@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 24px;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;
```

请刷新页面查看效果。

```typescript
  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }
```

```typescript
@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 24px;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;
```

---

**User**

搜索文本框和搜素按钮还是离的太近了

---

**Cursor**


增大间距值，并确保样式生效。检查当前代码并调整：



将间距增加到 32px，并使用 `!important` 确保样式生效：


```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    return html`
      <a2ui-button id=${id} @click=${handleClick}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      // Update data model with new value
      const textProp = props.text as BoundValue;
      if (textProp && 'path' in textProp) {
        // Note: This would need proper two-way binding implementation
        console.log(`TextField ${id} changed to: ${target.value}`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 32px !important;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```


检查 `renderRow` 是否正确设置了属性：



代码看起来正确。将间距增加到 48px，使效果更明显：


```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    return html`
      <a2ui-button id=${id} @click=${handleClick}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      // Update data model with new value
      const textProp = props.text as BoundValue;
      if (textProp && 'path' in textProp) {
        // Note: This would need proper two-way binding implementation
        console.log(`TextField ${id} changed to: ${target.value}`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```


已将搜索框和搜索按钮之间的间距增加到 48px，并添加了 `!important` 以确保样式优先级。

修改后的代码：

```429:450:project_alpha/a2ui_frontend/client/src/renderer.ts
@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;
```

请刷新页面查看效果。如果仍未生效，请：

1. 硬刷新浏览器（Ctrl+Shift+R 或 Cmd+Shift+R）
2. 在浏览器开发者工具中检查 `a2ui-row` 元素：
   - 是否有 `data-search-row="true"` 属性
   - 计算样式中 `gap` 是否为 48px

如果还是不行，我可以尝试其他方法。

```typescript
@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;
```

---

**User**

这些按钮需要缩小，或者以另外一个形式呈现

---

**Cursor**


查看当前按钮的实现，准备缩小或调整呈现方式：



筛选按钮样式可能未生效。在按钮组件中添加对筛选按钮的特殊处理，使其更小更紧凑。先检查按钮的渲染方式：



为筛选按钮添加特殊样式，使其更小更紧凑：


```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    // Check if this is a filter button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');

    return html`
      <a2ui-button id=${id} data-filter-button=${isFilterButton ? 'true' : nothing} @click=${handleClick}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      // Update data model with new value
      const textProp = props.text as BoundValue;
      if (textProp && 'path' in textProp) {
        // Note: This would need proper two-way binding implementation
        console.log(`TextField ${id} changed to: ${target.value}`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    // Check if this is a filter button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');

    return html`
      <a2ui-button id=${id} data-filter-button=${isFilterButton ? 'true' : nothing} @click=${handleClick}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      // Update data model with new value
      const textProp = props.text as BoundValue;
      if (textProp && 'path' in textProp) {
        // Note: This would need proper two-way binding implementation
        console.log(`TextField ${id} changed to: ${target.value}`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```


调整筛选按钮行的间距，使其更紧凑：


```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    // Check if this is a filter button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');

    return html`
      <a2ui-button id=${id} data-filter-button=${isFilterButton ? 'true' : nothing} @click=${handleClick}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      // Update data model with new value
      const textProp = props.text as BoundValue;
      if (textProp && 'path' in textProp) {
        // Note: This would need proper two-way binding implementation
        console.log(`TextField ${id} changed to: ${target.value}`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    // Check if this is a filter button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');

    return html`
      <a2ui-button id=${id} data-filter-button=${isFilterButton ? 'true' : nothing} @click=${handleClick}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      // Update data model with new value
      const textProp = props.text as BoundValue;
      if (textProp && 'path' in textProp) {
        // Note: This would need proper two-way binding implementation
        console.log(`TextField ${id} changed to: ${target.value}`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```


已优化筛选按钮样式，使其更小、更紧凑：

1. **缩小按钮尺寸**：筛选按钮使用更小的 padding（4px 12px）和字体（14px）
2. **更改视觉样式**：默认灰色背景，悬停时变为黄色
3. **圆角样式**：使用完全圆角（pill 形状）
4. **行间距优化**：筛选按钮行使用更小的间距（8px）并允许换行

修改后的代码：

```114:130:project_alpha/a2ui_frontend/client/src/renderer.ts
  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    // Check if this is a filter button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');

    return html`
      <a2ui-button id=${id} data-filter-button=${isFilterButton ? 'true' : nothing} @click=${handleClick}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }
```

```356:385:project_alpha/a2ui_frontend/client/src/renderer.ts
@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
  `;
```

刷新页面后，筛选按钮应显示为更小的灰色圆角按钮，悬停时变为黄色。如果还需要进一步调整，我可以继续优化。

```typescript
  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    // Check if this is a filter button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');

    return html`
      <a2ui-button id=${id} data-filter-button=${isFilterButton ? 'true' : nothing} @click=${handleClick}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }
```

```typescript
@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
  `;
```

---

**User**

点击这些按钮的时候，下面的查询结构没有变化。同时搜索结果和分页信息也不正确

---

**Cursor**


检查按钮点击事件处理和搜索/筛选逻辑：



检查客户端如何处理导航，以及筛选时是否正确保留查询参数：



修复以下问题：
1. 筛选时未保留其他查询参数（如已选择 status，再选 priority 会丢失 status）
2. 查询状态未从 URL 参数读取
3. 分页信息可能不正确

开始修复：


```python
"""A2UI Agent Server - Main entry point."""
import asyncio
import json
import logging
from datetime import datetime
from typing import AsyncGenerator, Optional
from urllib.parse import urlparse, parse_qs

from fastapi import FastAPI, Request, Query, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import StreamingResponse, FileResponse
from fastapi.staticfiles import StaticFiles
from sse_starlette.sse import EventSourceResponse

from config import settings
from models import UserAction
from api_client import api_client
from a2ui_builder import A2UIBuilder
from pages.layout import build_app_layout
from pages.tickets import (
    build_tickets_page, build_tickets_data,
    build_ticket_detail_page, build_ticket_detail_data,
    build_ticket_create_page, build_ticket_create_data,
    build_ticket_edit_page, build_ticket_edit_data,
)
from pages.tags import build_tags_page, build_tags_data
from pages.error import build_not_found_page, build_error_page

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(title="A2UI Agent Server", version="1.0.0")

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


def safe_int(value, default: int = 1) -> int:
    """Safely convert value to int with default fallback."""
    if value is None:
        return default
    try:
        return int(value)
    except (ValueError, TypeError):
        return default


async def generate_page_messages(path: str, query_params: dict) -> AsyncGenerator[str, None]:
    """Generate A2UI messages for a given page path."""
    builder = A2UIBuilder("main")

    try:
        # Route to appropriate page builder
        if path == "/" or path == "/tickets":
            # Tickets list page
            tickets_data = await api_client.list_tickets(
                search=query_params.get("search"),
                status=query_params.get("status"),
                priority=query_params.get("priority"),
                page=safe_int(query_params.get("page"), 1),
            )
            page_id, _ = build_tickets_page(builder)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_tickets_data(tickets_data):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tickets/new":
            # Ticket create page
            page_id, _ = build_ticket_create_page(builder)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_create_data():
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/") and path.endswith("/edit"):
            # Ticket edit page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            page_id, _ = build_ticket_edit_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_edit_data(ticket):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/"):
            # Ticket detail page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            attachments = await api_client.get_ticket_attachments(ticket_id)
            history_response = await api_client.get_ticket_history(ticket_id)
            history = history_response.get("data", [])

            page_id, _ = build_ticket_detail_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_detail_data(ticket, attachments, history):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tags":
            # Tags page
            tags = await api_client.list_tags()
            page_id, _ = build_tags_page(builder)
            build_app_layout(builder, page_id, "tags")

            yield builder.build_surface_update()
            for msg in build_tags_data(tags):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        else:
            # 404 page
            page_id, _ = build_not_found_page(builder)
            build_app_layout(builder, page_id, "")

            yield builder.build_surface_update()
            yield builder.build_begin_rendering("app-layout")

    except Exception as e:
        logger.exception(f"Error generating page: {e}")
        builder.reset()
        page_id, _ = build_error_page(builder, str(e))
        build_app_layout(builder, page_id, "")

        yield builder.build_surface_update()
        yield builder.build_begin_rendering("app-layout")


@app.get("/api/a2ui/stream")
async def stream_ui(
    request: Request,
    path: str = Query("/", description="Page path to render"),
):
    """SSE endpoint for A2UI messages."""
    # Parse query params from the path parameter itself (e.g., /tickets?page=2)
    parsed = urlparse(path)
    actual_path = parsed.path
    path_query_params = parse_qs(parsed.query)

    # Also get query params from the request URL (excluding 'path')
    request_params = dict(request.query_params)
    request_params.pop("path", None)

    # Merge query params (path params take precedence)
    query_params = request_params.copy()
    for key, values in path_query_params.items():
        if values:
            query_params[key] = values[0]  # Take first value

    # Use actual_path for routing
    path = actual_path

    async def event_generator():
        async for message in generate_page_messages(path, query_params):
            if await request.is_disconnected():
                break
            yield {"event": "message", "data": message}

    return EventSourceResponse(event_generator())


@app.post("/api/a2ui/action")
async def handle_action(action: UserAction):
    """Handle userAction from client."""
    logger.info(f"Received action: {action.name} with context: {action.context}")

    try:
        result = await process_action(action)
        return {"success": True, "result": result}
    except Exception as e:
        logger.exception(f"Error processing action: {e}")
        raise HTTPException(status_code=500, detail=str(e))


async def process_action(action: UserAction) -> dict:
    """Process a userAction and return the result."""
    name = action.name
    context = action.context
    logger.info(f"Processing action '{name}' with context: {context}")

    if name == "navigate":
        # Navigation is handled client-side by reconnecting to SSE
        return {"navigate": context.get("to", "/tickets")}

    elif name in ["search_tickets", "filter_status", "filter_priority", "paginate"]:
        # Get current query params from context (passed from client)
        # Client should pass current query state
        current_search = context.get("current_search", "")
        current_status = context.get("current_status", "")
        current_priority = context.get("current_priority", "")
        current_page = safe_int(context.get("current_page"), 1)

        # Update based on action
        if name == "search_tickets":
            search_term = context.get('search') or ''
            new_search = search_term
            new_status = current_status
            new_priority = current_priority
            new_page = 1  # Reset to page 1 on new search
        elif name == "filter_status":
            status = context.get("status") or ""
            new_search = current_search
            new_status = status
            new_priority = current_priority
            new_page = 1  # Reset to page 1 on filter change
        elif name == "filter_priority":
            priority = context.get("priority") or ""
            new_search = current_search
            new_status = current_status
            new_priority = priority
            new_page = 1  # Reset to page 1 on filter change
        elif name == "paginate":
            page = safe_int(context.get("page"), 1)
            new_search = current_search
            new_status = current_status
            new_priority = current_priority
            new_page = page

        # Build query string
        query_parts = []
        if new_search:
            query_parts.append(f"search={new_search}")
        if new_status:
            query_parts.append(f"status={new_status}")
        if new_priority:
            query_parts.append(f"priority={new_priority}")
        if new_page > 1:
            query_parts.append(f"page={new_page}")

        query_string = "?" + "&".join(query_parts) if query_parts else ""
        return {"navigate": f"/tickets{query_string}"}

    elif name == "view_ticket":
        ticket_id = context.get("id")
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_ticket":
        form = context.get("form", {})
        ticket = await api_client.create_ticket({
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority", "medium"),
        })
        return {"navigate": f"/tickets/{ticket['id']}"}

    elif name == "update_ticket":
        ticket_id = context.get("id")
        form = context.get("form", {})
        await api_client.update_ticket(ticket_id, {
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority"),
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "delete_ticket":
        ticket_id = context.get("id")
        await api_client.delete_ticket(ticket_id)
        return {"navigate": "/tickets"}

    elif name == "change_status":
        ticket_id = context.get("id")
        status = context.get("status")
        resolution = context.get("resolution")
        await api_client.update_ticket_status(ticket_id, {
            "status": status,
            "resolution": resolution,
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_tag":
        form = context.get("form", {})
        await api_client.create_tag({
            "name": form.get("name"),
            "color": form.get("color", "#3B82F6"),
        })
        return {"navigate": "/tags"}

    elif name == "delete_tag":
        tag_id = context.get("id")
        await api_client.delete_tag(tag_id)
        return {"navigate": "/tags"}

    elif name in ["show_create_tag_form", "hide_create_tag_form", "set_tag_color", "set_form_priority"]:
        # These are handled client-side via data model updates
        return {"handled": True}

    elif name in ["show_delete_dialog", "dismiss_dialog"]:
        # Dialog handling is client-side
        return {"handled": True}

    elif name == "retry":
        # Retry by refreshing current page
        return {"refresh": True}

    else:
        logger.warning(f"Unknown action: {name}")
        return {"unknown": True}


@app.get("/health")
async def health():
    """Health check endpoint."""
    return {"status": "healthy"}


# Serve static files for the client
try:
    app.mount("/", StaticFiles(directory="../client/dist", html=True), name="static")
except RuntimeError:
    # Client not built yet
    @app.get("/")
    async def root():
        return {"message": "A2UI Agent Server is running. Build the client to serve the UI."}


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host=settings.host, port=settings.port)

```


修改 `build_tickets_data` 以从查询参数读取状态，并更新按钮以传递当前查询状态：


```python
"""A2UI Agent Server - Main entry point."""
import asyncio
import json
import logging
from datetime import datetime
from typing import AsyncGenerator, Optional
from urllib.parse import urlparse, parse_qs

from fastapi import FastAPI, Request, Query, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import StreamingResponse, FileResponse
from fastapi.staticfiles import StaticFiles
from sse_starlette.sse import EventSourceResponse

from config import settings
from models import UserAction
from api_client import api_client
from a2ui_builder import A2UIBuilder
from pages.layout import build_app_layout
from pages.tickets import (
    build_tickets_page, build_tickets_data,
    build_ticket_detail_page, build_ticket_detail_data,
    build_ticket_create_page, build_ticket_create_data,
    build_ticket_edit_page, build_ticket_edit_data,
)
from pages.tags import build_tags_page, build_tags_data
from pages.error import build_not_found_page, build_error_page

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(title="A2UI Agent Server", version="1.0.0")

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


def safe_int(value, default: int = 1) -> int:
    """Safely convert value to int with default fallback."""
    if value is None:
        return default
    try:
        return int(value)
    except (ValueError, TypeError):
        return default


async def generate_page_messages(path: str, query_params: dict) -> AsyncGenerator[str, None]:
    """Generate A2UI messages for a given page path."""
    builder = A2UIBuilder("main")

    try:
        # Route to appropriate page builder
        if path == "/" or path == "/tickets":
            # Tickets list page
            search = query_params.get("search", "")
            status = query_params.get("status", "")
            priority = query_params.get("priority", "")
            page = safe_int(query_params.get("page"), 1)
            
            tickets_data = await api_client.list_tickets(
                search=search if search else None,
                status=status if status else None,
                priority=priority if priority else None,
                page=page,
            )
            page_id, _ = build_tickets_page(builder)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_tickets_data(tickets_data, search, status, priority, page):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tickets/new":
            # Ticket create page
            page_id, _ = build_ticket_create_page(builder)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_create_data():
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/") and path.endswith("/edit"):
            # Ticket edit page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            page_id, _ = build_ticket_edit_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_edit_data(ticket):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/"):
            # Ticket detail page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            attachments = await api_client.get_ticket_attachments(ticket_id)
            history_response = await api_client.get_ticket_history(ticket_id)
            history = history_response.get("data", [])

            page_id, _ = build_ticket_detail_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_detail_data(ticket, attachments, history):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tags":
            # Tags page
            tags = await api_client.list_tags()
            page_id, _ = build_tags_page(builder)
            build_app_layout(builder, page_id, "tags")

            yield builder.build_surface_update()
            for msg in build_tags_data(tags):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        else:
            # 404 page
            page_id, _ = build_not_found_page(builder)
            build_app_layout(builder, page_id, "")

            yield builder.build_surface_update()
            yield builder.build_begin_rendering("app-layout")

    except Exception as e:
        logger.exception(f"Error generating page: {e}")
        builder.reset()
        page_id, _ = build_error_page(builder, str(e))
        build_app_layout(builder, page_id, "")

        yield builder.build_surface_update()
        yield builder.build_begin_rendering("app-layout")


@app.get("/api/a2ui/stream")
async def stream_ui(
    request: Request,
    path: str = Query("/", description="Page path to render"),
):
    """SSE endpoint for A2UI messages."""
    # Parse query params from the path parameter itself (e.g., /tickets?page=2)
    parsed = urlparse(path)
    actual_path = parsed.path
    path_query_params = parse_qs(parsed.query)

    # Also get query params from the request URL (excluding 'path')
    request_params = dict(request.query_params)
    request_params.pop("path", None)

    # Merge query params (path params take precedence)
    query_params = request_params.copy()
    for key, values in path_query_params.items():
        if values:
            query_params[key] = values[0]  # Take first value

    # Use actual_path for routing
    path = actual_path

    async def event_generator():
        async for message in generate_page_messages(path, query_params):
            if await request.is_disconnected():
                break
            yield {"event": "message", "data": message}

    return EventSourceResponse(event_generator())


@app.post("/api/a2ui/action")
async def handle_action(action: UserAction):
    """Handle userAction from client."""
    logger.info(f"Received action: {action.name} with context: {action.context}")

    try:
        result = await process_action(action)
        return {"success": True, "result": result}
    except Exception as e:
        logger.exception(f"Error processing action: {e}")
        raise HTTPException(status_code=500, detail=str(e))


async def process_action(action: UserAction) -> dict:
    """Process a userAction and return the result."""
    name = action.name
    context = action.context
    logger.info(f"Processing action '{name}' with context: {context}")

    if name == "navigate":
        # Navigation is handled client-side by reconnecting to SSE
        return {"navigate": context.get("to", "/tickets")}

    elif name in ["search_tickets", "filter_status", "filter_priority", "paginate"]:
        # Get current query params from context (passed from client)
        # Client should pass current query state
        current_search = context.get("current_search", "")
        current_status = context.get("current_status", "")
        current_priority = context.get("current_priority", "")
        current_page = safe_int(context.get("current_page"), 1)

        # Update based on action
        if name == "search_tickets":
            search_term = context.get('search') or ''
            new_search = search_term
            new_status = current_status
            new_priority = current_priority
            new_page = 1  # Reset to page 1 on new search
        elif name == "filter_status":
            status = context.get("status") or ""
            new_search = current_search
            new_status = status
            new_priority = current_priority
            new_page = 1  # Reset to page 1 on filter change
        elif name == "filter_priority":
            priority = context.get("priority") or ""
            new_search = current_search
            new_status = current_status
            new_priority = priority
            new_page = 1  # Reset to page 1 on filter change
        elif name == "paginate":
            page = safe_int(context.get("page"), 1)
            new_search = current_search
            new_status = current_status
            new_priority = current_priority
            new_page = page

        # Build query string
        query_parts = []
        if new_search:
            query_parts.append(f"search={new_search}")
        if new_status:
            query_parts.append(f"status={new_status}")
        if new_priority:
            query_parts.append(f"priority={new_priority}")
        if new_page > 1:
            query_parts.append(f"page={new_page}")

        query_string = "?" + "&".join(query_parts) if query_parts else ""
        return {"navigate": f"/tickets{query_string}"}

    elif name == "view_ticket":
        ticket_id = context.get("id")
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_ticket":
        form = context.get("form", {})
        ticket = await api_client.create_ticket({
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority", "medium"),
        })
        return {"navigate": f"/tickets/{ticket['id']}"}

    elif name == "update_ticket":
        ticket_id = context.get("id")
        form = context.get("form", {})
        await api_client.update_ticket(ticket_id, {
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority"),
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "delete_ticket":
        ticket_id = context.get("id")
        await api_client.delete_ticket(ticket_id)
        return {"navigate": "/tickets"}

    elif name == "change_status":
        ticket_id = context.get("id")
        status = context.get("status")
        resolution = context.get("resolution")
        await api_client.update_ticket_status(ticket_id, {
            "status": status,
            "resolution": resolution,
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_tag":
        form = context.get("form", {})
        await api_client.create_tag({
            "name": form.get("name"),
            "color": form.get("color", "#3B82F6"),
        })
        return {"navigate": "/tags"}

    elif name == "delete_tag":
        tag_id = context.get("id")
        await api_client.delete_tag(tag_id)
        return {"navigate": "/tags"}

    elif name in ["show_create_tag_form", "hide_create_tag_form", "set_tag_color", "set_form_priority"]:
        # These are handled client-side via data model updates
        return {"handled": True}

    elif name in ["show_delete_dialog", "dismiss_dialog"]:
        # Dialog handling is client-side
        return {"handled": True}

    elif name == "retry":
        # Retry by refreshing current page
        return {"refresh": True}

    else:
        logger.warning(f"Unknown action: {name}")
        return {"unknown": True}


@app.get("/health")
async def health():
    """Health check endpoint."""
    return {"status": "healthy"}


# Serve static files for the client
try:
    app.mount("/", StaticFiles(directory="../client/dist", html=True), name="static")
except RuntimeError:
    # Client not built yet
    @app.get("/")
    async def root():
        return {"message": "A2UI Agent Server is running. Build the client to serve the UI."}


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host=settings.host, port=settings.port)

```

```python
"""Ticket page builders."""
from typing import Any, Optional
from a2ui_builder import A2UIBuilder, value_string, value_number, value_map, build_value_map_from_dict
from models import (
    STATUS_LABELS, PRIORITY_LABELS, STATUS_TRANSITIONS,
    TicketStatus, Priority
)


def build_tickets_page(builder: A2UIBuilder) -> tuple[str, list[str]]:
    """Build the tickets list page."""
    # Page header
    builder.text("tickets-title", "票据列表", usage_hint="h1")
    builder.text("tickets-add-text", "+ 新建票据")
    builder.button(
        "tickets-add-btn",
        "tickets-add-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets/new"}}],
    )
    builder.row("tickets-header", ["tickets-title", "tickets-add-btn"], distribution="spaceBetween", alignment="center")

    # Search
    builder.text_field("tickets-search", "搜索票据...", builder.path("/app/tickets/query/search"))
    builder.text("tickets-search-btn-text", "搜索")
    builder.button(
        "tickets-search-btn",
        "tickets-search-btn-text",
        "search_tickets",
        [{"key": "search", "value": {"path": "/app/tickets/query/search"}}],
    )
    builder.row("tickets-search-row", ["tickets-search", "tickets-search-btn"], alignment="center")

    # Status filter buttons
    builder.text("filter-all-text", "全部")
    builder.button("filter-all", "filter-all-text", "filter_status", [{"key": "status", "value": {"literalString": ""}}])
    builder.text("filter-open-text", "待处理")
    builder.button("filter-open", "filter-open-text", "filter_status", [{"key": "status", "value": {"literalString": "open"}}])
    builder.text("filter-progress-text", "处理中")
    builder.button("filter-progress", "filter-progress-text", "filter_status", [{"key": "status", "value": {"literalString": "in_progress"}}])
    builder.text("filter-completed-text", "已完成")
    builder.button("filter-completed", "filter-completed-text", "filter_status", [{"key": "status", "value": {"literalString": "completed"}}])
    builder.text("filter-cancelled-text", "已取消")
    builder.button("filter-cancelled", "filter-cancelled-text", "filter_status", [{"key": "status", "value": {"literalString": "cancelled"}}])
    builder.row("tickets-status-filters", ["filter-all", "filter-open", "filter-progress", "filter-completed", "filter-cancelled"], alignment="center")

    # Priority filter buttons
    builder.text("priority-all-text", "全部优先级")
    builder.button("priority-all", "priority-all-text", "filter_priority", [{"key": "priority", "value": {"literalString": ""}}])
    builder.text("priority-low-text", "低")
    builder.button("priority-low", "priority-low-text", "filter_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("priority-medium-text", "中")
    builder.button("priority-medium", "priority-medium-text", "filter_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("priority-high-text", "高")
    builder.button("priority-high", "priority-high-text", "filter_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("priority-urgent-text", "紧急")
    builder.button("priority-urgent", "priority-urgent-text", "filter_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("tickets-priority-filters", ["priority-all", "priority-low", "priority-medium", "priority-high", "priority-urgent"], alignment="center")

    builder.column("tickets-filters", ["tickets-search-row", "tickets-status-filters", "tickets-priority-filters"])
    builder.card("tickets-filters-card", "tickets-filters")

    # Ticket list template - simplified without icons
    builder.text("ticket-item-title", builder.path("title"), usage_hint="h3")
    builder.text("ticket-item-status", builder.path("statusLabel"))
    builder.text("ticket-item-priority", builder.path("priorityLabel"))
    builder.text("ticket-item-date", builder.path("created_at"))
    builder.row("ticket-item-meta", ["ticket-item-status", "ticket-item-priority", "ticket-item-date"], alignment="center")
    builder.column("ticket-item-content", ["ticket-item-title", "ticket-item-meta"])
    builder.text("ticket-item-arrow", "→")
    builder.row("ticket-item-row", ["ticket-item-content", "ticket-item-arrow"], distribution="spaceBetween", alignment="center")
    builder.button(
        "ticket-item-btn",
        "ticket-item-row",
        "view_ticket",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.card("ticket-item-card", "ticket-item-btn")

    # Ticket list
    builder.list_component(
        "tickets-list",
        template={"componentId": "ticket-item-card", "dataBinding": "/app/tickets/list"},
        direction="vertical",
    )

    # Empty state
    builder.text("tickets-empty-title", "暂无票据", usage_hint="h3")
    builder.text("tickets-empty-desc", "点击上方按钮创建第一个票据")
    builder.column("tickets-empty", ["tickets-empty-title", "tickets-empty-desc"], alignment="center")

    # Pagination - use literalNumber for page values since they're numbers
    builder.text("pagination-prev-text", "← 上一页")
    builder.button(
        "pagination-prev",
        "pagination-prev-text",
        "paginate",
        [{"key": "page", "value": {"path": "/app/tickets/pagination/prevPage"}}],
    )
    builder.text("pagination-info", builder.path("/app/tickets/pagination/info"))
    builder.text("pagination-next-text", "下一页 →")
    builder.button(
        "pagination-next",
        "pagination-next-text",
        "paginate",
        [{"key": "page", "value": {"path": "/app/tickets/pagination/nextPage"}}],
    )
    builder.row("tickets-pagination", ["pagination-prev", "pagination-info", "pagination-next"], distribution="center", alignment="center")

    # Main content
    builder.column("tickets-content", ["tickets-list", "tickets-pagination"])
    builder.column("tickets-page", ["tickets-header", "tickets-filters-card", "tickets-content"])

    return "tickets-page", []


def build_tickets_data(tickets_response: dict, search: str = "", status: str = "", priority: str = "", page: int = 1) -> list[str]:
    """Build data model updates for tickets page."""
    messages = []
    builder = A2UIBuilder()

    # Query state - use actual values from URL params
    query_data = [
        value_string("search", search),
        value_string("status", status),
        value_string("priority", priority),
        value_number("page", page),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/query", query_data))

    # Tickets list
    tickets = tickets_response.get("data", [])
    list_data = []
    for i, ticket in enumerate(tickets):
        ticket_map = build_value_map_from_dict({
            "id": ticket["id"],
            "title": ticket["title"],
            "status": ticket["status"],
            "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
            "priority": ticket["priority"],
            "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
            "created_at": ticket["created_at"][:10],  # Date only
        })
        list_data.append(value_map(f"ticket{i}", ticket_map))
    messages.append(builder.build_data_model_update("/app/tickets/list", list_data))

    # Pagination
    page = tickets_response.get("page", 1)
    total_pages = tickets_response.get("total_pages", 1)
    pagination_data = [
        value_number("page", page),
        value_number("totalPages", total_pages),
        value_number("prevPage", max(1, page - 1)),
        value_number("nextPage", min(total_pages, page + 1)),
        value_string("info", f"第 {page} 页 / 共 {total_pages} 页"),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/pagination", pagination_data))

    return messages


def build_ticket_detail_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket detail page."""
    ticket_id = ticket["id"]
    status = ticket["status"]

    # Back button
    builder.text("detail-back-text", "← 返回列表")
    builder.button(
        "detail-back-btn",
        "detail-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    # Title
    builder.text("detail-title", builder.path("/app/ticket/detail/title"), usage_hint="h1")

    # Actions
    builder.text("detail-edit-text", "编辑")
    builder.button(
        "detail-edit-btn",
        "detail-edit-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}/edit"}}],
    )

    builder.text("detail-delete-text", "删除")
    builder.button(
        "detail-delete-btn",
        "detail-delete-text",
        "show_delete_dialog",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )

    builder.row("detail-actions", ["detail-edit-btn", "detail-delete-btn"], alignment="center")
    builder.row("detail-header", ["detail-back-btn", "detail-title", "detail-actions"], distribution="spaceBetween", alignment="center")

    # Description card
    builder.text("detail-desc-label", "描述", usage_hint="h4")
    builder.text("detail-desc-content", builder.path("/app/ticket/detail/description"))
    builder.column("detail-desc-col", ["detail-desc-label", "detail-desc-content"])
    builder.card("detail-desc-card", "detail-desc-col")

    # Resolution card (if exists)
    builder.text("detail-resolution-label", "处理结果", usage_hint="h4")
    builder.text("detail-resolution-content", builder.path("/app/ticket/detail/resolution"))
    builder.column("detail-resolution-col", ["detail-resolution-label", "detail-resolution-content"])
    builder.card("detail-resolution-card", "detail-resolution-col")

    # Status card
    builder.text("detail-status-label", "状态", usage_hint="h4")
    builder.text("detail-status-value", builder.path("/app/ticket/detail/statusLabel"))

    # Status transition buttons
    allowed_transitions = STATUS_TRANSITIONS.get(TicketStatus(status), [])
    status_btns = []
    for target_status in allowed_transitions:
        btn_id = f"status-btn-{target_status.value}"
        text_id = f"status-btn-text-{target_status.value}"
        builder.text(text_id, f"→ {STATUS_LABELS[target_status]}")
        builder.button(
            btn_id,
            text_id,
            "change_status",
            [
                {"key": "id", "value": {"literalString": ticket_id}},
                {"key": "status", "value": {"literalString": target_status.value}},
            ],
        )
        status_btns.append(btn_id)

    builder.row("detail-status-btns", status_btns, alignment="center")
    builder.column("detail-status-col", ["detail-status-label", "detail-status-value", "detail-status-btns"])
    builder.card("detail-status-card", "detail-status-col")

    # Priority card
    builder.text("detail-priority-label", "优先级", usage_hint="h4")
    builder.text("detail-priority-value", builder.path("/app/ticket/detail/priorityLabel"))
    builder.column("detail-priority-col", ["detail-priority-label", "detail-priority-value"])
    builder.card("detail-priority-card", "detail-priority-col")

    # Tags card
    builder.text("detail-tags-label", "标签", usage_hint="h4")
    builder.text("detail-tag-name", builder.path("name"))
    builder.list_component(
        "detail-tags-list",
        template={"componentId": "detail-tag-name", "dataBinding": "/app/ticket/tags"},
        direction="horizontal",
    )
    builder.column("detail-tags-col", ["detail-tags-label", "detail-tags-list"])
    builder.card("detail-tags-card", "detail-tags-col")

    # Timestamps card
    builder.text("detail-time-label", "时间信息", usage_hint="h4")
    builder.text("detail-created-label", "创建时间")
    builder.text("detail-created-value", builder.path("/app/ticket/detail/created_at"))
    builder.row("detail-created-row", ["detail-created-label", "detail-created-value"], distribution="spaceBetween")
    builder.text("detail-updated-label", "更新时间")
    builder.text("detail-updated-value", builder.path("/app/ticket/detail/updated_at"))
    builder.row("detail-updated-row", ["detail-updated-label", "detail-updated-value"], distribution="spaceBetween")
    builder.column("detail-time-col", ["detail-time-label", "detail-created-row", "detail-updated-row"])
    builder.card("detail-time-card", "detail-time-col")

    # Attachments card
    builder.text("detail-attach-label", "附件", usage_hint="h4")
    builder.text("detail-attach-filename", builder.path("filename"))
    builder.text("detail-attach-size", builder.path("sizeFormatted"))
    builder.row("detail-attach-info", ["detail-attach-filename", "detail-attach-size"], distribution="spaceBetween")
    builder.text("detail-attach-download-text", "下载")
    builder.button(
        "detail-attach-download",
        "detail-attach-download-text",
        "download_attachment",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.row("detail-attach-item", ["detail-attach-info", "detail-attach-download"], distribution="spaceBetween", alignment="center")
    builder.list_component(
        "detail-attach-list",
        template={"componentId": "detail-attach-item", "dataBinding": "/app/ticket/attachments"},
        direction="vertical",
    )
    builder.text("detail-attach-empty", "暂无附件")
    builder.column("detail-attach-col", ["detail-attach-label", "detail-attach-list"])
    builder.card("detail-attach-card", "detail-attach-col")

    # History card
    builder.text("detail-history-label", "变更历史", usage_hint="h4")
    builder.text("detail-history-type", builder.path("changeTypeLabel"))
    builder.text("detail-history-time", builder.path("created_at"))
    builder.text("detail-history-old", builder.path("old_value"))
    builder.text("detail-history-arrow", "→")
    builder.text("detail-history-new", builder.path("new_value"))
    builder.row("detail-history-change", ["detail-history-old", "detail-history-arrow", "detail-history-new"], alignment="center")
    builder.column("detail-history-item", ["detail-history-type", "detail-history-time", "detail-history-change"])
    builder.list_component(
        "detail-history-list",
        template={"componentId": "detail-history-item", "dataBinding": "/app/ticket/history"},
        direction="vertical",
    )
    builder.column("detail-history-col", ["detail-history-label", "detail-history-list"])
    builder.card("detail-history-card", "detail-history-col")

    # Left column (main content)
    main_cards = ["detail-desc-card"]
    if ticket.get("resolution"):
        main_cards.append("detail-resolution-card")
    main_cards.append("detail-attach-card")
    builder.column("detail-main", main_cards)

    # Right column (sidebar)
    builder.column("detail-sidebar", [
        "detail-status-card",
        "detail-priority-card",
        "detail-tags-card",
        "detail-time-card",
        "detail-history-card",
    ])

    # Layout
    builder.row("detail-body", ["detail-main", "detail-sidebar"], distribution="start")
    builder.column("detail-page", ["detail-header", "detail-body"])

    # Delete confirmation modal
    builder.text("delete-modal-title", "确认删除", usage_hint="h3")
    builder.text("delete-modal-desc", "确定要删除这个票据吗？此操作无法撤销。")
    builder.text("delete-modal-cancel-text", "取消")
    builder.button("delete-modal-cancel", "delete-modal-cancel-text", "dismiss_dialog", [])
    builder.text("delete-modal-confirm-text", "确认删除")
    builder.button(
        "delete-modal-confirm",
        "delete-modal-confirm-text",
        "delete_ticket",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )
    builder.row("delete-modal-actions", ["delete-modal-cancel", "delete-modal-confirm"], distribution="end")
    builder.column("delete-modal-content", ["delete-modal-title", "delete-modal-desc", "delete-modal-actions"])

    return "detail-page", []


def build_ticket_detail_data(ticket: dict, attachments: list, history: list) -> list[str]:
    """Build data model updates for ticket detail page."""
    messages = []
    builder = A2UIBuilder()

    # Ticket detail
    detail_data = build_value_map_from_dict({
        "id": ticket["id"],
        "title": ticket["title"],
        "description": ticket.get("description") or "无描述",
        "status": ticket["status"],
        "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
        "priority": ticket["priority"],
        "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
        "resolution": ticket.get("resolution") or "",
        "created_at": ticket["created_at"][:19].replace("T", " "),
        "updated_at": ticket["updated_at"][:19].replace("T", " "),
    })
    messages.append(builder.build_data_model_update("/app/ticket/detail", detail_data))

    # Tags
    tags = ticket.get("tags", [])
    tags_data = []
    for i, tag in enumerate(tags):
        tags_data.append(value_map(f"tag{i}", build_value_map_from_dict({
            "id": tag["id"],
            "name": tag["name"],
            "color": tag["color"],
        })))
    messages.append(builder.build_data_model_update("/app/ticket/tags", tags_data))

    # Attachments
    attach_data = []
    for i, att in enumerate(attachments):
        size_bytes = att["size_bytes"]
        if size_bytes < 1024:
            size_formatted = f"{size_bytes} B"
        elif size_bytes < 1024 * 1024:
            size_formatted = f"{size_bytes / 1024:.1f} KB"
        else:
            size_formatted = f"{size_bytes / (1024 * 1024):.1f} MB"
        attach_data.append(value_map(f"att{i}", build_value_map_from_dict({
            "id": att["id"],
            "filename": att["filename"],
            "sizeFormatted": size_formatted,
        })))
    messages.append(builder.build_data_model_update("/app/ticket/attachments", attach_data))

    # History
    change_type_labels = {
        "status": "状态变更",
        "priority": "优先级变更",
        "resolution": "处理结果",
        "tag_added": "添加标签",
        "tag_removed": "移除标签",
    }
    history_data = []
    for i, h in enumerate(history):
        history_data.append(value_map(f"h{i}", build_value_map_from_dict({
            "changeTypeLabel": change_type_labels.get(h["change_type"], h["change_type"]),
            "old_value": h.get("old_value") or "-",
            "new_value": h.get("new_value") or "-",
            "created_at": h["created_at"][:19].replace("T", " "),
        })))
    messages.append(builder.build_data_model_update("/app/ticket/history", history_data))

    return messages


def build_ticket_create_page(builder: A2UIBuilder) -> tuple[str, list[str]]:
    """Build the ticket create page."""
    # Back button
    builder.text("create-back-text", "← 返回列表")
    builder.button(
        "create-back-btn",
        "create-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    builder.text("create-title", "新建票据", usage_hint="h1")
    builder.row("create-header", ["create-back-btn", "create-title"], alignment="center")

    # Form
    builder.text("create-title-label", "标题 *", usage_hint="h4")
    builder.text_field("create-title-input", "请输入票据标题", builder.path("/app/form/create/title"))

    builder.text("create-desc-label", "描述", usage_hint="h4")
    builder.text_field("create-desc-input", "请输入详细描述...", builder.path("/app/form/create/description"), text_field_type="multiline")

    builder.text("create-priority-label", "优先级", usage_hint="h4")
    # Priority selection buttons
    builder.text("create-priority-low-text", "低")
    builder.button("create-priority-low", "create-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("create-priority-medium-text", "中")
    builder.button("create-priority-medium", "create-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("create-priority-high-text", "高")
    builder.button("create-priority-high", "create-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("create-priority-urgent-text", "紧急")
    builder.button("create-priority-urgent", "create-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("create-priority-btns", ["create-priority-low", "create-priority-medium", "create-priority-high", "create-priority-urgent"], alignment="center")

    builder.column("create-form-fields", [
        "create-title-label", "create-title-input",
        "create-desc-label", "create-desc-input",
        "create-priority-label", "create-priority-btns",
    ])

    # Actions
    builder.divider("create-divider")
    builder.text("create-cancel-text", "取消")
    builder.button(
        "create-cancel-btn",
        "create-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )
    builder.text("create-submit-text", "创建票据")
    builder.button(
        "create-submit-btn",
        "create-submit-text",
        "create_ticket",
        [{"key": "form", "value": {"path": "/app/form/create"}}],
    )
    builder.row("create-actions", ["create-cancel-btn", "create-submit-btn"], distribution="end", alignment="center")

    builder.column("create-form", ["create-form-fields", "create-divider", "create-actions"])
    builder.card("create-form-card", "create-form")
    builder.column("create-page", ["create-header", "create-form-card"])

    return "create-page", []


def build_ticket_create_data() -> list[str]:
    """Build data model updates for ticket create page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ""),
        value_string("description", ""),
        value_string("priority", "medium"),
    ]
    messages.append(builder.build_data_model_update("/app/form/create", form_data))

    return messages


def build_ticket_edit_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket edit page."""
    ticket_id = ticket["id"]

    # Back button
    builder.text("edit-back-text", "← 返回详情")
    builder.button(
        "edit-back-btn",
        "edit-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )

    builder.text("edit-title", "编辑票据", usage_hint="h1")
    builder.row("edit-header", ["edit-back-btn", "edit-title"], alignment="center")

    # Form
    builder.text("edit-title-label", "标题 *", usage_hint="h4")
    builder.text_field("edit-title-input", "请输入票据标题", builder.path("/app/form/edit/title"))

    builder.text("edit-desc-label", "描述", usage_hint="h4")
    builder.text_field("edit-desc-input", "请输入详细描述...", builder.path("/app/form/edit/description"), text_field_type="multiline")

    builder.text("edit-priority-label", "优先级", usage_hint="h4")
    builder.text("edit-priority-low-text", "低")
    builder.button("edit-priority-low", "edit-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("edit-priority-medium-text", "中")
    builder.button("edit-priority-medium", "edit-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("edit-priority-high-text", "高")
    builder.button("edit-priority-high", "edit-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("edit-priority-urgent-text", "紧急")
    builder.button("edit-priority-urgent", "edit-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("edit-priority-btns", ["edit-priority-low", "edit-priority-medium", "edit-priority-high", "edit-priority-urgent"], alignment="center")

    builder.column("edit-form-fields", [
        "edit-title-label", "edit-title-input",
        "edit-desc-label", "edit-desc-input",
        "edit-priority-label", "edit-priority-btns",
    ])

    # Actions
    builder.divider("edit-divider")
    builder.text("edit-cancel-text", "取消")
    builder.button(
        "edit-cancel-btn",
        "edit-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )
    builder.text("edit-submit-text", "保存更改")
    builder.button(
        "edit-submit-btn",
        "edit-submit-text",
        "update_ticket",
        [
            {"key": "id", "value": {"literalString": ticket_id}},
            {"key": "form", "value": {"path": "/app/form/edit"}},
        ],
    )
    builder.row("edit-actions", ["edit-cancel-btn", "edit-submit-btn"], distribution="end", alignment="center")

    builder.column("edit-form", ["edit-form-fields", "edit-divider", "edit-actions"])
    builder.card("edit-form-card", "edit-form")
    builder.column("edit-page", ["edit-header", "edit-form-card"])

    return "edit-page", []


def build_ticket_edit_data(ticket: dict) -> list[str]:
    """Build data model updates for ticket edit page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ticket["title"]),
        value_string("description", ticket.get("description") or ""),
        value_string("priority", ticket["priority"]),
    ]
    messages.append(builder.build_data_model_update("/app/form/edit", form_data))

    return messages

```


修改按钮的 action context，使其从数据模型读取当前查询状态：


```python
"""Ticket page builders."""
from typing import Any, Optional
from a2ui_builder import A2UIBuilder, value_string, value_number, value_map, build_value_map_from_dict
from models import (
    STATUS_LABELS, PRIORITY_LABELS, STATUS_TRANSITIONS,
    TicketStatus, Priority
)


def build_tickets_page(builder: A2UIBuilder) -> tuple[str, list[str]]:
    """Build the tickets list page."""
    # Page header
    builder.text("tickets-title", "票据列表", usage_hint="h1")
    builder.text("tickets-add-text", "+ 新建票据")
    builder.button(
        "tickets-add-btn",
        "tickets-add-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets/new"}}],
    )
    builder.row("tickets-header", ["tickets-title", "tickets-add-btn"], distribution="spaceBetween", alignment="center")

    # Search
    builder.text_field("tickets-search", "搜索票据...", builder.path("/app/tickets/query/search"))
    builder.text("tickets-search-btn-text", "搜索")
    builder.button(
        "tickets-search-btn",
        "tickets-search-btn-text",
        "search_tickets",
        [
            {"key": "search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-search-row", ["tickets-search", "tickets-search-btn"], alignment="center")

    # Status filter buttons
    builder.text("filter-all-text", "全部")
    builder.button("filter-all", "filter-all-text", "filter_status", [
        {"key": "status", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-open-text", "待处理")
    builder.button("filter-open", "filter-open-text", "filter_status", [
        {"key": "status", "value": {"literalString": "open"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-progress-text", "处理中")
    builder.button("filter-progress", "filter-progress-text", "filter_status", [
        {"key": "status", "value": {"literalString": "in_progress"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-completed-text", "已完成")
    builder.button("filter-completed", "filter-completed-text", "filter_status", [
        {"key": "status", "value": {"literalString": "completed"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-cancelled-text", "已取消")
    builder.button("filter-cancelled", "filter-cancelled-text", "filter_status", [
        {"key": "status", "value": {"literalString": "cancelled"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-status-filters", ["filter-all", "filter-open", "filter-progress", "filter-completed", "filter-cancelled"], alignment="center")

    # Priority filter buttons
    builder.text("priority-all-text", "全部优先级")
    builder.button("priority-all", "priority-all-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-low-text", "低")
    builder.button("priority-low", "priority-low-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "low"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-medium-text", "中")
    builder.button("priority-medium", "priority-medium-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "medium"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-high-text", "高")
    builder.button("priority-high", "priority-high-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "high"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-urgent-text", "紧急")
    builder.button("priority-urgent", "priority-urgent-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "urgent"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-priority-filters", ["priority-all", "priority-low", "priority-medium", "priority-high", "priority-urgent"], alignment="center")

    builder.column("tickets-filters", ["tickets-search-row", "tickets-status-filters", "tickets-priority-filters"])
    builder.card("tickets-filters-card", "tickets-filters")

    # Ticket list template - simplified without icons
    builder.text("ticket-item-title", builder.path("title"), usage_hint="h3")
    builder.text("ticket-item-status", builder.path("statusLabel"))
    builder.text("ticket-item-priority", builder.path("priorityLabel"))
    builder.text("ticket-item-date", builder.path("created_at"))
    builder.row("ticket-item-meta", ["ticket-item-status", "ticket-item-priority", "ticket-item-date"], alignment="center")
    builder.column("ticket-item-content", ["ticket-item-title", "ticket-item-meta"])
    builder.text("ticket-item-arrow", "→")
    builder.row("ticket-item-row", ["ticket-item-content", "ticket-item-arrow"], distribution="spaceBetween", alignment="center")
    builder.button(
        "ticket-item-btn",
        "ticket-item-row",
        "view_ticket",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.card("ticket-item-card", "ticket-item-btn")

    # Ticket list
    builder.list_component(
        "tickets-list",
        template={"componentId": "ticket-item-card", "dataBinding": "/app/tickets/list"},
        direction="vertical",
    )

    # Empty state
    builder.text("tickets-empty-title", "暂无票据", usage_hint="h3")
    builder.text("tickets-empty-desc", "点击上方按钮创建第一个票据")
    builder.column("tickets-empty", ["tickets-empty-title", "tickets-empty-desc"], alignment="center")

    # Pagination - use literalNumber for page values since they're numbers
    builder.text("pagination-prev-text", "← 上一页")
    builder.button(
        "pagination-prev",
        "pagination-prev-text",
        "paginate",
        [{"key": "page", "value": {"path": "/app/tickets/pagination/prevPage"}}],
    )
    builder.text("pagination-info", builder.path("/app/tickets/pagination/info"))
    builder.text("pagination-next-text", "下一页 →")
    builder.button(
        "pagination-next",
        "pagination-next-text",
        "paginate",
        [{"key": "page", "value": {"path": "/app/tickets/pagination/nextPage"}}],
    )
    builder.row("tickets-pagination", ["pagination-prev", "pagination-info", "pagination-next"], distribution="center", alignment="center")

    # Main content
    builder.column("tickets-content", ["tickets-list", "tickets-pagination"])
    builder.column("tickets-page", ["tickets-header", "tickets-filters-card", "tickets-content"])

    return "tickets-page", []


def build_tickets_data(tickets_response: dict, search: str = "", status: str = "", priority: str = "", page: int = 1) -> list[str]:
    """Build data model updates for tickets page."""
    messages = []
    builder = A2UIBuilder()

    # Query state - use actual values from URL params
    query_data = [
        value_string("search", search),
        value_string("status", status),
        value_string("priority", priority),
        value_number("page", page),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/query", query_data))

    # Tickets list
    tickets = tickets_response.get("data", [])
    list_data = []
    for i, ticket in enumerate(tickets):
        ticket_map = build_value_map_from_dict({
            "id": ticket["id"],
            "title": ticket["title"],
            "status": ticket["status"],
            "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
            "priority": ticket["priority"],
            "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
            "created_at": ticket["created_at"][:10],  # Date only
        })
        list_data.append(value_map(f"ticket{i}", ticket_map))
    messages.append(builder.build_data_model_update("/app/tickets/list", list_data))

    # Pagination
    page = tickets_response.get("page", 1)
    total_pages = tickets_response.get("total_pages", 1)
    pagination_data = [
        value_number("page", page),
        value_number("totalPages", total_pages),
        value_number("prevPage", max(1, page - 1)),
        value_number("nextPage", min(total_pages, page + 1)),
        value_string("info", f"第 {page} 页 / 共 {total_pages} 页"),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/pagination", pagination_data))

    return messages


def build_ticket_detail_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket detail page."""
    ticket_id = ticket["id"]
    status = ticket["status"]

    # Back button
    builder.text("detail-back-text", "← 返回列表")
    builder.button(
        "detail-back-btn",
        "detail-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    # Title
    builder.text("detail-title", builder.path("/app/ticket/detail/title"), usage_hint="h1")

    # Actions
    builder.text("detail-edit-text", "编辑")
    builder.button(
        "detail-edit-btn",
        "detail-edit-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}/edit"}}],
    )

    builder.text("detail-delete-text", "删除")
    builder.button(
        "detail-delete-btn",
        "detail-delete-text",
        "show_delete_dialog",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )

    builder.row("detail-actions", ["detail-edit-btn", "detail-delete-btn"], alignment="center")
    builder.row("detail-header", ["detail-back-btn", "detail-title", "detail-actions"], distribution="spaceBetween", alignment="center")

    # Description card
    builder.text("detail-desc-label", "描述", usage_hint="h4")
    builder.text("detail-desc-content", builder.path("/app/ticket/detail/description"))
    builder.column("detail-desc-col", ["detail-desc-label", "detail-desc-content"])
    builder.card("detail-desc-card", "detail-desc-col")

    # Resolution card (if exists)
    builder.text("detail-resolution-label", "处理结果", usage_hint="h4")
    builder.text("detail-resolution-content", builder.path("/app/ticket/detail/resolution"))
    builder.column("detail-resolution-col", ["detail-resolution-label", "detail-resolution-content"])
    builder.card("detail-resolution-card", "detail-resolution-col")

    # Status card
    builder.text("detail-status-label", "状态", usage_hint="h4")
    builder.text("detail-status-value", builder.path("/app/ticket/detail/statusLabel"))

    # Status transition buttons
    allowed_transitions = STATUS_TRANSITIONS.get(TicketStatus(status), [])
    status_btns = []
    for target_status in allowed_transitions:
        btn_id = f"status-btn-{target_status.value}"
        text_id = f"status-btn-text-{target_status.value}"
        builder.text(text_id, f"→ {STATUS_LABELS[target_status]}")
        builder.button(
            btn_id,
            text_id,
            "change_status",
            [
                {"key": "id", "value": {"literalString": ticket_id}},
                {"key": "status", "value": {"literalString": target_status.value}},
            ],
        )
        status_btns.append(btn_id)

    builder.row("detail-status-btns", status_btns, alignment="center")
    builder.column("detail-status-col", ["detail-status-label", "detail-status-value", "detail-status-btns"])
    builder.card("detail-status-card", "detail-status-col")

    # Priority card
    builder.text("detail-priority-label", "优先级", usage_hint="h4")
    builder.text("detail-priority-value", builder.path("/app/ticket/detail/priorityLabel"))
    builder.column("detail-priority-col", ["detail-priority-label", "detail-priority-value"])
    builder.card("detail-priority-card", "detail-priority-col")

    # Tags card
    builder.text("detail-tags-label", "标签", usage_hint="h4")
    builder.text("detail-tag-name", builder.path("name"))
    builder.list_component(
        "detail-tags-list",
        template={"componentId": "detail-tag-name", "dataBinding": "/app/ticket/tags"},
        direction="horizontal",
    )
    builder.column("detail-tags-col", ["detail-tags-label", "detail-tags-list"])
    builder.card("detail-tags-card", "detail-tags-col")

    # Timestamps card
    builder.text("detail-time-label", "时间信息", usage_hint="h4")
    builder.text("detail-created-label", "创建时间")
    builder.text("detail-created-value", builder.path("/app/ticket/detail/created_at"))
    builder.row("detail-created-row", ["detail-created-label", "detail-created-value"], distribution="spaceBetween")
    builder.text("detail-updated-label", "更新时间")
    builder.text("detail-updated-value", builder.path("/app/ticket/detail/updated_at"))
    builder.row("detail-updated-row", ["detail-updated-label", "detail-updated-value"], distribution="spaceBetween")
    builder.column("detail-time-col", ["detail-time-label", "detail-created-row", "detail-updated-row"])
    builder.card("detail-time-card", "detail-time-col")

    # Attachments card
    builder.text("detail-attach-label", "附件", usage_hint="h4")
    builder.text("detail-attach-filename", builder.path("filename"))
    builder.text("detail-attach-size", builder.path("sizeFormatted"))
    builder.row("detail-attach-info", ["detail-attach-filename", "detail-attach-size"], distribution="spaceBetween")
    builder.text("detail-attach-download-text", "下载")
    builder.button(
        "detail-attach-download",
        "detail-attach-download-text",
        "download_attachment",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.row("detail-attach-item", ["detail-attach-info", "detail-attach-download"], distribution="spaceBetween", alignment="center")
    builder.list_component(
        "detail-attach-list",
        template={"componentId": "detail-attach-item", "dataBinding": "/app/ticket/attachments"},
        direction="vertical",
    )
    builder.text("detail-attach-empty", "暂无附件")
    builder.column("detail-attach-col", ["detail-attach-label", "detail-attach-list"])
    builder.card("detail-attach-card", "detail-attach-col")

    # History card
    builder.text("detail-history-label", "变更历史", usage_hint="h4")
    builder.text("detail-history-type", builder.path("changeTypeLabel"))
    builder.text("detail-history-time", builder.path("created_at"))
    builder.text("detail-history-old", builder.path("old_value"))
    builder.text("detail-history-arrow", "→")
    builder.text("detail-history-new", builder.path("new_value"))
    builder.row("detail-history-change", ["detail-history-old", "detail-history-arrow", "detail-history-new"], alignment="center")
    builder.column("detail-history-item", ["detail-history-type", "detail-history-time", "detail-history-change"])
    builder.list_component(
        "detail-history-list",
        template={"componentId": "detail-history-item", "dataBinding": "/app/ticket/history"},
        direction="vertical",
    )
    builder.column("detail-history-col", ["detail-history-label", "detail-history-list"])
    builder.card("detail-history-card", "detail-history-col")

    # Left column (main content)
    main_cards = ["detail-desc-card"]
    if ticket.get("resolution"):
        main_cards.append("detail-resolution-card")
    main_cards.append("detail-attach-card")
    builder.column("detail-main", main_cards)

    # Right column (sidebar)
    builder.column("detail-sidebar", [
        "detail-status-card",
        "detail-priority-card",
        "detail-tags-card",
        "detail-time-card",
        "detail-history-card",
    ])

    # Layout
    builder.row("detail-body", ["detail-main", "detail-sidebar"], distribution="start")
    builder.column("detail-page", ["detail-header", "detail-body"])

    # Delete confirmation modal
    builder.text("delete-modal-title", "确认删除", usage_hint="h3")
    builder.text("delete-modal-desc", "确定要删除这个票据吗？此操作无法撤销。")
    builder.text("delete-modal-cancel-text", "取消")
    builder.button("delete-modal-cancel", "delete-modal-cancel-text", "dismiss_dialog", [])
    builder.text("delete-modal-confirm-text", "确认删除")
    builder.button(
        "delete-modal-confirm",
        "delete-modal-confirm-text",
        "delete_ticket",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )
    builder.row("delete-modal-actions", ["delete-modal-cancel", "delete-modal-confirm"], distribution="end")
    builder.column("delete-modal-content", ["delete-modal-title", "delete-modal-desc", "delete-modal-actions"])

    return "detail-page", []


def build_ticket_detail_data(ticket: dict, attachments: list, history: list) -> list[str]:
    """Build data model updates for ticket detail page."""
    messages = []
    builder = A2UIBuilder()

    # Ticket detail
    detail_data = build_value_map_from_dict({
        "id": ticket["id"],
        "title": ticket["title"],
        "description": ticket.get("description") or "无描述",
        "status": ticket["status"],
        "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
        "priority": ticket["priority"],
        "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
        "resolution": ticket.get("resolution") or "",
        "created_at": ticket["created_at"][:19].replace("T", " "),
        "updated_at": ticket["updated_at"][:19].replace("T", " "),
    })
    messages.append(builder.build_data_model_update("/app/ticket/detail", detail_data))

    # Tags
    tags = ticket.get("tags", [])
    tags_data = []
    for i, tag in enumerate(tags):
        tags_data.append(value_map(f"tag{i}", build_value_map_from_dict({
            "id": tag["id"],
            "name": tag["name"],
            "color": tag["color"],
        })))
    messages.append(builder.build_data_model_update("/app/ticket/tags", tags_data))

    # Attachments
    attach_data = []
    for i, att in enumerate(attachments):
        size_bytes = att["size_bytes"]
        if size_bytes < 1024:
            size_formatted = f"{size_bytes} B"
        elif size_bytes < 1024 * 1024:
            size_formatted = f"{size_bytes / 1024:.1f} KB"
        else:
            size_formatted = f"{size_bytes / (1024 * 1024):.1f} MB"
        attach_data.append(value_map(f"att{i}", build_value_map_from_dict({
            "id": att["id"],
            "filename": att["filename"],
            "sizeFormatted": size_formatted,
        })))
    messages.append(builder.build_data_model_update("/app/ticket/attachments", attach_data))

    # History
    change_type_labels = {
        "status": "状态变更",
        "priority": "优先级变更",
        "resolution": "处理结果",
        "tag_added": "添加标签",
        "tag_removed": "移除标签",
    }
    history_data = []
    for i, h in enumerate(history):
        history_data.append(value_map(f"h{i}", build_value_map_from_dict({
            "changeTypeLabel": change_type_labels.get(h["change_type"], h["change_type"]),
            "old_value": h.get("old_value") or "-",
            "new_value": h.get("new_value") or "-",
            "created_at": h["created_at"][:19].replace("T", " "),
        })))
    messages.append(builder.build_data_model_update("/app/ticket/history", history_data))

    return messages


def build_ticket_create_page(builder: A2UIBuilder) -> tuple[str, list[str]]:
    """Build the ticket create page."""
    # Back button
    builder.text("create-back-text", "← 返回列表")
    builder.button(
        "create-back-btn",
        "create-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    builder.text("create-title", "新建票据", usage_hint="h1")
    builder.row("create-header", ["create-back-btn", "create-title"], alignment="center")

    # Form
    builder.text("create-title-label", "标题 *", usage_hint="h4")
    builder.text_field("create-title-input", "请输入票据标题", builder.path("/app/form/create/title"))

    builder.text("create-desc-label", "描述", usage_hint="h4")
    builder.text_field("create-desc-input", "请输入详细描述...", builder.path("/app/form/create/description"), text_field_type="multiline")

    builder.text("create-priority-label", "优先级", usage_hint="h4")
    # Priority selection buttons
    builder.text("create-priority-low-text", "低")
    builder.button("create-priority-low", "create-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("create-priority-medium-text", "中")
    builder.button("create-priority-medium", "create-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("create-priority-high-text", "高")
    builder.button("create-priority-high", "create-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("create-priority-urgent-text", "紧急")
    builder.button("create-priority-urgent", "create-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("create-priority-btns", ["create-priority-low", "create-priority-medium", "create-priority-high", "create-priority-urgent"], alignment="center")

    builder.column("create-form-fields", [
        "create-title-label", "create-title-input",
        "create-desc-label", "create-desc-input",
        "create-priority-label", "create-priority-btns",
    ])

    # Actions
    builder.divider("create-divider")
    builder.text("create-cancel-text", "取消")
    builder.button(
        "create-cancel-btn",
        "create-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )
    builder.text("create-submit-text", "创建票据")
    builder.button(
        "create-submit-btn",
        "create-submit-text",
        "create_ticket",
        [{"key": "form", "value": {"path": "/app/form/create"}}],
    )
    builder.row("create-actions", ["create-cancel-btn", "create-submit-btn"], distribution="end", alignment="center")

    builder.column("create-form", ["create-form-fields", "create-divider", "create-actions"])
    builder.card("create-form-card", "create-form")
    builder.column("create-page", ["create-header", "create-form-card"])

    return "create-page", []


def build_ticket_create_data() -> list[str]:
    """Build data model updates for ticket create page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ""),
        value_string("description", ""),
        value_string("priority", "medium"),
    ]
    messages.append(builder.build_data_model_update("/app/form/create", form_data))

    return messages


def build_ticket_edit_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket edit page."""
    ticket_id = ticket["id"]

    # Back button
    builder.text("edit-back-text", "← 返回详情")
    builder.button(
        "edit-back-btn",
        "edit-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )

    builder.text("edit-title", "编辑票据", usage_hint="h1")
    builder.row("edit-header", ["edit-back-btn", "edit-title"], alignment="center")

    # Form
    builder.text("edit-title-label", "标题 *", usage_hint="h4")
    builder.text_field("edit-title-input", "请输入票据标题", builder.path("/app/form/edit/title"))

    builder.text("edit-desc-label", "描述", usage_hint="h4")
    builder.text_field("edit-desc-input", "请输入详细描述...", builder.path("/app/form/edit/description"), text_field_type="multiline")

    builder.text("edit-priority-label", "优先级", usage_hint="h4")
    builder.text("edit-priority-low-text", "低")
    builder.button("edit-priority-low", "edit-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("edit-priority-medium-text", "中")
    builder.button("edit-priority-medium", "edit-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("edit-priority-high-text", "高")
    builder.button("edit-priority-high", "edit-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("edit-priority-urgent-text", "紧急")
    builder.button("edit-priority-urgent", "edit-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("edit-priority-btns", ["edit-priority-low", "edit-priority-medium", "edit-priority-high", "edit-priority-urgent"], alignment="center")

    builder.column("edit-form-fields", [
        "edit-title-label", "edit-title-input",
        "edit-desc-label", "edit-desc-input",
        "edit-priority-label", "edit-priority-btns",
    ])

    # Actions
    builder.divider("edit-divider")
    builder.text("edit-cancel-text", "取消")
    builder.button(
        "edit-cancel-btn",
        "edit-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )
    builder.text("edit-submit-text", "保存更改")
    builder.button(
        "edit-submit-btn",
        "edit-submit-text",
        "update_ticket",
        [
            {"key": "id", "value": {"literalString": ticket_id}},
            {"key": "form", "value": {"path": "/app/form/edit"}},
        ],
    )
    builder.row("edit-actions", ["edit-cancel-btn", "edit-submit-btn"], distribution="end", alignment="center")

    builder.column("edit-form", ["edit-form-fields", "edit-divider", "edit-actions"])
    builder.card("edit-form-card", "edit-form")
    builder.column("edit-page", ["edit-header", "edit-form-card"])

    return "edit-page", []


def build_ticket_edit_data(ticket: dict) -> list[str]:
    """Build data model updates for ticket edit page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ticket["title"]),
        value_string("description", ticket.get("description") or ""),
        value_string("priority", ticket["priority"]),
    ]
    messages.append(builder.build_data_model_update("/app/form/edit", form_data))

    return messages

```


更新分页按钮，使其也传递当前查询状态：


```python
    # Pagination - use literalNumber for page values since they're numbers
    builder.text("pagination-prev-text", "← 上一页")
    builder.button(
        "pagination-prev",
        "pagination-prev-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/prevPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.text("pagination-info", builder.path("/app/tickets/pagination/info"))
    builder.text("pagination-next-text", "下一页 →")
    builder.button(
        "pagination-next",
        "pagination-next-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/nextPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
```


重新读取分页部分：


```python
"""Ticket page builders."""
from typing import Any, Optional
from a2ui_builder import A2UIBuilder, value_string, value_number, value_map, build_value_map_from_dict
from models import (
    STATUS_LABELS, PRIORITY_LABELS, STATUS_TRANSITIONS,
    TicketStatus, Priority
)


def build_tickets_page(builder: A2UIBuilder) -> tuple[str, list[str]]:
    """Build the tickets list page."""
    # Page header
    builder.text("tickets-title", "票据列表", usage_hint="h1")
    builder.text("tickets-add-text", "+ 新建票据")
    builder.button(
        "tickets-add-btn",
        "tickets-add-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets/new"}}],
    )
    builder.row("tickets-header", ["tickets-title", "tickets-add-btn"], distribution="spaceBetween", alignment="center")

    # Search
    builder.text_field("tickets-search", "搜索票据...", builder.path("/app/tickets/query/search"))
    builder.text("tickets-search-btn-text", "搜索")
    builder.button(
        "tickets-search-btn",
        "tickets-search-btn-text",
        "search_tickets",
        [
            {"key": "search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-search-row", ["tickets-search", "tickets-search-btn"], alignment="center")

    # Status filter buttons
    builder.text("filter-all-text", "全部")
    builder.button("filter-all", "filter-all-text", "filter_status", [
        {"key": "status", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-open-text", "待处理")
    builder.button("filter-open", "filter-open-text", "filter_status", [
        {"key": "status", "value": {"literalString": "open"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-progress-text", "处理中")
    builder.button("filter-progress", "filter-progress-text", "filter_status", [
        {"key": "status", "value": {"literalString": "in_progress"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-completed-text", "已完成")
    builder.button("filter-completed", "filter-completed-text", "filter_status", [
        {"key": "status", "value": {"literalString": "completed"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-cancelled-text", "已取消")
    builder.button("filter-cancelled", "filter-cancelled-text", "filter_status", [
        {"key": "status", "value": {"literalString": "cancelled"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-status-filters", ["filter-all", "filter-open", "filter-progress", "filter-completed", "filter-cancelled"], alignment="center")

    # Priority filter buttons
    builder.text("priority-all-text", "全部优先级")
    builder.button("priority-all", "priority-all-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-low-text", "低")
    builder.button("priority-low", "priority-low-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "low"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-medium-text", "中")
    builder.button("priority-medium", "priority-medium-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "medium"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-high-text", "高")
    builder.button("priority-high", "priority-high-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "high"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-urgent-text", "紧急")
    builder.button("priority-urgent", "priority-urgent-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "urgent"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-priority-filters", ["priority-all", "priority-low", "priority-medium", "priority-high", "priority-urgent"], alignment="center")

    builder.column("tickets-filters", ["tickets-search-row", "tickets-status-filters", "tickets-priority-filters"])
    builder.card("tickets-filters-card", "tickets-filters")

    # Ticket list template - simplified without icons
    builder.text("ticket-item-title", builder.path("title"), usage_hint="h3")
    builder.text("ticket-item-status", builder.path("statusLabel"))
    builder.text("ticket-item-priority", builder.path("priorityLabel"))
    builder.text("ticket-item-date", builder.path("created_at"))
    builder.row("ticket-item-meta", ["ticket-item-status", "ticket-item-priority", "ticket-item-date"], alignment="center")
    builder.column("ticket-item-content", ["ticket-item-title", "ticket-item-meta"])
    builder.text("ticket-item-arrow", "→")
    builder.row("ticket-item-row", ["ticket-item-content", "ticket-item-arrow"], distribution="spaceBetween", alignment="center")
    builder.button(
        "ticket-item-btn",
        "ticket-item-row",
        "view_ticket",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.card("ticket-item-card", "ticket-item-btn")

    # Ticket list
    builder.list_component(
        "tickets-list",
        template={"componentId": "ticket-item-card", "dataBinding": "/app/tickets/list"},
        direction="vertical",
    )

    # Empty state
    builder.text("tickets-empty-title", "暂无票据", usage_hint="h3")
    builder.text("tickets-empty-desc", "点击上方按钮创建第一个票据")
    builder.column("tickets-empty", ["tickets-empty-title", "tickets-empty-desc"], alignment="center")

    # Pagination - use literalNumber for page values since they're numbers
    builder.text("pagination-prev-text", "← 上一页")
    builder.button(
        "pagination-prev",
        "pagination-prev-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/prevPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.text("pagination-info", builder.path("/app/tickets/pagination/info"))
    builder.text("pagination-next-text", "下一页 →")
    builder.button(
        "pagination-next",
        "pagination-next-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/nextPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-pagination", ["pagination-prev", "pagination-info", "pagination-next"], distribution="center", alignment="center")

    # Main content
    builder.column("tickets-content", ["tickets-list", "tickets-pagination"])
    builder.column("tickets-page", ["tickets-header", "tickets-filters-card", "tickets-content"])

    return "tickets-page", []


def build_tickets_data(tickets_response: dict, search: str = "", status: str = "", priority: str = "", page: int = 1) -> list[str]:
    """Build data model updates for tickets page."""
    messages = []
    builder = A2UIBuilder()

    # Query state - use actual values from URL params
    query_data = [
        value_string("search", search),
        value_string("status", status),
        value_string("priority", priority),
        value_number("page", page),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/query", query_data))

    # Tickets list
    tickets = tickets_response.get("data", [])
    list_data = []
    for i, ticket in enumerate(tickets):
        ticket_map = build_value_map_from_dict({
            "id": ticket["id"],
            "title": ticket["title"],
            "status": ticket["status"],
            "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
            "priority": ticket["priority"],
            "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
            "created_at": ticket["created_at"][:10],  # Date only
        })
        list_data.append(value_map(f"ticket{i}", ticket_map))
    messages.append(builder.build_data_model_update("/app/tickets/list", list_data))

    # Pagination
    page = tickets_response.get("page", 1)
    total_pages = tickets_response.get("total_pages", 1)
    pagination_data = [
        value_number("page", page),
        value_number("totalPages", total_pages),
        value_number("prevPage", max(1, page - 1)),
        value_number("nextPage", min(total_pages, page + 1)),
        value_string("info", f"第 {page} 页 / 共 {total_pages} 页"),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/pagination", pagination_data))

    return messages


def build_ticket_detail_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket detail page."""
    ticket_id = ticket["id"]
    status = ticket["status"]

    # Back button
    builder.text("detail-back-text", "← 返回列表")
    builder.button(
        "detail-back-btn",
        "detail-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    # Title
    builder.text("detail-title", builder.path("/app/ticket/detail/title"), usage_hint="h1")

    # Actions
    builder.text("detail-edit-text", "编辑")
    builder.button(
        "detail-edit-btn",
        "detail-edit-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}/edit"}}],
    )

    builder.text("detail-delete-text", "删除")
    builder.button(
        "detail-delete-btn",
        "detail-delete-text",
        "show_delete_dialog",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )

    builder.row("detail-actions", ["detail-edit-btn", "detail-delete-btn"], alignment="center")
    builder.row("detail-header", ["detail-back-btn", "detail-title", "detail-actions"], distribution="spaceBetween", alignment="center")

    # Description card
    builder.text("detail-desc-label", "描述", usage_hint="h4")
    builder.text("detail-desc-content", builder.path("/app/ticket/detail/description"))
    builder.column("detail-desc-col", ["detail-desc-label", "detail-desc-content"])
    builder.card("detail-desc-card", "detail-desc-col")

    # Resolution card (if exists)
    builder.text("detail-resolution-label", "处理结果", usage_hint="h4")
    builder.text("detail-resolution-content", builder.path("/app/ticket/detail/resolution"))
    builder.column("detail-resolution-col", ["detail-resolution-label", "detail-resolution-content"])
    builder.card("detail-resolution-card", "detail-resolution-col")

    # Status card
    builder.text("detail-status-label", "状态", usage_hint="h4")
    builder.text("detail-status-value", builder.path("/app/ticket/detail/statusLabel"))

    # Status transition buttons
    allowed_transitions = STATUS_TRANSITIONS.get(TicketStatus(status), [])
    status_btns = []
    for target_status in allowed_transitions:
        btn_id = f"status-btn-{target_status.value}"
        text_id = f"status-btn-text-{target_status.value}"
        builder.text(text_id, f"→ {STATUS_LABELS[target_status]}")
        builder.button(
            btn_id,
            text_id,
            "change_status",
            [
                {"key": "id", "value": {"literalString": ticket_id}},
                {"key": "status", "value": {"literalString": target_status.value}},
            ],
        )
        status_btns.append(btn_id)

    builder.row("detail-status-btns", status_btns, alignment="center")
    builder.column("detail-status-col", ["detail-status-label", "detail-status-value", "detail-status-btns"])
    builder.card("detail-status-card", "detail-status-col")

    # Priority card
    builder.text("detail-priority-label", "优先级", usage_hint="h4")
    builder.text("detail-priority-value", builder.path("/app/ticket/detail/priorityLabel"))
    builder.column("detail-priority-col", ["detail-priority-label", "detail-priority-value"])
    builder.card("detail-priority-card", "detail-priority-col")

    # Tags card
    builder.text("detail-tags-label", "标签", usage_hint="h4")
    builder.text("detail-tag-name", builder.path("name"))
    builder.list_component(
        "detail-tags-list",
        template={"componentId": "detail-tag-name", "dataBinding": "/app/ticket/tags"},
        direction="horizontal",
    )
    builder.column("detail-tags-col", ["detail-tags-label", "detail-tags-list"])
    builder.card("detail-tags-card", "detail-tags-col")

    # Timestamps card
    builder.text("detail-time-label", "时间信息", usage_hint="h4")
    builder.text("detail-created-label", "创建时间")
    builder.text("detail-created-value", builder.path("/app/ticket/detail/created_at"))
    builder.row("detail-created-row", ["detail-created-label", "detail-created-value"], distribution="spaceBetween")
    builder.text("detail-updated-label", "更新时间")
    builder.text("detail-updated-value", builder.path("/app/ticket/detail/updated_at"))
    builder.row("detail-updated-row", ["detail-updated-label", "detail-updated-value"], distribution="spaceBetween")
    builder.column("detail-time-col", ["detail-time-label", "detail-created-row", "detail-updated-row"])
    builder.card("detail-time-card", "detail-time-col")

    # Attachments card
    builder.text("detail-attach-label", "附件", usage_hint="h4")
    builder.text("detail-attach-filename", builder.path("filename"))
    builder.text("detail-attach-size", builder.path("sizeFormatted"))
    builder.row("detail-attach-info", ["detail-attach-filename", "detail-attach-size"], distribution="spaceBetween")
    builder.text("detail-attach-download-text", "下载")
    builder.button(
        "detail-attach-download",
        "detail-attach-download-text",
        "download_attachment",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.row("detail-attach-item", ["detail-attach-info", "detail-attach-download"], distribution="spaceBetween", alignment="center")
    builder.list_component(
        "detail-attach-list",
        template={"componentId": "detail-attach-item", "dataBinding": "/app/ticket/attachments"},
        direction="vertical",
    )
    builder.text("detail-attach-empty", "暂无附件")
    builder.column("detail-attach-col", ["detail-attach-label", "detail-attach-list"])
    builder.card("detail-attach-card", "detail-attach-col")

    # History card
    builder.text("detail-history-label", "变更历史", usage_hint="h4")
    builder.text("detail-history-type", builder.path("changeTypeLabel"))
    builder.text("detail-history-time", builder.path("created_at"))
    builder.text("detail-history-old", builder.path("old_value"))
    builder.text("detail-history-arrow", "→")
    builder.text("detail-history-new", builder.path("new_value"))
    builder.row("detail-history-change", ["detail-history-old", "detail-history-arrow", "detail-history-new"], alignment="center")
    builder.column("detail-history-item", ["detail-history-type", "detail-history-time", "detail-history-change"])
    builder.list_component(
        "detail-history-list",
        template={"componentId": "detail-history-item", "dataBinding": "/app/ticket/history"},
        direction="vertical",
    )
    builder.column("detail-history-col", ["detail-history-label", "detail-history-list"])
    builder.card("detail-history-card", "detail-history-col")

    # Left column (main content)
    main_cards = ["detail-desc-card"]
    if ticket.get("resolution"):
        main_cards.append("detail-resolution-card")
    main_cards.append("detail-attach-card")
    builder.column("detail-main", main_cards)

    # Right column (sidebar)
    builder.column("detail-sidebar", [
        "detail-status-card",
        "detail-priority-card",
        "detail-tags-card",
        "detail-time-card",
        "detail-history-card",
    ])

    # Layout
    builder.row("detail-body", ["detail-main", "detail-sidebar"], distribution="start")
    builder.column("detail-page", ["detail-header", "detail-body"])

    # Delete confirmation modal
    builder.text("delete-modal-title", "确认删除", usage_hint="h3")
    builder.text("delete-modal-desc", "确定要删除这个票据吗？此操作无法撤销。")
    builder.text("delete-modal-cancel-text", "取消")
    builder.button("delete-modal-cancel", "delete-modal-cancel-text", "dismiss_dialog", [])
    builder.text("delete-modal-confirm-text", "确认删除")
    builder.button(
        "delete-modal-confirm",
        "delete-modal-confirm-text",
        "delete_ticket",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )
    builder.row("delete-modal-actions", ["delete-modal-cancel", "delete-modal-confirm"], distribution="end")
    builder.column("delete-modal-content", ["delete-modal-title", "delete-modal-desc", "delete-modal-actions"])

    return "detail-page", []


def build_ticket_detail_data(ticket: dict, attachments: list, history: list) -> list[str]:
    """Build data model updates for ticket detail page."""
    messages = []
    builder = A2UIBuilder()

    # Ticket detail
    detail_data = build_value_map_from_dict({
        "id": ticket["id"],
        "title": ticket["title"],
        "description": ticket.get("description") or "无描述",
        "status": ticket["status"],
        "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
        "priority": ticket["priority"],
        "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
        "resolution": ticket.get("resolution") or "",
        "created_at": ticket["created_at"][:19].replace("T", " "),
        "updated_at": ticket["updated_at"][:19].replace("T", " "),
    })
    messages.append(builder.build_data_model_update("/app/ticket/detail", detail_data))

    # Tags
    tags = ticket.get("tags", [])
    tags_data = []
    for i, tag in enumerate(tags):
        tags_data.append(value_map(f"tag{i}", build_value_map_from_dict({
            "id": tag["id"],
            "name": tag["name"],
            "color": tag["color"],
        })))
    messages.append(builder.build_data_model_update("/app/ticket/tags", tags_data))

    # Attachments
    attach_data = []
    for i, att in enumerate(attachments):
        size_bytes = att["size_bytes"]
        if size_bytes < 1024:
            size_formatted = f"{size_bytes} B"
        elif size_bytes < 1024 * 1024:
            size_formatted = f"{size_bytes / 1024:.1f} KB"
        else:
            size_formatted = f"{size_bytes / (1024 * 1024):.1f} MB"
        attach_data.append(value_map(f"att{i}", build_value_map_from_dict({
            "id": att["id"],
            "filename": att["filename"],
            "sizeFormatted": size_formatted,
        })))
    messages.append(builder.build_data_model_update("/app/ticket/attachments", attach_data))

    # History
    change_type_labels = {
        "status": "状态变更",
        "priority": "优先级变更",
        "resolution": "处理结果",
        "tag_added": "添加标签",
        "tag_removed": "移除标签",
    }
    history_data = []
    for i, h in enumerate(history):
        history_data.append(value_map(f"h{i}", build_value_map_from_dict({
            "changeTypeLabel": change_type_labels.get(h["change_type"], h["change_type"]),
            "old_value": h.get("old_value") or "-",
            "new_value": h.get("new_value") or "-",
            "created_at": h["created_at"][:19].replace("T", " "),
        })))
    messages.append(builder.build_data_model_update("/app/ticket/history", history_data))

    return messages


def build_ticket_create_page(builder: A2UIBuilder) -> tuple[str, list[str]]:
    """Build the ticket create page."""
    # Back button
    builder.text("create-back-text", "← 返回列表")
    builder.button(
        "create-back-btn",
        "create-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    builder.text("create-title", "新建票据", usage_hint="h1")
    builder.row("create-header", ["create-back-btn", "create-title"], alignment="center")

    # Form
    builder.text("create-title-label", "标题 *", usage_hint="h4")
    builder.text_field("create-title-input", "请输入票据标题", builder.path("/app/form/create/title"))

    builder.text("create-desc-label", "描述", usage_hint="h4")
    builder.text_field("create-desc-input", "请输入详细描述...", builder.path("/app/form/create/description"), text_field_type="multiline")

    builder.text("create-priority-label", "优先级", usage_hint="h4")
    # Priority selection buttons
    builder.text("create-priority-low-text", "低")
    builder.button("create-priority-low", "create-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("create-priority-medium-text", "中")
    builder.button("create-priority-medium", "create-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("create-priority-high-text", "高")
    builder.button("create-priority-high", "create-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("create-priority-urgent-text", "紧急")
    builder.button("create-priority-urgent", "create-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("create-priority-btns", ["create-priority-low", "create-priority-medium", "create-priority-high", "create-priority-urgent"], alignment="center")

    builder.column("create-form-fields", [
        "create-title-label", "create-title-input",
        "create-desc-label", "create-desc-input",
        "create-priority-label", "create-priority-btns",
    ])

    # Actions
    builder.divider("create-divider")
    builder.text("create-cancel-text", "取消")
    builder.button(
        "create-cancel-btn",
        "create-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )
    builder.text("create-submit-text", "创建票据")
    builder.button(
        "create-submit-btn",
        "create-submit-text",
        "create_ticket",
        [{"key": "form", "value": {"path": "/app/form/create"}}],
    )
    builder.row("create-actions", ["create-cancel-btn", "create-submit-btn"], distribution="end", alignment="center")

    builder.column("create-form", ["create-form-fields", "create-divider", "create-actions"])
    builder.card("create-form-card", "create-form")
    builder.column("create-page", ["create-header", "create-form-card"])

    return "create-page", []


def build_ticket_create_data() -> list[str]:
    """Build data model updates for ticket create page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ""),
        value_string("description", ""),
        value_string("priority", "medium"),
    ]
    messages.append(builder.build_data_model_update("/app/form/create", form_data))

    return messages


def build_ticket_edit_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket edit page."""
    ticket_id = ticket["id"]

    # Back button
    builder.text("edit-back-text", "← 返回详情")
    builder.button(
        "edit-back-btn",
        "edit-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )

    builder.text("edit-title", "编辑票据", usage_hint="h1")
    builder.row("edit-header", ["edit-back-btn", "edit-title"], alignment="center")

    # Form
    builder.text("edit-title-label", "标题 *", usage_hint="h4")
    builder.text_field("edit-title-input", "请输入票据标题", builder.path("/app/form/edit/title"))

    builder.text("edit-desc-label", "描述", usage_hint="h4")
    builder.text_field("edit-desc-input", "请输入详细描述...", builder.path("/app/form/edit/description"), text_field_type="multiline")

    builder.text("edit-priority-label", "优先级", usage_hint="h4")
    builder.text("edit-priority-low-text", "低")
    builder.button("edit-priority-low", "edit-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("edit-priority-medium-text", "中")
    builder.button("edit-priority-medium", "edit-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("edit-priority-high-text", "高")
    builder.button("edit-priority-high", "edit-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("edit-priority-urgent-text", "紧急")
    builder.button("edit-priority-urgent", "edit-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("edit-priority-btns", ["edit-priority-low", "edit-priority-medium", "edit-priority-high", "edit-priority-urgent"], alignment="center")

    builder.column("edit-form-fields", [
        "edit-title-label", "edit-title-input",
        "edit-desc-label", "edit-desc-input",
        "edit-priority-label", "edit-priority-btns",
    ])

    # Actions
    builder.divider("edit-divider")
    builder.text("edit-cancel-text", "取消")
    builder.button(
        "edit-cancel-btn",
        "edit-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )
    builder.text("edit-submit-text", "保存更改")
    builder.button(
        "edit-submit-btn",
        "edit-submit-text",
        "update_ticket",
        [
            {"key": "id", "value": {"literalString": ticket_id}},
            {"key": "form", "value": {"path": "/app/form/edit"}},
        ],
    )
    builder.row("edit-actions", ["edit-cancel-btn", "edit-submit-btn"], distribution="end", alignment="center")

    builder.column("edit-form", ["edit-form-fields", "edit-divider", "edit-actions"])
    builder.card("edit-form-card", "edit-form")
    builder.column("edit-page", ["edit-header", "edit-form-card"])

    return "edit-page", []


def build_ticket_edit_data(ticket: dict) -> list[str]:
    """Build data model updates for ticket edit page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ticket["title"]),
        value_string("description", ticket.get("description") or ""),
        value_string("priority", ticket["priority"]),
    ]
    messages.append(builder.build_data_model_update("/app/form/edit", form_data))

    return messages

```


检查并修复 `process_action` 中的空值处理：


```python
"""A2UI Agent Server - Main entry point."""
import asyncio
import json
import logging
from datetime import datetime
from typing import AsyncGenerator, Optional
from urllib.parse import urlparse, parse_qs

from fastapi import FastAPI, Request, Query, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import StreamingResponse, FileResponse
from fastapi.staticfiles import StaticFiles
from sse_starlette.sse import EventSourceResponse

from config import settings
from models import UserAction
from api_client import api_client
from a2ui_builder import A2UIBuilder
from pages.layout import build_app_layout
from pages.tickets import (
    build_tickets_page, build_tickets_data,
    build_ticket_detail_page, build_ticket_detail_data,
    build_ticket_create_page, build_ticket_create_data,
    build_ticket_edit_page, build_ticket_edit_data,
)
from pages.tags import build_tags_page, build_tags_data
from pages.error import build_not_found_page, build_error_page

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(title="A2UI Agent Server", version="1.0.0")

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


def safe_int(value, default: int = 1) -> int:
    """Safely convert value to int with default fallback."""
    if value is None:
        return default
    try:
        return int(value)
    except (ValueError, TypeError):
        return default


async def generate_page_messages(path: str, query_params: dict) -> AsyncGenerator[str, None]:
    """Generate A2UI messages for a given page path."""
    builder = A2UIBuilder("main")

    try:
        # Route to appropriate page builder
        if path == "/" or path == "/tickets":
            # Tickets list page
            search = query_params.get("search", "")
            status = query_params.get("status", "")
            priority = query_params.get("priority", "")
            page = safe_int(query_params.get("page"), 1)
            
            tickets_data = await api_client.list_tickets(
                search=search if search else None,
                status=status if status else None,
                priority=priority if priority else None,
                page=page,
            )
            page_id, _ = build_tickets_page(builder)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_tickets_data(tickets_data, search, status, priority, page):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tickets/new":
            # Ticket create page
            page_id, _ = build_ticket_create_page(builder)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_create_data():
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/") and path.endswith("/edit"):
            # Ticket edit page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            page_id, _ = build_ticket_edit_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_edit_data(ticket):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/"):
            # Ticket detail page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            attachments = await api_client.get_ticket_attachments(ticket_id)
            history_response = await api_client.get_ticket_history(ticket_id)
            history = history_response.get("data", [])

            page_id, _ = build_ticket_detail_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_detail_data(ticket, attachments, history):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tags":
            # Tags page
            tags = await api_client.list_tags()
            page_id, _ = build_tags_page(builder)
            build_app_layout(builder, page_id, "tags")

            yield builder.build_surface_update()
            for msg in build_tags_data(tags):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        else:
            # 404 page
            page_id, _ = build_not_found_page(builder)
            build_app_layout(builder, page_id, "")

            yield builder.build_surface_update()
            yield builder.build_begin_rendering("app-layout")

    except Exception as e:
        logger.exception(f"Error generating page: {e}")
        builder.reset()
        page_id, _ = build_error_page(builder, str(e))
        build_app_layout(builder, page_id, "")

        yield builder.build_surface_update()
        yield builder.build_begin_rendering("app-layout")


@app.get("/api/a2ui/stream")
async def stream_ui(
    request: Request,
    path: str = Query("/", description="Page path to render"),
):
    """SSE endpoint for A2UI messages."""
    # Parse query params from the path parameter itself (e.g., /tickets?page=2)
    parsed = urlparse(path)
    actual_path = parsed.path
    path_query_params = parse_qs(parsed.query)

    # Also get query params from the request URL (excluding 'path')
    request_params = dict(request.query_params)
    request_params.pop("path", None)

    # Merge query params (path params take precedence)
    query_params = request_params.copy()
    for key, values in path_query_params.items():
        if values:
            query_params[key] = values[0]  # Take first value

    # Use actual_path for routing
    path = actual_path

    async def event_generator():
        async for message in generate_page_messages(path, query_params):
            if await request.is_disconnected():
                break
            yield {"event": "message", "data": message}

    return EventSourceResponse(event_generator())


@app.post("/api/a2ui/action")
async def handle_action(action: UserAction):
    """Handle userAction from client."""
    logger.info(f"Received action: {action.name} with context: {action.context}")

    try:
        result = await process_action(action)
        return {"success": True, "result": result}
    except Exception as e:
        logger.exception(f"Error processing action: {e}")
        raise HTTPException(status_code=500, detail=str(e))


async def process_action(action: UserAction) -> dict:
    """Process a userAction and return the result."""
    name = action.name
    context = action.context
    logger.info(f"Processing action '{name}' with context: {context}")

    if name == "navigate":
        # Navigation is handled client-side by reconnecting to SSE
        return {"navigate": context.get("to", "/tickets")}

    elif name in ["search_tickets", "filter_status", "filter_priority", "paginate"]:
        # Get current query params from context (passed from client)
        # Client should pass current query state
        # Handle None values from data model
        current_search = context.get("current_search") or ""
        current_status = context.get("current_status") or ""
        current_priority = context.get("current_priority") or ""
        current_page = safe_int(context.get("current_page"), 1)

        # Update based on action
        if name == "search_tickets":
            search_term = context.get('search') or ''
            new_search = search_term
            new_status = current_status
            new_priority = current_priority
            new_page = 1  # Reset to page 1 on new search
        elif name == "filter_status":
            status = context.get("status")
            if status is None:
                status = ""
            new_search = current_search
            new_status = status
            new_priority = current_priority
            new_page = 1  # Reset to page 1 on filter change
        elif name == "filter_priority":
            priority = context.get("priority")
            if priority is None:
                priority = ""
            new_search = current_search
            new_status = current_status
            new_priority = priority
            new_page = 1  # Reset to page 1 on filter change
        elif name == "paginate":
            page = safe_int(context.get("page"), 1)
            new_search = current_search
            new_status = current_status
            new_priority = current_priority
            new_page = page

        # Build query string
        query_parts = []
        if new_search:
            query_parts.append(f"search={new_search}")
        if new_status:
            query_parts.append(f"status={new_status}")
        if new_priority:
            query_parts.append(f"priority={new_priority}")
        if new_page > 1:
            query_parts.append(f"page={new_page}")

        query_string = "?" + "&".join(query_parts) if query_parts else ""
        return {"navigate": f"/tickets{query_string}"}

    elif name == "view_ticket":
        ticket_id = context.get("id")
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_ticket":
        form = context.get("form", {})
        ticket = await api_client.create_ticket({
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority", "medium"),
        })
        return {"navigate": f"/tickets/{ticket['id']}"}

    elif name == "update_ticket":
        ticket_id = context.get("id")
        form = context.get("form", {})
        await api_client.update_ticket(ticket_id, {
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority"),
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "delete_ticket":
        ticket_id = context.get("id")
        await api_client.delete_ticket(ticket_id)
        return {"navigate": "/tickets"}

    elif name == "change_status":
        ticket_id = context.get("id")
        status = context.get("status")
        resolution = context.get("resolution")
        await api_client.update_ticket_status(ticket_id, {
            "status": status,
            "resolution": resolution,
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_tag":
        form = context.get("form", {})
        await api_client.create_tag({
            "name": form.get("name"),
            "color": form.get("color", "#3B82F6"),
        })
        return {"navigate": "/tags"}

    elif name == "delete_tag":
        tag_id = context.get("id")
        await api_client.delete_tag(tag_id)
        return {"navigate": "/tags"}

    elif name in ["show_create_tag_form", "hide_create_tag_form", "set_tag_color", "set_form_priority"]:
        # These are handled client-side via data model updates
        return {"handled": True}

    elif name in ["show_delete_dialog", "dismiss_dialog"]:
        # Dialog handling is client-side
        return {"handled": True}

    elif name == "retry":
        # Retry by refreshing current page
        return {"refresh": True}

    else:
        logger.warning(f"Unknown action: {name}")
        return {"unknown": True}


@app.get("/health")
async def health():
    """Health check endpoint."""
    return {"status": "healthy"}


# Serve static files for the client
try:
    app.mount("/", StaticFiles(directory="../client/dist", html=True), name="static")
except RuntimeError:
    # Client not built yet
    @app.get("/")
    async def root():
        return {"message": "A2UI Agent Server is running. Build the client to serve the UI."}


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host=settings.host, port=settings.port)

```


检查分页信息是否正确计算：



修复可能的变量未赋值问题：


```python
"""A2UI Agent Server - Main entry point."""
import asyncio
import json
import logging
from datetime import datetime
from typing import AsyncGenerator, Optional
from urllib.parse import urlparse, parse_qs

from fastapi import FastAPI, Request, Query, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import StreamingResponse, FileResponse
from fastapi.staticfiles import StaticFiles
from sse_starlette.sse import EventSourceResponse

from config import settings
from models import UserAction
from api_client import api_client
from a2ui_builder import A2UIBuilder
from pages.layout import build_app_layout
from pages.tickets import (
    build_tickets_page, build_tickets_data,
    build_ticket_detail_page, build_ticket_detail_data,
    build_ticket_create_page, build_ticket_create_data,
    build_ticket_edit_page, build_ticket_edit_data,
)
from pages.tags import build_tags_page, build_tags_data
from pages.error import build_not_found_page, build_error_page

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(title="A2UI Agent Server", version="1.0.0")

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


def safe_int(value, default: int = 1) -> int:
    """Safely convert value to int with default fallback."""
    if value is None:
        return default
    try:
        return int(value)
    except (ValueError, TypeError):
        return default


async def generate_page_messages(path: str, query_params: dict) -> AsyncGenerator[str, None]:
    """Generate A2UI messages for a given page path."""
    builder = A2UIBuilder("main")

    try:
        # Route to appropriate page builder
        if path == "/" or path == "/tickets":
            # Tickets list page
            search = query_params.get("search", "")
            status = query_params.get("status", "")
            priority = query_params.get("priority", "")
            page = safe_int(query_params.get("page"), 1)
            
            tickets_data = await api_client.list_tickets(
                search=search if search else None,
                status=status if status else None,
                priority=priority if priority else None,
                page=page,
            )
            page_id, _ = build_tickets_page(builder)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_tickets_data(tickets_data, search, status, priority, page):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tickets/new":
            # Ticket create page
            page_id, _ = build_ticket_create_page(builder)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_create_data():
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/") and path.endswith("/edit"):
            # Ticket edit page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            page_id, _ = build_ticket_edit_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_edit_data(ticket):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/"):
            # Ticket detail page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            attachments = await api_client.get_ticket_attachments(ticket_id)
            history_response = await api_client.get_ticket_history(ticket_id)
            history = history_response.get("data", [])

            page_id, _ = build_ticket_detail_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_detail_data(ticket, attachments, history):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tags":
            # Tags page
            tags = await api_client.list_tags()
            page_id, _ = build_tags_page(builder)
            build_app_layout(builder, page_id, "tags")

            yield builder.build_surface_update()
            for msg in build_tags_data(tags):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        else:
            # 404 page
            page_id, _ = build_not_found_page(builder)
            build_app_layout(builder, page_id, "")

            yield builder.build_surface_update()
            yield builder.build_begin_rendering("app-layout")

    except Exception as e:
        logger.exception(f"Error generating page: {e}")
        builder.reset()
        page_id, _ = build_error_page(builder, str(e))
        build_app_layout(builder, page_id, "")

        yield builder.build_surface_update()
        yield builder.build_begin_rendering("app-layout")


@app.get("/api/a2ui/stream")
async def stream_ui(
    request: Request,
    path: str = Query("/", description="Page path to render"),
):
    """SSE endpoint for A2UI messages."""
    # Parse query params from the path parameter itself (e.g., /tickets?page=2)
    parsed = urlparse(path)
    actual_path = parsed.path
    path_query_params = parse_qs(parsed.query)

    # Also get query params from the request URL (excluding 'path')
    request_params = dict(request.query_params)
    request_params.pop("path", None)

    # Merge query params (path params take precedence)
    query_params = request_params.copy()
    for key, values in path_query_params.items():
        if values:
            query_params[key] = values[0]  # Take first value

    # Use actual_path for routing
    path = actual_path

    async def event_generator():
        async for message in generate_page_messages(path, query_params):
            if await request.is_disconnected():
                break
            yield {"event": "message", "data": message}

    return EventSourceResponse(event_generator())


@app.post("/api/a2ui/action")
async def handle_action(action: UserAction):
    """Handle userAction from client."""
    logger.info(f"Received action: {action.name} with context: {action.context}")

    try:
        result = await process_action(action)
        return {"success": True, "result": result}
    except Exception as e:
        logger.exception(f"Error processing action: {e}")
        raise HTTPException(status_code=500, detail=str(e))


async def process_action(action: UserAction) -> dict:
    """Process a userAction and return the result."""
    name = action.name
    context = action.context
    logger.info(f"Processing action '{name}' with context: {context}")

    if name == "navigate":
        # Navigation is handled client-side by reconnecting to SSE
        return {"navigate": context.get("to", "/tickets")}

    elif name in ["search_tickets", "filter_status", "filter_priority", "paginate"]:
        # Get current query params from context (passed from client)
        # Client should pass current query state
        # Handle None values from data model
        current_search = context.get("current_search") or ""
        current_status = context.get("current_status") or ""
        current_priority = context.get("current_priority") or ""
        current_page = safe_int(context.get("current_page"), 1)

        # Initialize new values
        new_search = current_search
        new_status = current_status
        new_priority = current_priority
        new_page = current_page

        # Update based on action
        if name == "search_tickets":
            search_term = context.get('search') or ''
            new_search = search_term
            new_page = 1  # Reset to page 1 on new search
        elif name == "filter_status":
            status = context.get("status")
            if status is None:
                status = ""
            new_status = status
            new_page = 1  # Reset to page 1 on filter change
        elif name == "filter_priority":
            priority = context.get("priority")
            if priority is None:
                priority = ""
            new_priority = priority
            new_page = 1  # Reset to page 1 on filter change
        elif name == "paginate":
            page = safe_int(context.get("page"), 1)
            new_page = page

        # Build query string
        query_parts = []
        if new_search:
            query_parts.append(f"search={new_search}")
        if new_status:
            query_parts.append(f"status={new_status}")
        if new_priority:
            query_parts.append(f"priority={new_priority}")
        if new_page > 1:
            query_parts.append(f"page={new_page}")

        query_string = "?" + "&".join(query_parts) if query_parts else ""
        return {"navigate": f"/tickets{query_string}"}

    elif name == "view_ticket":
        ticket_id = context.get("id")
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_ticket":
        form = context.get("form", {})
        ticket = await api_client.create_ticket({
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority", "medium"),
        })
        return {"navigate": f"/tickets/{ticket['id']}"}

    elif name == "update_ticket":
        ticket_id = context.get("id")
        form = context.get("form", {})
        await api_client.update_ticket(ticket_id, {
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority"),
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "delete_ticket":
        ticket_id = context.get("id")
        await api_client.delete_ticket(ticket_id)
        return {"navigate": "/tickets"}

    elif name == "change_status":
        ticket_id = context.get("id")
        status = context.get("status")
        resolution = context.get("resolution")
        await api_client.update_ticket_status(ticket_id, {
            "status": status,
            "resolution": resolution,
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_tag":
        form = context.get("form", {})
        await api_client.create_tag({
            "name": form.get("name"),
            "color": form.get("color", "#3B82F6"),
        })
        return {"navigate": "/tags"}

    elif name == "delete_tag":
        tag_id = context.get("id")
        await api_client.delete_tag(tag_id)
        return {"navigate": "/tags"}

    elif name in ["show_create_tag_form", "hide_create_tag_form", "set_tag_color", "set_form_priority"]:
        # These are handled client-side via data model updates
        return {"handled": True}

    elif name in ["show_delete_dialog", "dismiss_dialog"]:
        # Dialog handling is client-side
        return {"handled": True}

    elif name == "retry":
        # Retry by refreshing current page
        return {"refresh": True}

    else:
        logger.warning(f"Unknown action: {name}")
        return {"unknown": True}


@app.get("/health")
async def health():
    """Health check endpoint."""
    return {"status": "healthy"}


# Serve static files for the client
try:
    app.mount("/", StaticFiles(directory="../client/dist", html=True), name="static")
except RuntimeError:
    # Client not built yet
    @app.get("/")
    async def root():
        return {"message": "A2UI Agent Server is running. Build the client to serve the UI."}


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host=settings.host, port=settings.port)

```


已修复筛选和分页问题。主要修改：

1. **保留查询参数**：筛选或搜索时，会保留其他筛选条件（如已选 status，再选 priority 不会丢失 status）

2. **从 URL 参数读取状态**：`build_tickets_data` 现在从 URL 参数读取实际的查询状态，而不是硬编码为空

3. **按钮传递当前状态**：所有筛选按钮、搜索按钮和分页按钮现在都会传递当前的查询状态（search、status、priority、page）

4. **分页信息**：分页信息现在基于后端返回的实际数据

修改的关键点：

- `main.py` 中的 `process_action`：合并查询参数，确保筛选时保留其他条件
- `tickets.py` 中的 `build_tickets_data`：接收并正确设置查询参数
- 所有按钮的 action context：添加了 `current_search`、`current_status`、`current_priority`、`current_page` 参数

刷新页面后，点击筛选按钮应能正确更新查询结果，分页信息也会正确显示。

---

**User**

点击搜索或其他按钮的时候并没有按照要求查询数据并在下面的列表中显示，如果查询结果是没有相关数据的应该不显示任何的数据。同时分页也应该是第0页/共0页，而不是第1页/共0页，请咨询排查问题并修正

---

**Cursor**

检查问题：首先查看服务端日志和客户端请求处理：

问题找到了：日志显示每次请求都是 `/api/a2ui/stream?path=%2Ftickets`，没有带筛选参数。说明按钮点击的 action 没有正确处理。检查日志中是否有 action 请求，同时修复分页问题：

从日志可以看到筛选实际上是工作的（例如 `GET /api/a2ui/stream?path=%2Ftickets%3Fstatus%3Din_progress`），但问题是：
1. context 中只有 `{'status': 'in_progress'}`，缺少 `current_*` 参数（数据模型解析问题）
2. 分页显示需要修复

先修复分页显示（空数据时显示"第0页/共0页"）：

```python
"""Ticket page builders."""
from typing import Any, Optional
from a2ui_builder import A2UIBuilder, value_string, value_number, value_map, build_value_map_from_dict
from models import (
    STATUS_LABELS, PRIORITY_LABELS, STATUS_TRANSITIONS,
    TicketStatus, Priority
)


def build_tickets_page(builder: A2UIBuilder) -> tuple[str, list[str]]:
    """Build the tickets list page."""
    # Page header
    builder.text("tickets-title", "票据列表", usage_hint="h1")
    builder.text("tickets-add-text", "+ 新建票据")
    builder.button(
        "tickets-add-btn",
        "tickets-add-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets/new"}}],
    )
    builder.row("tickets-header", ["tickets-title", "tickets-add-btn"], distribution="spaceBetween", alignment="center")

    # Search
    builder.text_field("tickets-search", "搜索票据...", builder.path("/app/tickets/query/search"))
    builder.text("tickets-search-btn-text", "搜索")
    builder.button(
        "tickets-search-btn",
        "tickets-search-btn-text",
        "search_tickets",
        [
            {"key": "search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-search-row", ["tickets-search", "tickets-search-btn"], alignment="center")

    # Status filter buttons
    builder.text("filter-all-text", "全部")
    builder.button("filter-all", "filter-all-text", "filter_status", [
        {"key": "status", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-open-text", "待处理")
    builder.button("filter-open", "filter-open-text", "filter_status", [
        {"key": "status", "value": {"literalString": "open"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-progress-text", "处理中")
    builder.button("filter-progress", "filter-progress-text", "filter_status", [
        {"key": "status", "value": {"literalString": "in_progress"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-completed-text", "已完成")
    builder.button("filter-completed", "filter-completed-text", "filter_status", [
        {"key": "status", "value": {"literalString": "completed"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-cancelled-text", "已取消")
    builder.button("filter-cancelled", "filter-cancelled-text", "filter_status", [
        {"key": "status", "value": {"literalString": "cancelled"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-status-filters", ["filter-all", "filter-open", "filter-progress", "filter-completed", "filter-cancelled"], alignment="center")

    # Priority filter buttons
    builder.text("priority-all-text", "全部优先级")
    builder.button("priority-all", "priority-all-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-low-text", "低")
    builder.button("priority-low", "priority-low-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "low"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-medium-text", "中")
    builder.button("priority-medium", "priority-medium-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "medium"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-high-text", "高")
    builder.button("priority-high", "priority-high-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "high"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-urgent-text", "紧急")
    builder.button("priority-urgent", "priority-urgent-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "urgent"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-priority-filters", ["priority-all", "priority-low", "priority-medium", "priority-high", "priority-urgent"], alignment="center")

    builder.column("tickets-filters", ["tickets-search-row", "tickets-status-filters", "tickets-priority-filters"])
    builder.card("tickets-filters-card", "tickets-filters")

    # Ticket list template - simplified without icons
    builder.text("ticket-item-title", builder.path("title"), usage_hint="h3")
    builder.text("ticket-item-status", builder.path("statusLabel"))
    builder.text("ticket-item-priority", builder.path("priorityLabel"))
    builder.text("ticket-item-date", builder.path("created_at"))
    builder.row("ticket-item-meta", ["ticket-item-status", "ticket-item-priority", "ticket-item-date"], alignment="center")
    builder.column("ticket-item-content", ["ticket-item-title", "ticket-item-meta"])
    builder.text("ticket-item-arrow", "→")
    builder.row("ticket-item-row", ["ticket-item-content", "ticket-item-arrow"], distribution="spaceBetween", alignment="center")
    builder.button(
        "ticket-item-btn",
        "ticket-item-row",
        "view_ticket",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.card("ticket-item-card", "ticket-item-btn")

    # Ticket list
    builder.list_component(
        "tickets-list",
        template={"componentId": "ticket-item-card", "dataBinding": "/app/tickets/list"},
        direction="vertical",
    )

    # Empty state
    builder.text("tickets-empty-title", "暂无票据", usage_hint="h3")
    builder.text("tickets-empty-desc", "点击上方按钮创建第一个票据")
    builder.column("tickets-empty", ["tickets-empty-title", "tickets-empty-desc"], alignment="center")

    # Pagination - use literalNumber for page values since they're numbers
    builder.text("pagination-prev-text", "← 上一页")
    builder.button(
        "pagination-prev",
        "pagination-prev-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/prevPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.text("pagination-info", builder.path("/app/tickets/pagination/info"))
    builder.text("pagination-next-text", "下一页 →")
    builder.button(
        "pagination-next",
        "pagination-next-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/nextPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-pagination", ["pagination-prev", "pagination-info", "pagination-next"], distribution="center", alignment="center")

    # Main content
    builder.column("tickets-content", ["tickets-list", "tickets-pagination"])
    builder.column("tickets-page", ["tickets-header", "tickets-filters-card", "tickets-content"])

    return "tickets-page", []


def build_tickets_data(tickets_response: dict, search: str = "", status: str = "", priority: str = "", page: int = 1) -> list[str]:
    """Build data model updates for tickets page."""
    messages = []
    builder = A2UIBuilder()

    # Query state - use actual values from URL params
    query_data = [
        value_string("search", search),
        value_string("status", status),
        value_string("priority", priority),
        value_number("page", page),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/query", query_data))

    # Tickets list
    tickets = tickets_response.get("data", [])
    list_data = []
    for i, ticket in enumerate(tickets):
        ticket_map = build_value_map_from_dict({
            "id": ticket["id"],
            "title": ticket["title"],
            "status": ticket["status"],
            "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
            "priority": ticket["priority"],
            "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
            "created_at": ticket["created_at"][:10],  # Date only
        })
        list_data.append(value_map(f"ticket{i}", ticket_map))
    messages.append(builder.build_data_model_update("/app/tickets/list", list_data))

    # Pagination
    page = tickets_response.get("page", 1)
    total_pages = tickets_response.get("total_pages", 0)
    total_count = tickets_response.get("total", 0)
    
    # If no data, show "第0页/共0页"
    if total_count == 0 or total_pages == 0:
        display_page = 0
        display_total = 0
    else:
        display_page = page
        display_total = total_pages
    
    pagination_data = [
        value_number("page", display_page),
        value_number("totalPages", display_total),
        value_number("prevPage", max(1, page - 1) if total_pages > 0 else 0),
        value_number("nextPage", min(total_pages, page + 1) if total_pages > 0 else 0),
        value_string("info", f"第 {display_page} 页 / 共 {display_total} 页"),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/pagination", pagination_data))

    return messages


def build_ticket_detail_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket detail page."""
    ticket_id = ticket["id"]
    status = ticket["status"]

    # Back button
    builder.text("detail-back-text", "← 返回列表")
    builder.button(
        "detail-back-btn",
        "detail-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    # Title
    builder.text("detail-title", builder.path("/app/ticket/detail/title"), usage_hint="h1")

    # Actions
    builder.text("detail-edit-text", "编辑")
    builder.button(
        "detail-edit-btn",
        "detail-edit-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}/edit"}}],
    )

    builder.text("detail-delete-text", "删除")
    builder.button(
        "detail-delete-btn",
        "detail-delete-text",
        "show_delete_dialog",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )

    builder.row("detail-actions", ["detail-edit-btn", "detail-delete-btn"], alignment="center")
    builder.row("detail-header", ["detail-back-btn", "detail-title", "detail-actions"], distribution="spaceBetween", alignment="center")

    # Description card
    builder.text("detail-desc-label", "描述", usage_hint="h4")
    builder.text("detail-desc-content", builder.path("/app/ticket/detail/description"))
    builder.column("detail-desc-col", ["detail-desc-label", "detail-desc-content"])
    builder.card("detail-desc-card", "detail-desc-col")

    # Resolution card (if exists)
    builder.text("detail-resolution-label", "处理结果", usage_hint="h4")
    builder.text("detail-resolution-content", builder.path("/app/ticket/detail/resolution"))
    builder.column("detail-resolution-col", ["detail-resolution-label", "detail-resolution-content"])
    builder.card("detail-resolution-card", "detail-resolution-col")

    # Status card
    builder.text("detail-status-label", "状态", usage_hint="h4")
    builder.text("detail-status-value", builder.path("/app/ticket/detail/statusLabel"))

    # Status transition buttons
    allowed_transitions = STATUS_TRANSITIONS.get(TicketStatus(status), [])
    status_btns = []
    for target_status in allowed_transitions:
        btn_id = f"status-btn-{target_status.value}"
        text_id = f"status-btn-text-{target_status.value}"
        builder.text(text_id, f"→ {STATUS_LABELS[target_status]}")
        builder.button(
            btn_id,
            text_id,
            "change_status",
            [
                {"key": "id", "value": {"literalString": ticket_id}},
                {"key": "status", "value": {"literalString": target_status.value}},
            ],
        )
        status_btns.append(btn_id)

    builder.row("detail-status-btns", status_btns, alignment="center")
    builder.column("detail-status-col", ["detail-status-label", "detail-status-value", "detail-status-btns"])
    builder.card("detail-status-card", "detail-status-col")

    # Priority card
    builder.text("detail-priority-label", "优先级", usage_hint="h4")
    builder.text("detail-priority-value", builder.path("/app/ticket/detail/priorityLabel"))
    builder.column("detail-priority-col", ["detail-priority-label", "detail-priority-value"])
    builder.card("detail-priority-card", "detail-priority-col")

    # Tags card
    builder.text("detail-tags-label", "标签", usage_hint="h4")
    builder.text("detail-tag-name", builder.path("name"))
    builder.list_component(
        "detail-tags-list",
        template={"componentId": "detail-tag-name", "dataBinding": "/app/ticket/tags"},
        direction="horizontal",
    )
    builder.column("detail-tags-col", ["detail-tags-label", "detail-tags-list"])
    builder.card("detail-tags-card", "detail-tags-col")

    # Timestamps card
    builder.text("detail-time-label", "时间信息", usage_hint="h4")
    builder.text("detail-created-label", "创建时间")
    builder.text("detail-created-value", builder.path("/app/ticket/detail/created_at"))
    builder.row("detail-created-row", ["detail-created-label", "detail-created-value"], distribution="spaceBetween")
    builder.text("detail-updated-label", "更新时间")
    builder.text("detail-updated-value", builder.path("/app/ticket/detail/updated_at"))
    builder.row("detail-updated-row", ["detail-updated-label", "detail-updated-value"], distribution="spaceBetween")
    builder.column("detail-time-col", ["detail-time-label", "detail-created-row", "detail-updated-row"])
    builder.card("detail-time-card", "detail-time-col")

    # Attachments card
    builder.text("detail-attach-label", "附件", usage_hint="h4")
    builder.text("detail-attach-filename", builder.path("filename"))
    builder.text("detail-attach-size", builder.path("sizeFormatted"))
    builder.row("detail-attach-info", ["detail-attach-filename", "detail-attach-size"], distribution="spaceBetween")
    builder.text("detail-attach-download-text", "下载")
    builder.button(
        "detail-attach-download",
        "detail-attach-download-text",
        "download_attachment",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.row("detail-attach-item", ["detail-attach-info", "detail-attach-download"], distribution="spaceBetween", alignment="center")
    builder.list_component(
        "detail-attach-list",
        template={"componentId": "detail-attach-item", "dataBinding": "/app/ticket/attachments"},
        direction="vertical",
    )
    builder.text("detail-attach-empty", "暂无附件")
    builder.column("detail-attach-col", ["detail-attach-label", "detail-attach-list"])
    builder.card("detail-attach-card", "detail-attach-col")

    # History card
    builder.text("detail-history-label", "变更历史", usage_hint="h4")
    builder.text("detail-history-type", builder.path("changeTypeLabel"))
    builder.text("detail-history-time", builder.path("created_at"))
    builder.text("detail-history-old", builder.path("old_value"))
    builder.text("detail-history-arrow", "→")
    builder.text("detail-history-new", builder.path("new_value"))
    builder.row("detail-history-change", ["detail-history-old", "detail-history-arrow", "detail-history-new"], alignment="center")
    builder.column("detail-history-item", ["detail-history-type", "detail-history-time", "detail-history-change"])
    builder.list_component(
        "detail-history-list",
        template={"componentId": "detail-history-item", "dataBinding": "/app/ticket/history"},
        direction="vertical",
    )
    builder.column("detail-history-col", ["detail-history-label", "detail-history-list"])
    builder.card("detail-history-card", "detail-history-col")

    # Left column (main content)
    main_cards = ["detail-desc-card"]
    if ticket.get("resolution"):
        main_cards.append("detail-resolution-card")
    main_cards.append("detail-attach-card")
    builder.column("detail-main", main_cards)

    # Right column (sidebar)
    builder.column("detail-sidebar", [
        "detail-status-card",
        "detail-priority-card",
        "detail-tags-card",
        "detail-time-card",
        "detail-history-card",
    ])

    # Layout
    builder.row("detail-body", ["detail-main", "detail-sidebar"], distribution="start")
    builder.column("detail-page", ["detail-header", "detail-body"])

    # Delete confirmation modal
    builder.text("delete-modal-title", "确认删除", usage_hint="h3")
    builder.text("delete-modal-desc", "确定要删除这个票据吗？此操作无法撤销。")
    builder.text("delete-modal-cancel-text", "取消")
    builder.button("delete-modal-cancel", "delete-modal-cancel-text", "dismiss_dialog", [])
    builder.text("delete-modal-confirm-text", "确认删除")
    builder.button(
        "delete-modal-confirm",
        "delete-modal-confirm-text",
        "delete_ticket",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )
    builder.row("delete-modal-actions", ["delete-modal-cancel", "delete-modal-confirm"], distribution="end")
    builder.column("delete-modal-content", ["delete-modal-title", "delete-modal-desc", "delete-modal-actions"])

    return "detail-page", []


def build_ticket_detail_data(ticket: dict, attachments: list, history: list) -> list[str]:
    """Build data model updates for ticket detail page."""
    messages = []
    builder = A2UIBuilder()

    # Ticket detail
    detail_data = build_value_map_from_dict({
        "id": ticket["id"],
        "title": ticket["title"],
        "description": ticket.get("description") or "无描述",
        "status": ticket["status"],
        "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
        "priority": ticket["priority"],
        "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
        "resolution": ticket.get("resolution") or "",
        "created_at": ticket["created_at"][:19].replace("T", " "),
        "updated_at": ticket["updated_at"][:19].replace("T", " "),
    })
    messages.append(builder.build_data_model_update("/app/ticket/detail", detail_data))

    # Tags
    tags = ticket.get("tags", [])
    tags_data = []
    for i, tag in enumerate(tags):
        tags_data.append(value_map(f"tag{i}", build_value_map_from_dict({
            "id": tag["id"],
            "name": tag["name"],
            "color": tag["color"],
        })))
    messages.append(builder.build_data_model_update("/app/ticket/tags", tags_data))

    # Attachments
    attach_data = []
    for i, att in enumerate(attachments):
        size_bytes = att["size_bytes"]
        if size_bytes < 1024:
            size_formatted = f"{size_bytes} B"
        elif size_bytes < 1024 * 1024:
            size_formatted = f"{size_bytes / 1024:.1f} KB"
        else:
            size_formatted = f"{size_bytes / (1024 * 1024):.1f} MB"
        attach_data.append(value_map(f"att{i}", build_value_map_from_dict({
            "id": att["id"],
            "filename": att["filename"],
            "sizeFormatted": size_formatted,
        })))
    messages.append(builder.build_data_model_update("/app/ticket/attachments", attach_data))

    # History
    change_type_labels = {
        "status": "状态变更",
        "priority": "优先级变更",
        "resolution": "处理结果",
        "tag_added": "添加标签",
        "tag_removed": "移除标签",
    }
    history_data = []
    for i, h in enumerate(history):
        history_data.append(value_map(f"h{i}", build_value_map_from_dict({
            "changeTypeLabel": change_type_labels.get(h["change_type"], h["change_type"]),
            "old_value": h.get("old_value") or "-",
            "new_value": h.get("new_value") or "-",
            "created_at": h["created_at"][:19].replace("T", " "),
        })))
    messages.append(builder.build_data_model_update("/app/ticket/history", history_data))

    return messages


def build_ticket_create_page(builder: A2UIBuilder) -> tuple[str, list[str]]:
    """Build the ticket create page."""
    # Back button
    builder.text("create-back-text", "← 返回列表")
    builder.button(
        "create-back-btn",
        "create-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    builder.text("create-title", "新建票据", usage_hint="h1")
    builder.row("create-header", ["create-back-btn", "create-title"], alignment="center")

    # Form
    builder.text("create-title-label", "标题 *", usage_hint="h4")
    builder.text_field("create-title-input", "请输入票据标题", builder.path("/app/form/create/title"))

    builder.text("create-desc-label", "描述", usage_hint="h4")
    builder.text_field("create-desc-input", "请输入详细描述...", builder.path("/app/form/create/description"), text_field_type="multiline")

    builder.text("create-priority-label", "优先级", usage_hint="h4")
    # Priority selection buttons
    builder.text("create-priority-low-text", "低")
    builder.button("create-priority-low", "create-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("create-priority-medium-text", "中")
    builder.button("create-priority-medium", "create-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("create-priority-high-text", "高")
    builder.button("create-priority-high", "create-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("create-priority-urgent-text", "紧急")
    builder.button("create-priority-urgent", "create-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("create-priority-btns", ["create-priority-low", "create-priority-medium", "create-priority-high", "create-priority-urgent"], alignment="center")

    builder.column("create-form-fields", [
        "create-title-label", "create-title-input",
        "create-desc-label", "create-desc-input",
        "create-priority-label", "create-priority-btns",
    ])

    # Actions
    builder.divider("create-divider")
    builder.text("create-cancel-text", "取消")
    builder.button(
        "create-cancel-btn",
        "create-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )
    builder.text("create-submit-text", "创建票据")
    builder.button(
        "create-submit-btn",
        "create-submit-text",
        "create_ticket",
        [{"key": "form", "value": {"path": "/app/form/create"}}],
    )
    builder.row("create-actions", ["create-cancel-btn", "create-submit-btn"], distribution="end", alignment="center")

    builder.column("create-form", ["create-form-fields", "create-divider", "create-actions"])
    builder.card("create-form-card", "create-form")
    builder.column("create-page", ["create-header", "create-form-card"])

    return "create-page", []


def build_ticket_create_data() -> list[str]:
    """Build data model updates for ticket create page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ""),
        value_string("description", ""),
        value_string("priority", "medium"),
    ]
    messages.append(builder.build_data_model_update("/app/form/create", form_data))

    return messages


def build_ticket_edit_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket edit page."""
    ticket_id = ticket["id"]

    # Back button
    builder.text("edit-back-text", "← 返回详情")
    builder.button(
        "edit-back-btn",
        "edit-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )

    builder.text("edit-title", "编辑票据", usage_hint="h1")
    builder.row("edit-header", ["edit-back-btn", "edit-title"], alignment="center")

    # Form
    builder.text("edit-title-label", "标题 *", usage_hint="h4")
    builder.text_field("edit-title-input", "请输入票据标题", builder.path("/app/form/edit/title"))

    builder.text("edit-desc-label", "描述", usage_hint="h4")
    builder.text_field("edit-desc-input", "请输入详细描述...", builder.path("/app/form/edit/description"), text_field_type="multiline")

    builder.text("edit-priority-label", "优先级", usage_hint="h4")
    builder.text("edit-priority-low-text", "低")
    builder.button("edit-priority-low", "edit-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("edit-priority-medium-text", "中")
    builder.button("edit-priority-medium", "edit-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("edit-priority-high-text", "高")
    builder.button("edit-priority-high", "edit-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("edit-priority-urgent-text", "紧急")
    builder.button("edit-priority-urgent", "edit-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("edit-priority-btns", ["edit-priority-low", "edit-priority-medium", "edit-priority-high", "edit-priority-urgent"], alignment="center")

    builder.column("edit-form-fields", [
        "edit-title-label", "edit-title-input",
        "edit-desc-label", "edit-desc-input",
        "edit-priority-label", "edit-priority-btns",
    ])

    # Actions
    builder.divider("edit-divider")
    builder.text("edit-cancel-text", "取消")
    builder.button(
        "edit-cancel-btn",
        "edit-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )
    builder.text("edit-submit-text", "保存更改")
    builder.button(
        "edit-submit-btn",
        "edit-submit-text",
        "update_ticket",
        [
            {"key": "id", "value": {"literalString": ticket_id}},
            {"key": "form", "value": {"path": "/app/form/edit"}},
        ],
    )
    builder.row("edit-actions", ["edit-cancel-btn", "edit-submit-btn"], distribution="end", alignment="center")

    builder.column("edit-form", ["edit-form-fields", "edit-divider", "edit-actions"])
    builder.card("edit-form-card", "edit-form")
    builder.column("edit-page", ["edit-header", "edit-form-card"])

    return "edit-page", []


def build_ticket_edit_data(ticket: dict) -> list[str]:
    """Build data model updates for ticket edit page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ticket["title"]),
        value_string("description", ticket.get("description") or ""),
        value_string("priority", ticket["priority"]),
    ]
    messages.append(builder.build_data_model_update("/app/form/edit", form_data))

    return messages

```

检查客户端的数据模型解析，看看为什么 `current_*` 参数没有被正确传递：

检查 `main.ts` 中的 action 处理，看看 undefined 值如何处理：

问题是服务器可能需要重启以加载新代码。但从日志看，筛选确实是工作的（请求正确带上参数）。让我检查服务端是否正确返回了空数据的处理，以及确认 `current_*` 参数的处理：

```python
"""A2UI Agent Server - Main entry point."""
import asyncio
import json
import logging
from datetime import datetime
from typing import AsyncGenerator, Optional
from urllib.parse import urlparse, parse_qs

from fastapi import FastAPI, Request, Query, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import StreamingResponse, FileResponse
from fastapi.staticfiles import StaticFiles
from sse_starlette.sse import EventSourceResponse

from config import settings
from models import UserAction
from api_client import api_client
from a2ui_builder import A2UIBuilder
from pages.layout import build_app_layout
from pages.tickets import (
    build_tickets_page, build_tickets_data,
    build_ticket_detail_page, build_ticket_detail_data,
    build_ticket_create_page, build_ticket_create_data,
    build_ticket_edit_page, build_ticket_edit_data,
)
from pages.tags import build_tags_page, build_tags_data
from pages.error import build_not_found_page, build_error_page

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(title="A2UI Agent Server", version="1.0.0")

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


def safe_int(value, default: int = 1) -> int:
    """Safely convert value to int with default fallback."""
    if value is None:
        return default
    try:
        return int(value)
    except (ValueError, TypeError):
        return default


async def generate_page_messages(path: str, query_params: dict) -> AsyncGenerator[str, None]:
    """Generate A2UI messages for a given page path."""
    builder = A2UIBuilder("main")

    try:
        # Route to appropriate page builder
        if path == "/" or path == "/tickets":
            # Tickets list page
            search = query_params.get("search", "")
            status = query_params.get("status", "")
            priority = query_params.get("priority", "")
            page = safe_int(query_params.get("page"), 1)
            
            tickets_data = await api_client.list_tickets(
                search=search if search else None,
                status=status if status else None,
                priority=priority if priority else None,
                page=page,
            )
            page_id, _ = build_tickets_page(builder)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_tickets_data(tickets_data, search, status, priority, page):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tickets/new":
            # Ticket create page
            page_id, _ = build_ticket_create_page(builder)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_create_data():
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/") and path.endswith("/edit"):
            # Ticket edit page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            page_id, _ = build_ticket_edit_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_edit_data(ticket):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/"):
            # Ticket detail page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            attachments = await api_client.get_ticket_attachments(ticket_id)
            history_response = await api_client.get_ticket_history(ticket_id)
            history = history_response.get("data", [])

            page_id, _ = build_ticket_detail_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_detail_data(ticket, attachments, history):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tags":
            # Tags page
            tags = await api_client.list_tags()
            page_id, _ = build_tags_page(builder)
            build_app_layout(builder, page_id, "tags")

            yield builder.build_surface_update()
            for msg in build_tags_data(tags):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        else:
            # 404 page
            page_id, _ = build_not_found_page(builder)
            build_app_layout(builder, page_id, "")

            yield builder.build_surface_update()
            yield builder.build_begin_rendering("app-layout")

    except Exception as e:
        logger.exception(f"Error generating page: {e}")
        builder.reset()
        page_id, _ = build_error_page(builder, str(e))
        build_app_layout(builder, page_id, "")

        yield builder.build_surface_update()
        yield builder.build_begin_rendering("app-layout")


@app.get("/api/a2ui/stream")
async def stream_ui(
    request: Request,
    path: str = Query("/", description="Page path to render"),
):
    """SSE endpoint for A2UI messages."""
    # Parse query params from the path parameter itself (e.g., /tickets?page=2)
    parsed = urlparse(path)
    actual_path = parsed.path
    path_query_params = parse_qs(parsed.query)

    # Also get query params from the request URL (excluding 'path')
    request_params = dict(request.query_params)
    request_params.pop("path", None)

    # Merge query params (path params take precedence)
    query_params = request_params.copy()
    for key, values in path_query_params.items():
        if values:
            query_params[key] = values[0]  # Take first value

    # Use actual_path for routing
    path = actual_path

    async def event_generator():
        async for message in generate_page_messages(path, query_params):
            if await request.is_disconnected():
                break
            yield {"event": "message", "data": message}

    return EventSourceResponse(event_generator())


@app.post("/api/a2ui/action")
async def handle_action(action: UserAction):
    """Handle userAction from client."""
    logger.info(f"Received action: {action.name} with context: {action.context}")

    try:
        result = await process_action(action)
        return {"success": True, "result": result}
    except Exception as e:
        logger.exception(f"Error processing action: {e}")
        raise HTTPException(status_code=500, detail=str(e))


async def process_action(action: UserAction) -> dict:
    """Process a userAction and return the result."""
    name = action.name
    context = action.context
    logger.info(f"Processing action '{name}' with context: {context}")

    if name == "navigate":
        # Navigation is handled client-side by reconnecting to SSE
        return {"navigate": context.get("to", "/tickets")}

    elif name in ["search_tickets", "filter_status", "filter_priority", "paginate"]:
        # Get current query params from context (passed from client)
        # Client should pass current query state
        # Handle None/null values from data model
        current_search = context.get("current_search") or ""
        current_status = context.get("current_status") or ""
        current_priority = context.get("current_priority") or ""
        current_page = safe_int(context.get("current_page"), 1)
        
        logger.info(f"Current state: search={current_search}, status={current_status}, priority={current_priority}, page={current_page}")

        # Initialize new values
        new_search = current_search
        new_status = current_status
        new_priority = current_priority
        new_page = current_page

        # Update based on action
        if name == "search_tickets":
            search_term = context.get('search') or ''
            new_search = search_term
            new_page = 1  # Reset to page 1 on new search
        elif name == "filter_status":
            status = context.get("status")
            if status is None:
                status = ""
            new_status = status
            new_page = 1  # Reset to page 1 on filter change
        elif name == "filter_priority":
            priority = context.get("priority")
            if priority is None:
                priority = ""
            new_priority = priority
            new_page = 1  # Reset to page 1 on filter change
        elif name == "paginate":
            page = safe_int(context.get("page"), 1)
            new_page = page

        logger.info(f"New state: search={new_search}, status={new_status}, priority={new_priority}, page={new_page}")

        # Build query string
        query_parts = []
        if new_search:
            query_parts.append(f"search={new_search}")
        if new_status:
            query_parts.append(f"status={new_status}")
        if new_priority:
            query_parts.append(f"priority={new_priority}")
        if new_page > 1:
            query_parts.append(f"page={new_page}")

        query_string = "?" + "&".join(query_parts) if query_parts else ""
        return {"navigate": f"/tickets{query_string}"}

    elif name == "view_ticket":
        ticket_id = context.get("id")
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_ticket":
        form = context.get("form", {})
        ticket = await api_client.create_ticket({
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority", "medium"),
        })
        return {"navigate": f"/tickets/{ticket['id']}"}

    elif name == "update_ticket":
        ticket_id = context.get("id")
        form = context.get("form", {})
        await api_client.update_ticket(ticket_id, {
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority"),
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "delete_ticket":
        ticket_id = context.get("id")
        await api_client.delete_ticket(ticket_id)
        return {"navigate": "/tickets"}

    elif name == "change_status":
        ticket_id = context.get("id")
        status = context.get("status")
        resolution = context.get("resolution")
        await api_client.update_ticket_status(ticket_id, {
            "status": status,
            "resolution": resolution,
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_tag":
        form = context.get("form", {})
        await api_client.create_tag({
            "name": form.get("name"),
            "color": form.get("color", "#3B82F6"),
        })
        return {"navigate": "/tags"}

    elif name == "delete_tag":
        tag_id = context.get("id")
        await api_client.delete_tag(tag_id)
        return {"navigate": "/tags"}

    elif name in ["show_create_tag_form", "hide_create_tag_form", "set_tag_color", "set_form_priority"]:
        # These are handled client-side via data model updates
        return {"handled": True}

    elif name in ["show_delete_dialog", "dismiss_dialog"]:
        # Dialog handling is client-side
        return {"handled": True}

    elif name == "retry":
        # Retry by refreshing current page
        return {"refresh": True}

    else:
        logger.warning(f"Unknown action: {name}")
        return {"unknown": True}


@app.get("/health")
async def health():
    """Health check endpoint."""
    return {"status": "healthy"}


# Serve static files for the client
try:
    app.mount("/", StaticFiles(directory="../client/dist", html=True), name="static")
except RuntimeError:
    # Client not built yet
    @app.get("/")
    async def root():
        return {"message": "A2UI Agent Server is running. Build the client to serve the UI."}


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host=settings.host, port=settings.port)

```

现在需要重启 Python 服务器以加载新代码。同时，我发现可能存在一个问题：客户端在导航后可能没有清除旧数据。让我检查：

问题找到了：客户端在导航后没有清除旧数据，导致列表可能显示旧数据。修复这个问题：

```typescript
/**
 * A2UI Client Shell - Main entry point
 */
import './renderer';
import type { A2UIMessage, Action, UserAction, SurfaceUpdate, DataModelUpdate, BeginRendering } from './types';
import type { A2UISurface } from './renderer';

class A2UIClient {
  private surface: A2UISurface | null = null;
  private eventSource: EventSource | null = null;
  private currentPath: string = '/';

  constructor() {
    this.init();
  }

  private async init(): Promise<void> {
    // Create surface element
    const app = document.getElementById('app');
    if (!app) {
      console.error('App container not found');
      return;
    }

    // Clear loading state
    app.innerHTML = '';

    // Create surface
    this.surface = document.createElement('a2ui-surface') as A2UISurface;
    this.surface.surfaceId = 'main';
    this.surface.setActionHandler((action, sourceId, contextPath) => this.handleAction(action, sourceId, contextPath));
    app.appendChild(this.surface);

    // Get initial path from URL
    this.currentPath = window.location.pathname + window.location.search;

    // Handle browser navigation
    window.addEventListener('popstate', () => {
      this.currentPath = window.location.pathname + window.location.search;
      this.connect();
    });

    // Connect to server
    this.connect();
  }

  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Clear data model on new connection to ensure fresh data
    if (this.surface) {
      this.surface.dataModel.clear();
    }

    // Build SSE URL
    const sseUrl = `/api/a2ui/stream?path=${encodeURIComponent(this.currentPath)}`;
    console.log(`Connecting to: ${sseUrl}`);

    this.eventSource = new EventSource(sseUrl);

    this.eventSource.onmessage = (event) => {
      this.handleMessage(event.data);
    };

    this.eventSource.onerror = (error) => {
      console.error('SSE error:', error);
      // Attempt to reconnect after delay
      setTimeout(() => {
        if (this.eventSource?.readyState === EventSource.CLOSED) {
          this.connect();
        }
      }, 3000);
    };

    this.eventSource.onopen = () => {
      console.log('SSE connection established');
    };
  }

  private handleMessage(data: string): void {
    try {
      const message: A2UIMessage = JSON.parse(data);

      if ('surfaceUpdate' in message) {
        this.handleSurfaceUpdate(message as SurfaceUpdate);
      } else if ('dataModelUpdate' in message) {
        this.handleDataModelUpdate(message as DataModelUpdate);
      } else if ('beginRendering' in message) {
        this.handleBeginRendering(message as BeginRendering);
      } else if ('deleteSurface' in message) {
        console.log('Surface deleted');
      }
    } catch (error) {
      console.error('Error parsing message:', error, data);
    }
  }

  private handleSurfaceUpdate(message: SurfaceUpdate): void {
    if (this.surface && message.surfaceUpdate.surfaceId === this.surface.surfaceId) {
      this.surface.setComponents(message.surfaceUpdate.components);
    }
  }

  private handleDataModelUpdate(message: DataModelUpdate): void {
    if (this.surface && message.dataModelUpdate.surfaceId === this.surface.surfaceId) {
      const path = message.dataModelUpdate.path || '/';
      this.surface.dataModel.update(path, message.dataModelUpdate.contents);
    }
  }

  private handleBeginRendering(message: BeginRendering): void {
    if (this.surface && message.beginRendering.surfaceId === this.surface.surfaceId) {
      this.surface.setRoot(message.beginRendering.root);
    }
  }

  private async handleAction(action: Action, sourceId: string, contextPath?: string): Promise<void> {
    console.log(`Action: ${action.name} from ${sourceId}`, action.context, `contextPath: ${contextPath}`);

    // Build context object from action.context array
    // Pass contextPath to resolve relative paths (e.g., "id" -> "/app/tickets/list/ticket0/id")
    const context: Record<string, unknown> = {};
    if (action.context) {
      for (const item of action.context) {
        const value = this.surface?.dataModel.resolve(item.value, contextPath);
        // Convert undefined to null to ensure it's included in JSON
        context[item.key] = value !== undefined ? value : null;
        console.log(`  Context ${item.key}:`, value, 'from', item.value);
      }
    }

    // Build userAction
    const userAction: UserAction = {
      name: action.name,
      surfaceId: this.surface?.surfaceId || 'main',
      sourceComponentId: sourceId,
      timestamp: new Date().toISOString(),
      context,
    };

    try {
      const response = await fetch('/api/a2ui/action', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(userAction),
      });

      if (!response.ok) {
        throw new Error(`Action failed: ${response.statusText}`);
      }

      const result = await response.json();
      console.log('Action result:', result);

      // Handle navigation
      if (result.result?.navigate) {
        this.navigate(result.result.navigate);
      } else if (result.result?.refresh) {
        this.connect();
      }
    } catch (error) {
      console.error('Error sending action:', error);
    }
  }

  private navigate(path: string): void {
    // Update URL without reload
    window.history.pushState({}, '', path);
    // Store full path including query string for SSE reconnection
    this.currentPath = path;

    // Reconnect to get new page
    this.connect();
  }
}

// Initialize client
new A2UIClient();

```

已完成修复。现在需要**重启 Python 服务器**以加载新代码。修复内容包括：

1. **分页显示修复**：当没有数据时显示"第0页/共0页"

2. **数据清除修复**：导航到新页面时清除旧数据，确保列表正确显示

请重启 Python 服务器：

服务器已被停止。请在终端 3 中手动重启 Python 服务器。修复内容总结：

## 已修复的问题

### 1. 分页显示修复 (`tickets.py`)
当没有数据时显示"第0页/共0页"：

```225:245:project_alpha/a2ui_frontend/server/pages/tickets.py
    # Pagination
    page = tickets_response.get("page", 1)
    total_pages = tickets_response.get("total_pages", 0)
    total_count = tickets_response.get("total", 0)
    
    # If no data, show "第0页/共0页"
    if total_count == 0 or total_pages == 0:
        display_page = 0
        display_total = 0
    else:
        display_page = page
        display_total = total_pages
    
    pagination_data = [
        value_number("page", display_page),
        value_number("totalPages", display_total),
        value_number("prevPage", max(1, page - 1) if total_pages > 0 else 0),
        value_number("nextPage", min(total_pages, page + 1) if total_pages > 0 else 0),
        value_string("info", f"第 {display_page} 页 / 共 {display_total} 页"),
    ]
```

### 2. 数据清除修复 (`main.ts`)
导航到新页面时清除旧数据，确保列表正确显示新查询结果：

```47:58:project_alpha/a2ui_frontend/client/src/main.ts
  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Clear data model on new connection to ensure fresh data
    if (this.surface) {
      this.surface.dataModel.clear();
    }

    // Build SSE URL
```

### 3. 调试日志 (`main.py`)
添加了日志来跟踪筛选参数，方便调试。

请在终端中重启 Python 服务器后刷新页面测试。

```python
    # Pagination
    page = tickets_response.get("page", 1)
    total_pages = tickets_response.get("total_pages", 0)
    total_count = tickets_response.get("total", 0)
    
    # If no data, show "第0页/共0页"
    if total_count == 0 or total_pages == 0:
        display_page = 0
        display_total = 0
    else:
        display_page = page
        display_total = total_pages
    
    pagination_data = [
        value_number("page", display_page),
        value_number("totalPages", display_total),
        value_number("prevPage", max(1, page - 1) if total_pages > 0 else 0),
        value_number("nextPage", min(total_pages, page + 1) if total_pages > 0 else 0),
        value_string("info", f"第 {display_page} 页 / 共 {display_total} 页"),
    ]
```

```typescript
  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Clear data model on new connection to ensure fresh data
    if (this.surface) {
      this.surface.dataModel.clear();
    }

    // Build SSE URL
```

---

**User**

选择的内容需要高亮，全部这一行的内容，应该是只能进行单选，全部优先级这行的内容也应该只能单选。全部和全部优先级这行的内容如果分别被选中之后应该是 And 的关系进行数据的查询，请仔细检查和修改

---

**Cursor**

明白，需要：
1. 选中的按钮高亮显示
2. 状态筛选和优先级筛选分别单选
3. 两者是 AND 关系查询

需要在渲染按钮时根据当前选中状态设置高亮。修改 `renderer.ts`：

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    // Check if this is a filter button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    
    // Check if this filter button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isFilterButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      // Update data model with new value
      const textProp = props.text as BoundValue;
      if (textProp && 'path' in textProp) {
        // Note: This would need proper two-way binding implementation
        console.log(`TextField ${id} changed to: ${target.value}`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

添加选中状态的高亮样式：

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    // Check if this is a filter button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    
    // Check if this filter button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isFilterButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      // Update data model with new value
      const textProp = props.text as BoundValue;
      if (textProp && 'path' in textProp) {
        // Note: This would need proper two-way binding implementation
        console.log(`TextField ${id} changed to: ${target.value}`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

已完成修改。现在需要确保服务器正确处理 AND 查询（已在之前的修改中实现）。检查 lint 错误：

检查服务端 AND 查询逻辑：

AND 查询逻辑已正确实现。修改总结：

## 已完成的修改

### 1. 按钮选中高亮 (`renderer.ts`)
根据当前状态/优先级设置 `data-selected` 属性：

```114:155:project_alpha/a2ui_frontend/client/src/renderer.ts
  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // ...
    // Check if this filter button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      // ...
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      // ...
    }
    // ...
  }
```

### 2. 选中状态高亮样式 (`renderer.ts`)

```css
:host([data-filter-button="true"][data-selected="true"]) {
  background: #FFD93D;
  color: #1E3A5F;
  border-color: #FFD93D;
  font-weight: 500;
}
```

### 3. AND 查询逻辑 (`main.py`)
- 选择状态筛选时保留优先级
- 选择优先级筛选时保留状态
- 两者组合成 AND 查询（如 `?status=open&priority=high`）

请重启 Python 服务器后刷新页面测试。选中的筛选按钮会显示黄色高亮，且两行筛选是 AND 关系。

```typescript
  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // ...
    // Check if this filter button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      // ...
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      // ...
    }
    // ...
  }
```

```css
:host([data-filter-button="true"][data-selected="true"]) {
  background: #FFD93D;
  color: #1E3A5F;
  border-color: #FFD93D;
  font-weight: 500;
}
```

---

**User**

输入需要搜索的内容，点击搜索框没有作用。

---

**Cursor**

检查搜索框输入绑定问题。输入框的值需要正确绑定到数据模型：

问题找到了！输入框的 `handleInput` 只打印日志，没有真正更新数据模型。需要实现双向绑定：

首先在 DataModel 中添加 `set` 方法：

```typescript
/**
 * A2UI Data Model Manager
 */
import type { ValueMap, BoundValue } from './types';

export class DataModel {
  private data: Map<string, unknown> = new Map();

  /**
   * Update data model from ValueMap contents
   */
  update(path: string, contents: ValueMap[]): void {
    const basePath = path.startsWith('/') ? path : `/${path}`;

    for (const item of contents) {
      const fullPath = `${basePath}/${item.key}`;
      const value = this.extractValue(item);
      this.data.set(fullPath, value);

      // Also store nested paths for valueMap items
      if (item.valueMap !== undefined) {
        this.storeNestedPaths(fullPath, item.valueMap);
      }
    }
  }

  /**
   * Recursively store nested ValueMap paths
   */
  private storeNestedPaths(basePath: string, contents: ValueMap[]): void {
    for (const item of contents) {
      const fullPath = `${basePath}/${item.key}`;
      const value = this.extractValue(item);
      this.data.set(fullPath, value);

      if (item.valueMap !== undefined) {
        this.storeNestedPaths(fullPath, item.valueMap);
      }
    }
  }

  /**
   * Get value at path
   */
  get(path: string): unknown {
    // Handle relative paths (starting with .)
    if (path === '.' || path === '') {
      return undefined;
    }

    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    return this.data.get(normalizedPath);
  }

  /**
   * Set value at path
   */
  set(path: string, value: unknown): void {
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    this.data.set(normalizedPath, value);
  }

  /**
   * Resolve a BoundValue to its actual value
   */
  resolve(value: BoundValue, contextPath?: string): unknown {
    if ('literalString' in value) {
      return value.literalString;
    }
    if ('literalNumber' in value) {
      return value.literalNumber;
    }
    if ('literalBoolean' in value) {
      return value.literalBoolean;
    }
    if ('path' in value) {
      const resolvedPath = this.resolvePath(value.path, contextPath);
      return this.get(resolvedPath);
    }
    return undefined;
  }

  /**
   * Resolve a path considering context
   */
  private resolvePath(path: string, contextPath?: string): string {
    if (path.startsWith('/')) {
      return path;
    }
    if (contextPath) {
      return `${contextPath}/${path}`;
    }
    return path;
  }

  /**
   * Extract value from ValueMap item
   */
  private extractValue(item: ValueMap): unknown {
    if (item.valueString !== undefined) {
      return item.valueString;
    }
    if (item.valueNumber !== undefined) {
      return item.valueNumber;
    }
    if (item.valueBoolean !== undefined) {
      return item.valueBoolean;
    }
    if (item.valueMap !== undefined) {
      // Convert nested ValueMap to object
      const obj: Record<string, unknown> = {};
      for (const nested of item.valueMap) {
        obj[nested.key] = this.extractValue(nested);
      }
      return obj;
    }
    return undefined;
  }

  /**
   * Get all entries under a path (for list templates)
   */
  getEntries(path: string): Array<{ key: string; value: unknown; path: string }> {
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    const entries: Array<{ key: string; value: unknown; path: string }> = [];

    for (const [key, value] of this.data.entries()) {
      if (key.startsWith(normalizedPath + '/')) {
        const relativePath = key.substring(normalizedPath.length + 1);
        const parts = relativePath.split('/');
        if (parts.length === 1) {
          entries.push({
            key: parts[0],
            value,
            path: key,
          });
        }
      }
    }

    return entries;
  }

  /**
   * Clear all data
   */
  clear(): void {
    this.data.clear();
  }

  /**
   * Debug: dump all data
   */
  dump(): Record<string, unknown> {
    const result: Record<string, unknown> = {};
    for (const [key, value] of this.data.entries()) {
      result[key] = value;
    }
    return result;
  }
}

```

现在修改 `renderTextField` 以正确更新数据模型：

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    // Check if this is a filter button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    
    // Check if this filter button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isFilterButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      // Update data model with new value
      const textProp = props.text as BoundValue;
      if (textProp && 'path' in textProp) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textProp.path, target.value);
        console.log(`TextField ${id} changed to: ${target.value}, path: ${textProp.path}`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

已修复搜索框输入问题。现在输入框会将值正确写入数据模型，点击搜索按钮时能读取到最新输入的值。

修改内容：

### 1. DataModel 添加 `set` 方法 (`data-model.ts`)

```42:51:project_alpha/a2ui_frontend/client/src/data-model.ts
  /**
   * Set value at path
   */
  set(path: string, value: unknown): void {
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    this.data.set(normalizedPath, value);
  }
```

### 2. TextField 实现双向绑定 (`renderer.ts`)

```166:174:project_alpha/a2ui_frontend/client/src/renderer.ts
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      // Update data model with new value
      const textProp = props.text as BoundValue;
      if (textProp && 'path' in textProp) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textProp.path, target.value);
        console.log(`TextField ${id} changed to: ${target.value}, path: ${textProp.path}`);
      }
    };
```

现在：
1. 在搜索框中输入内容
2. 值会自动保存到数据模型 `/app/tickets/query/search`
3. 点击搜索按钮会读取这个值并发送请求

请确保 Python 服务器已启动，然后刷新页面测试。

```typescript
  /**
   * Set value at path
   */
  set(path: string, value: unknown): void {
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    this.data.set(normalizedPath, value);
  }
```

```typescript
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      // Update data model with new value
      const textProp = props.text as BoundValue;
      if (textProp && 'path' in textProp) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textProp.path, target.value);
        console.log(`TextField ${id} changed to: ${target.value}, path: ${textProp.path}`);
      }
    };
```

---

**User**

输入的内容会自动消息，并且点击搜索按钮还是没有任何效果

---

**Cursor**

问题分析：
1. 输入内容消失 - 可能是 LitElement 的响应式更新问题
2. 搜索按钮无效 - Python 服务器未运行（日志显示 `ECONNREFUSED`）

先检查服务器状态并修复输入消失问题：

服务器在终端 3 中运行。问题是每次 SSE 重连时会清除数据模型，导致输入消失。检查并修复：

问题找到了！SSE 断线重连时会清除数据模型，导致输入消失。修改为只在路径变化时清除：

```typescript
/**
 * A2UI Client Shell - Main entry point
 */
import './renderer';
import type { A2UIMessage, Action, UserAction, SurfaceUpdate, DataModelUpdate, BeginRendering } from './types';
import type { A2UISurface } from './renderer';

class A2UIClient {
  private surface: A2UISurface | null = null;
  private eventSource: EventSource | null = null;
  private currentPath: string = '/';

  constructor() {
    this.init();
  }

  private async init(): Promise<void> {
    // Create surface element
    const app = document.getElementById('app');
    if (!app) {
      console.error('App container not found');
      return;
    }

    // Clear loading state
    app.innerHTML = '';

    // Create surface
    this.surface = document.createElement('a2ui-surface') as A2UISurface;
    this.surface.surfaceId = 'main';
    this.surface.setActionHandler((action, sourceId, contextPath) => this.handleAction(action, sourceId, contextPath));
    app.appendChild(this.surface);

    // Get initial path from URL
    this.currentPath = window.location.pathname + window.location.search;

    // Handle browser navigation
    window.addEventListener('popstate', () => {
      this.currentPath = window.location.pathname + window.location.search;
      this.connect();
    });

    // Connect to server
    this.connect();
  }

  private lastConnectedPath: string = '';
  
  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Only clear data model when path changes (navigation), not on reconnect
    if (this.surface && this.currentPath !== this.lastConnectedPath) {
      this.surface.dataModel.clear();
      this.lastConnectedPath = this.currentPath;
    }

    // Build SSE URL
    const sseUrl = `/api/a2ui/stream?path=${encodeURIComponent(this.currentPath)}`;
    console.log(`Connecting to: ${sseUrl}`);

    this.eventSource = new EventSource(sseUrl);

    this.eventSource.onmessage = (event) => {
      this.handleMessage(event.data);
    };

    this.eventSource.onerror = (error) => {
      console.error('SSE error:', error);
      // Attempt to reconnect after delay
      setTimeout(() => {
        if (this.eventSource?.readyState === EventSource.CLOSED) {
          this.connect();
        }
      }, 3000);
    };

    this.eventSource.onopen = () => {
      console.log('SSE connection established');
    };
  }

  private handleMessage(data: string): void {
    try {
      const message: A2UIMessage = JSON.parse(data);

      if ('surfaceUpdate' in message) {
        this.handleSurfaceUpdate(message as SurfaceUpdate);
      } else if ('dataModelUpdate' in message) {
        this.handleDataModelUpdate(message as DataModelUpdate);
      } else if ('beginRendering' in message) {
        this.handleBeginRendering(message as BeginRendering);
      } else if ('deleteSurface' in message) {
        console.log('Surface deleted');
      }
    } catch (error) {
      console.error('Error parsing message:', error, data);
    }
  }

  private handleSurfaceUpdate(message: SurfaceUpdate): void {
    if (this.surface && message.surfaceUpdate.surfaceId === this.surface.surfaceId) {
      this.surface.setComponents(message.surfaceUpdate.components);
    }
  }

  private handleDataModelUpdate(message: DataModelUpdate): void {
    if (this.surface && message.dataModelUpdate.surfaceId === this.surface.surfaceId) {
      const path = message.dataModelUpdate.path || '/';
      this.surface.dataModel.update(path, message.dataModelUpdate.contents);
    }
  }

  private handleBeginRendering(message: BeginRendering): void {
    if (this.surface && message.beginRendering.surfaceId === this.surface.surfaceId) {
      this.surface.setRoot(message.beginRendering.root);
    }
  }

  private async handleAction(action: Action, sourceId: string, contextPath?: string): Promise<void> {
    console.log(`Action: ${action.name} from ${sourceId}`, action.context, `contextPath: ${contextPath}`);

    // Build context object from action.context array
    // Pass contextPath to resolve relative paths (e.g., "id" -> "/app/tickets/list/ticket0/id")
    const context: Record<string, unknown> = {};
    if (action.context) {
      for (const item of action.context) {
        const value = this.surface?.dataModel.resolve(item.value, contextPath);
        // Convert undefined to null to ensure it's included in JSON
        context[item.key] = value !== undefined ? value : null;
        console.log(`  Context ${item.key}:`, value, 'from', item.value);
      }
    }

    // Build userAction
    const userAction: UserAction = {
      name: action.name,
      surfaceId: this.surface?.surfaceId || 'main',
      sourceComponentId: sourceId,
      timestamp: new Date().toISOString(),
      context,
    };

    try {
      const response = await fetch('/api/a2ui/action', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(userAction),
      });

      if (!response.ok) {
        throw new Error(`Action failed: ${response.statusText}`);
      }

      const result = await response.json();
      console.log('Action result:', result);

      // Handle navigation
      if (result.result?.navigate) {
        this.navigate(result.result.navigate);
      } else if (result.result?.refresh) {
        this.connect();
      }
    } catch (error) {
      console.error('Error sending action:', error);
    }
  }

  private navigate(path: string): void {
    // Update URL without reload
    window.history.pushState({}, '', path);
    // Store full path including query string for SSE reconnection
    this.currentPath = path;

    // Reconnect to get new page
    this.connect();
  }
}

// Initialize client
new A2UIClient();

```

检查 navigate 方法，确保导航时更新 lastConnectedPath：

检查类属性声明位置：

将属性移动到类属性区域以保持代码整洁：

```typescript
/**
 * A2UI Client Shell - Main entry point
 */
import './renderer';
import type { A2UIMessage, Action, UserAction, SurfaceUpdate, DataModelUpdate, BeginRendering } from './types';
import type { A2UISurface } from './renderer';

class A2UIClient {
  private surface: A2UISurface | null = null;
  private eventSource: EventSource | null = null;
  private currentPath: string = '/';
  private lastConnectedPath: string = '';

  constructor() {
    this.init();
  }

  private async init(): Promise<void> {
    // Create surface element
    const app = document.getElementById('app');
    if (!app) {
      console.error('App container not found');
      return;
    }

    // Clear loading state
    app.innerHTML = '';

    // Create surface
    this.surface = document.createElement('a2ui-surface') as A2UISurface;
    this.surface.surfaceId = 'main';
    this.surface.setActionHandler((action, sourceId, contextPath) => this.handleAction(action, sourceId, contextPath));
    app.appendChild(this.surface);

    // Get initial path from URL
    this.currentPath = window.location.pathname + window.location.search;

    // Handle browser navigation
    window.addEventListener('popstate', () => {
      this.currentPath = window.location.pathname + window.location.search;
      this.connect();
    });

    // Connect to server
    this.connect();
  }

  private lastConnectedPath: string = '';
  
  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Only clear data model when path changes (navigation), not on reconnect
    if (this.surface && this.currentPath !== this.lastConnectedPath) {
      this.surface.dataModel.clear();
      this.lastConnectedPath = this.currentPath;
    }

    // Build SSE URL
    const sseUrl = `/api/a2ui/stream?path=${encodeURIComponent(this.currentPath)}`;
    console.log(`Connecting to: ${sseUrl}`);

    this.eventSource = new EventSource(sseUrl);

    this.eventSource.onmessage = (event) => {
      this.handleMessage(event.data);
    };

    this.eventSource.onerror = (error) => {
      console.error('SSE error:', error);
      // Attempt to reconnect after delay
      setTimeout(() => {
        if (this.eventSource?.readyState === EventSource.CLOSED) {
          this.connect();
        }
      }, 3000);
    };

    this.eventSource.onopen = () => {
      console.log('SSE connection established');
    };
  }

  private handleMessage(data: string): void {
    try {
      const message: A2UIMessage = JSON.parse(data);

      if ('surfaceUpdate' in message) {
        this.handleSurfaceUpdate(message as SurfaceUpdate);
      } else if ('dataModelUpdate' in message) {
        this.handleDataModelUpdate(message as DataModelUpdate);
      } else if ('beginRendering' in message) {
        this.handleBeginRendering(message as BeginRendering);
      } else if ('deleteSurface' in message) {
        console.log('Surface deleted');
      }
    } catch (error) {
      console.error('Error parsing message:', error, data);
    }
  }

  private handleSurfaceUpdate(message: SurfaceUpdate): void {
    if (this.surface && message.surfaceUpdate.surfaceId === this.surface.surfaceId) {
      this.surface.setComponents(message.surfaceUpdate.components);
    }
  }

  private handleDataModelUpdate(message: DataModelUpdate): void {
    if (this.surface && message.dataModelUpdate.surfaceId === this.surface.surfaceId) {
      const path = message.dataModelUpdate.path || '/';
      this.surface.dataModel.update(path, message.dataModelUpdate.contents);
    }
  }

  private handleBeginRendering(message: BeginRendering): void {
    if (this.surface && message.beginRendering.surfaceId === this.surface.surfaceId) {
      this.surface.setRoot(message.beginRendering.root);
    }
  }

  private async handleAction(action: Action, sourceId: string, contextPath?: string): Promise<void> {
    console.log(`Action: ${action.name} from ${sourceId}`, action.context, `contextPath: ${contextPath}`);

    // Build context object from action.context array
    // Pass contextPath to resolve relative paths (e.g., "id" -> "/app/tickets/list/ticket0/id")
    const context: Record<string, unknown> = {};
    if (action.context) {
      for (const item of action.context) {
        const value = this.surface?.dataModel.resolve(item.value, contextPath);
        // Convert undefined to null to ensure it's included in JSON
        context[item.key] = value !== undefined ? value : null;
        console.log(`  Context ${item.key}:`, value, 'from', item.value);
      }
    }

    // Build userAction
    const userAction: UserAction = {
      name: action.name,
      surfaceId: this.surface?.surfaceId || 'main',
      sourceComponentId: sourceId,
      timestamp: new Date().toISOString(),
      context,
    };

    try {
      const response = await fetch('/api/a2ui/action', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(userAction),
      });

      if (!response.ok) {
        throw new Error(`Action failed: ${response.statusText}`);
      }

      const result = await response.json();
      console.log('Action result:', result);

      // Handle navigation
      if (result.result?.navigate) {
        this.navigate(result.result.navigate);
      } else if (result.result?.refresh) {
        this.connect();
      }
    } catch (error) {
      console.error('Error sending action:', error);
    }
  }

  private navigate(path: string): void {
    // Update URL without reload
    window.history.pushState({}, '', path);
    // Store full path including query string for SSE reconnection
    this.currentPath = path;

    // Reconnect to get new page
    this.connect();
  }
}

// Initialize client
new A2UIClient();

```

```typescript
/**
 * A2UI Client Shell - Main entry point
 */
import './renderer';
import type { A2UIMessage, Action, UserAction, SurfaceUpdate, DataModelUpdate, BeginRendering } from './types';
import type { A2UISurface } from './renderer';

class A2UIClient {
  private surface: A2UISurface | null = null;
  private eventSource: EventSource | null = null;
  private currentPath: string = '/';
  private lastConnectedPath: string = '';

  constructor() {
    this.init();
  }

  private async init(): Promise<void> {
    // Create surface element
    const app = document.getElementById('app');
    if (!app) {
      console.error('App container not found');
      return;
    }

    // Clear loading state
    app.innerHTML = '';

    // Create surface
    this.surface = document.createElement('a2ui-surface') as A2UISurface;
    this.surface.surfaceId = 'main';
    this.surface.setActionHandler((action, sourceId, contextPath) => this.handleAction(action, sourceId, contextPath));
    app.appendChild(this.surface);

    // Get initial path from URL
    this.currentPath = window.location.pathname + window.location.search;

    // Handle browser navigation
    window.addEventListener('popstate', () => {
      this.currentPath = window.location.pathname + window.location.search;
      this.connect();
    });

    // Connect to server
    this.connect();
  }

  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Only clear data model when path changes (navigation), not on reconnect
    if (this.surface && this.currentPath !== this.lastConnectedPath) {
      this.surface.dataModel.clear();
      this.lastConnectedPath = this.currentPath;
    }

    // Build SSE URL
    const sseUrl = `/api/a2ui/stream?path=${encodeURIComponent(this.currentPath)}`;
    console.log(`Connecting to: ${sseUrl}`);

    this.eventSource = new EventSource(sseUrl);

    this.eventSource.onmessage = (event) => {
      this.handleMessage(event.data);
    };

    this.eventSource.onerror = (error) => {
      console.error('SSE error:', error);
      // Attempt to reconnect after delay
      setTimeout(() => {
        if (this.eventSource?.readyState === EventSource.CLOSED) {
          this.connect();
        }
      }, 3000);
    };

    this.eventSource.onopen = () => {
      console.log('SSE connection established');
    };
  }

  private handleMessage(data: string): void {
    try {
      const message: A2UIMessage = JSON.parse(data);

      if ('surfaceUpdate' in message) {
        this.handleSurfaceUpdate(message as SurfaceUpdate);
      } else if ('dataModelUpdate' in message) {
        this.handleDataModelUpdate(message as DataModelUpdate);
      } else if ('beginRendering' in message) {
        this.handleBeginRendering(message as BeginRendering);
      } else if ('deleteSurface' in message) {
        console.log('Surface deleted');
      }
    } catch (error) {
      console.error('Error parsing message:', error, data);
    }
  }

  private handleSurfaceUpdate(message: SurfaceUpdate): void {
    if (this.surface && message.surfaceUpdate.surfaceId === this.surface.surfaceId) {
      this.surface.setComponents(message.surfaceUpdate.components);
    }
  }

  private handleDataModelUpdate(message: DataModelUpdate): void {
    if (this.surface && message.dataModelUpdate.surfaceId === this.surface.surfaceId) {
      const path = message.dataModelUpdate.path || '/';
      this.surface.dataModel.update(path, message.dataModelUpdate.contents);
    }
  }

  private handleBeginRendering(message: BeginRendering): void {
    if (this.surface && message.beginRendering.surfaceId === this.surface.surfaceId) {
      this.surface.setRoot(message.beginRendering.root);
    }
  }

  private async handleAction(action: Action, sourceId: string, contextPath?: string): Promise<void> {
    console.log(`Action: ${action.name} from ${sourceId}`, action.context, `contextPath: ${contextPath}`);

    // Build context object from action.context array
    // Pass contextPath to resolve relative paths (e.g., "id" -> "/app/tickets/list/ticket0/id")
    const context: Record<string, unknown> = {};
    if (action.context) {
      for (const item of action.context) {
        const value = this.surface?.dataModel.resolve(item.value, contextPath);
        // Convert undefined to null to ensure it's included in JSON
        context[item.key] = value !== undefined ? value : null;
        console.log(`  Context ${item.key}:`, value, 'from', item.value);
      }
    }

    // Build userAction
    const userAction: UserAction = {
      name: action.name,
      surfaceId: this.surface?.surfaceId || 'main',
      sourceComponentId: sourceId,
      timestamp: new Date().toISOString(),
      context,
    };

    try {
      const response = await fetch('/api/a2ui/action', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(userAction),
      });

      if (!response.ok) {
        throw new Error(`Action failed: ${response.statusText}`);
      }

      const result = await response.json();
      console.log('Action result:', result);

      // Handle navigation
      if (result.result?.navigate) {
        this.navigate(result.result.navigate);
      } else if (result.result?.refresh) {
        this.connect();
      }
    } catch (error) {
      console.error('Error sending action:', error);
    }
  }

  private navigate(path: string): void {
    // Update URL without reload
    window.history.pushState({}, '', path);
    // Store full path including query string for SSE reconnection
    this.currentPath = path;

    // Reconnect to get new page
    this.connect();
  }
}

// Initialize client
new A2UIClient();

```

已修复输入消失问题。现在只有在路径变化（导航）时才会清除数据模型，SSE 断线重连不会清除。

修改内容：

```8:12:project_alpha/a2ui_frontend/client/src/main.ts
class A2UIClient {
  private surface: A2UISurface | null = null;
  private eventSource: EventSource | null = null;
  private currentPath: string = '/';
  private lastConnectedPath: string = '';
```

```47:56:project_alpha/a2ui_frontend/client/src/main.ts
  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Only clear data model when path changes (navigation), not on reconnect
    if (this.surface && this.currentPath !== this.lastConnectedPath) {
      this.surface.dataModel.clear();
      this.lastConnectedPath = this.currentPath;
    }
```

现在：
1. 输入框的值不会因 SSE 重连而消失
2. 只有导航到新页面时才会清除数据模型

请刷新页面测试。确保 Python 服务器正在运行（从终端 3 的日志看，服务器已启动）。

```typescript
class A2UIClient {
  private surface: A2UISurface | null = null;
  private eventSource: EventSource | null = null;
  private currentPath: string = '/';
  private lastConnectedPath: string = '';
```

```typescript
  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Only clear data model when path changes (navigation), not on reconnect
    if (this.surface && this.currentPath !== this.lastConnectedPath) {
      this.surface.dataModel.clear();
      this.lastConnectedPath = this.currentPath;
    }
```

---

**User**

输入框中输入的内容会自动消息，并且点击搜索按钮没有任何反应。
如果输入框中存在内容，点击搜索的查询条件跟全部这一行和全部优先级这行之间都是 And 的逻辑关系。点击搜搜之后去进行查询
请仔细检查和修复问题。

---

**Cursor**

检查并修复问题。首先查看当前 `main.ts` 的状态：

检查终端 3 和 4 的服务器状态：

从日志看到搜索请求发送了，但 `search` 参数是空的。问题是服务端的数据模型更新覆盖了用户输入。

检查服务端如何设置 search 值：

问题是服务端每次都会发送数据模型更新，覆盖用户输入。修改方案：让输入框维护本地状态，只在提交时读取：

修改 DataModel，添加 "dirty" 标记来保护用户输入：

修改 DataModel，添加 dirty 标记保护用户输入：

```typescript
/**
 * A2UI Data Model Manager
 */
import type { ValueMap, BoundValue } from './types';

export class DataModel {
  private data: Map<string, unknown> = new Map();
  private dirtyPaths: Set<string> = new Set(); // Paths modified by user input

  /**
   * Update data model from ValueMap contents (from server)
   * Skips paths marked as dirty by user input
   */
  update(path: string, contents: ValueMap[]): void {
    const basePath = path.startsWith('/') ? path : `/${path}`;

    for (const item of contents) {
      const fullPath = `${basePath}/${item.key}`;
      
      // Skip paths that have been modified by user input
      if (this.dirtyPaths.has(fullPath)) {
        console.log(`Skipping server update for dirty path: ${fullPath}`);
        continue;
      }
      
      const value = this.extractValue(item);
      this.data.set(fullPath, value);

      // Also store nested paths for valueMap items
      if (item.valueMap !== undefined) {
        this.storeNestedPaths(fullPath, item.valueMap);
      }
    }
  }

  /**
   * Recursively store nested ValueMap paths
   */
  private storeNestedPaths(basePath: string, contents: ValueMap[]): void {
    for (const item of contents) {
      const fullPath = `${basePath}/${item.key}`;
      
      // Skip paths that have been modified by user input
      if (this.dirtyPaths.has(fullPath)) {
        console.log(`Skipping server update for dirty path: ${fullPath}`);
        continue;
      }
      
      const value = this.extractValue(item);
      this.data.set(fullPath, value);

      if (item.valueMap !== undefined) {
        this.storeNestedPaths(fullPath, item.valueMap);
      }
    }
  }

  /**
   * Get value at path
   */
  get(path: string): unknown {
    // Handle relative paths (starting with .)
    if (path === '.' || path === '') {
      return undefined;
    }

    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    return this.data.get(normalizedPath);
  }

  /**
   * Set value at path
   */
  set(path: string, value: unknown): void {
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    this.data.set(normalizedPath, value);
  }

  /**
   * Resolve a BoundValue to its actual value
   */
  resolve(value: BoundValue, contextPath?: string): unknown {
    if ('literalString' in value) {
      return value.literalString;
    }
    if ('literalNumber' in value) {
      return value.literalNumber;
    }
    if ('literalBoolean' in value) {
      return value.literalBoolean;
    }
    if ('path' in value) {
      const resolvedPath = this.resolvePath(value.path, contextPath);
      return this.get(resolvedPath);
    }
    return undefined;
  }

  /**
   * Resolve a path considering context
   */
  private resolvePath(path: string, contextPath?: string): string {
    if (path.startsWith('/')) {
      return path;
    }
    if (contextPath) {
      return `${contextPath}/${path}`;
    }
    return path;
  }

  /**
   * Extract value from ValueMap item
   */
  private extractValue(item: ValueMap): unknown {
    if (item.valueString !== undefined) {
      return item.valueString;
    }
    if (item.valueNumber !== undefined) {
      return item.valueNumber;
    }
    if (item.valueBoolean !== undefined) {
      return item.valueBoolean;
    }
    if (item.valueMap !== undefined) {
      // Convert nested ValueMap to object
      const obj: Record<string, unknown> = {};
      for (const nested of item.valueMap) {
        obj[nested.key] = this.extractValue(nested);
      }
      return obj;
    }
    return undefined;
  }

  /**
   * Get all entries under a path (for list templates)
   */
  getEntries(path: string): Array<{ key: string; value: unknown; path: string }> {
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    const entries: Array<{ key: string; value: unknown; path: string }> = [];

    for (const [key, value] of this.data.entries()) {
      if (key.startsWith(normalizedPath + '/')) {
        const relativePath = key.substring(normalizedPath.length + 1);
        const parts = relativePath.split('/');
        if (parts.length === 1) {
          entries.push({
            key: parts[0],
            value,
            path: key,
          });
        }
      }
    }

    return entries;
  }

  /**
   * Clear all data
   */
  clear(): void {
    this.data.clear();
  }

  /**
   * Debug: dump all data
   */
  dump(): Record<string, unknown> {
    const result: Record<string, unknown> = {};
    for (const [key, value] of this.data.entries()) {
      result[key] = value;
    }
    return result;
  }
}

```

修改 `set` 方法标记路径为 dirty：

```typescript
/**
 * A2UI Data Model Manager
 */
import type { ValueMap, BoundValue } from './types';

export class DataModel {
  private data: Map<string, unknown> = new Map();
  private dirtyPaths: Set<string> = new Set(); // Paths modified by user input

  /**
   * Update data model from ValueMap contents (from server)
   * Skips paths marked as dirty by user input
   */
  update(path: string, contents: ValueMap[]): void {
    const basePath = path.startsWith('/') ? path : `/${path}`;

    for (const item of contents) {
      const fullPath = `${basePath}/${item.key}`;
      
      // Skip paths that have been modified by user input
      if (this.dirtyPaths.has(fullPath)) {
        console.log(`Skipping server update for dirty path: ${fullPath}`);
        continue;
      }
      
      const value = this.extractValue(item);
      this.data.set(fullPath, value);

      // Also store nested paths for valueMap items
      if (item.valueMap !== undefined) {
        this.storeNestedPaths(fullPath, item.valueMap);
      }
    }
  }

  /**
   * Recursively store nested ValueMap paths
   */
  private storeNestedPaths(basePath: string, contents: ValueMap[]): void {
    for (const item of contents) {
      const fullPath = `${basePath}/${item.key}`;
      
      // Skip paths that have been modified by user input
      if (this.dirtyPaths.has(fullPath)) {
        console.log(`Skipping server update for dirty path: ${fullPath}`);
        continue;
      }
      
      const value = this.extractValue(item);
      this.data.set(fullPath, value);

      if (item.valueMap !== undefined) {
        this.storeNestedPaths(fullPath, item.valueMap);
      }
    }
  }

  /**
   * Get value at path
   */
  get(path: string): unknown {
    // Handle relative paths (starting with .)
    if (path === '.' || path === '') {
      return undefined;
    }

    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    return this.data.get(normalizedPath);
  }

  /**
   * Set value at path (called by user input)
   * Marks the path as dirty to prevent server updates from overwriting
   */
  set(path: string, value: unknown): void {
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    this.data.set(normalizedPath, value);
    this.dirtyPaths.add(normalizedPath);
    console.log(`DataModel.set: ${normalizedPath} = ${value} (marked dirty)`);
  }

  /**
   * Clear dirty flag for a path (called after submitting)
   */
  clearDirty(path: string): void {
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    this.dirtyPaths.delete(normalizedPath);
  }

  /**
   * Clear all dirty flags
   */
  clearAllDirty(): void {
    this.dirtyPaths.clear();
  }

  /**
   * Resolve a BoundValue to its actual value
   */
  resolve(value: BoundValue, contextPath?: string): unknown {
    if ('literalString' in value) {
      return value.literalString;
    }
    if ('literalNumber' in value) {
      return value.literalNumber;
    }
    if ('literalBoolean' in value) {
      return value.literalBoolean;
    }
    if ('path' in value) {
      const resolvedPath = this.resolvePath(value.path, contextPath);
      return this.get(resolvedPath);
    }
    return undefined;
  }

  /**
   * Resolve a path considering context
   */
  private resolvePath(path: string, contextPath?: string): string {
    if (path.startsWith('/')) {
      return path;
    }
    if (contextPath) {
      return `${contextPath}/${path}`;
    }
    return path;
  }

  /**
   * Extract value from ValueMap item
   */
  private extractValue(item: ValueMap): unknown {
    if (item.valueString !== undefined) {
      return item.valueString;
    }
    if (item.valueNumber !== undefined) {
      return item.valueNumber;
    }
    if (item.valueBoolean !== undefined) {
      return item.valueBoolean;
    }
    if (item.valueMap !== undefined) {
      // Convert nested ValueMap to object
      const obj: Record<string, unknown> = {};
      for (const nested of item.valueMap) {
        obj[nested.key] = this.extractValue(nested);
      }
      return obj;
    }
    return undefined;
  }

  /**
   * Get all entries under a path (for list templates)
   */
  getEntries(path: string): Array<{ key: string; value: unknown; path: string }> {
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    const entries: Array<{ key: string; value: unknown; path: string }> = [];

    for (const [key, value] of this.data.entries()) {
      if (key.startsWith(normalizedPath + '/')) {
        const relativePath = key.substring(normalizedPath.length + 1);
        const parts = relativePath.split('/');
        if (parts.length === 1) {
          entries.push({
            key: parts[0],
            value,
            path: key,
          });
        }
      }
    }

    return entries;
  }

  /**
   * Clear all data
   */
  clear(): void {
    this.data.clear();
  }

  /**
   * Debug: dump all data
   */
  dump(): Record<string, unknown> {
    const result: Record<string, unknown> = {};
    for (const [key, value] of this.data.entries()) {
      result[key] = value;
    }
    return result;
  }
}

```

修改 `clear` 方法同时清除 dirty 集合：

```typescript
/**
 * A2UI Data Model Manager
 */
import type { ValueMap, BoundValue } from './types';

export class DataModel {
  private data: Map<string, unknown> = new Map();
  private dirtyPaths: Set<string> = new Set(); // Paths modified by user input

  /**
   * Update data model from ValueMap contents (from server)
   * Skips paths marked as dirty by user input
   */
  update(path: string, contents: ValueMap[]): void {
    const basePath = path.startsWith('/') ? path : `/${path}`;

    for (const item of contents) {
      const fullPath = `${basePath}/${item.key}`;
      
      // Skip paths that have been modified by user input
      if (this.dirtyPaths.has(fullPath)) {
        console.log(`Skipping server update for dirty path: ${fullPath}`);
        continue;
      }
      
      const value = this.extractValue(item);
      this.data.set(fullPath, value);

      // Also store nested paths for valueMap items
      if (item.valueMap !== undefined) {
        this.storeNestedPaths(fullPath, item.valueMap);
      }
    }
  }

  /**
   * Recursively store nested ValueMap paths
   */
  private storeNestedPaths(basePath: string, contents: ValueMap[]): void {
    for (const item of contents) {
      const fullPath = `${basePath}/${item.key}`;
      
      // Skip paths that have been modified by user input
      if (this.dirtyPaths.has(fullPath)) {
        console.log(`Skipping server update for dirty path: ${fullPath}`);
        continue;
      }
      
      const value = this.extractValue(item);
      this.data.set(fullPath, value);

      if (item.valueMap !== undefined) {
        this.storeNestedPaths(fullPath, item.valueMap);
      }
    }
  }

  /**
   * Get value at path
   */
  get(path: string): unknown {
    // Handle relative paths (starting with .)
    if (path === '.' || path === '') {
      return undefined;
    }

    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    return this.data.get(normalizedPath);
  }

  /**
   * Set value at path (called by user input)
   * Marks the path as dirty to prevent server updates from overwriting
   */
  set(path: string, value: unknown): void {
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    this.data.set(normalizedPath, value);
    this.dirtyPaths.add(normalizedPath);
    console.log(`DataModel.set: ${normalizedPath} = ${value} (marked dirty)`);
  }

  /**
   * Clear dirty flag for a path (called after submitting)
   */
  clearDirty(path: string): void {
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    this.dirtyPaths.delete(normalizedPath);
  }

  /**
   * Clear all dirty flags
   */
  clearAllDirty(): void {
    this.dirtyPaths.clear();
  }

  /**
   * Resolve a BoundValue to its actual value
   */
  resolve(value: BoundValue, contextPath?: string): unknown {
    if ('literalString' in value) {
      return value.literalString;
    }
    if ('literalNumber' in value) {
      return value.literalNumber;
    }
    if ('literalBoolean' in value) {
      return value.literalBoolean;
    }
    if ('path' in value) {
      const resolvedPath = this.resolvePath(value.path, contextPath);
      return this.get(resolvedPath);
    }
    return undefined;
  }

  /**
   * Resolve a path considering context
   */
  private resolvePath(path: string, contextPath?: string): string {
    if (path.startsWith('/')) {
      return path;
    }
    if (contextPath) {
      return `${contextPath}/${path}`;
    }
    return path;
  }

  /**
   * Extract value from ValueMap item
   */
  private extractValue(item: ValueMap): unknown {
    if (item.valueString !== undefined) {
      return item.valueString;
    }
    if (item.valueNumber !== undefined) {
      return item.valueNumber;
    }
    if (item.valueBoolean !== undefined) {
      return item.valueBoolean;
    }
    if (item.valueMap !== undefined) {
      // Convert nested ValueMap to object
      const obj: Record<string, unknown> = {};
      for (const nested of item.valueMap) {
        obj[nested.key] = this.extractValue(nested);
      }
      return obj;
    }
    return undefined;
  }

  /**
   * Get all entries under a path (for list templates)
   */
  getEntries(path: string): Array<{ key: string; value: unknown; path: string }> {
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    const entries: Array<{ key: string; value: unknown; path: string }> = [];

    for (const [key, value] of this.data.entries()) {
      if (key.startsWith(normalizedPath + '/')) {
        const relativePath = key.substring(normalizedPath.length + 1);
        const parts = relativePath.split('/');
        if (parts.length === 1) {
          entries.push({
            key: parts[0],
            value,
            path: key,
          });
        }
      }
    }

    return entries;
  }

  /**
   * Clear all data and dirty flags
   */
  clear(): void {
    this.data.clear();
    this.dirtyPaths.clear();
  }

  /**
   * Debug: dump all data
   */
  dump(): Record<string, unknown> {
    const result: Record<string, unknown> = {};
    for (const [key, value] of this.data.entries()) {
      result[key] = value;
    }
    return result;
  }
}

```

检查搜索按钮的配置：

让我检查 `text_field` 的实现：

```python
builder.text_field("tickets-search", "搜索票据...", builder.path("/app/tickets/query/search"))
```

```typescript
const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
```

检查 A2UISurface 类中 dataModel 的使用：

检查 `a2ui-textfield` 组件定义：

```typescript
private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
  if (!value) return undefined;  return this.dataModel.resolve(value, contextPath);}
```

```plaintext
  if ('literalString' in value) {    return value.literalString;
  }  if ('literalNumber' in value) {
    return value.literalNumber;  }
  if ('literalBoolean' in value) {    return value.literalBoolean;
  }  if ('path' in value) {
    const resolvedPath = this.resolvePath(value.path, contextPath);    return this.get(resolvedPath);
  }  return undefined;
}
```

我看到有编译警告。让我重新检查完整的 `main.ts` 确保没有重复声明：

检查 Python 服务器是否正常运行：

检查 renderButton 实现：

检查 handleAction 的实现：

```plaintext
  if (this.surface && message.surfaceUpdate.surfaceId === this.surface.surfaceId) {
    this.surface.setComponents(message.surfaceUpdate.components);
  }}
```

让我检查服务端发送消息的顺序：

```plaintext
  this.lastConnectedPath = this.currentPath;}
```

让我检查服务端 action 处理逻辑：

```python
search_term = context.get('search') or ''
```

```python
{"key": "search", "value": {"path": "/app/tickets/query/search"}},
```

问题可能是 `.value` 绑定方式。让我修改为使用不同的绑定方式，避免每次渲染覆盖用户输入：

让我修改 handleInput 添加更详细的日志来调试：

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    // Check if this is a filter button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    
    // Check if this filter button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isFilterButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

添加日志到 handleAction 来验证：

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    // Check if this is a filter button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    
    // Check if this filter button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isFilterButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

重启 Python 服务器并请用户测试：

服务器已启动。我已添加调试日志来帮助诊断问题。请执行以下测试步骤：

1. **刷新浏览器页面** (http://localhost:5173)
2. **打开浏览器开发者工具** (F12 或 Cmd+Option+I)
3. **切换到 Console 标签**
4. **在搜索输入框中输入一些文字**（如 "test"）
5. **观察控制台输出**，应该看到类似：
   - `[TextField tickets-search] handleInput called, value: "t"`
   - `[TextField tickets-search] DataModel updated: /app/tickets/query/search = "t"`
6. **点击搜索按钮**
7. **观察控制台输出**，应该看到：
   - `[A2UISurface] handleAction called: search_tickets from tickets-search-btn`
   - `[A2UISurface] Before action, DataModel /app/tickets/query/search = "test"`

**我做的修改：**

1. **添加了 dirty 标记机制** (`data-model.ts`)：
   - 用户输入会标记路径为 "dirty"
   - 服务端的 dataModelUpdate 会跳过 dirty 路径，防止覆盖用户输入

2. **添加了详细调试日志** (`renderer.ts`)：
   - 输入框每次输入都会打印日志
   - 搜索按钮点击时会打印当前 DataModel 状态

请测试后告诉我：
- 输入时控制台是否有日志输出？
- 点击搜索时 DataModel 中的搜索值是否正确？

---

**User**

新建票据和新建标签中的按钮都没有实际的生效。请全面排查项目中是否还存在这个问题，请及时修复

---

**Cursor**

让我检查新建票据和新建标签的按钮实现：

检查表单输入框配置：

问题可能是 DataModel 无法获取嵌套对象。检查当前实现：

需要添加获取嵌套对象的功能。修改 DataModel：

```typescript
/**
 * A2UI Data Model Manager
 */
import type { ValueMap, BoundValue } from './types';

export class DataModel {
  private data: Map<string, unknown> = new Map();
  private dirtyPaths: Set<string> = new Set(); // Paths modified by user input

  /**
   * Update data model from ValueMap contents (from server)
   * Skips paths marked as dirty by user input
   */
  update(path: string, contents: ValueMap[]): void {
    const basePath = path.startsWith('/') ? path : `/${path}`;

    for (const item of contents) {
      const fullPath = `${basePath}/${item.key}`;
      
      // Skip paths that have been modified by user input
      if (this.dirtyPaths.has(fullPath)) {
        console.log(`Skipping server update for dirty path: ${fullPath}`);
        continue;
      }
      
      const value = this.extractValue(item);
      this.data.set(fullPath, value);

      // Also store nested paths for valueMap items
      if (item.valueMap !== undefined) {
        this.storeNestedPaths(fullPath, item.valueMap);
      }
    }
  }

  /**
   * Recursively store nested ValueMap paths
   */
  private storeNestedPaths(basePath: string, contents: ValueMap[]): void {
    for (const item of contents) {
      const fullPath = `${basePath}/${item.key}`;
      
      // Skip paths that have been modified by user input
      if (this.dirtyPaths.has(fullPath)) {
        console.log(`Skipping server update for dirty path: ${fullPath}`);
        continue;
      }
      
      const value = this.extractValue(item);
      this.data.set(fullPath, value);

      if (item.valueMap !== undefined) {
        this.storeNestedPaths(fullPath, item.valueMap);
      }
    }
  }

  /**
   * Get value at path
   * If the path has no direct value but has children, returns an object with all children
   */
  get(path: string): unknown {
    // Handle relative paths (starting with .)
    if (path === '.' || path === '') {
      return undefined;
    }

    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    
    // First, check if there's a direct value at this path
    const directValue = this.data.get(normalizedPath);
    if (directValue !== undefined) {
      return directValue;
    }
    
    // If no direct value, collect all children into an object
    const prefix = normalizedPath + '/';
    const result: Record<string, unknown> = {};
    let hasChildren = false;
    
    for (const [key, value] of this.data.entries()) {
      if (key.startsWith(prefix)) {
        const relativePath = key.substring(prefix.length);
        const parts = relativePath.split('/');
        
        // Only get immediate children (not nested paths)
        if (parts.length === 1) {
          result[parts[0]] = value;
          hasChildren = true;
        }
      }
    }
    
    return hasChildren ? result : undefined;
  }

  /**
   * Set value at path (called by user input)
   * Marks the path as dirty to prevent server updates from overwriting
   */
  set(path: string, value: unknown): void {
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    this.data.set(normalizedPath, value);
    this.dirtyPaths.add(normalizedPath);
    console.log(`DataModel.set: ${normalizedPath} = ${value} (marked dirty)`);
  }

  /**
   * Clear dirty flag for a path (called after submitting)
   */
  clearDirty(path: string): void {
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    this.dirtyPaths.delete(normalizedPath);
  }

  /**
   * Clear all dirty flags
   */
  clearAllDirty(): void {
    this.dirtyPaths.clear();
  }

  /**
   * Resolve a BoundValue to its actual value
   */
  resolve(value: BoundValue, contextPath?: string): unknown {
    if ('literalString' in value) {
      return value.literalString;
    }
    if ('literalNumber' in value) {
      return value.literalNumber;
    }
    if ('literalBoolean' in value) {
      return value.literalBoolean;
    }
    if ('path' in value) {
      const resolvedPath = this.resolvePath(value.path, contextPath);
      return this.get(resolvedPath);
    }
    return undefined;
  }

  /**
   * Resolve a path considering context
   */
  private resolvePath(path: string, contextPath?: string): string {
    if (path.startsWith('/')) {
      return path;
    }
    if (contextPath) {
      return `${contextPath}/${path}`;
    }
    return path;
  }

  /**
   * Extract value from ValueMap item
   */
  private extractValue(item: ValueMap): unknown {
    if (item.valueString !== undefined) {
      return item.valueString;
    }
    if (item.valueNumber !== undefined) {
      return item.valueNumber;
    }
    if (item.valueBoolean !== undefined) {
      return item.valueBoolean;
    }
    if (item.valueMap !== undefined) {
      // Convert nested ValueMap to object
      const obj: Record<string, unknown> = {};
      for (const nested of item.valueMap) {
        obj[nested.key] = this.extractValue(nested);
      }
      return obj;
    }
    return undefined;
  }

  /**
   * Get all entries under a path (for list templates)
   */
  getEntries(path: string): Array<{ key: string; value: unknown; path: string }> {
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    const entries: Array<{ key: string; value: unknown; path: string }> = [];

    for (const [key, value] of this.data.entries()) {
      if (key.startsWith(normalizedPath + '/')) {
        const relativePath = key.substring(normalizedPath.length + 1);
        const parts = relativePath.split('/');
        if (parts.length === 1) {
          entries.push({
            key: parts[0],
            value,
            path: key,
          });
        }
      }
    }

    return entries;
  }

  /**
   * Clear all data and dirty flags
   */
  clear(): void {
    this.data.clear();
    this.dirtyPaths.clear();
  }

  /**
   * Debug: dump all data
   */
  dump(): Record<string, unknown> {
    const result: Record<string, unknown> = {};
    for (const [key, value] of this.data.entries()) {
      result[key] = value;
    }
    return result;
  }
}

```

```python
form_data = [
    value_string("title", ""),
    value_string("description", ""),
    value_string("priority", "medium"),
]
messages.append(builder.build_data_model_update("/app/form/create", form_data))
```

现在检查优先级设置逻辑 - `set_form_priority` action：

需要在客户端处理 `set_form_priority` 等 action。修改 `main.ts`：

```typescript
/**
 * A2UI Client Shell - Main entry point
 */
import './renderer';
import type { A2UIMessage, Action, UserAction, SurfaceUpdate, DataModelUpdate, BeginRendering } from './types';
import type { A2UISurface } from './renderer';

class A2UIClient {
  private surface: A2UISurface | null = null;
  private eventSource: EventSource | null = null;
  private currentPath: string = '/';
  private lastConnectedPath: string = '';

  constructor() {
    this.init();
  }

  private async init(): Promise<void> {
    // Create surface element
    const app = document.getElementById('app');
    if (!app) {
      console.error('App container not found');
      return;
    }

    // Clear loading state
    app.innerHTML = '';

    // Create surface
    this.surface = document.createElement('a2ui-surface') as A2UISurface;
    this.surface.surfaceId = 'main';
    this.surface.setActionHandler((action, sourceId, contextPath) => this.handleAction(action, sourceId, contextPath));
    app.appendChild(this.surface);

    // Get initial path from URL
    this.currentPath = window.location.pathname + window.location.search;

    // Handle browser navigation
    window.addEventListener('popstate', () => {
      this.currentPath = window.location.pathname + window.location.search;
      this.connect();
    });

    // Connect to server
    this.connect();
  }

  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Only clear data model when path changes (navigation), not on reconnect
    if (this.surface && this.currentPath !== this.lastConnectedPath) {
      this.surface.dataModel.clear();
      this.lastConnectedPath = this.currentPath;
    }

    // Build SSE URL
    const sseUrl = `/api/a2ui/stream?path=${encodeURIComponent(this.currentPath)}`;
    console.log(`Connecting to: ${sseUrl}`);

    this.eventSource = new EventSource(sseUrl);

    this.eventSource.onmessage = (event) => {
      this.handleMessage(event.data);
    };

    this.eventSource.onerror = (error) => {
      console.error('SSE error:', error);
      // Attempt to reconnect after delay
      setTimeout(() => {
        if (this.eventSource?.readyState === EventSource.CLOSED) {
          this.connect();
        }
      }, 3000);
    };

    this.eventSource.onopen = () => {
      console.log('SSE connection established');
    };
  }

  private handleMessage(data: string): void {
    try {
      const message: A2UIMessage = JSON.parse(data);

      if ('surfaceUpdate' in message) {
        this.handleSurfaceUpdate(message as SurfaceUpdate);
      } else if ('dataModelUpdate' in message) {
        this.handleDataModelUpdate(message as DataModelUpdate);
      } else if ('beginRendering' in message) {
        this.handleBeginRendering(message as BeginRendering);
      } else if ('deleteSurface' in message) {
        console.log('Surface deleted');
      }
    } catch (error) {
      console.error('Error parsing message:', error, data);
    }
  }

  private handleSurfaceUpdate(message: SurfaceUpdate): void {
    if (this.surface && message.surfaceUpdate.surfaceId === this.surface.surfaceId) {
      this.surface.setComponents(message.surfaceUpdate.components);
    }
  }

  private handleDataModelUpdate(message: DataModelUpdate): void {
    if (this.surface && message.dataModelUpdate.surfaceId === this.surface.surfaceId) {
      const path = message.dataModelUpdate.path || '/';
      this.surface.dataModel.update(path, message.dataModelUpdate.contents);
    }
  }

  private handleBeginRendering(message: BeginRendering): void {
    if (this.surface && message.beginRendering.surfaceId === this.surface.surfaceId) {
      this.surface.setRoot(message.beginRendering.root);
    }
  }

  private async handleAction(action: Action, sourceId: string, contextPath?: string): Promise<void> {
    console.log(`Action: ${action.name} from ${sourceId}`, action.context, `contextPath: ${contextPath}`);

    // Build context object from action.context array
    // Pass contextPath to resolve relative paths (e.g., "id" -> "/app/tickets/list/ticket0/id")
    const context: Record<string, unknown> = {};
    if (action.context) {
      for (const item of action.context) {
        const value = this.surface?.dataModel.resolve(item.value, contextPath);
        // Convert undefined to null to ensure it's included in JSON
        context[item.key] = value !== undefined ? value : null;
        console.log(`  Context ${item.key}:`, value, 'from', item.value);
      }
    }

    // Build userAction
    const userAction: UserAction = {
      name: action.name,
      surfaceId: this.surface?.surfaceId || 'main',
      sourceComponentId: sourceId,
      timestamp: new Date().toISOString(),
      context,
    };

    try {
      const response = await fetch('/api/a2ui/action', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(userAction),
      });

      if (!response.ok) {
        throw new Error(`Action failed: ${response.statusText}`);
      }

      const result = await response.json();
      console.log('Action result:', result);

      // Handle navigation
      if (result.result?.navigate) {
        this.navigate(result.result.navigate);
      } else if (result.result?.refresh) {
        this.connect();
      } else if (result.result?.handled) {
        // Handle client-side actions
        this.handleClientSideAction(action.name, context);
      }
    } catch (error) {
      console.error('Error sending action:', error);
    }
  }

  private navigate(path: string): void {
    // Update URL without reload
    window.history.pushState({}, '', path);
    // Store full path including query string for SSE reconnection
    this.currentPath = path;

    // Reconnect to get new page
    this.connect();
  }
}

// Initialize client
new A2UIClient();

```

```typescript
/**
 * A2UI Client Shell - Main entry point
 */
import './renderer';
import type { A2UIMessage, Action, UserAction, SurfaceUpdate, DataModelUpdate, BeginRendering } from './types';
import type { A2UISurface } from './renderer';

class A2UIClient {
  private surface: A2UISurface | null = null;
  private eventSource: EventSource | null = null;
  private currentPath: string = '/';
  private lastConnectedPath: string = '';

  constructor() {
    this.init();
  }

  private async init(): Promise<void> {
    // Create surface element
    const app = document.getElementById('app');
    if (!app) {
      console.error('App container not found');
      return;
    }

    // Clear loading state
    app.innerHTML = '';

    // Create surface
    this.surface = document.createElement('a2ui-surface') as A2UISurface;
    this.surface.surfaceId = 'main';
    this.surface.setActionHandler((action, sourceId, contextPath) => this.handleAction(action, sourceId, contextPath));
    app.appendChild(this.surface);

    // Get initial path from URL
    this.currentPath = window.location.pathname + window.location.search;

    // Handle browser navigation
    window.addEventListener('popstate', () => {
      this.currentPath = window.location.pathname + window.location.search;
      this.connect();
    });

    // Connect to server
    this.connect();
  }

  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Only clear data model when path changes (navigation), not on reconnect
    if (this.surface && this.currentPath !== this.lastConnectedPath) {
      this.surface.dataModel.clear();
      this.lastConnectedPath = this.currentPath;
    }

    // Build SSE URL
    const sseUrl = `/api/a2ui/stream?path=${encodeURIComponent(this.currentPath)}`;
    console.log(`Connecting to: ${sseUrl}`);

    this.eventSource = new EventSource(sseUrl);

    this.eventSource.onmessage = (event) => {
      this.handleMessage(event.data);
    };

    this.eventSource.onerror = (error) => {
      console.error('SSE error:', error);
      // Attempt to reconnect after delay
      setTimeout(() => {
        if (this.eventSource?.readyState === EventSource.CLOSED) {
          this.connect();
        }
      }, 3000);
    };

    this.eventSource.onopen = () => {
      console.log('SSE connection established');
    };
  }

  private handleMessage(data: string): void {
    try {
      const message: A2UIMessage = JSON.parse(data);

      if ('surfaceUpdate' in message) {
        this.handleSurfaceUpdate(message as SurfaceUpdate);
      } else if ('dataModelUpdate' in message) {
        this.handleDataModelUpdate(message as DataModelUpdate);
      } else if ('beginRendering' in message) {
        this.handleBeginRendering(message as BeginRendering);
      } else if ('deleteSurface' in message) {
        console.log('Surface deleted');
      }
    } catch (error) {
      console.error('Error parsing message:', error, data);
    }
  }

  private handleSurfaceUpdate(message: SurfaceUpdate): void {
    if (this.surface && message.surfaceUpdate.surfaceId === this.surface.surfaceId) {
      this.surface.setComponents(message.surfaceUpdate.components);
    }
  }

  private handleDataModelUpdate(message: DataModelUpdate): void {
    if (this.surface && message.dataModelUpdate.surfaceId === this.surface.surfaceId) {
      const path = message.dataModelUpdate.path || '/';
      this.surface.dataModel.update(path, message.dataModelUpdate.contents);
    }
  }

  private handleBeginRendering(message: BeginRendering): void {
    if (this.surface && message.beginRendering.surfaceId === this.surface.surfaceId) {
      this.surface.setRoot(message.beginRendering.root);
    }
  }

  private async handleAction(action: Action, sourceId: string, contextPath?: string): Promise<void> {
    console.log(`Action: ${action.name} from ${sourceId}`, action.context, `contextPath: ${contextPath}`);

    // Build context object from action.context array
    // Pass contextPath to resolve relative paths (e.g., "id" -> "/app/tickets/list/ticket0/id")
    const context: Record<string, unknown> = {};
    if (action.context) {
      for (const item of action.context) {
        const value = this.surface?.dataModel.resolve(item.value, contextPath);
        // Convert undefined to null to ensure it's included in JSON
        context[item.key] = value !== undefined ? value : null;
        console.log(`  Context ${item.key}:`, value, 'from', item.value);
      }
    }

    // Build userAction
    const userAction: UserAction = {
      name: action.name,
      surfaceId: this.surface?.surfaceId || 'main',
      sourceComponentId: sourceId,
      timestamp: new Date().toISOString(),
      context,
    };

    try {
      const response = await fetch('/api/a2ui/action', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(userAction),
      });

      if (!response.ok) {
        throw new Error(`Action failed: ${response.statusText}`);
      }

      const result = await response.json();
      console.log('Action result:', result);

      // Handle navigation
      if (result.result?.navigate) {
        this.navigate(result.result.navigate);
      } else if (result.result?.refresh) {
        this.connect();
      } else if (result.result?.handled) {
        // Handle client-side actions
        this.handleClientSideAction(action.name, context);
      }
    } catch (error) {
      console.error('Error sending action:', error);
    }
  }

  private navigate(path: string): void {
    // Update URL without reload
    window.history.pushState({}, '', path);
    // Store full path including query string for SSE reconnection
    this.currentPath = path;

    // Reconnect to get new page
    this.connect();
  }

  private handleClientSideAction(name: string, context: Record<string, unknown>): void {
    if (!this.surface) return;
    
    console.log(`[Client] Handling client-side action: ${name}`, context);
    
    if (name === 'set_form_priority') {
      // Determine the form path based on current page
      const priority = context.priority as string;
      const isEditPage = this.currentPath.includes('/edit');
      const formPath = isEditPage ? '/app/form/edit/priority' : '/app/form/create/priority';
      this.surface.dataModel.set(formPath, priority);
      console.log(`[Client] Set ${formPath} = ${priority}`);
    } else if (name === 'set_tag_color') {
      // Set tag form color
      const color = context.color as string;
      this.surface.dataModel.set('/app/tags/form/color', color);
      console.log(`[Client] Set /app/tags/form/color = ${color}`);
    } else if (name === 'show_create_tag_form') {
      this.surface.dataModel.set('/app/tags/showForm', true);
      console.log(`[Client] Set /app/tags/showForm = true`);
    } else if (name === 'hide_create_tag_form') {
      this.surface.dataModel.set('/app/tags/showForm', false);
      console.log(`[Client] Set /app/tags/showForm = false`);
    } else if (name === 'show_delete_dialog') {
      // Show delete confirmation dialog
      const id = context.id as string;
      this.surface.dataModel.set('/app/dialog/deleteId', id);
      this.surface.dataModel.set('/app/dialog/show', true);
      console.log(`[Client] Show delete dialog for id: ${id}`);
    } else if (name === 'dismiss_dialog') {
      this.surface.dataModel.set('/app/dialog/show', false);
      console.log(`[Client] Dismiss dialog`);
    }
  }
}

// Initialize client
new A2UIClient();

```

检查标签颜色按钮配置：

检查标签表单数据初始化：

检查服务器状态并确保正在运行：

服务器正在运行。我已经做了以下修复：

**问题分析：**
1. 表单输入框的值存储在子路径（如 `/app/form/create/title`），但按钮请求整个表单对象（`/app/form/create`）
2. `set_form_priority`、`set_tag_color` 等客户端 action 没有实际更新 DataModel

**修复内容：**

1. **`data-model.ts`** - 修改 `get` 方法支持获取嵌套对象：
   - 当请求路径没有直接值时，自动收集所有子路径构建对象
   - 例如 `get('/app/form/create')` 会返回 `{title: "...", description: "...", priority: "..."}`

2. **`main.ts`** - 添加客户端 action 处理：
   - `set_form_priority`: 根据当前页面更新表单优先级
   - `set_tag_color`: 更新标签颜色
   - `show_create_tag_form` / `hide_create_tag_form`: 控制表单显示
   - `show_delete_dialog` / `dismiss_dialog`: 控制删除确认对话框

请刷新页面并测试：
1. **新建票据**：填写标题和描述，选择优先级，点击创建
2. **新建标签**：填写名称，选择颜色，点击创建
3. **编辑票据**：修改内容后保存

如果在浏览器控制台看到类似以下日志，说明功能正常：
- `[Client] Set /app/form/create/priority = high`
- `DataModel.set: /app/form/create/title = "测试" (marked dirty)`

---

**User**

新建票据的时候，如果选中了一个优先级应该有高亮的显示以明确哪个优先级被选中了。

---

**Cursor**

我来修改 renderer.ts，让优先级按钮能够高亮显示选中状态：

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    // Check if this is a filter button or form priority button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isSelectableButton = isFilterButton || isFormPriorityButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isFilterButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    // Check if this is a filter button or form priority button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isSelectableButton = isFilterButton || isFormPriorityButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

需要在客户端 action 后触发重新渲染。修改 `main.ts`：

```typescript
/**
 * A2UI Client Shell - Main entry point
 */
import './renderer';
import type { A2UIMessage, Action, UserAction, SurfaceUpdate, DataModelUpdate, BeginRendering } from './types';
import type { A2UISurface } from './renderer';

class A2UIClient {
  private surface: A2UISurface | null = null;
  private eventSource: EventSource | null = null;
  private currentPath: string = '/';
  private lastConnectedPath: string = '';

  constructor() {
    this.init();
  }

  private async init(): Promise<void> {
    // Create surface element
    const app = document.getElementById('app');
    if (!app) {
      console.error('App container not found');
      return;
    }

    // Clear loading state
    app.innerHTML = '';

    // Create surface
    this.surface = document.createElement('a2ui-surface') as A2UISurface;
    this.surface.surfaceId = 'main';
    this.surface.setActionHandler((action, sourceId, contextPath) => this.handleAction(action, sourceId, contextPath));
    app.appendChild(this.surface);

    // Get initial path from URL
    this.currentPath = window.location.pathname + window.location.search;

    // Handle browser navigation
    window.addEventListener('popstate', () => {
      this.currentPath = window.location.pathname + window.location.search;
      this.connect();
    });

    // Connect to server
    this.connect();
  }

  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Only clear data model when path changes (navigation), not on reconnect
    if (this.surface && this.currentPath !== this.lastConnectedPath) {
      this.surface.dataModel.clear();
      this.lastConnectedPath = this.currentPath;
    }

    // Build SSE URL
    const sseUrl = `/api/a2ui/stream?path=${encodeURIComponent(this.currentPath)}`;
    console.log(`Connecting to: ${sseUrl}`);

    this.eventSource = new EventSource(sseUrl);

    this.eventSource.onmessage = (event) => {
      this.handleMessage(event.data);
    };

    this.eventSource.onerror = (error) => {
      console.error('SSE error:', error);
      // Attempt to reconnect after delay
      setTimeout(() => {
        if (this.eventSource?.readyState === EventSource.CLOSED) {
          this.connect();
        }
      }, 3000);
    };

    this.eventSource.onopen = () => {
      console.log('SSE connection established');
    };
  }

  private handleMessage(data: string): void {
    try {
      const message: A2UIMessage = JSON.parse(data);

      if ('surfaceUpdate' in message) {
        this.handleSurfaceUpdate(message as SurfaceUpdate);
      } else if ('dataModelUpdate' in message) {
        this.handleDataModelUpdate(message as DataModelUpdate);
      } else if ('beginRendering' in message) {
        this.handleBeginRendering(message as BeginRendering);
      } else if ('deleteSurface' in message) {
        console.log('Surface deleted');
      }
    } catch (error) {
      console.error('Error parsing message:', error, data);
    }
  }

  private handleSurfaceUpdate(message: SurfaceUpdate): void {
    if (this.surface && message.surfaceUpdate.surfaceId === this.surface.surfaceId) {
      this.surface.setComponents(message.surfaceUpdate.components);
    }
  }

  private handleDataModelUpdate(message: DataModelUpdate): void {
    if (this.surface && message.dataModelUpdate.surfaceId === this.surface.surfaceId) {
      const path = message.dataModelUpdate.path || '/';
      this.surface.dataModel.update(path, message.dataModelUpdate.contents);
    }
  }

  private handleBeginRendering(message: BeginRendering): void {
    if (this.surface && message.beginRendering.surfaceId === this.surface.surfaceId) {
      this.surface.setRoot(message.beginRendering.root);
    }
  }

  private async handleAction(action: Action, sourceId: string, contextPath?: string): Promise<void> {
    console.log(`Action: ${action.name} from ${sourceId}`, action.context, `contextPath: ${contextPath}`);

    // Build context object from action.context array
    // Pass contextPath to resolve relative paths (e.g., "id" -> "/app/tickets/list/ticket0/id")
    const context: Record<string, unknown> = {};
    if (action.context) {
      for (const item of action.context) {
        const value = this.surface?.dataModel.resolve(item.value, contextPath);
        // Convert undefined to null to ensure it's included in JSON
        context[item.key] = value !== undefined ? value : null;
        console.log(`  Context ${item.key}:`, value, 'from', item.value);
      }
    }

    // Build userAction
    const userAction: UserAction = {
      name: action.name,
      surfaceId: this.surface?.surfaceId || 'main',
      sourceComponentId: sourceId,
      timestamp: new Date().toISOString(),
      context,
    };

    try {
      const response = await fetch('/api/a2ui/action', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(userAction),
      });

      if (!response.ok) {
        throw new Error(`Action failed: ${response.statusText}`);
      }

      const result = await response.json();
      console.log('Action result:', result);

      // Handle navigation
      if (result.result?.navigate) {
        this.navigate(result.result.navigate);
      } else if (result.result?.refresh) {
        this.connect();
      } else if (result.result?.handled) {
        // Handle client-side actions
        this.handleClientSideAction(action.name, context);
      }
    } catch (error) {
      console.error('Error sending action:', error);
    }
  }

  private navigate(path: string): void {
    // Update URL without reload
    window.history.pushState({}, '', path);
    // Store full path including query string for SSE reconnection
    this.currentPath = path;

    // Reconnect to get new page
    this.connect();
  }

  private handleClientSideAction(name: string, context: Record<string, unknown>): void {
    if (!this.surface) return;
    
    console.log(`[Client] Handling client-side action: ${name}`, context);
    
    let needsUpdate = false;
    
    if (name === 'set_form_priority') {
      // Determine the form path based on current page
      const priority = context.priority as string;
      const isEditPage = this.currentPath.includes('/edit');
      const formPath = isEditPage ? '/app/form/edit/priority' : '/app/form/create/priority';
      this.surface.dataModel.set(formPath, priority);
      console.log(`[Client] Set ${formPath} = ${priority}`);
      needsUpdate = true;
    } else if (name === 'set_tag_color') {
      // Set tag form color
      const color = context.color as string;
      this.surface.dataModel.set('/app/tags/form/color', color);
      console.log(`[Client] Set /app/tags/form/color = ${color}`);
      needsUpdate = true;
    } else if (name === 'show_create_tag_form') {
      this.surface.dataModel.set('/app/tags/showForm', true);
      console.log(`[Client] Set /app/tags/showForm = true`);
      needsUpdate = true;
    } else if (name === 'hide_create_tag_form') {
      this.surface.dataModel.set('/app/tags/showForm', false);
      console.log(`[Client] Set /app/tags/showForm = false`);
      needsUpdate = true;
    } else if (name === 'show_delete_dialog') {
      // Show delete confirmation dialog
      const id = context.id as string;
      this.surface.dataModel.set('/app/dialog/deleteId', id);
      this.surface.dataModel.set('/app/dialog/show', true);
      console.log(`[Client] Show delete dialog for id: ${id}`);
      needsUpdate = true;
    } else if (name === 'dismiss_dialog') {
      this.surface.dataModel.set('/app/dialog/show', false);
      console.log(`[Client] Dismiss dialog`);
      needsUpdate = true;
    }
    
    // Trigger re-render to update UI (e.g., button selection states)
    if (needsUpdate) {
      this.surface.requestUpdate();
    }
  }
}

// Initialize client
new A2UIClient();

```

现在添加标签颜色按钮的高亮支持：

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      }
    };

    // Check if this is a filter button, form priority button, or tag color button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

已完成修改！现在优先级按钮和颜色按钮都会高亮显示选中状态。

**修改内容：**

1. **`renderer.ts`** - 扩展按钮高亮逻辑：
   - 新建/编辑票据的优先级按钮 (`create-priority-*`, `edit-priority-*`)
   - 标签颜色选择按钮 (`tag-color-*`)
   - 默认选中 "中" 优先级和蓝色

2. **`main.ts`** - 客户端 action 后触发重新渲染：
   - 添加 `requestUpdate()` 调用，确保点击按钮后 UI 立即更新

**效果：**
- 新建票据页面：默认高亮 "中" 优先级，点击其他优先级会切换高亮
- 编辑票据页面：根据当前票据优先级高亮对应按钮
- 标签页面：默认高亮蓝色，点击其他颜色会切换高亮

请刷新页面测试新建票据功能，选择不同优先级时应该能看到高亮效果。

---

**User**

新建标签的时候这个按钮没有效果

---

**Cursor**

让我检查服务器日志和 create_tag 的处理：

检查标签表单的按钮配置和 action 处理：

让我检查完整的服务器日志，看看是否有 action 请求：

让我在 renderButton 添加调试日志来诊断问题：

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, or tag color button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```json
{"name": "Kevin", "color": "#EF4444"}
```

让我检查 resolve 方法是否正确处理 path 类型的值：

让我刷新服务器日志并查看最近的请求：

请刷新页面并打开浏览器开发者工具 (F12)，然后：

1. 进入标签管理页面
2. 点击 "+ 新建标签"
3. 填写标签名称（如 "Kevin"）
4. 选择颜色
5. 点击 "创建标签" 按钮
6. 查看控制台是否有以下日志：
   - `[Button tag-form-submit] clicked, action: {...}`

如果没有看到日志，可能按钮事件没有正确绑定。

另外，请告诉我：点击 "创建标签" 按钮时，浏览器控制台有没有显示任何错误（红色文字）？

---

**User**

点击创建标签的按钮还是没有反应

---

**Cursor**

让我检查服务器状态：

从日志可以看到按钮**确实在工作**！之前的请求成功发送了：
```
Received action: create_tag with context: {'form': {'name': '丁丁', 'color': '#3B82F6'}}
```

问题是后端 API 返回了 **409 Conflict** 错误（标签名称 "丁丁" 可能已经存在）。

需要添加错误处理，让用户能看到错误信息。修改服务端：

```plaintext
Received action: create_tag with context: {'form': {'name': '丁丁', 'color': '#3B82F6'}}
```

```python
"""A2UI Agent Server - Main entry point."""
import asyncio
import json
import logging
from datetime import datetime
from typing import AsyncGenerator, Optional
from urllib.parse import urlparse, parse_qs

from fastapi import FastAPI, Request, Query, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import StreamingResponse, FileResponse
from fastapi.staticfiles import StaticFiles
from sse_starlette.sse import EventSourceResponse

from config import settings
from models import UserAction
from api_client import api_client
from a2ui_builder import A2UIBuilder
from pages.layout import build_app_layout
from pages.tickets import (
    build_tickets_page, build_tickets_data,
    build_ticket_detail_page, build_ticket_detail_data,
    build_ticket_create_page, build_ticket_create_data,
    build_ticket_edit_page, build_ticket_edit_data,
)
from pages.tags import build_tags_page, build_tags_data
from pages.error import build_not_found_page, build_error_page

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(title="A2UI Agent Server", version="1.0.0")

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


def safe_int(value, default: int = 1) -> int:
    """Safely convert value to int with default fallback."""
    if value is None:
        return default
    try:
        return int(value)
    except (ValueError, TypeError):
        return default


async def generate_page_messages(path: str, query_params: dict) -> AsyncGenerator[str, None]:
    """Generate A2UI messages for a given page path."""
    builder = A2UIBuilder("main")

    try:
        # Route to appropriate page builder
        if path == "/" or path == "/tickets":
            # Tickets list page
            search = query_params.get("search", "")
            status = query_params.get("status", "")
            priority = query_params.get("priority", "")
            page = safe_int(query_params.get("page"), 1)
            
            tickets_data = await api_client.list_tickets(
                search=search if search else None,
                status=status if status else None,
                priority=priority if priority else None,
                page=page,
            )
            page_id, _ = build_tickets_page(builder)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_tickets_data(tickets_data, search, status, priority, page):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tickets/new":
            # Ticket create page
            page_id, _ = build_ticket_create_page(builder)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_create_data():
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/") and path.endswith("/edit"):
            # Ticket edit page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            page_id, _ = build_ticket_edit_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_edit_data(ticket):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/"):
            # Ticket detail page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            attachments = await api_client.get_ticket_attachments(ticket_id)
            history_response = await api_client.get_ticket_history(ticket_id)
            history = history_response.get("data", [])

            page_id, _ = build_ticket_detail_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_detail_data(ticket, attachments, history):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tags":
            # Tags page
            tags = await api_client.list_tags()
            page_id, _ = build_tags_page(builder)
            build_app_layout(builder, page_id, "tags")

            yield builder.build_surface_update()
            for msg in build_tags_data(tags):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        else:
            # 404 page
            page_id, _ = build_not_found_page(builder)
            build_app_layout(builder, page_id, "")

            yield builder.build_surface_update()
            yield builder.build_begin_rendering("app-layout")

    except Exception as e:
        logger.exception(f"Error generating page: {e}")
        builder.reset()
        page_id, _ = build_error_page(builder, str(e))
        build_app_layout(builder, page_id, "")

        yield builder.build_surface_update()
        yield builder.build_begin_rendering("app-layout")


@app.get("/api/a2ui/stream")
async def stream_ui(
    request: Request,
    path: str = Query("/", description="Page path to render"),
):
    """SSE endpoint for A2UI messages."""
    # Parse query params from the path parameter itself (e.g., /tickets?page=2)
    parsed = urlparse(path)
    actual_path = parsed.path
    path_query_params = parse_qs(parsed.query)

    # Also get query params from the request URL (excluding 'path')
    request_params = dict(request.query_params)
    request_params.pop("path", None)

    # Merge query params (path params take precedence)
    query_params = request_params.copy()
    for key, values in path_query_params.items():
        if values:
            query_params[key] = values[0]  # Take first value

    # Use actual_path for routing
    path = actual_path

    async def event_generator():
        async for message in generate_page_messages(path, query_params):
            if await request.is_disconnected():
                break
            yield {"event": "message", "data": message}

    return EventSourceResponse(event_generator())


@app.post("/api/a2ui/action")
async def handle_action(action: UserAction):
    """Handle userAction from client."""
    logger.info(f"Received action: {action.name} with context: {action.context}")

    try:
        result = await process_action(action)
        return {"success": True, "result": result}
    except Exception as e:
        logger.exception(f"Error processing action: {e}")
        # Return error as JSON instead of raising HTTPException
        # This allows the client to display the error message
        error_message = str(e)
        if "409" in error_message or "Conflict" in error_message:
            error_message = "操作失败：该名称已存在，请使用其他名称"
        elif "400" in error_message or "Bad Request" in error_message:
            error_message = "操作失败：请检查输入内容"
        elif "404" in error_message or "Not Found" in error_message:
            error_message = "操作失败：资源未找到"
        else:
            error_message = f"操作失败：{error_message}"
        return {"success": False, "error": error_message}


async def process_action(action: UserAction) -> dict:
    """Process a userAction and return the result."""
    name = action.name
    context = action.context
    logger.info(f"Processing action '{name}' with context: {context}")

    if name == "navigate":
        # Navigation is handled client-side by reconnecting to SSE
        return {"navigate": context.get("to", "/tickets")}

    elif name in ["search_tickets", "filter_status", "filter_priority", "paginate"]:
        # Get current query params from context (passed from client)
        # Client should pass current query state
        # Handle None/null values from data model
        current_search = context.get("current_search") or ""
        current_status = context.get("current_status") or ""
        current_priority = context.get("current_priority") or ""
        current_page = safe_int(context.get("current_page"), 1)
        
        logger.info(f"Current state: search={current_search}, status={current_status}, priority={current_priority}, page={current_page}")

        # Initialize new values
        new_search = current_search
        new_status = current_status
        new_priority = current_priority
        new_page = current_page

        # Update based on action
        if name == "search_tickets":
            search_term = context.get('search') or ''
            new_search = search_term
            new_page = 1  # Reset to page 1 on new search
        elif name == "filter_status":
            status = context.get("status")
            if status is None:
                status = ""
            new_status = status
            new_page = 1  # Reset to page 1 on filter change
        elif name == "filter_priority":
            priority = context.get("priority")
            if priority is None:
                priority = ""
            new_priority = priority
            new_page = 1  # Reset to page 1 on filter change
        elif name == "paginate":
            page = safe_int(context.get("page"), 1)
            new_page = page

        logger.info(f"New state: search={new_search}, status={new_status}, priority={new_priority}, page={new_page}")

        # Build query string
        query_parts = []
        if new_search:
            query_parts.append(f"search={new_search}")
        if new_status:
            query_parts.append(f"status={new_status}")
        if new_priority:
            query_parts.append(f"priority={new_priority}")
        if new_page > 1:
            query_parts.append(f"page={new_page}")

        query_string = "?" + "&".join(query_parts) if query_parts else ""
        return {"navigate": f"/tickets{query_string}"}

    elif name == "view_ticket":
        ticket_id = context.get("id")
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_ticket":
        form = context.get("form", {})
        ticket = await api_client.create_ticket({
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority", "medium"),
        })
        return {"navigate": f"/tickets/{ticket['id']}"}

    elif name == "update_ticket":
        ticket_id = context.get("id")
        form = context.get("form", {})
        await api_client.update_ticket(ticket_id, {
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority"),
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "delete_ticket":
        ticket_id = context.get("id")
        await api_client.delete_ticket(ticket_id)
        return {"navigate": "/tickets"}

    elif name == "change_status":
        ticket_id = context.get("id")
        status = context.get("status")
        resolution = context.get("resolution")
        await api_client.update_ticket_status(ticket_id, {
            "status": status,
            "resolution": resolution,
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_tag":
        form = context.get("form", {})
        await api_client.create_tag({
            "name": form.get("name"),
            "color": form.get("color", "#3B82F6"),
        })
        return {"navigate": "/tags"}

    elif name == "delete_tag":
        tag_id = context.get("id")
        await api_client.delete_tag(tag_id)
        return {"navigate": "/tags"}

    elif name in ["show_create_tag_form", "hide_create_tag_form", "set_tag_color", "set_form_priority"]:
        # These are handled client-side via data model updates
        return {"handled": True}

    elif name in ["show_delete_dialog", "dismiss_dialog"]:
        # Dialog handling is client-side
        return {"handled": True}

    elif name == "retry":
        # Retry by refreshing current page
        return {"refresh": True}

    else:
        logger.warning(f"Unknown action: {name}")
        return {"unknown": True}


@app.get("/health")
async def health():
    """Health check endpoint."""
    return {"status": "healthy"}


# Serve static files for the client
try:
    app.mount("/", StaticFiles(directory="../client/dist", html=True), name="static")
except RuntimeError:
    # Client not built yet
    @app.get("/")
    async def root():
        return {"message": "A2UI Agent Server is running. Build the client to serve the UI."}


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host=settings.host, port=settings.port)

```

修改客户端显示错误信息：

```typescript
/**
 * A2UI Client Shell - Main entry point
 */
import './renderer';
import type { A2UIMessage, Action, UserAction, SurfaceUpdate, DataModelUpdate, BeginRendering } from './types';
import type { A2UISurface } from './renderer';

class A2UIClient {
  private surface: A2UISurface | null = null;
  private eventSource: EventSource | null = null;
  private currentPath: string = '/';
  private lastConnectedPath: string = '';

  constructor() {
    this.init();
  }

  private async init(): Promise<void> {
    // Create surface element
    const app = document.getElementById('app');
    if (!app) {
      console.error('App container not found');
      return;
    }

    // Clear loading state
    app.innerHTML = '';

    // Create surface
    this.surface = document.createElement('a2ui-surface') as A2UISurface;
    this.surface.surfaceId = 'main';
    this.surface.setActionHandler((action, sourceId, contextPath) => this.handleAction(action, sourceId, contextPath));
    app.appendChild(this.surface);

    // Get initial path from URL
    this.currentPath = window.location.pathname + window.location.search;

    // Handle browser navigation
    window.addEventListener('popstate', () => {
      this.currentPath = window.location.pathname + window.location.search;
      this.connect();
    });

    // Connect to server
    this.connect();
  }

  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Only clear data model when path changes (navigation), not on reconnect
    if (this.surface && this.currentPath !== this.lastConnectedPath) {
      this.surface.dataModel.clear();
      this.lastConnectedPath = this.currentPath;
    }

    // Build SSE URL
    const sseUrl = `/api/a2ui/stream?path=${encodeURIComponent(this.currentPath)}`;
    console.log(`Connecting to: ${sseUrl}`);

    this.eventSource = new EventSource(sseUrl);

    this.eventSource.onmessage = (event) => {
      this.handleMessage(event.data);
    };

    this.eventSource.onerror = (error) => {
      console.error('SSE error:', error);
      // Attempt to reconnect after delay
      setTimeout(() => {
        if (this.eventSource?.readyState === EventSource.CLOSED) {
          this.connect();
        }
      }, 3000);
    };

    this.eventSource.onopen = () => {
      console.log('SSE connection established');
    };
  }

  private handleMessage(data: string): void {
    try {
      const message: A2UIMessage = JSON.parse(data);

      if ('surfaceUpdate' in message) {
        this.handleSurfaceUpdate(message as SurfaceUpdate);
      } else if ('dataModelUpdate' in message) {
        this.handleDataModelUpdate(message as DataModelUpdate);
      } else if ('beginRendering' in message) {
        this.handleBeginRendering(message as BeginRendering);
      } else if ('deleteSurface' in message) {
        console.log('Surface deleted');
      }
    } catch (error) {
      console.error('Error parsing message:', error, data);
    }
  }

  private handleSurfaceUpdate(message: SurfaceUpdate): void {
    if (this.surface && message.surfaceUpdate.surfaceId === this.surface.surfaceId) {
      this.surface.setComponents(message.surfaceUpdate.components);
    }
  }

  private handleDataModelUpdate(message: DataModelUpdate): void {
    if (this.surface && message.dataModelUpdate.surfaceId === this.surface.surfaceId) {
      const path = message.dataModelUpdate.path || '/';
      this.surface.dataModel.update(path, message.dataModelUpdate.contents);
    }
  }

  private handleBeginRendering(message: BeginRendering): void {
    if (this.surface && message.beginRendering.surfaceId === this.surface.surfaceId) {
      this.surface.setRoot(message.beginRendering.root);
    }
  }

  private async handleAction(action: Action, sourceId: string, contextPath?: string): Promise<void> {
    console.log(`Action: ${action.name} from ${sourceId}`, action.context, `contextPath: ${contextPath}`);

    // Build context object from action.context array
    // Pass contextPath to resolve relative paths (e.g., "id" -> "/app/tickets/list/ticket0/id")
    const context: Record<string, unknown> = {};
    if (action.context) {
      for (const item of action.context) {
        const value = this.surface?.dataModel.resolve(item.value, contextPath);
        // Convert undefined to null to ensure it's included in JSON
        context[item.key] = value !== undefined ? value : null;
        console.log(`  Context ${item.key}:`, value, 'from', item.value);
      }
    }

    // Build userAction
    const userAction: UserAction = {
      name: action.name,
      surfaceId: this.surface?.surfaceId || 'main',
      sourceComponentId: sourceId,
      timestamp: new Date().toISOString(),
      context,
    };

    try {
      const response = await fetch('/api/a2ui/action', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(userAction),
      });

      const result = await response.json();
      console.log('Action result:', result);

      // Check for error response
      if (!result.success && result.error) {
        // Show error message to user
        alert(result.error);
        return;
      }

      // Handle navigation
      if (result.result?.navigate) {
        this.navigate(result.result.navigate);
      } else if (result.result?.refresh) {
        this.connect();
      } else if (result.result?.handled) {
        // Handle client-side actions
        this.handleClientSideAction(action.name, context);
      }
    } catch (error) {
      console.error('Error sending action:', error);
      alert('操作失败，请稍后重试');
    }
  }

  private navigate(path: string): void {
    // Update URL without reload
    window.history.pushState({}, '', path);
    // Store full path including query string for SSE reconnection
    this.currentPath = path;

    // Reconnect to get new page
    this.connect();
  }

  private handleClientSideAction(name: string, context: Record<string, unknown>): void {
    if (!this.surface) return;
    
    console.log(`[Client] Handling client-side action: ${name}`, context);
    
    let needsUpdate = false;
    
    if (name === 'set_form_priority') {
      // Determine the form path based on current page
      const priority = context.priority as string;
      const isEditPage = this.currentPath.includes('/edit');
      const formPath = isEditPage ? '/app/form/edit/priority' : '/app/form/create/priority';
      this.surface.dataModel.set(formPath, priority);
      console.log(`[Client] Set ${formPath} = ${priority}`);
      needsUpdate = true;
    } else if (name === 'set_tag_color') {
      // Set tag form color
      const color = context.color as string;
      this.surface.dataModel.set('/app/tags/form/color', color);
      console.log(`[Client] Set /app/tags/form/color = ${color}`);
      needsUpdate = true;
    } else if (name === 'show_create_tag_form') {
      this.surface.dataModel.set('/app/tags/showForm', true);
      console.log(`[Client] Set /app/tags/showForm = true`);
      needsUpdate = true;
    } else if (name === 'hide_create_tag_form') {
      this.surface.dataModel.set('/app/tags/showForm', false);
      console.log(`[Client] Set /app/tags/showForm = false`);
      needsUpdate = true;
    } else if (name === 'show_delete_dialog') {
      // Show delete confirmation dialog
      const id = context.id as string;
      this.surface.dataModel.set('/app/dialog/deleteId', id);
      this.surface.dataModel.set('/app/dialog/show', true);
      console.log(`[Client] Show delete dialog for id: ${id}`);
      needsUpdate = true;
    } else if (name === 'dismiss_dialog') {
      this.surface.dataModel.set('/app/dialog/show', false);
      console.log(`[Client] Dismiss dialog`);
      needsUpdate = true;
    }
    
    // Trigger re-render to update UI (e.g., button selection states)
    if (needsUpdate) {
      this.surface.requestUpdate();
    }
  }
}

// Initialize client
new A2UIClient();

```

重启 Python 服务器应用更改：

服务器已重启。**按钮功能正常工作！** 

**问题说明：**
之前的日志显示按钮确实发送了请求并收到了响应：
```
Received action: create_tag with context: {'form': {'name': '丁丁', 'color': '#3B82F6'}}
HTTP Request: POST http://localhost:3000/api/tags "HTTP/1.1 409 Conflict"
```

这表示标签 "丁丁" 已经存在，后端返回了 409 冲突错误。

**已添加的错误处理：**
1. **服务端** - 将错误转换为友好的中文提示
2. **客户端** - 显示 alert 弹窗提示用户错误信息

请刷新页面后重新测试：
1. 使用一个**新的、不存在的标签名称**（如 "测试标签123"）
2. 选择颜色
3. 点击 "创建标签"

如果名称已存在，会弹出提示 "操作失败：该名称已存在，请使用其他名称"。

```plaintext
Received action: create_tag with context: {'form': {'name': '丁丁', 'color': '#3B82F6'}}
HTTP Request: POST http://localhost:3000/api/tags "HTTP/1.1 409 Conflict"
```

```plaintext
Received action: create_tag with context: {'form': {'name': '丁丁', 'color': '#3B82F6'}}
HTTP Request: POST http://localhost:3000/api/tags "HTTP/1.1 409 Conflict"
```

---

**User**

创建标签成功之后需要有提示，目前只有重复创建之后的提示

---

**Cursor**

添加成功提示：

```typescript
/**
 * A2UI Client Shell - Main entry point
 */
import './renderer';
import type { A2UIMessage, Action, UserAction, SurfaceUpdate, DataModelUpdate, BeginRendering } from './types';
import type { A2UISurface } from './renderer';

class A2UIClient {
  private surface: A2UISurface | null = null;
  private eventSource: EventSource | null = null;
  private currentPath: string = '/';
  private lastConnectedPath: string = '';

  constructor() {
    this.init();
  }

  private async init(): Promise<void> {
    // Create surface element
    const app = document.getElementById('app');
    if (!app) {
      console.error('App container not found');
      return;
    }

    // Clear loading state
    app.innerHTML = '';

    // Create surface
    this.surface = document.createElement('a2ui-surface') as A2UISurface;
    this.surface.surfaceId = 'main';
    this.surface.setActionHandler((action, sourceId, contextPath) => this.handleAction(action, sourceId, contextPath));
    app.appendChild(this.surface);

    // Get initial path from URL
    this.currentPath = window.location.pathname + window.location.search;

    // Handle browser navigation
    window.addEventListener('popstate', () => {
      this.currentPath = window.location.pathname + window.location.search;
      this.connect();
    });

    // Connect to server
    this.connect();
  }

  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Only clear data model when path changes (navigation), not on reconnect
    if (this.surface && this.currentPath !== this.lastConnectedPath) {
      this.surface.dataModel.clear();
      this.lastConnectedPath = this.currentPath;
    }

    // Build SSE URL
    const sseUrl = `/api/a2ui/stream?path=${encodeURIComponent(this.currentPath)}`;
    console.log(`Connecting to: ${sseUrl}`);

    this.eventSource = new EventSource(sseUrl);

    this.eventSource.onmessage = (event) => {
      this.handleMessage(event.data);
    };

    this.eventSource.onerror = (error) => {
      console.error('SSE error:', error);
      // Attempt to reconnect after delay
      setTimeout(() => {
        if (this.eventSource?.readyState === EventSource.CLOSED) {
          this.connect();
        }
      }, 3000);
    };

    this.eventSource.onopen = () => {
      console.log('SSE connection established');
    };
  }

  private handleMessage(data: string): void {
    try {
      const message: A2UIMessage = JSON.parse(data);

      if ('surfaceUpdate' in message) {
        this.handleSurfaceUpdate(message as SurfaceUpdate);
      } else if ('dataModelUpdate' in message) {
        this.handleDataModelUpdate(message as DataModelUpdate);
      } else if ('beginRendering' in message) {
        this.handleBeginRendering(message as BeginRendering);
      } else if ('deleteSurface' in message) {
        console.log('Surface deleted');
      }
    } catch (error) {
      console.error('Error parsing message:', error, data);
    }
  }

  private handleSurfaceUpdate(message: SurfaceUpdate): void {
    if (this.surface && message.surfaceUpdate.surfaceId === this.surface.surfaceId) {
      this.surface.setComponents(message.surfaceUpdate.components);
    }
  }

  private handleDataModelUpdate(message: DataModelUpdate): void {
    if (this.surface && message.dataModelUpdate.surfaceId === this.surface.surfaceId) {
      const path = message.dataModelUpdate.path || '/';
      this.surface.dataModel.update(path, message.dataModelUpdate.contents);
    }
  }

  private handleBeginRendering(message: BeginRendering): void {
    if (this.surface && message.beginRendering.surfaceId === this.surface.surfaceId) {
      this.surface.setRoot(message.beginRendering.root);
    }
  }

  private async handleAction(action: Action, sourceId: string, contextPath?: string): Promise<void> {
    console.log(`Action: ${action.name} from ${sourceId}`, action.context, `contextPath: ${contextPath}`);

    // Build context object from action.context array
    // Pass contextPath to resolve relative paths (e.g., "id" -> "/app/tickets/list/ticket0/id")
    const context: Record<string, unknown> = {};
    if (action.context) {
      for (const item of action.context) {
        const value = this.surface?.dataModel.resolve(item.value, contextPath);
        // Convert undefined to null to ensure it's included in JSON
        context[item.key] = value !== undefined ? value : null;
        console.log(`  Context ${item.key}:`, value, 'from', item.value);
      }
    }

    // Build userAction
    const userAction: UserAction = {
      name: action.name,
      surfaceId: this.surface?.surfaceId || 'main',
      sourceComponentId: sourceId,
      timestamp: new Date().toISOString(),
      context,
    };

    try {
      const response = await fetch('/api/a2ui/action', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(userAction),
      });

      const result = await response.json();
      console.log('Action result:', result);

      // Check for error response
      if (!result.success && result.error) {
        // Show error message to user
        alert(result.error);
        return;
      }

      // Show success message for certain actions
      const successMessages: Record<string, string> = {
        'create_tag': '标签创建成功！',
        'create_ticket': '票据创建成功！',
        'update_ticket': '票据更新成功！',
        'delete_ticket': '票据删除成功！',
        'delete_tag': '标签删除成功！',
        'change_status': '状态更新成功！',
      };
      
      if (successMessages[action.name] && result.result?.navigate) {
        alert(successMessages[action.name]);
      }

      // Handle navigation
      if (result.result?.navigate) {
        this.navigate(result.result.navigate);
      } else if (result.result?.refresh) {
        this.connect();
      } else if (result.result?.handled) {
        // Handle client-side actions
        this.handleClientSideAction(action.name, context);
      }
    } catch (error) {
      console.error('Error sending action:', error);
      alert('操作失败，请稍后重试');
    }
  }

  private navigate(path: string): void {
    // Update URL without reload
    window.history.pushState({}, '', path);
    // Store full path including query string for SSE reconnection
    this.currentPath = path;

    // Reconnect to get new page
    this.connect();
  }

  private handleClientSideAction(name: string, context: Record<string, unknown>): void {
    if (!this.surface) return;
    
    console.log(`[Client] Handling client-side action: ${name}`, context);
    
    let needsUpdate = false;
    
    if (name === 'set_form_priority') {
      // Determine the form path based on current page
      const priority = context.priority as string;
      const isEditPage = this.currentPath.includes('/edit');
      const formPath = isEditPage ? '/app/form/edit/priority' : '/app/form/create/priority';
      this.surface.dataModel.set(formPath, priority);
      console.log(`[Client] Set ${formPath} = ${priority}`);
      needsUpdate = true;
    } else if (name === 'set_tag_color') {
      // Set tag form color
      const color = context.color as string;
      this.surface.dataModel.set('/app/tags/form/color', color);
      console.log(`[Client] Set /app/tags/form/color = ${color}`);
      needsUpdate = true;
    } else if (name === 'show_create_tag_form') {
      this.surface.dataModel.set('/app/tags/showForm', true);
      console.log(`[Client] Set /app/tags/showForm = true`);
      needsUpdate = true;
    } else if (name === 'hide_create_tag_form') {
      this.surface.dataModel.set('/app/tags/showForm', false);
      console.log(`[Client] Set /app/tags/showForm = false`);
      needsUpdate = true;
    } else if (name === 'show_delete_dialog') {
      // Show delete confirmation dialog
      const id = context.id as string;
      this.surface.dataModel.set('/app/dialog/deleteId', id);
      this.surface.dataModel.set('/app/dialog/show', true);
      console.log(`[Client] Show delete dialog for id: ${id}`);
      needsUpdate = true;
    } else if (name === 'dismiss_dialog') {
      this.surface.dataModel.set('/app/dialog/show', false);
      console.log(`[Client] Dismiss dialog`);
      needsUpdate = true;
    }
    
    // Trigger re-render to update UI (e.g., button selection states)
    if (needsUpdate) {
      this.surface.requestUpdate();
    }
  }
}

// Initialize client
new A2UIClient();

```

已添加成功提示！现在以下操作成功后都会显示提示：

- **创建标签** → "标签创建成功！"
- **创建票据** → "票据创建成功！"
- **更新票据** → "票据更新成功！"
- **删除票据** → "票据删除成功！"
- **删除标签** → "标签删除成功！"
- **更改状态** → "状态更新成功！"

请刷新页面后测试创建标签功能。

---

**User**

删除的时候有报错

---

**Cursor**

让我检查服务器日志查看删除错误：

问题是 DELETE 请求返回空响应，但代码尝试解析 JSON。让我修复：

```python
"""HTTP client for backend API."""
import httpx
from typing import Any, Optional

from config import settings


class ApiClient:
    """Client for communicating with the backend API."""

    def __init__(self):
        self.base_url = settings.backend_url

    async def _request(
        self,
        method: str,
        path: str,
        params: Optional[dict] = None,
        json: Optional[dict] = None,
    ) -> Any:
        """Make HTTP request to backend."""
        # Disable proxy for local backend requests (trust_env=False ignores HTTP_PROXY env vars)
        async with httpx.AsyncClient(trust_env=False) as client:
            url = f"{self.base_url}{path}"
            response = await client.request(
                method=method,
                url=url,
                params=params,
                json=json,
                timeout=30.0,
            )
            response.raise_for_status()
            # Handle empty responses (204 No Content or empty body)
            if response.status_code == 204 or not response.content:
                return None
            return response.json()

    async def get(self, path: str, params: Optional[dict] = None) -> Any:
        return await self._request("GET", path, params=params)

    async def post(self, path: str, json: Optional[dict] = None) -> Any:
        return await self._request("POST", path, json=json)

    async def put(self, path: str, json: Optional[dict] = None) -> Any:
        return await self._request("PUT", path, json=json)

    async def patch(self, path: str, json: Optional[dict] = None) -> Any:
        return await self._request("PATCH", path, json=json)

    async def delete(self, path: str) -> Any:
        return await self._request("DELETE", path)

    # Ticket API
    async def list_tickets(
        self,
        search: Optional[str] = None,
        status: Optional[str] = None,
        priority: Optional[str] = None,
        page: int = 1,
        per_page: int = 20,
    ) -> dict:
        params = {"page": str(page), "per_page": str(per_page)}
        if search:
            params["search"] = search
        if status:
            params["status"] = status
        if priority:
            params["priority"] = priority
        return await self.get("/api/tickets", params)

    async def get_ticket(self, ticket_id: str) -> dict:
        return await self.get(f"/api/tickets/{ticket_id}")

    async def create_ticket(self, data: dict) -> dict:
        return await self.post("/api/tickets", data)

    async def update_ticket(self, ticket_id: str, data: dict) -> dict:
        return await self.put(f"/api/tickets/{ticket_id}", data)

    async def delete_ticket(self, ticket_id: str) -> None:
        await self.delete(f"/api/tickets/{ticket_id}")

    async def update_ticket_status(self, ticket_id: str, data: dict) -> dict:
        return await self.patch(f"/api/tickets/{ticket_id}/status", data)

    async def get_ticket_history(self, ticket_id: str) -> dict:
        return await self.get(f"/api/tickets/{ticket_id}/history")

    async def get_ticket_attachments(self, ticket_id: str) -> list:
        return await self.get(f"/api/tickets/{ticket_id}/attachments")

    # Tag API
    async def list_tags(self) -> list:
        return await self.get("/api/tags")

    async def create_tag(self, data: dict) -> dict:
        return await self.post("/api/tags", data)

    async def delete_tag(self, tag_id: str) -> None:
        await self.delete(f"/api/tags/{tag_id}")


api_client = ApiClient()

```

重启服务器应用更改：

已修复！问题是 DELETE 请求返回 200 OK 但响应体为空，代码尝试解析 JSON 时失败。

**修复内容：**
- 修改 `api_client.py` 的 `_request` 方法，检查响应体是否为空后再解析 JSON

服务器已重启，请刷新页面重新测试删除功能。

---

**User**

删除标签的时候依然会有问题，如果创建完再进行删除的操作，会出现两条一样的数据

---

**Cursor**

让我检查服务器日志了解问题：

```plaintext
  this.lastConnectedPath = this.currentPath;}
```

问题是导航到相同路径时（如从 /tags 创建标签后导航回 /tags），DataModel 没有被清除。需要修复：

```typescript
/**
 * A2UI Client Shell - Main entry point
 */
import './renderer';
import type { A2UIMessage, Action, UserAction, SurfaceUpdate, DataModelUpdate, BeginRendering } from './types';
import type { A2UISurface } from './renderer';

class A2UIClient {
  private surface: A2UISurface | null = null;
  private eventSource: EventSource | null = null;
  private currentPath: string = '/';
  private lastConnectedPath: string = '';

  constructor() {
    this.init();
  }

  private async init(): Promise<void> {
    // Create surface element
    const app = document.getElementById('app');
    if (!app) {
      console.error('App container not found');
      return;
    }

    // Clear loading state
    app.innerHTML = '';

    // Create surface
    this.surface = document.createElement('a2ui-surface') as A2UISurface;
    this.surface.surfaceId = 'main';
    this.surface.setActionHandler((action, sourceId, contextPath) => this.handleAction(action, sourceId, contextPath));
    app.appendChild(this.surface);

    // Get initial path from URL
    this.currentPath = window.location.pathname + window.location.search;

    // Handle browser navigation
    window.addEventListener('popstate', () => {
      this.currentPath = window.location.pathname + window.location.search;
      this.connect();
    });

    // Connect to server
    this.connect();
  }

  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Only clear data model when path changes (navigation), not on reconnect
    if (this.surface && this.currentPath !== this.lastConnectedPath) {
      this.surface.dataModel.clear();
      this.lastConnectedPath = this.currentPath;
    }

    // Build SSE URL
    const sseUrl = `/api/a2ui/stream?path=${encodeURIComponent(this.currentPath)}`;
    console.log(`Connecting to: ${sseUrl}`);

    this.eventSource = new EventSource(sseUrl);

    this.eventSource.onmessage = (event) => {
      this.handleMessage(event.data);
    };

    this.eventSource.onerror = (error) => {
      console.error('SSE error:', error);
      // Attempt to reconnect after delay
      setTimeout(() => {
        if (this.eventSource?.readyState === EventSource.CLOSED) {
          this.connect();
        }
      }, 3000);
    };

    this.eventSource.onopen = () => {
      console.log('SSE connection established');
    };
  }

  private handleMessage(data: string): void {
    try {
      const message: A2UIMessage = JSON.parse(data);

      if ('surfaceUpdate' in message) {
        this.handleSurfaceUpdate(message as SurfaceUpdate);
      } else if ('dataModelUpdate' in message) {
        this.handleDataModelUpdate(message as DataModelUpdate);
      } else if ('beginRendering' in message) {
        this.handleBeginRendering(message as BeginRendering);
      } else if ('deleteSurface' in message) {
        console.log('Surface deleted');
      }
    } catch (error) {
      console.error('Error parsing message:', error, data);
    }
  }

  private handleSurfaceUpdate(message: SurfaceUpdate): void {
    if (this.surface && message.surfaceUpdate.surfaceId === this.surface.surfaceId) {
      this.surface.setComponents(message.surfaceUpdate.components);
    }
  }

  private handleDataModelUpdate(message: DataModelUpdate): void {
    if (this.surface && message.dataModelUpdate.surfaceId === this.surface.surfaceId) {
      const path = message.dataModelUpdate.path || '/';
      this.surface.dataModel.update(path, message.dataModelUpdate.contents);
    }
  }

  private handleBeginRendering(message: BeginRendering): void {
    if (this.surface && message.beginRendering.surfaceId === this.surface.surfaceId) {
      this.surface.setRoot(message.beginRendering.root);
    }
  }

  private async handleAction(action: Action, sourceId: string, contextPath?: string): Promise<void> {
    console.log(`Action: ${action.name} from ${sourceId}`, action.context, `contextPath: ${contextPath}`);

    // Build context object from action.context array
    // Pass contextPath to resolve relative paths (e.g., "id" -> "/app/tickets/list/ticket0/id")
    const context: Record<string, unknown> = {};
    if (action.context) {
      for (const item of action.context) {
        const value = this.surface?.dataModel.resolve(item.value, contextPath);
        // Convert undefined to null to ensure it's included in JSON
        context[item.key] = value !== undefined ? value : null;
        console.log(`  Context ${item.key}:`, value, 'from', item.value);
      }
    }

    // Build userAction
    const userAction: UserAction = {
      name: action.name,
      surfaceId: this.surface?.surfaceId || 'main',
      sourceComponentId: sourceId,
      timestamp: new Date().toISOString(),
      context,
    };

    try {
      const response = await fetch('/api/a2ui/action', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(userAction),
      });

      const result = await response.json();
      console.log('Action result:', result);

      // Check for error response
      if (!result.success && result.error) {
        // Show error message to user
        alert(result.error);
        return;
      }

      // Show success message for certain actions
      const successMessages: Record<string, string> = {
        'create_tag': '标签创建成功！',
        'create_ticket': '票据创建成功！',
        'update_ticket': '票据更新成功！',
        'delete_ticket': '票据删除成功！',
        'delete_tag': '标签删除成功！',
        'change_status': '状态更新成功！',
      };
      
      if (successMessages[action.name] && result.result?.navigate) {
        alert(successMessages[action.name]);
      }

      // Handle navigation
      if (result.result?.navigate) {
        this.navigate(result.result.navigate);
      } else if (result.result?.refresh) {
        this.connect();
      } else if (result.result?.handled) {
        // Handle client-side actions
        this.handleClientSideAction(action.name, context);
      }
    } catch (error) {
      console.error('Error sending action:', error);
      alert('操作失败，请稍后重试');
    }
  }

  private navigate(path: string): void {
    // Update URL without reload
    window.history.pushState({}, '', path);
    // Store full path including query string for SSE reconnection
    this.currentPath = path;

    // Force clear data model on navigation (even if path is the same)
    // This ensures fresh data is loaded after create/delete operations
    if (this.surface) {
      this.surface.dataModel.clear();
    }
    // Reset lastConnectedPath to force data refresh
    this.lastConnectedPath = '';

    // Reconnect to get new page
    this.connect();
  }

  private handleClientSideAction(name: string, context: Record<string, unknown>): void {
    if (!this.surface) return;
    
    console.log(`[Client] Handling client-side action: ${name}`, context);
    
    let needsUpdate = false;
    
    if (name === 'set_form_priority') {
      // Determine the form path based on current page
      const priority = context.priority as string;
      const isEditPage = this.currentPath.includes('/edit');
      const formPath = isEditPage ? '/app/form/edit/priority' : '/app/form/create/priority';
      this.surface.dataModel.set(formPath, priority);
      console.log(`[Client] Set ${formPath} = ${priority}`);
      needsUpdate = true;
    } else if (name === 'set_tag_color') {
      // Set tag form color
      const color = context.color as string;
      this.surface.dataModel.set('/app/tags/form/color', color);
      console.log(`[Client] Set /app/tags/form/color = ${color}`);
      needsUpdate = true;
    } else if (name === 'show_create_tag_form') {
      this.surface.dataModel.set('/app/tags/showForm', true);
      console.log(`[Client] Set /app/tags/showForm = true`);
      needsUpdate = true;
    } else if (name === 'hide_create_tag_form') {
      this.surface.dataModel.set('/app/tags/showForm', false);
      console.log(`[Client] Set /app/tags/showForm = false`);
      needsUpdate = true;
    } else if (name === 'show_delete_dialog') {
      // Show delete confirmation dialog
      const id = context.id as string;
      this.surface.dataModel.set('/app/dialog/deleteId', id);
      this.surface.dataModel.set('/app/dialog/show', true);
      console.log(`[Client] Show delete dialog for id: ${id}`);
      needsUpdate = true;
    } else if (name === 'dismiss_dialog') {
      this.surface.dataModel.set('/app/dialog/show', false);
      console.log(`[Client] Dismiss dialog`);
      needsUpdate = true;
    }
    
    // Trigger re-render to update UI (e.g., button selection states)
    if (needsUpdate) {
      this.surface.requestUpdate();
    }
  }
}

// Initialize client
new A2UIClient();

```

已修复！问题是当导航回相同路径（如 /tags → /tags）时，DataModel 没有被清除，导致旧数据和新数据混合。

**修复内容：**
- 在 `navigate` 方法中强制清除 DataModel
- 重置 `lastConnectedPath` 确保重新加载数据

请刷新页面后重新测试：
1. 创建新标签
2. 删除该标签
3. 检查是否还有重复数据

---

**User**

新建票据的时候好像没有标签的选项能够选中这个票据属于哪个标签

---

**Cursor**

让我检查创建票据页面的代码，看看是否有标签选择功能：

确实，当前创建票据页面没有标签选择功能。需要添加这个功能。让我检查后端 API 是否支持：

后端支持给票据添加标签（`POST /api/tickets/{id}/tags`）。我来为创建票据页面添加标签选择功能：

```python
"""HTTP client for backend API."""
import httpx
from typing import Any, Optional

from config import settings


class ApiClient:
    """Client for communicating with the backend API."""

    def __init__(self):
        self.base_url = settings.backend_url

    async def _request(
        self,
        method: str,
        path: str,
        params: Optional[dict] = None,
        json: Optional[dict] = None,
    ) -> Any:
        """Make HTTP request to backend."""
        # Disable proxy for local backend requests (trust_env=False ignores HTTP_PROXY env vars)
        async with httpx.AsyncClient(trust_env=False) as client:
            url = f"{self.base_url}{path}"
            response = await client.request(
                method=method,
                url=url,
                params=params,
                json=json,
                timeout=30.0,
            )
            response.raise_for_status()
            # Handle empty responses (204 No Content or empty body)
            if response.status_code == 204 or not response.content:
                return None
            return response.json()

    async def get(self, path: str, params: Optional[dict] = None) -> Any:
        return await self._request("GET", path, params=params)

    async def post(self, path: str, json: Optional[dict] = None) -> Any:
        return await self._request("POST", path, json=json)

    async def put(self, path: str, json: Optional[dict] = None) -> Any:
        return await self._request("PUT", path, json=json)

    async def patch(self, path: str, json: Optional[dict] = None) -> Any:
        return await self._request("PATCH", path, json=json)

    async def delete(self, path: str) -> Any:
        return await self._request("DELETE", path)

    # Ticket API
    async def list_tickets(
        self,
        search: Optional[str] = None,
        status: Optional[str] = None,
        priority: Optional[str] = None,
        page: int = 1,
        per_page: int = 20,
    ) -> dict:
        params = {"page": str(page), "per_page": str(per_page)}
        if search:
            params["search"] = search
        if status:
            params["status"] = status
        if priority:
            params["priority"] = priority
        return await self.get("/api/tickets", params)

    async def get_ticket(self, ticket_id: str) -> dict:
        return await self.get(f"/api/tickets/{ticket_id}")

    async def create_ticket(self, data: dict) -> dict:
        return await self.post("/api/tickets", data)

    async def update_ticket(self, ticket_id: str, data: dict) -> dict:
        return await self.put(f"/api/tickets/{ticket_id}", data)

    async def delete_ticket(self, ticket_id: str) -> None:
        await self.delete(f"/api/tickets/{ticket_id}")

    async def update_ticket_status(self, ticket_id: str, data: dict) -> dict:
        return await self.patch(f"/api/tickets/{ticket_id}/status", data)

    async def get_ticket_history(self, ticket_id: str) -> dict:
        return await self.get(f"/api/tickets/{ticket_id}/history")

    async def get_ticket_attachments(self, ticket_id: str) -> list:
        return await self.get(f"/api/tickets/{ticket_id}/attachments")

    # Tag API
    async def list_tags(self) -> list:
        return await self.get("/api/tags")

    async def create_tag(self, data: dict) -> dict:
        return await self.post("/api/tags", data)

    async def delete_tag(self, tag_id: str) -> None:
        await self.delete(f"/api/tags/{tag_id}")

    async def add_tag_to_ticket(self, ticket_id: str, tag_id: str) -> None:
        await self.post(f"/api/tickets/{ticket_id}/tags", {"tag_id": tag_id})

    async def remove_tag_from_ticket(self, ticket_id: str, tag_id: str) -> None:
        await self.delete(f"/api/tickets/{ticket_id}/tags/{tag_id}")


api_client = ApiClient()

```

```python
"""Ticket page builders."""
from typing import Any, Optional
from a2ui_builder import A2UIBuilder, value_string, value_number, value_map, build_value_map_from_dict
from models import (
    STATUS_LABELS, PRIORITY_LABELS, STATUS_TRANSITIONS,
    TicketStatus, Priority
)


def build_tickets_page(builder: A2UIBuilder) -> tuple[str, list[str]]:
    """Build the tickets list page."""
    # Page header
    builder.text("tickets-title", "票据列表", usage_hint="h1")
    builder.text("tickets-add-text", "+ 新建票据")
    builder.button(
        "tickets-add-btn",
        "tickets-add-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets/new"}}],
    )
    builder.row("tickets-header", ["tickets-title", "tickets-add-btn"], distribution="spaceBetween", alignment="center")

    # Search
    builder.text_field("tickets-search", "搜索票据...", builder.path("/app/tickets/query/search"))
    builder.text("tickets-search-btn-text", "搜索")
    builder.button(
        "tickets-search-btn",
        "tickets-search-btn-text",
        "search_tickets",
        [
            {"key": "search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-search-row", ["tickets-search", "tickets-search-btn"], alignment="center")

    # Status filter buttons
    builder.text("filter-all-text", "全部")
    builder.button("filter-all", "filter-all-text", "filter_status", [
        {"key": "status", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-open-text", "待处理")
    builder.button("filter-open", "filter-open-text", "filter_status", [
        {"key": "status", "value": {"literalString": "open"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-progress-text", "处理中")
    builder.button("filter-progress", "filter-progress-text", "filter_status", [
        {"key": "status", "value": {"literalString": "in_progress"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-completed-text", "已完成")
    builder.button("filter-completed", "filter-completed-text", "filter_status", [
        {"key": "status", "value": {"literalString": "completed"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-cancelled-text", "已取消")
    builder.button("filter-cancelled", "filter-cancelled-text", "filter_status", [
        {"key": "status", "value": {"literalString": "cancelled"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-status-filters", ["filter-all", "filter-open", "filter-progress", "filter-completed", "filter-cancelled"], alignment="center")

    # Priority filter buttons
    builder.text("priority-all-text", "全部优先级")
    builder.button("priority-all", "priority-all-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-low-text", "低")
    builder.button("priority-low", "priority-low-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "low"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-medium-text", "中")
    builder.button("priority-medium", "priority-medium-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "medium"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-high-text", "高")
    builder.button("priority-high", "priority-high-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "high"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-urgent-text", "紧急")
    builder.button("priority-urgent", "priority-urgent-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "urgent"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-priority-filters", ["priority-all", "priority-low", "priority-medium", "priority-high", "priority-urgent"], alignment="center")

    builder.column("tickets-filters", ["tickets-search-row", "tickets-status-filters", "tickets-priority-filters"])
    builder.card("tickets-filters-card", "tickets-filters")

    # Ticket list template - simplified without icons
    builder.text("ticket-item-title", builder.path("title"), usage_hint="h3")
    builder.text("ticket-item-status", builder.path("statusLabel"))
    builder.text("ticket-item-priority", builder.path("priorityLabel"))
    builder.text("ticket-item-date", builder.path("created_at"))
    builder.row("ticket-item-meta", ["ticket-item-status", "ticket-item-priority", "ticket-item-date"], alignment="center")
    builder.column("ticket-item-content", ["ticket-item-title", "ticket-item-meta"])
    builder.text("ticket-item-arrow", "→")
    builder.row("ticket-item-row", ["ticket-item-content", "ticket-item-arrow"], distribution="spaceBetween", alignment="center")
    builder.button(
        "ticket-item-btn",
        "ticket-item-row",
        "view_ticket",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.card("ticket-item-card", "ticket-item-btn")

    # Ticket list
    builder.list_component(
        "tickets-list",
        template={"componentId": "ticket-item-card", "dataBinding": "/app/tickets/list"},
        direction="vertical",
    )

    # Empty state
    builder.text("tickets-empty-title", "暂无票据", usage_hint="h3")
    builder.text("tickets-empty-desc", "点击上方按钮创建第一个票据")
    builder.column("tickets-empty", ["tickets-empty-title", "tickets-empty-desc"], alignment="center")

    # Pagination - use literalNumber for page values since they're numbers
    builder.text("pagination-prev-text", "← 上一页")
    builder.button(
        "pagination-prev",
        "pagination-prev-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/prevPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.text("pagination-info", builder.path("/app/tickets/pagination/info"))
    builder.text("pagination-next-text", "下一页 →")
    builder.button(
        "pagination-next",
        "pagination-next-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/nextPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-pagination", ["pagination-prev", "pagination-info", "pagination-next"], distribution="center", alignment="center")

    # Main content
    builder.column("tickets-content", ["tickets-list", "tickets-pagination"])
    builder.column("tickets-page", ["tickets-header", "tickets-filters-card", "tickets-content"])

    return "tickets-page", []


def build_tickets_data(tickets_response: dict, search: str = "", status: str = "", priority: str = "", page: int = 1) -> list[str]:
    """Build data model updates for tickets page."""
    messages = []
    builder = A2UIBuilder()

    # Query state - use actual values from URL params
    query_data = [
        value_string("search", search),
        value_string("status", status),
        value_string("priority", priority),
        value_number("page", page),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/query", query_data))

    # Tickets list
    tickets = tickets_response.get("data", [])
    list_data = []
    for i, ticket in enumerate(tickets):
        ticket_map = build_value_map_from_dict({
            "id": ticket["id"],
            "title": ticket["title"],
            "status": ticket["status"],
            "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
            "priority": ticket["priority"],
            "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
            "created_at": ticket["created_at"][:10],  # Date only
        })
        list_data.append(value_map(f"ticket{i}", ticket_map))
    messages.append(builder.build_data_model_update("/app/tickets/list", list_data))

    # Pagination
    page = tickets_response.get("page", 1)
    total_pages = tickets_response.get("total_pages", 0)
    total_count = tickets_response.get("total", 0)
    
    # If no data, show "第0页/共0页"
    if total_count == 0 or total_pages == 0:
        display_page = 0
        display_total = 0
    else:
        display_page = page
        display_total = total_pages
    
    pagination_data = [
        value_number("page", display_page),
        value_number("totalPages", display_total),
        value_number("prevPage", max(1, page - 1) if total_pages > 0 else 0),
        value_number("nextPage", min(total_pages, page + 1) if total_pages > 0 else 0),
        value_string("info", f"第 {display_page} 页 / 共 {display_total} 页"),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/pagination", pagination_data))

    return messages


def build_ticket_detail_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket detail page."""
    ticket_id = ticket["id"]
    status = ticket["status"]

    # Back button
    builder.text("detail-back-text", "← 返回列表")
    builder.button(
        "detail-back-btn",
        "detail-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    # Title
    builder.text("detail-title", builder.path("/app/ticket/detail/title"), usage_hint="h1")

    # Actions
    builder.text("detail-edit-text", "编辑")
    builder.button(
        "detail-edit-btn",
        "detail-edit-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}/edit"}}],
    )

    builder.text("detail-delete-text", "删除")
    builder.button(
        "detail-delete-btn",
        "detail-delete-text",
        "show_delete_dialog",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )

    builder.row("detail-actions", ["detail-edit-btn", "detail-delete-btn"], alignment="center")
    builder.row("detail-header", ["detail-back-btn", "detail-title", "detail-actions"], distribution="spaceBetween", alignment="center")

    # Description card
    builder.text("detail-desc-label", "描述", usage_hint="h4")
    builder.text("detail-desc-content", builder.path("/app/ticket/detail/description"))
    builder.column("detail-desc-col", ["detail-desc-label", "detail-desc-content"])
    builder.card("detail-desc-card", "detail-desc-col")

    # Resolution card (if exists)
    builder.text("detail-resolution-label", "处理结果", usage_hint="h4")
    builder.text("detail-resolution-content", builder.path("/app/ticket/detail/resolution"))
    builder.column("detail-resolution-col", ["detail-resolution-label", "detail-resolution-content"])
    builder.card("detail-resolution-card", "detail-resolution-col")

    # Status card
    builder.text("detail-status-label", "状态", usage_hint="h4")
    builder.text("detail-status-value", builder.path("/app/ticket/detail/statusLabel"))

    # Status transition buttons
    allowed_transitions = STATUS_TRANSITIONS.get(TicketStatus(status), [])
    status_btns = []
    for target_status in allowed_transitions:
        btn_id = f"status-btn-{target_status.value}"
        text_id = f"status-btn-text-{target_status.value}"
        builder.text(text_id, f"→ {STATUS_LABELS[target_status]}")
        builder.button(
            btn_id,
            text_id,
            "change_status",
            [
                {"key": "id", "value": {"literalString": ticket_id}},
                {"key": "status", "value": {"literalString": target_status.value}},
            ],
        )
        status_btns.append(btn_id)

    builder.row("detail-status-btns", status_btns, alignment="center")
    builder.column("detail-status-col", ["detail-status-label", "detail-status-value", "detail-status-btns"])
    builder.card("detail-status-card", "detail-status-col")

    # Priority card
    builder.text("detail-priority-label", "优先级", usage_hint="h4")
    builder.text("detail-priority-value", builder.path("/app/ticket/detail/priorityLabel"))
    builder.column("detail-priority-col", ["detail-priority-label", "detail-priority-value"])
    builder.card("detail-priority-card", "detail-priority-col")

    # Tags card
    builder.text("detail-tags-label", "标签", usage_hint="h4")
    builder.text("detail-tag-name", builder.path("name"))
    builder.list_component(
        "detail-tags-list",
        template={"componentId": "detail-tag-name", "dataBinding": "/app/ticket/tags"},
        direction="horizontal",
    )
    builder.column("detail-tags-col", ["detail-tags-label", "detail-tags-list"])
    builder.card("detail-tags-card", "detail-tags-col")

    # Timestamps card
    builder.text("detail-time-label", "时间信息", usage_hint="h4")
    builder.text("detail-created-label", "创建时间")
    builder.text("detail-created-value", builder.path("/app/ticket/detail/created_at"))
    builder.row("detail-created-row", ["detail-created-label", "detail-created-value"], distribution="spaceBetween")
    builder.text("detail-updated-label", "更新时间")
    builder.text("detail-updated-value", builder.path("/app/ticket/detail/updated_at"))
    builder.row("detail-updated-row", ["detail-updated-label", "detail-updated-value"], distribution="spaceBetween")
    builder.column("detail-time-col", ["detail-time-label", "detail-created-row", "detail-updated-row"])
    builder.card("detail-time-card", "detail-time-col")

    # Attachments card
    builder.text("detail-attach-label", "附件", usage_hint="h4")
    builder.text("detail-attach-filename", builder.path("filename"))
    builder.text("detail-attach-size", builder.path("sizeFormatted"))
    builder.row("detail-attach-info", ["detail-attach-filename", "detail-attach-size"], distribution="spaceBetween")
    builder.text("detail-attach-download-text", "下载")
    builder.button(
        "detail-attach-download",
        "detail-attach-download-text",
        "download_attachment",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.row("detail-attach-item", ["detail-attach-info", "detail-attach-download"], distribution="spaceBetween", alignment="center")
    builder.list_component(
        "detail-attach-list",
        template={"componentId": "detail-attach-item", "dataBinding": "/app/ticket/attachments"},
        direction="vertical",
    )
    builder.text("detail-attach-empty", "暂无附件")
    builder.column("detail-attach-col", ["detail-attach-label", "detail-attach-list"])
    builder.card("detail-attach-card", "detail-attach-col")

    # History card
    builder.text("detail-history-label", "变更历史", usage_hint="h4")
    builder.text("detail-history-type", builder.path("changeTypeLabel"))
    builder.text("detail-history-time", builder.path("created_at"))
    builder.text("detail-history-old", builder.path("old_value"))
    builder.text("detail-history-arrow", "→")
    builder.text("detail-history-new", builder.path("new_value"))
    builder.row("detail-history-change", ["detail-history-old", "detail-history-arrow", "detail-history-new"], alignment="center")
    builder.column("detail-history-item", ["detail-history-type", "detail-history-time", "detail-history-change"])
    builder.list_component(
        "detail-history-list",
        template={"componentId": "detail-history-item", "dataBinding": "/app/ticket/history"},
        direction="vertical",
    )
    builder.column("detail-history-col", ["detail-history-label", "detail-history-list"])
    builder.card("detail-history-card", "detail-history-col")

    # Left column (main content)
    main_cards = ["detail-desc-card"]
    if ticket.get("resolution"):
        main_cards.append("detail-resolution-card")
    main_cards.append("detail-attach-card")
    builder.column("detail-main", main_cards)

    # Right column (sidebar)
    builder.column("detail-sidebar", [
        "detail-status-card",
        "detail-priority-card",
        "detail-tags-card",
        "detail-time-card",
        "detail-history-card",
    ])

    # Layout
    builder.row("detail-body", ["detail-main", "detail-sidebar"], distribution="start")
    builder.column("detail-page", ["detail-header", "detail-body"])

    # Delete confirmation modal
    builder.text("delete-modal-title", "确认删除", usage_hint="h3")
    builder.text("delete-modal-desc", "确定要删除这个票据吗？此操作无法撤销。")
    builder.text("delete-modal-cancel-text", "取消")
    builder.button("delete-modal-cancel", "delete-modal-cancel-text", "dismiss_dialog", [])
    builder.text("delete-modal-confirm-text", "确认删除")
    builder.button(
        "delete-modal-confirm",
        "delete-modal-confirm-text",
        "delete_ticket",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )
    builder.row("delete-modal-actions", ["delete-modal-cancel", "delete-modal-confirm"], distribution="end")
    builder.column("delete-modal-content", ["delete-modal-title", "delete-modal-desc", "delete-modal-actions"])

    return "detail-page", []


def build_ticket_detail_data(ticket: dict, attachments: list, history: list) -> list[str]:
    """Build data model updates for ticket detail page."""
    messages = []
    builder = A2UIBuilder()

    # Ticket detail
    detail_data = build_value_map_from_dict({
        "id": ticket["id"],
        "title": ticket["title"],
        "description": ticket.get("description") or "无描述",
        "status": ticket["status"],
        "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
        "priority": ticket["priority"],
        "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
        "resolution": ticket.get("resolution") or "",
        "created_at": ticket["created_at"][:19].replace("T", " "),
        "updated_at": ticket["updated_at"][:19].replace("T", " "),
    })
    messages.append(builder.build_data_model_update("/app/ticket/detail", detail_data))

    # Tags
    tags = ticket.get("tags", [])
    tags_data = []
    for i, tag in enumerate(tags):
        tags_data.append(value_map(f"tag{i}", build_value_map_from_dict({
            "id": tag["id"],
            "name": tag["name"],
            "color": tag["color"],
        })))
    messages.append(builder.build_data_model_update("/app/ticket/tags", tags_data))

    # Attachments
    attach_data = []
    for i, att in enumerate(attachments):
        size_bytes = att["size_bytes"]
        if size_bytes < 1024:
            size_formatted = f"{size_bytes} B"
        elif size_bytes < 1024 * 1024:
            size_formatted = f"{size_bytes / 1024:.1f} KB"
        else:
            size_formatted = f"{size_bytes / (1024 * 1024):.1f} MB"
        attach_data.append(value_map(f"att{i}", build_value_map_from_dict({
            "id": att["id"],
            "filename": att["filename"],
            "sizeFormatted": size_formatted,
        })))
    messages.append(builder.build_data_model_update("/app/ticket/attachments", attach_data))

    # History
    change_type_labels = {
        "status": "状态变更",
        "priority": "优先级变更",
        "resolution": "处理结果",
        "tag_added": "添加标签",
        "tag_removed": "移除标签",
    }
    history_data = []
    for i, h in enumerate(history):
        history_data.append(value_map(f"h{i}", build_value_map_from_dict({
            "changeTypeLabel": change_type_labels.get(h["change_type"], h["change_type"]),
            "old_value": h.get("old_value") or "-",
            "new_value": h.get("new_value") or "-",
            "created_at": h["created_at"][:19].replace("T", " "),
        })))
    messages.append(builder.build_data_model_update("/app/ticket/history", history_data))

    return messages


def build_ticket_create_page(builder: A2UIBuilder, tags: list) -> tuple[str, list[str]]:
    """Build the ticket create page."""
    # Back button
    builder.text("create-back-text", "← 返回列表")
    builder.button(
        "create-back-btn",
        "create-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    builder.text("create-title", "新建票据", usage_hint="h1")
    builder.row("create-header", ["create-back-btn", "create-title"], alignment="center")

    # Form
    builder.text("create-title-label", "标题 *", usage_hint="h4")
    builder.text_field("create-title-input", "请输入票据标题", builder.path("/app/form/create/title"))

    builder.text("create-desc-label", "描述", usage_hint="h4")
    builder.text_field("create-desc-input", "请输入详细描述...", builder.path("/app/form/create/description"), text_field_type="multiline")

    builder.text("create-priority-label", "优先级", usage_hint="h4")
    # Priority selection buttons
    builder.text("create-priority-low-text", "低")
    builder.button("create-priority-low", "create-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("create-priority-medium-text", "中")
    builder.button("create-priority-medium", "create-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("create-priority-high-text", "高")
    builder.button("create-priority-high", "create-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("create-priority-urgent-text", "紧急")
    builder.button("create-priority-urgent", "create-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("create-priority-btns", ["create-priority-low", "create-priority-medium", "create-priority-high", "create-priority-urgent"], alignment="center")

    # Tags selection
    builder.text("create-tags-label", "标签（可多选）", usage_hint="h4")
    tag_button_ids = []
    for i, tag in enumerate(tags):
        tag_id = tag.get("id", "")
        tag_name = tag.get("name", f"标签{i}")
        btn_text_id = f"create-tag-{i}-text"
        btn_id = f"create-tag-{i}"
        builder.text(btn_text_id, tag_name)
        builder.button(btn_id, btn_text_id, "toggle_form_tag", [
            {"key": "tagId", "value": {"literalString": tag_id}},
            {"key": "tagName", "value": {"literalString": tag_name}},
        ])
        tag_button_ids.append(btn_id)
    
    if tag_button_ids:
        builder.row("create-tags-btns", tag_button_ids, alignment="center")
        form_fields = [
            "create-title-label", "create-title-input",
            "create-desc-label", "create-desc-input",
            "create-priority-label", "create-priority-btns",
            "create-tags-label", "create-tags-btns",
        ]
    else:
        builder.text("create-tags-empty", "暂无可用标签")
        form_fields = [
            "create-title-label", "create-title-input",
            "create-desc-label", "create-desc-input",
            "create-priority-label", "create-priority-btns",
            "create-tags-label", "create-tags-empty",
        ]

    builder.column("create-form-fields", form_fields)

    # Actions
    builder.divider("create-divider")
    builder.text("create-cancel-text", "取消")
    builder.button(
        "create-cancel-btn",
        "create-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )
    builder.text("create-submit-text", "创建票据")
    builder.button(
        "create-submit-btn",
        "create-submit-text",
        "create_ticket",
        [{"key": "form", "value": {"path": "/app/form/create"}}],
    )
    builder.row("create-actions", ["create-cancel-btn", "create-submit-btn"], distribution="end", alignment="center")

    builder.column("create-form", ["create-form-fields", "create-divider", "create-actions"])
    builder.card("create-form-card", "create-form")
    builder.column("create-page", ["create-header", "create-form-card"])

    return "create-page", []


def build_ticket_create_data(tags: list) -> list[str]:
    """Build data model updates for ticket create page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ""),
        value_string("description", ""),
        value_string("priority", "medium"),
        value_string("selectedTagIds", ""),  # Comma-separated tag IDs
    ]
    messages.append(builder.build_data_model_update("/app/form/create", form_data))

    # Store available tags for reference
    tags_data = []
    for i, tag in enumerate(tags):
        tags_data.append(value_map(f"tag{i}", build_value_map_from_dict({
            "id": tag.get("id", ""),
            "name": tag.get("name", ""),
            "color": tag.get("color", "#3B82F6"),
        })))
    messages.append(builder.build_data_model_update("/app/form/create/availableTags", tags_data))

    return messages


def build_ticket_edit_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket edit page."""
    ticket_id = ticket["id"]

    # Back button
    builder.text("edit-back-text", "← 返回详情")
    builder.button(
        "edit-back-btn",
        "edit-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )

    builder.text("edit-title", "编辑票据", usage_hint="h1")
    builder.row("edit-header", ["edit-back-btn", "edit-title"], alignment="center")

    # Form
    builder.text("edit-title-label", "标题 *", usage_hint="h4")
    builder.text_field("edit-title-input", "请输入票据标题", builder.path("/app/form/edit/title"))

    builder.text("edit-desc-label", "描述", usage_hint="h4")
    builder.text_field("edit-desc-input", "请输入详细描述...", builder.path("/app/form/edit/description"), text_field_type="multiline")

    builder.text("edit-priority-label", "优先级", usage_hint="h4")
    builder.text("edit-priority-low-text", "低")
    builder.button("edit-priority-low", "edit-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("edit-priority-medium-text", "中")
    builder.button("edit-priority-medium", "edit-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("edit-priority-high-text", "高")
    builder.button("edit-priority-high", "edit-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("edit-priority-urgent-text", "紧急")
    builder.button("edit-priority-urgent", "edit-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("edit-priority-btns", ["edit-priority-low", "edit-priority-medium", "edit-priority-high", "edit-priority-urgent"], alignment="center")

    builder.column("edit-form-fields", [
        "edit-title-label", "edit-title-input",
        "edit-desc-label", "edit-desc-input",
        "edit-priority-label", "edit-priority-btns",
    ])

    # Actions
    builder.divider("edit-divider")
    builder.text("edit-cancel-text", "取消")
    builder.button(
        "edit-cancel-btn",
        "edit-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )
    builder.text("edit-submit-text", "保存更改")
    builder.button(
        "edit-submit-btn",
        "edit-submit-text",
        "update_ticket",
        [
            {"key": "id", "value": {"literalString": ticket_id}},
            {"key": "form", "value": {"path": "/app/form/edit"}},
        ],
    )
    builder.row("edit-actions", ["edit-cancel-btn", "edit-submit-btn"], distribution="end", alignment="center")

    builder.column("edit-form", ["edit-form-fields", "edit-divider", "edit-actions"])
    builder.card("edit-form-card", "edit-form")
    builder.column("edit-page", ["edit-header", "edit-form-card"])

    return "edit-page", []


def build_ticket_edit_data(ticket: dict) -> list[str]:
    """Build data model updates for ticket edit page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ticket["title"]),
        value_string("description", ticket.get("description") or ""),
        value_string("priority", ticket["priority"]),
    ]
    messages.append(builder.build_data_model_update("/app/form/edit", form_data))

    return messages

```

```python
"""A2UI Agent Server - Main entry point."""
import asyncio
import json
import logging
from datetime import datetime
from typing import AsyncGenerator, Optional
from urllib.parse import urlparse, parse_qs

from fastapi import FastAPI, Request, Query, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import StreamingResponse, FileResponse
from fastapi.staticfiles import StaticFiles
from sse_starlette.sse import EventSourceResponse

from config import settings
from models import UserAction
from api_client import api_client
from a2ui_builder import A2UIBuilder
from pages.layout import build_app_layout
from pages.tickets import (
    build_tickets_page, build_tickets_data,
    build_ticket_detail_page, build_ticket_detail_data,
    build_ticket_create_page, build_ticket_create_data,
    build_ticket_edit_page, build_ticket_edit_data,
)
from pages.tags import build_tags_page, build_tags_data
from pages.error import build_not_found_page, build_error_page

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(title="A2UI Agent Server", version="1.0.0")

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


def safe_int(value, default: int = 1) -> int:
    """Safely convert value to int with default fallback."""
    if value is None:
        return default
    try:
        return int(value)
    except (ValueError, TypeError):
        return default


async def generate_page_messages(path: str, query_params: dict) -> AsyncGenerator[str, None]:
    """Generate A2UI messages for a given page path."""
    builder = A2UIBuilder("main")

    try:
        # Route to appropriate page builder
        if path == "/" or path == "/tickets":
            # Tickets list page
            search = query_params.get("search", "")
            status = query_params.get("status", "")
            priority = query_params.get("priority", "")
            page = safe_int(query_params.get("page"), 1)
            
            tickets_data = await api_client.list_tickets(
                search=search if search else None,
                status=status if status else None,
                priority=priority if priority else None,
                page=page,
            )
            page_id, _ = build_tickets_page(builder)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_tickets_data(tickets_data, search, status, priority, page):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tickets/new":
            # Ticket create page - fetch tags for selection
            tags = await api_client.list_tags()
            page_id, _ = build_ticket_create_page(builder, tags)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_create_data(tags):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/") and path.endswith("/edit"):
            # Ticket edit page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            page_id, _ = build_ticket_edit_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_edit_data(ticket):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/"):
            # Ticket detail page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            attachments = await api_client.get_ticket_attachments(ticket_id)
            history_response = await api_client.get_ticket_history(ticket_id)
            history = history_response.get("data", [])

            page_id, _ = build_ticket_detail_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_detail_data(ticket, attachments, history):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tags":
            # Tags page
            tags = await api_client.list_tags()
            page_id, _ = build_tags_page(builder)
            build_app_layout(builder, page_id, "tags")

            yield builder.build_surface_update()
            for msg in build_tags_data(tags):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        else:
            # 404 page
            page_id, _ = build_not_found_page(builder)
            build_app_layout(builder, page_id, "")

            yield builder.build_surface_update()
            yield builder.build_begin_rendering("app-layout")

    except Exception as e:
        logger.exception(f"Error generating page: {e}")
        builder.reset()
        page_id, _ = build_error_page(builder, str(e))
        build_app_layout(builder, page_id, "")

        yield builder.build_surface_update()
        yield builder.build_begin_rendering("app-layout")


@app.get("/api/a2ui/stream")
async def stream_ui(
    request: Request,
    path: str = Query("/", description="Page path to render"),
):
    """SSE endpoint for A2UI messages."""
    # Parse query params from the path parameter itself (e.g., /tickets?page=2)
    parsed = urlparse(path)
    actual_path = parsed.path
    path_query_params = parse_qs(parsed.query)

    # Also get query params from the request URL (excluding 'path')
    request_params = dict(request.query_params)
    request_params.pop("path", None)

    # Merge query params (path params take precedence)
    query_params = request_params.copy()
    for key, values in path_query_params.items():
        if values:
            query_params[key] = values[0]  # Take first value

    # Use actual_path for routing
    path = actual_path

    async def event_generator():
        async for message in generate_page_messages(path, query_params):
            if await request.is_disconnected():
                break
            yield {"event": "message", "data": message}

    return EventSourceResponse(event_generator())


@app.post("/api/a2ui/action")
async def handle_action(action: UserAction):
    """Handle userAction from client."""
    logger.info(f"Received action: {action.name} with context: {action.context}")

    try:
        result = await process_action(action)
        return {"success": True, "result": result}
    except Exception as e:
        logger.exception(f"Error processing action: {e}")
        # Return error as JSON instead of raising HTTPException
        # This allows the client to display the error message
        error_message = str(e)
        if "409" in error_message or "Conflict" in error_message:
            error_message = "操作失败：该名称已存在，请使用其他名称"
        elif "400" in error_message or "Bad Request" in error_message:
            error_message = "操作失败：请检查输入内容"
        elif "404" in error_message or "Not Found" in error_message:
            error_message = "操作失败：资源未找到"
        else:
            error_message = f"操作失败：{error_message}"
        return {"success": False, "error": error_message}


async def process_action(action: UserAction) -> dict:
    """Process a userAction and return the result."""
    name = action.name
    context = action.context
    logger.info(f"Processing action '{name}' with context: {context}")

    if name == "navigate":
        # Navigation is handled client-side by reconnecting to SSE
        return {"navigate": context.get("to", "/tickets")}

    elif name in ["search_tickets", "filter_status", "filter_priority", "paginate"]:
        # Get current query params from context (passed from client)
        # Client should pass current query state
        # Handle None/null values from data model
        current_search = context.get("current_search") or ""
        current_status = context.get("current_status") or ""
        current_priority = context.get("current_priority") or ""
        current_page = safe_int(context.get("current_page"), 1)
        
        logger.info(f"Current state: search={current_search}, status={current_status}, priority={current_priority}, page={current_page}")

        # Initialize new values
        new_search = current_search
        new_status = current_status
        new_priority = current_priority
        new_page = current_page

        # Update based on action
        if name == "search_tickets":
            search_term = context.get('search') or ''
            new_search = search_term
            new_page = 1  # Reset to page 1 on new search
        elif name == "filter_status":
            status = context.get("status")
            if status is None:
                status = ""
            new_status = status
            new_page = 1  # Reset to page 1 on filter change
        elif name == "filter_priority":
            priority = context.get("priority")
            if priority is None:
                priority = ""
            new_priority = priority
            new_page = 1  # Reset to page 1 on filter change
        elif name == "paginate":
            page = safe_int(context.get("page"), 1)
            new_page = page

        logger.info(f"New state: search={new_search}, status={new_status}, priority={new_priority}, page={new_page}")

        # Build query string
        query_parts = []
        if new_search:
            query_parts.append(f"search={new_search}")
        if new_status:
            query_parts.append(f"status={new_status}")
        if new_priority:
            query_parts.append(f"priority={new_priority}")
        if new_page > 1:
            query_parts.append(f"page={new_page}")

        query_string = "?" + "&".join(query_parts) if query_parts else ""
        return {"navigate": f"/tickets{query_string}"}

    elif name == "view_ticket":
        ticket_id = context.get("id")
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_ticket":
        form = context.get("form", {})
        ticket = await api_client.create_ticket({
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority", "medium"),
        })
        return {"navigate": f"/tickets/{ticket['id']}"}

    elif name == "update_ticket":
        ticket_id = context.get("id")
        form = context.get("form", {})
        await api_client.update_ticket(ticket_id, {
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority"),
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "delete_ticket":
        ticket_id = context.get("id")
        await api_client.delete_ticket(ticket_id)
        return {"navigate": "/tickets"}

    elif name == "change_status":
        ticket_id = context.get("id")
        status = context.get("status")
        resolution = context.get("resolution")
        await api_client.update_ticket_status(ticket_id, {
            "status": status,
            "resolution": resolution,
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_tag":
        form = context.get("form", {})
        await api_client.create_tag({
            "name": form.get("name"),
            "color": form.get("color", "#3B82F6"),
        })
        return {"navigate": "/tags"}

    elif name == "delete_tag":
        tag_id = context.get("id")
        await api_client.delete_tag(tag_id)
        return {"navigate": "/tags"}

    elif name in ["show_create_tag_form", "hide_create_tag_form", "set_tag_color", "set_form_priority"]:
        # These are handled client-side via data model updates
        return {"handled": True}

    elif name in ["show_delete_dialog", "dismiss_dialog"]:
        # Dialog handling is client-side
        return {"handled": True}

    elif name == "retry":
        # Retry by refreshing current page
        return {"refresh": True}

    else:
        logger.warning(f"Unknown action: {name}")
        return {"unknown": True}


@app.get("/health")
async def health():
    """Health check endpoint."""
    return {"status": "healthy"}


# Serve static files for the client
try:
    app.mount("/", StaticFiles(directory="../client/dist", html=True), name="static")
except RuntimeError:
    # Client not built yet
    @app.get("/")
    async def root():
        return {"message": "A2UI Agent Server is running. Build the client to serve the UI."}


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host=settings.host, port=settings.port)

```

```python
"""A2UI Agent Server - Main entry point."""
import asyncio
import json
import logging
from datetime import datetime
from typing import AsyncGenerator, Optional
from urllib.parse import urlparse, parse_qs

from fastapi import FastAPI, Request, Query, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import StreamingResponse, FileResponse
from fastapi.staticfiles import StaticFiles
from sse_starlette.sse import EventSourceResponse

from config import settings
from models import UserAction
from api_client import api_client
from a2ui_builder import A2UIBuilder
from pages.layout import build_app_layout
from pages.tickets import (
    build_tickets_page, build_tickets_data,
    build_ticket_detail_page, build_ticket_detail_data,
    build_ticket_create_page, build_ticket_create_data,
    build_ticket_edit_page, build_ticket_edit_data,
)
from pages.tags import build_tags_page, build_tags_data
from pages.error import build_not_found_page, build_error_page

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(title="A2UI Agent Server", version="1.0.0")

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


def safe_int(value, default: int = 1) -> int:
    """Safely convert value to int with default fallback."""
    if value is None:
        return default
    try:
        return int(value)
    except (ValueError, TypeError):
        return default


async def generate_page_messages(path: str, query_params: dict) -> AsyncGenerator[str, None]:
    """Generate A2UI messages for a given page path."""
    builder = A2UIBuilder("main")

    try:
        # Route to appropriate page builder
        if path == "/" or path == "/tickets":
            # Tickets list page
            search = query_params.get("search", "")
            status = query_params.get("status", "")
            priority = query_params.get("priority", "")
            page = safe_int(query_params.get("page"), 1)
            
            tickets_data = await api_client.list_tickets(
                search=search if search else None,
                status=status if status else None,
                priority=priority if priority else None,
                page=page,
            )
            page_id, _ = build_tickets_page(builder)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_tickets_data(tickets_data, search, status, priority, page):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tickets/new":
            # Ticket create page - fetch tags for selection
            tags = await api_client.list_tags()
            page_id, _ = build_ticket_create_page(builder, tags)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_create_data(tags):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/") and path.endswith("/edit"):
            # Ticket edit page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            page_id, _ = build_ticket_edit_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_edit_data(ticket):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/"):
            # Ticket detail page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            attachments = await api_client.get_ticket_attachments(ticket_id)
            history_response = await api_client.get_ticket_history(ticket_id)
            history = history_response.get("data", [])

            page_id, _ = build_ticket_detail_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_detail_data(ticket, attachments, history):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tags":
            # Tags page
            tags = await api_client.list_tags()
            page_id, _ = build_tags_page(builder)
            build_app_layout(builder, page_id, "tags")

            yield builder.build_surface_update()
            for msg in build_tags_data(tags):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        else:
            # 404 page
            page_id, _ = build_not_found_page(builder)
            build_app_layout(builder, page_id, "")

            yield builder.build_surface_update()
            yield builder.build_begin_rendering("app-layout")

    except Exception as e:
        logger.exception(f"Error generating page: {e}")
        builder.reset()
        page_id, _ = build_error_page(builder, str(e))
        build_app_layout(builder, page_id, "")

        yield builder.build_surface_update()
        yield builder.build_begin_rendering("app-layout")


@app.get("/api/a2ui/stream")
async def stream_ui(
    request: Request,
    path: str = Query("/", description="Page path to render"),
):
    """SSE endpoint for A2UI messages."""
    # Parse query params from the path parameter itself (e.g., /tickets?page=2)
    parsed = urlparse(path)
    actual_path = parsed.path
    path_query_params = parse_qs(parsed.query)

    # Also get query params from the request URL (excluding 'path')
    request_params = dict(request.query_params)
    request_params.pop("path", None)

    # Merge query params (path params take precedence)
    query_params = request_params.copy()
    for key, values in path_query_params.items():
        if values:
            query_params[key] = values[0]  # Take first value

    # Use actual_path for routing
    path = actual_path

    async def event_generator():
        async for message in generate_page_messages(path, query_params):
            if await request.is_disconnected():
                break
            yield {"event": "message", "data": message}

    return EventSourceResponse(event_generator())


@app.post("/api/a2ui/action")
async def handle_action(action: UserAction):
    """Handle userAction from client."""
    logger.info(f"Received action: {action.name} with context: {action.context}")

    try:
        result = await process_action(action)
        return {"success": True, "result": result}
    except Exception as e:
        logger.exception(f"Error processing action: {e}")
        # Return error as JSON instead of raising HTTPException
        # This allows the client to display the error message
        error_message = str(e)
        if "409" in error_message or "Conflict" in error_message:
            error_message = "操作失败：该名称已存在，请使用其他名称"
        elif "400" in error_message or "Bad Request" in error_message:
            error_message = "操作失败：请检查输入内容"
        elif "404" in error_message or "Not Found" in error_message:
            error_message = "操作失败：资源未找到"
        else:
            error_message = f"操作失败：{error_message}"
        return {"success": False, "error": error_message}


async def process_action(action: UserAction) -> dict:
    """Process a userAction and return the result."""
    name = action.name
    context = action.context
    logger.info(f"Processing action '{name}' with context: {context}")

    if name == "navigate":
        # Navigation is handled client-side by reconnecting to SSE
        return {"navigate": context.get("to", "/tickets")}

    elif name in ["search_tickets", "filter_status", "filter_priority", "paginate"]:
        # Get current query params from context (passed from client)
        # Client should pass current query state
        # Handle None/null values from data model
        current_search = context.get("current_search") or ""
        current_status = context.get("current_status") or ""
        current_priority = context.get("current_priority") or ""
        current_page = safe_int(context.get("current_page"), 1)
        
        logger.info(f"Current state: search={current_search}, status={current_status}, priority={current_priority}, page={current_page}")

        # Initialize new values
        new_search = current_search
        new_status = current_status
        new_priority = current_priority
        new_page = current_page

        # Update based on action
        if name == "search_tickets":
            search_term = context.get('search') or ''
            new_search = search_term
            new_page = 1  # Reset to page 1 on new search
        elif name == "filter_status":
            status = context.get("status")
            if status is None:
                status = ""
            new_status = status
            new_page = 1  # Reset to page 1 on filter change
        elif name == "filter_priority":
            priority = context.get("priority")
            if priority is None:
                priority = ""
            new_priority = priority
            new_page = 1  # Reset to page 1 on filter change
        elif name == "paginate":
            page = safe_int(context.get("page"), 1)
            new_page = page

        logger.info(f"New state: search={new_search}, status={new_status}, priority={new_priority}, page={new_page}")

        # Build query string
        query_parts = []
        if new_search:
            query_parts.append(f"search={new_search}")
        if new_status:
            query_parts.append(f"status={new_status}")
        if new_priority:
            query_parts.append(f"priority={new_priority}")
        if new_page > 1:
            query_parts.append(f"page={new_page}")

        query_string = "?" + "&".join(query_parts) if query_parts else ""
        return {"navigate": f"/tickets{query_string}"}

    elif name == "view_ticket":
        ticket_id = context.get("id")
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_ticket":
        form = context.get("form", {})
        ticket = await api_client.create_ticket({
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority", "medium"),
        })
        return {"navigate": f"/tickets/{ticket['id']}"}

    elif name == "update_ticket":
        ticket_id = context.get("id")
        form = context.get("form", {})
        await api_client.update_ticket(ticket_id, {
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority"),
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "delete_ticket":
        ticket_id = context.get("id")
        await api_client.delete_ticket(ticket_id)
        return {"navigate": "/tickets"}

    elif name == "change_status":
        ticket_id = context.get("id")
        status = context.get("status")
        resolution = context.get("resolution")
        await api_client.update_ticket_status(ticket_id, {
            "status": status,
            "resolution": resolution,
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_tag":
        form = context.get("form", {})
        await api_client.create_tag({
            "name": form.get("name"),
            "color": form.get("color", "#3B82F6"),
        })
        return {"navigate": "/tags"}

    elif name == "delete_tag":
        tag_id = context.get("id")
        await api_client.delete_tag(tag_id)
        return {"navigate": "/tags"}

    elif name in ["show_create_tag_form", "hide_create_tag_form", "set_tag_color", "set_form_priority", "toggle_form_tag"]:
        # These are handled client-side via data model updates
        return {"handled": True}

    elif name in ["show_delete_dialog", "dismiss_dialog"]:
        # Dialog handling is client-side
        return {"handled": True}

    elif name == "retry":
        # Retry by refreshing current page
        return {"refresh": True}

    else:
        logger.warning(f"Unknown action: {name}")
        return {"unknown": True}


@app.get("/health")
async def health():
    """Health check endpoint."""
    return {"status": "healthy"}


# Serve static files for the client
try:
    app.mount("/", StaticFiles(directory="../client/dist", html=True), name="static")
except RuntimeError:
    # Client not built yet
    @app.get("/")
    async def root():
        return {"message": "A2UI Agent Server is running. Build the client to serve the UI."}


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host=settings.host, port=settings.port)

```

```python
"""A2UI Agent Server - Main entry point."""
import asyncio
import json
import logging
from datetime import datetime
from typing import AsyncGenerator, Optional
from urllib.parse import urlparse, parse_qs

from fastapi import FastAPI, Request, Query, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import StreamingResponse, FileResponse
from fastapi.staticfiles import StaticFiles
from sse_starlette.sse import EventSourceResponse

from config import settings
from models import UserAction
from api_client import api_client
from a2ui_builder import A2UIBuilder
from pages.layout import build_app_layout
from pages.tickets import (
    build_tickets_page, build_tickets_data,
    build_ticket_detail_page, build_ticket_detail_data,
    build_ticket_create_page, build_ticket_create_data,
    build_ticket_edit_page, build_ticket_edit_data,
)
from pages.tags import build_tags_page, build_tags_data
from pages.error import build_not_found_page, build_error_page

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(title="A2UI Agent Server", version="1.0.0")

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


def safe_int(value, default: int = 1) -> int:
    """Safely convert value to int with default fallback."""
    if value is None:
        return default
    try:
        return int(value)
    except (ValueError, TypeError):
        return default


async def generate_page_messages(path: str, query_params: dict) -> AsyncGenerator[str, None]:
    """Generate A2UI messages for a given page path."""
    builder = A2UIBuilder("main")

    try:
        # Route to appropriate page builder
        if path == "/" or path == "/tickets":
            # Tickets list page
            search = query_params.get("search", "")
            status = query_params.get("status", "")
            priority = query_params.get("priority", "")
            page = safe_int(query_params.get("page"), 1)
            
            tickets_data = await api_client.list_tickets(
                search=search if search else None,
                status=status if status else None,
                priority=priority if priority else None,
                page=page,
            )
            page_id, _ = build_tickets_page(builder)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_tickets_data(tickets_data, search, status, priority, page):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tickets/new":
            # Ticket create page - fetch tags for selection
            tags = await api_client.list_tags()
            page_id, _ = build_ticket_create_page(builder, tags)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_create_data(tags):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/") and path.endswith("/edit"):
            # Ticket edit page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            page_id, _ = build_ticket_edit_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_edit_data(ticket):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/"):
            # Ticket detail page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            attachments = await api_client.get_ticket_attachments(ticket_id)
            history_response = await api_client.get_ticket_history(ticket_id)
            history = history_response.get("data", [])

            page_id, _ = build_ticket_detail_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_detail_data(ticket, attachments, history):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tags":
            # Tags page
            tags = await api_client.list_tags()
            page_id, _ = build_tags_page(builder)
            build_app_layout(builder, page_id, "tags")

            yield builder.build_surface_update()
            for msg in build_tags_data(tags):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        else:
            # 404 page
            page_id, _ = build_not_found_page(builder)
            build_app_layout(builder, page_id, "")

            yield builder.build_surface_update()
            yield builder.build_begin_rendering("app-layout")

    except Exception as e:
        logger.exception(f"Error generating page: {e}")
        builder.reset()
        page_id, _ = build_error_page(builder, str(e))
        build_app_layout(builder, page_id, "")

        yield builder.build_surface_update()
        yield builder.build_begin_rendering("app-layout")


@app.get("/api/a2ui/stream")
async def stream_ui(
    request: Request,
    path: str = Query("/", description="Page path to render"),
):
    """SSE endpoint for A2UI messages."""
    # Parse query params from the path parameter itself (e.g., /tickets?page=2)
    parsed = urlparse(path)
    actual_path = parsed.path
    path_query_params = parse_qs(parsed.query)

    # Also get query params from the request URL (excluding 'path')
    request_params = dict(request.query_params)
    request_params.pop("path", None)

    # Merge query params (path params take precedence)
    query_params = request_params.copy()
    for key, values in path_query_params.items():
        if values:
            query_params[key] = values[0]  # Take first value

    # Use actual_path for routing
    path = actual_path

    async def event_generator():
        async for message in generate_page_messages(path, query_params):
            if await request.is_disconnected():
                break
            yield {"event": "message", "data": message}

    return EventSourceResponse(event_generator())


@app.post("/api/a2ui/action")
async def handle_action(action: UserAction):
    """Handle userAction from client."""
    logger.info(f"Received action: {action.name} with context: {action.context}")

    try:
        result = await process_action(action)
        return {"success": True, "result": result}
    except Exception as e:
        logger.exception(f"Error processing action: {e}")
        # Return error as JSON instead of raising HTTPException
        # This allows the client to display the error message
        error_message = str(e)
        if "409" in error_message or "Conflict" in error_message:
            error_message = "操作失败：该名称已存在，请使用其他名称"
        elif "400" in error_message or "Bad Request" in error_message:
            error_message = "操作失败：请检查输入内容"
        elif "404" in error_message or "Not Found" in error_message:
            error_message = "操作失败：资源未找到"
        else:
            error_message = f"操作失败：{error_message}"
        return {"success": False, "error": error_message}


async def process_action(action: UserAction) -> dict:
    """Process a userAction and return the result."""
    name = action.name
    context = action.context
    logger.info(f"Processing action '{name}' with context: {context}")

    if name == "navigate":
        # Navigation is handled client-side by reconnecting to SSE
        return {"navigate": context.get("to", "/tickets")}

    elif name in ["search_tickets", "filter_status", "filter_priority", "paginate"]:
        # Get current query params from context (passed from client)
        # Client should pass current query state
        # Handle None/null values from data model
        current_search = context.get("current_search") or ""
        current_status = context.get("current_status") or ""
        current_priority = context.get("current_priority") or ""
        current_page = safe_int(context.get("current_page"), 1)
        
        logger.info(f"Current state: search={current_search}, status={current_status}, priority={current_priority}, page={current_page}")

        # Initialize new values
        new_search = current_search
        new_status = current_status
        new_priority = current_priority
        new_page = current_page

        # Update based on action
        if name == "search_tickets":
            search_term = context.get('search') or ''
            new_search = search_term
            new_page = 1  # Reset to page 1 on new search
        elif name == "filter_status":
            status = context.get("status")
            if status is None:
                status = ""
            new_status = status
            new_page = 1  # Reset to page 1 on filter change
        elif name == "filter_priority":
            priority = context.get("priority")
            if priority is None:
                priority = ""
            new_priority = priority
            new_page = 1  # Reset to page 1 on filter change
        elif name == "paginate":
            page = safe_int(context.get("page"), 1)
            new_page = page

        logger.info(f"New state: search={new_search}, status={new_status}, priority={new_priority}, page={new_page}")

        # Build query string
        query_parts = []
        if new_search:
            query_parts.append(f"search={new_search}")
        if new_status:
            query_parts.append(f"status={new_status}")
        if new_priority:
            query_parts.append(f"priority={new_priority}")
        if new_page > 1:
            query_parts.append(f"page={new_page}")

        query_string = "?" + "&".join(query_parts) if query_parts else ""
        return {"navigate": f"/tickets{query_string}"}

    elif name == "view_ticket":
        ticket_id = context.get("id")
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_ticket":
        form = context.get("form", {})
        ticket = await api_client.create_ticket({
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority", "medium"),
        })
        ticket_id = ticket['id']
        
        # Add selected tags to the ticket
        selected_tag_ids = form.get("selectedTagIds", "")
        if selected_tag_ids:
            tag_ids = [tid.strip() for tid in selected_tag_ids.split(",") if tid.strip()]
            for tag_id in tag_ids:
                try:
                    await api_client.add_tag_to_ticket(ticket_id, tag_id)
                except Exception as e:
                    logger.warning(f"Failed to add tag {tag_id} to ticket {ticket_id}: {e}")
        
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "update_ticket":
        ticket_id = context.get("id")
        form = context.get("form", {})
        await api_client.update_ticket(ticket_id, {
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority"),
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "delete_ticket":
        ticket_id = context.get("id")
        await api_client.delete_ticket(ticket_id)
        return {"navigate": "/tickets"}

    elif name == "change_status":
        ticket_id = context.get("id")
        status = context.get("status")
        resolution = context.get("resolution")
        await api_client.update_ticket_status(ticket_id, {
            "status": status,
            "resolution": resolution,
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_tag":
        form = context.get("form", {})
        await api_client.create_tag({
            "name": form.get("name"),
            "color": form.get("color", "#3B82F6"),
        })
        return {"navigate": "/tags"}

    elif name == "delete_tag":
        tag_id = context.get("id")
        await api_client.delete_tag(tag_id)
        return {"navigate": "/tags"}

    elif name in ["show_create_tag_form", "hide_create_tag_form", "set_tag_color", "set_form_priority", "toggle_form_tag"]:
        # These are handled client-side via data model updates
        return {"handled": True}

    elif name in ["show_delete_dialog", "dismiss_dialog"]:
        # Dialog handling is client-side
        return {"handled": True}

    elif name == "retry":
        # Retry by refreshing current page
        return {"refresh": True}

    else:
        logger.warning(f"Unknown action: {name}")
        return {"unknown": True}


@app.get("/health")
async def health():
    """Health check endpoint."""
    return {"status": "healthy"}


# Serve static files for the client
try:
    app.mount("/", StaticFiles(directory="../client/dist", html=True), name="static")
except RuntimeError:
    # Client not built yet
    @app.get("/")
    async def root():
        return {"message": "A2UI Agent Server is running. Build the client to serve the UI."}


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host=settings.host, port=settings.port)

```

```typescript
/**
 * A2UI Client Shell - Main entry point
 */
import './renderer';
import type { A2UIMessage, Action, UserAction, SurfaceUpdate, DataModelUpdate, BeginRendering } from './types';
import type { A2UISurface } from './renderer';

class A2UIClient {
  private surface: A2UISurface | null = null;
  private eventSource: EventSource | null = null;
  private currentPath: string = '/';
  private lastConnectedPath: string = '';

  constructor() {
    this.init();
  }

  private async init(): Promise<void> {
    // Create surface element
    const app = document.getElementById('app');
    if (!app) {
      console.error('App container not found');
      return;
    }

    // Clear loading state
    app.innerHTML = '';

    // Create surface
    this.surface = document.createElement('a2ui-surface') as A2UISurface;
    this.surface.surfaceId = 'main';
    this.surface.setActionHandler((action, sourceId, contextPath) => this.handleAction(action, sourceId, contextPath));
    app.appendChild(this.surface);

    // Get initial path from URL
    this.currentPath = window.location.pathname + window.location.search;

    // Handle browser navigation
    window.addEventListener('popstate', () => {
      this.currentPath = window.location.pathname + window.location.search;
      this.connect();
    });

    // Connect to server
    this.connect();
  }

  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Only clear data model when path changes (navigation), not on reconnect
    if (this.surface && this.currentPath !== this.lastConnectedPath) {
      this.surface.dataModel.clear();
      this.lastConnectedPath = this.currentPath;
    }

    // Build SSE URL
    const sseUrl = `/api/a2ui/stream?path=${encodeURIComponent(this.currentPath)}`;
    console.log(`Connecting to: ${sseUrl}`);

    this.eventSource = new EventSource(sseUrl);

    this.eventSource.onmessage = (event) => {
      this.handleMessage(event.data);
    };

    this.eventSource.onerror = (error) => {
      console.error('SSE error:', error);
      // Attempt to reconnect after delay
      setTimeout(() => {
        if (this.eventSource?.readyState === EventSource.CLOSED) {
          this.connect();
        }
      }, 3000);
    };

    this.eventSource.onopen = () => {
      console.log('SSE connection established');
    };
  }

  private handleMessage(data: string): void {
    try {
      const message: A2UIMessage = JSON.parse(data);

      if ('surfaceUpdate' in message) {
        this.handleSurfaceUpdate(message as SurfaceUpdate);
      } else if ('dataModelUpdate' in message) {
        this.handleDataModelUpdate(message as DataModelUpdate);
      } else if ('beginRendering' in message) {
        this.handleBeginRendering(message as BeginRendering);
      } else if ('deleteSurface' in message) {
        console.log('Surface deleted');
      }
    } catch (error) {
      console.error('Error parsing message:', error, data);
    }
  }

  private handleSurfaceUpdate(message: SurfaceUpdate): void {
    if (this.surface && message.surfaceUpdate.surfaceId === this.surface.surfaceId) {
      this.surface.setComponents(message.surfaceUpdate.components);
    }
  }

  private handleDataModelUpdate(message: DataModelUpdate): void {
    if (this.surface && message.dataModelUpdate.surfaceId === this.surface.surfaceId) {
      const path = message.dataModelUpdate.path || '/';
      this.surface.dataModel.update(path, message.dataModelUpdate.contents);
    }
  }

  private handleBeginRendering(message: BeginRendering): void {
    if (this.surface && message.beginRendering.surfaceId === this.surface.surfaceId) {
      this.surface.setRoot(message.beginRendering.root);
    }
  }

  private async handleAction(action: Action, sourceId: string, contextPath?: string): Promise<void> {
    console.log(`Action: ${action.name} from ${sourceId}`, action.context, `contextPath: ${contextPath}`);

    // Build context object from action.context array
    // Pass contextPath to resolve relative paths (e.g., "id" -> "/app/tickets/list/ticket0/id")
    const context: Record<string, unknown> = {};
    if (action.context) {
      for (const item of action.context) {
        const value = this.surface?.dataModel.resolve(item.value, contextPath);
        // Convert undefined to null to ensure it's included in JSON
        context[item.key] = value !== undefined ? value : null;
        console.log(`  Context ${item.key}:`, value, 'from', item.value);
      }
    }

    // Build userAction
    const userAction: UserAction = {
      name: action.name,
      surfaceId: this.surface?.surfaceId || 'main',
      sourceComponentId: sourceId,
      timestamp: new Date().toISOString(),
      context,
    };

    try {
      const response = await fetch('/api/a2ui/action', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(userAction),
      });

      const result = await response.json();
      console.log('Action result:', result);

      // Check for error response
      if (!result.success && result.error) {
        // Show error message to user
        alert(result.error);
        return;
      }

      // Show success message for certain actions
      const successMessages: Record<string, string> = {
        'create_tag': '标签创建成功！',
        'create_ticket': '票据创建成功！',
        'update_ticket': '票据更新成功！',
        'delete_ticket': '票据删除成功！',
        'delete_tag': '标签删除成功！',
        'change_status': '状态更新成功！',
      };
      
      if (successMessages[action.name] && result.result?.navigate) {
        alert(successMessages[action.name]);
      }

      // Handle navigation
      if (result.result?.navigate) {
        this.navigate(result.result.navigate);
      } else if (result.result?.refresh) {
        this.connect();
      } else if (result.result?.handled) {
        // Handle client-side actions
        this.handleClientSideAction(action.name, context);
      }
    } catch (error) {
      console.error('Error sending action:', error);
      alert('操作失败，请稍后重试');
    }
  }

  private navigate(path: string): void {
    // Update URL without reload
    window.history.pushState({}, '', path);
    // Store full path including query string for SSE reconnection
    this.currentPath = path;

    // Force clear data model on navigation (even if path is the same)
    // This ensures fresh data is loaded after create/delete operations
    if (this.surface) {
      this.surface.dataModel.clear();
    }
    // Reset lastConnectedPath to force data refresh
    this.lastConnectedPath = '';

    // Reconnect to get new page
    this.connect();
  }

  private handleClientSideAction(name: string, context: Record<string, unknown>): void {
    if (!this.surface) return;
    
    console.log(`[Client] Handling client-side action: ${name}`, context);
    
    let needsUpdate = false;
    
    if (name === 'set_form_priority') {
      // Determine the form path based on current page
      const priority = context.priority as string;
      const isEditPage = this.currentPath.includes('/edit');
      const formPath = isEditPage ? '/app/form/edit/priority' : '/app/form/create/priority';
      this.surface.dataModel.set(formPath, priority);
      console.log(`[Client] Set ${formPath} = ${priority}`);
      needsUpdate = true;
    } else if (name === 'set_tag_color') {
      // Set tag form color
      const color = context.color as string;
      this.surface.dataModel.set('/app/tags/form/color', color);
      console.log(`[Client] Set /app/tags/form/color = ${color}`);
      needsUpdate = true;
    } else if (name === 'show_create_tag_form') {
      this.surface.dataModel.set('/app/tags/showForm', true);
      console.log(`[Client] Set /app/tags/showForm = true`);
      needsUpdate = true;
    } else if (name === 'hide_create_tag_form') {
      this.surface.dataModel.set('/app/tags/showForm', false);
      console.log(`[Client] Set /app/tags/showForm = false`);
      needsUpdate = true;
    } else if (name === 'show_delete_dialog') {
      // Show delete confirmation dialog
      const id = context.id as string;
      this.surface.dataModel.set('/app/dialog/deleteId', id);
      this.surface.dataModel.set('/app/dialog/show', true);
      console.log(`[Client] Show delete dialog for id: ${id}`);
      needsUpdate = true;
    } else if (name === 'dismiss_dialog') {
      this.surface.dataModel.set('/app/dialog/show', false);
      console.log(`[Client] Dismiss dialog`);
      needsUpdate = true;
    } else if (name === 'toggle_form_tag') {
      // Toggle tag selection for create/edit ticket form
      const tagId = context.tagId as string;
      const isEditPage = this.currentPath.includes('/edit');
      const formPath = isEditPage ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      
      const currentSelected = (this.surface.dataModel.get(formPath) as string) || '';
      const selectedIds = currentSelected ? currentSelected.split(',').filter(id => id.trim()) : [];
      
      const index = selectedIds.indexOf(tagId);
      if (index >= 0) {
        // Remove tag
        selectedIds.splice(index, 1);
      } else {
        // Add tag
        selectedIds.push(tagId);
      }
      
      this.surface.dataModel.set(formPath, selectedIds.join(','));
      console.log(`[Client] Toggle tag ${tagId}, selectedTagIds: ${selectedIds.join(',')}`);
      needsUpdate = true;
    }
    
    // Trigger re-render to update UI (e.g., button selection states)
    if (needsUpdate) {
      this.surface.requestUpdate();
    }
  }
}

// Initialize client
new A2UIClient();

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

已完成新建票据页面的标签选择功能！

**实现内容：**

1. **创建票据页面** - 添加了"标签（可多选）"区域，显示系统中所有可用标签作为可选择的按钮
2. **标签多选** - 点击标签按钮可以切换选中状态，选中的标签会高亮显示
3. **创建票据时自动添加标签** - 创建票据后，选中的标签会自动关联到新票据

服务器已重启，请刷新页面访问「新建票据」页面测试：

1. 打开新建票据页面 `/tickets/new`
2. 您应该能看到"标签（可多选）"区域
3. 点击标签按钮可以选中/取消选中（选中后会高亮）
4. 创建票据后，选中的标签会自动关联

**注意**：如果系统中还没有创建标签，会显示"暂无可用标签"。您可以先到标签管理页面创建一些标签。

是否需要我也为编辑票据页面添加标签管理功能？

---

**User**

标签应该是一个可多选的下拉菜单，而不是现在的展现形式。

---

**Cursor**

```python
"""A2UI v0.8 message builder utilities."""
import json
from typing import Any, Optional, Union


class A2UIBuilder:
    """Builder for A2UI v0.8 JSONL messages."""

    def __init__(self, surface_id: str = "main"):
        self.surface_id = surface_id
        self._components: list[dict] = []
        self._data_updates: list[dict] = []

    def reset(self):
        """Reset builder state."""
        self._components = []
        self._data_updates = []

    # Value helpers
    @staticmethod
    def literal_string(value: str) -> dict:
        return {"literalString": value}

    @staticmethod
    def literal_number(value: Union[int, float]) -> dict:
        return {"literalNumber": value}

    @staticmethod
    def literal_bool(value: bool) -> dict:
        return {"literalBoolean": value}

    @staticmethod
    def path(value: str) -> dict:
        return {"path": value}

    # Component builders
    def text(
        self,
        component_id: str,
        text: Union[str, dict],
        usage_hint: Optional[str] = None,
    ) -> "A2UIBuilder":
        """Add a Text component."""
        text_value = text if isinstance(text, dict) else self.literal_string(text)
        props: dict[str, Any] = {"text": text_value}
        if usage_hint:
            props["usageHint"] = usage_hint
        self._components.append({
            "id": component_id,
            "component": {"Text": props}
        })
        return self

    def button(
        self,
        component_id: str,
        child_id: str,
        action_name: str,
        context: Optional[list[dict]] = None,
    ) -> "A2UIBuilder":
        """Add a Button component."""
        action: dict[str, Any] = {"name": action_name}
        if context:
            action["context"] = context
        self._components.append({
            "id": component_id,
            "component": {"Button": {"child": child_id, "action": action}}
        })
        return self

    def text_field(
        self,
        component_id: str,
        label: Union[str, dict],
        text: Optional[Union[str, dict]] = None,
        text_field_type: Optional[str] = None,
    ) -> "A2UIBuilder":
        """Add a TextField component."""
        label_value = label if isinstance(label, dict) else self.literal_string(label)
        props: dict[str, Any] = {"label": label_value}
        if text:
            text_value = text if isinstance(text, dict) else self.literal_string(text)
            props["text"] = text_value
        if text_field_type:
            props["textFieldType"] = text_field_type
        self._components.append({
            "id": component_id,
            "component": {"TextField": props}
        })
        return self

    def column(
        self,
        component_id: str,
        children: list[str],
        alignment: Optional[str] = None,
        distribution: Optional[str] = None,
    ) -> "A2UIBuilder":
        """Add a Column component."""
        props: dict[str, Any] = {"children": {"explicitList": children}}
        if alignment:
            props["alignment"] = alignment
        if distribution:
            props["distribution"] = distribution
        self._components.append({
            "id": component_id,
            "component": {"Column": props}
        })
        return self

    def row(
        self,
        component_id: str,
        children: list[str],
        alignment: Optional[str] = None,
        distribution: Optional[str] = None,
    ) -> "A2UIBuilder":
        """Add a Row component."""
        props: dict[str, Any] = {"children": {"explicitList": children}}
        if alignment:
            props["alignment"] = alignment
        if distribution:
            props["distribution"] = distribution
        self._components.append({
            "id": component_id,
            "component": {"Row": props}
        })
        return self

    def card(
        self,
        component_id: str,
        child: str,
    ) -> "A2UIBuilder":
        """Add a Card component."""
        self._components.append({
            "id": component_id,
            "component": {"Card": {"child": child}}
        })
        return self

    def list_component(
        self,
        component_id: str,
        children: Optional[list[str]] = None,
        template: Optional[dict] = None,
        direction: str = "vertical",
        alignment: Optional[str] = None,
    ) -> "A2UIBuilder":
        """Add a List component."""
        props: dict[str, Any] = {"direction": direction}
        if children:
            props["children"] = {"explicitList": children}
        elif template:
            props["children"] = {"template": template}
        if alignment:
            props["alignment"] = alignment
        self._components.append({
            "id": component_id,
            "component": {"List": props}
        })
        return self

    def icon(
        self,
        component_id: str,
        name: Union[str, dict],
    ) -> "A2UIBuilder":
        """Add an Icon component."""
        name_value = name if isinstance(name, dict) else self.literal_string(name)
        self._components.append({
            "id": component_id,
            "component": {"Icon": {"name": name_value}}
        })
        return self

    def divider(self, component_id: str) -> "A2UIBuilder":
        """Add a Divider component."""
        self._components.append({
            "id": component_id,
            "component": {"Divider": {}}
        })
        return self

    def modal(
        self,
        component_id: str,
        entry_point_child: str,
        content_child: str,
    ) -> "A2UIBuilder":
        """Add a Modal component."""
        self._components.append({
            "id": component_id,
            "component": {"Modal": {
                "entryPointChild": entry_point_child,
                "contentChild": content_child,
            }}
        })
        return self

    def checkbox(
        self,
        component_id: str,
        label: Union[str, dict],
        value: Union[bool, dict],
    ) -> "A2UIBuilder":
        """Add a CheckBox component."""
        label_value = label if isinstance(label, dict) else self.literal_string(label)
        value_data = value if isinstance(value, dict) else self.literal_bool(value)
        self._components.append({
            "id": component_id,
            "component": {"CheckBox": {"label": label_value, "value": value_data}}
        })
        return self

    def slider(
        self,
        component_id: str,
        value: Union[int, float, dict],
        min_value: Optional[Union[int, float]] = None,
        max_value: Optional[Union[int, float]] = None,
    ) -> "A2UIBuilder":
        """Add a Slider component."""
        value_data = value if isinstance(value, dict) else self.literal_number(value)
        props: dict[str, Any] = {"value": value_data}
        if min_value is not None:
            props["minValue"] = min_value
        if max_value is not None:
            props["maxValue"] = max_value
        self._components.append({
            "id": component_id,
            "component": {"Slider": props}
        })
        return self

    def multi_select(
        self,
        component_id: str,
        label: Union[str, dict],
        options: list[dict],  # List of {id, name, color?} dicts
        selected_path: str,  # Path to comma-separated selected IDs
        action_name: str = "toggle_multi_select",
    ) -> "A2UIBuilder":
        """Add a MultiSelect dropdown component."""
        label_value = label if isinstance(label, dict) else self.literal_string(label)
        self._components.append({
            "id": component_id,
            "component": {"MultiSelect": {
                "label": label_value,
                "options": options,
                "selectedPath": selected_path,
                "actionName": action_name,
            }}
        })
        return self

    def add_component(self, component: dict) -> "A2UIBuilder":
        """Add a raw component dict."""
        self._components.append(component)
        return self

    def add_components(self, components: list[dict]) -> "A2UIBuilder":
        """Add multiple raw component dicts."""
        self._components.extend(components)
        return self

    # Message builders
    def build_surface_update(self) -> str:
        """Build surfaceUpdate JSONL message."""
        return json.dumps({
            "surfaceUpdate": {
                "surfaceId": self.surface_id,
                "components": self._components
            }
        })

    def build_data_model_update(
        self,
        path: str,
        contents: list[dict],
    ) -> str:
        """Build dataModelUpdate JSONL message."""
        return json.dumps({
            "dataModelUpdate": {
                "surfaceId": self.surface_id,
                "path": path,
                "contents": contents
            }
        })

    def build_begin_rendering(self, root: str) -> str:
        """Build beginRendering JSONL message."""
        return json.dumps({
            "beginRendering": {
                "surfaceId": self.surface_id,
                "root": root
            }
        })

    def build_delete_surface(self) -> str:
        """Build deleteSurface JSONL message."""
        return json.dumps({
            "deleteSurface": {
                "surfaceId": self.surface_id
            }
        })


# Data model helpers
def value_string(key: str, value: str) -> dict:
    return {"key": key, "valueString": value}


def value_number(key: str, value: Union[int, float]) -> dict:
    return {"key": key, "valueNumber": value}


def value_bool(key: str, value: bool) -> dict:
    return {"key": key, "valueBoolean": value}


def value_map(key: str, items: list[dict]) -> dict:
    return {"key": key, "valueMap": items}


def build_value_map_from_dict(data: dict) -> list[dict]:
    """Convert a Python dict to A2UI ValueMap contents."""
    contents = []
    for key, value in data.items():
        if isinstance(value, str):
            contents.append(value_string(key, value))
        elif isinstance(value, bool):
            contents.append(value_bool(key, value))
        elif isinstance(value, (int, float)):
            contents.append(value_number(key, value))
        elif isinstance(value, dict):
            contents.append(value_map(key, build_value_map_from_dict(value)))
        elif isinstance(value, list):
            # Convert list to map with index keys
            list_map = []
            for i, item in enumerate(value):
                if isinstance(item, dict):
                    list_map.append(value_map(f"item{i}", build_value_map_from_dict(item)))
                else:
                    list_map.append(value_string(f"item{i}", str(item)))
            contents.append(value_map(key, list_map))
        elif value is None:
            contents.append(value_string(key, ""))
    return contents

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Client Shell - Main entry point
 */
import './renderer';
import type { A2UIMessage, Action, UserAction, SurfaceUpdate, DataModelUpdate, BeginRendering } from './types';
import type { A2UISurface } from './renderer';

class A2UIClient {
  private surface: A2UISurface | null = null;
  private eventSource: EventSource | null = null;
  private currentPath: string = '/';
  private lastConnectedPath: string = '';

  constructor() {
    this.init();
  }

  private async init(): Promise<void> {
    // Create surface element
    const app = document.getElementById('app');
    if (!app) {
      console.error('App container not found');
      return;
    }

    // Clear loading state
    app.innerHTML = '';

    // Create surface
    this.surface = document.createElement('a2ui-surface') as A2UISurface;
    this.surface.surfaceId = 'main';
    this.surface.setActionHandler((action, sourceId, contextPath) => this.handleAction(action, sourceId, contextPath));
    app.appendChild(this.surface);

    // Get initial path from URL
    this.currentPath = window.location.pathname + window.location.search;

    // Handle browser navigation
    window.addEventListener('popstate', () => {
      this.currentPath = window.location.pathname + window.location.search;
      this.connect();
    });

    // Connect to server
    this.connect();
  }

  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Only clear data model when path changes (navigation), not on reconnect
    if (this.surface && this.currentPath !== this.lastConnectedPath) {
      this.surface.dataModel.clear();
      this.lastConnectedPath = this.currentPath;
    }

    // Build SSE URL
    const sseUrl = `/api/a2ui/stream?path=${encodeURIComponent(this.currentPath)}`;
    console.log(`Connecting to: ${sseUrl}`);

    this.eventSource = new EventSource(sseUrl);

    this.eventSource.onmessage = (event) => {
      this.handleMessage(event.data);
    };

    this.eventSource.onerror = (error) => {
      console.error('SSE error:', error);
      // Attempt to reconnect after delay
      setTimeout(() => {
        if (this.eventSource?.readyState === EventSource.CLOSED) {
          this.connect();
        }
      }, 3000);
    };

    this.eventSource.onopen = () => {
      console.log('SSE connection established');
    };
  }

  private handleMessage(data: string): void {
    try {
      const message: A2UIMessage = JSON.parse(data);

      if ('surfaceUpdate' in message) {
        this.handleSurfaceUpdate(message as SurfaceUpdate);
      } else if ('dataModelUpdate' in message) {
        this.handleDataModelUpdate(message as DataModelUpdate);
      } else if ('beginRendering' in message) {
        this.handleBeginRendering(message as BeginRendering);
      } else if ('deleteSurface' in message) {
        console.log('Surface deleted');
      }
    } catch (error) {
      console.error('Error parsing message:', error, data);
    }
  }

  private handleSurfaceUpdate(message: SurfaceUpdate): void {
    if (this.surface && message.surfaceUpdate.surfaceId === this.surface.surfaceId) {
      this.surface.setComponents(message.surfaceUpdate.components);
    }
  }

  private handleDataModelUpdate(message: DataModelUpdate): void {
    if (this.surface && message.dataModelUpdate.surfaceId === this.surface.surfaceId) {
      const path = message.dataModelUpdate.path || '/';
      this.surface.dataModel.update(path, message.dataModelUpdate.contents);
    }
  }

  private handleBeginRendering(message: BeginRendering): void {
    if (this.surface && message.beginRendering.surfaceId === this.surface.surfaceId) {
      this.surface.setRoot(message.beginRendering.root);
    }
  }

  private async handleAction(action: Action, sourceId: string, contextPath?: string): Promise<void> {
    console.log(`Action: ${action.name} from ${sourceId}`, action.context, `contextPath: ${contextPath}`);

    // Build context object from action.context array
    // Pass contextPath to resolve relative paths (e.g., "id" -> "/app/tickets/list/ticket0/id")
    const context: Record<string, unknown> = {};
    if (action.context) {
      for (const item of action.context) {
        const value = this.surface?.dataModel.resolve(item.value, contextPath);
        // Convert undefined to null to ensure it's included in JSON
        context[item.key] = value !== undefined ? value : null;
        console.log(`  Context ${item.key}:`, value, 'from', item.value);
      }
    }

    // Build userAction
    const userAction: UserAction = {
      name: action.name,
      surfaceId: this.surface?.surfaceId || 'main',
      sourceComponentId: sourceId,
      timestamp: new Date().toISOString(),
      context,
    };

    try {
      const response = await fetch('/api/a2ui/action', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(userAction),
      });

      const result = await response.json();
      console.log('Action result:', result);

      // Check for error response
      if (!result.success && result.error) {
        // Show error message to user
        alert(result.error);
        return;
      }

      // Show success message for certain actions
      const successMessages: Record<string, string> = {
        'create_tag': '标签创建成功！',
        'create_ticket': '票据创建成功！',
        'update_ticket': '票据更新成功！',
        'delete_ticket': '票据删除成功！',
        'delete_tag': '标签删除成功！',
        'change_status': '状态更新成功！',
      };
      
      if (successMessages[action.name] && result.result?.navigate) {
        alert(successMessages[action.name]);
      }

      // Handle navigation
      if (result.result?.navigate) {
        this.navigate(result.result.navigate);
      } else if (result.result?.refresh) {
        this.connect();
      } else if (result.result?.handled) {
        // Handle client-side actions
        this.handleClientSideAction(action.name, context);
      }
    } catch (error) {
      console.error('Error sending action:', error);
      alert('操作失败，请稍后重试');
    }
  }

  private navigate(path: string): void {
    // Update URL without reload
    window.history.pushState({}, '', path);
    // Store full path including query string for SSE reconnection
    this.currentPath = path;

    // Force clear data model on navigation (even if path is the same)
    // This ensures fresh data is loaded after create/delete operations
    if (this.surface) {
      this.surface.dataModel.clear();
    }
    // Reset lastConnectedPath to force data refresh
    this.lastConnectedPath = '';

    // Reconnect to get new page
    this.connect();
  }

  private handleClientSideAction(name: string, context: Record<string, unknown>): void {
    if (!this.surface) return;
    
    console.log(`[Client] Handling client-side action: ${name}`, context);
    
    let needsUpdate = false;
    
    if (name === 'set_form_priority') {
      // Determine the form path based on current page
      const priority = context.priority as string;
      const isEditPage = this.currentPath.includes('/edit');
      const formPath = isEditPage ? '/app/form/edit/priority' : '/app/form/create/priority';
      this.surface.dataModel.set(formPath, priority);
      console.log(`[Client] Set ${formPath} = ${priority}`);
      needsUpdate = true;
    } else if (name === 'set_tag_color') {
      // Set tag form color
      const color = context.color as string;
      this.surface.dataModel.set('/app/tags/form/color', color);
      console.log(`[Client] Set /app/tags/form/color = ${color}`);
      needsUpdate = true;
    } else if (name === 'show_create_tag_form') {
      this.surface.dataModel.set('/app/tags/showForm', true);
      console.log(`[Client] Set /app/tags/showForm = true`);
      needsUpdate = true;
    } else if (name === 'hide_create_tag_form') {
      this.surface.dataModel.set('/app/tags/showForm', false);
      console.log(`[Client] Set /app/tags/showForm = false`);
      needsUpdate = true;
    } else if (name === 'show_delete_dialog') {
      // Show delete confirmation dialog
      const id = context.id as string;
      this.surface.dataModel.set('/app/dialog/deleteId', id);
      this.surface.dataModel.set('/app/dialog/show', true);
      console.log(`[Client] Show delete dialog for id: ${id}`);
      needsUpdate = true;
    } else if (name === 'dismiss_dialog') {
      this.surface.dataModel.set('/app/dialog/show', false);
      console.log(`[Client] Dismiss dialog`);
      needsUpdate = true;
    } else if (name === 'toggle_form_tag' || name === 'toggle_multi_select') {
      // Toggle selection in multi-select (works for tags and other multi-selects)
      const optionId = (context.optionId || context.tagId) as string;
      const selectedPath = context.selectedPath as string | undefined;
      
      // Determine path - use explicit selectedPath or infer from context
      let formPath: string;
      if (selectedPath) {
        formPath = selectedPath;
      } else {
        const isEditPage = this.currentPath.includes('/edit');
        formPath = isEditPage ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      }
      
      const currentSelected = (this.surface.dataModel.get(formPath) as string) || '';
      const selectedIds = currentSelected ? currentSelected.split(',').filter(id => id.trim()) : [];
      
      const index = selectedIds.indexOf(optionId);
      if (index >= 0) {
        // Remove option
        selectedIds.splice(index, 1);
      } else {
        // Add option
        selectedIds.push(optionId);
      }
      
      this.surface.dataModel.set(formPath, selectedIds.join(','));
      console.log(`[Client] Toggle ${optionId} in ${formPath}, selected: ${selectedIds.join(',')}`);
      needsUpdate = true;
    }
    
    // Trigger re-render to update UI (e.g., button selection states)
    if (needsUpdate) {
      this.surface.requestUpdate();
    }
  }
}

// Initialize client
new A2UIClient();

```

```python
"""Ticket page builders."""
from typing import Any, Optional
from a2ui_builder import A2UIBuilder, value_string, value_number, value_map, build_value_map_from_dict
from models import (
    STATUS_LABELS, PRIORITY_LABELS, STATUS_TRANSITIONS,
    TicketStatus, Priority
)


def build_tickets_page(builder: A2UIBuilder) -> tuple[str, list[str]]:
    """Build the tickets list page."""
    # Page header
    builder.text("tickets-title", "票据列表", usage_hint="h1")
    builder.text("tickets-add-text", "+ 新建票据")
    builder.button(
        "tickets-add-btn",
        "tickets-add-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets/new"}}],
    )
    builder.row("tickets-header", ["tickets-title", "tickets-add-btn"], distribution="spaceBetween", alignment="center")

    # Search
    builder.text_field("tickets-search", "搜索票据...", builder.path("/app/tickets/query/search"))
    builder.text("tickets-search-btn-text", "搜索")
    builder.button(
        "tickets-search-btn",
        "tickets-search-btn-text",
        "search_tickets",
        [
            {"key": "search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-search-row", ["tickets-search", "tickets-search-btn"], alignment="center")

    # Status filter buttons
    builder.text("filter-all-text", "全部")
    builder.button("filter-all", "filter-all-text", "filter_status", [
        {"key": "status", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-open-text", "待处理")
    builder.button("filter-open", "filter-open-text", "filter_status", [
        {"key": "status", "value": {"literalString": "open"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-progress-text", "处理中")
    builder.button("filter-progress", "filter-progress-text", "filter_status", [
        {"key": "status", "value": {"literalString": "in_progress"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-completed-text", "已完成")
    builder.button("filter-completed", "filter-completed-text", "filter_status", [
        {"key": "status", "value": {"literalString": "completed"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-cancelled-text", "已取消")
    builder.button("filter-cancelled", "filter-cancelled-text", "filter_status", [
        {"key": "status", "value": {"literalString": "cancelled"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-status-filters", ["filter-all", "filter-open", "filter-progress", "filter-completed", "filter-cancelled"], alignment="center")

    # Priority filter buttons
    builder.text("priority-all-text", "全部优先级")
    builder.button("priority-all", "priority-all-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-low-text", "低")
    builder.button("priority-low", "priority-low-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "low"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-medium-text", "中")
    builder.button("priority-medium", "priority-medium-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "medium"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-high-text", "高")
    builder.button("priority-high", "priority-high-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "high"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-urgent-text", "紧急")
    builder.button("priority-urgent", "priority-urgent-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "urgent"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-priority-filters", ["priority-all", "priority-low", "priority-medium", "priority-high", "priority-urgent"], alignment="center")

    builder.column("tickets-filters", ["tickets-search-row", "tickets-status-filters", "tickets-priority-filters"])
    builder.card("tickets-filters-card", "tickets-filters")

    # Ticket list template - simplified without icons
    builder.text("ticket-item-title", builder.path("title"), usage_hint="h3")
    builder.text("ticket-item-status", builder.path("statusLabel"))
    builder.text("ticket-item-priority", builder.path("priorityLabel"))
    builder.text("ticket-item-date", builder.path("created_at"))
    builder.row("ticket-item-meta", ["ticket-item-status", "ticket-item-priority", "ticket-item-date"], alignment="center")
    builder.column("ticket-item-content", ["ticket-item-title", "ticket-item-meta"])
    builder.text("ticket-item-arrow", "→")
    builder.row("ticket-item-row", ["ticket-item-content", "ticket-item-arrow"], distribution="spaceBetween", alignment="center")
    builder.button(
        "ticket-item-btn",
        "ticket-item-row",
        "view_ticket",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.card("ticket-item-card", "ticket-item-btn")

    # Ticket list
    builder.list_component(
        "tickets-list",
        template={"componentId": "ticket-item-card", "dataBinding": "/app/tickets/list"},
        direction="vertical",
    )

    # Empty state
    builder.text("tickets-empty-title", "暂无票据", usage_hint="h3")
    builder.text("tickets-empty-desc", "点击上方按钮创建第一个票据")
    builder.column("tickets-empty", ["tickets-empty-title", "tickets-empty-desc"], alignment="center")

    # Pagination - use literalNumber for page values since they're numbers
    builder.text("pagination-prev-text", "← 上一页")
    builder.button(
        "pagination-prev",
        "pagination-prev-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/prevPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.text("pagination-info", builder.path("/app/tickets/pagination/info"))
    builder.text("pagination-next-text", "下一页 →")
    builder.button(
        "pagination-next",
        "pagination-next-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/nextPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-pagination", ["pagination-prev", "pagination-info", "pagination-next"], distribution="center", alignment="center")

    # Main content
    builder.column("tickets-content", ["tickets-list", "tickets-pagination"])
    builder.column("tickets-page", ["tickets-header", "tickets-filters-card", "tickets-content"])

    return "tickets-page", []


def build_tickets_data(tickets_response: dict, search: str = "", status: str = "", priority: str = "", page: int = 1) -> list[str]:
    """Build data model updates for tickets page."""
    messages = []
    builder = A2UIBuilder()

    # Query state - use actual values from URL params
    query_data = [
        value_string("search", search),
        value_string("status", status),
        value_string("priority", priority),
        value_number("page", page),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/query", query_data))

    # Tickets list
    tickets = tickets_response.get("data", [])
    list_data = []
    for i, ticket in enumerate(tickets):
        ticket_map = build_value_map_from_dict({
            "id": ticket["id"],
            "title": ticket["title"],
            "status": ticket["status"],
            "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
            "priority": ticket["priority"],
            "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
            "created_at": ticket["created_at"][:10],  # Date only
        })
        list_data.append(value_map(f"ticket{i}", ticket_map))
    messages.append(builder.build_data_model_update("/app/tickets/list", list_data))

    # Pagination
    page = tickets_response.get("page", 1)
    total_pages = tickets_response.get("total_pages", 0)
    total_count = tickets_response.get("total", 0)
    
    # If no data, show "第0页/共0页"
    if total_count == 0 or total_pages == 0:
        display_page = 0
        display_total = 0
    else:
        display_page = page
        display_total = total_pages
    
    pagination_data = [
        value_number("page", display_page),
        value_number("totalPages", display_total),
        value_number("prevPage", max(1, page - 1) if total_pages > 0 else 0),
        value_number("nextPage", min(total_pages, page + 1) if total_pages > 0 else 0),
        value_string("info", f"第 {display_page} 页 / 共 {display_total} 页"),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/pagination", pagination_data))

    return messages


def build_ticket_detail_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket detail page."""
    ticket_id = ticket["id"]
    status = ticket["status"]

    # Back button
    builder.text("detail-back-text", "← 返回列表")
    builder.button(
        "detail-back-btn",
        "detail-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    # Title
    builder.text("detail-title", builder.path("/app/ticket/detail/title"), usage_hint="h1")

    # Actions
    builder.text("detail-edit-text", "编辑")
    builder.button(
        "detail-edit-btn",
        "detail-edit-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}/edit"}}],
    )

    builder.text("detail-delete-text", "删除")
    builder.button(
        "detail-delete-btn",
        "detail-delete-text",
        "show_delete_dialog",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )

    builder.row("detail-actions", ["detail-edit-btn", "detail-delete-btn"], alignment="center")
    builder.row("detail-header", ["detail-back-btn", "detail-title", "detail-actions"], distribution="spaceBetween", alignment="center")

    # Description card
    builder.text("detail-desc-label", "描述", usage_hint="h4")
    builder.text("detail-desc-content", builder.path("/app/ticket/detail/description"))
    builder.column("detail-desc-col", ["detail-desc-label", "detail-desc-content"])
    builder.card("detail-desc-card", "detail-desc-col")

    # Resolution card (if exists)
    builder.text("detail-resolution-label", "处理结果", usage_hint="h4")
    builder.text("detail-resolution-content", builder.path("/app/ticket/detail/resolution"))
    builder.column("detail-resolution-col", ["detail-resolution-label", "detail-resolution-content"])
    builder.card("detail-resolution-card", "detail-resolution-col")

    # Status card
    builder.text("detail-status-label", "状态", usage_hint="h4")
    builder.text("detail-status-value", builder.path("/app/ticket/detail/statusLabel"))

    # Status transition buttons
    allowed_transitions = STATUS_TRANSITIONS.get(TicketStatus(status), [])
    status_btns = []
    for target_status in allowed_transitions:
        btn_id = f"status-btn-{target_status.value}"
        text_id = f"status-btn-text-{target_status.value}"
        builder.text(text_id, f"→ {STATUS_LABELS[target_status]}")
        builder.button(
            btn_id,
            text_id,
            "change_status",
            [
                {"key": "id", "value": {"literalString": ticket_id}},
                {"key": "status", "value": {"literalString": target_status.value}},
            ],
        )
        status_btns.append(btn_id)

    builder.row("detail-status-btns", status_btns, alignment="center")
    builder.column("detail-status-col", ["detail-status-label", "detail-status-value", "detail-status-btns"])
    builder.card("detail-status-card", "detail-status-col")

    # Priority card
    builder.text("detail-priority-label", "优先级", usage_hint="h4")
    builder.text("detail-priority-value", builder.path("/app/ticket/detail/priorityLabel"))
    builder.column("detail-priority-col", ["detail-priority-label", "detail-priority-value"])
    builder.card("detail-priority-card", "detail-priority-col")

    # Tags card
    builder.text("detail-tags-label", "标签", usage_hint="h4")
    builder.text("detail-tag-name", builder.path("name"))
    builder.list_component(
        "detail-tags-list",
        template={"componentId": "detail-tag-name", "dataBinding": "/app/ticket/tags"},
        direction="horizontal",
    )
    builder.column("detail-tags-col", ["detail-tags-label", "detail-tags-list"])
    builder.card("detail-tags-card", "detail-tags-col")

    # Timestamps card
    builder.text("detail-time-label", "时间信息", usage_hint="h4")
    builder.text("detail-created-label", "创建时间")
    builder.text("detail-created-value", builder.path("/app/ticket/detail/created_at"))
    builder.row("detail-created-row", ["detail-created-label", "detail-created-value"], distribution="spaceBetween")
    builder.text("detail-updated-label", "更新时间")
    builder.text("detail-updated-value", builder.path("/app/ticket/detail/updated_at"))
    builder.row("detail-updated-row", ["detail-updated-label", "detail-updated-value"], distribution="spaceBetween")
    builder.column("detail-time-col", ["detail-time-label", "detail-created-row", "detail-updated-row"])
    builder.card("detail-time-card", "detail-time-col")

    # Attachments card
    builder.text("detail-attach-label", "附件", usage_hint="h4")
    builder.text("detail-attach-filename", builder.path("filename"))
    builder.text("detail-attach-size", builder.path("sizeFormatted"))
    builder.row("detail-attach-info", ["detail-attach-filename", "detail-attach-size"], distribution="spaceBetween")
    builder.text("detail-attach-download-text", "下载")
    builder.button(
        "detail-attach-download",
        "detail-attach-download-text",
        "download_attachment",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.row("detail-attach-item", ["detail-attach-info", "detail-attach-download"], distribution="spaceBetween", alignment="center")
    builder.list_component(
        "detail-attach-list",
        template={"componentId": "detail-attach-item", "dataBinding": "/app/ticket/attachments"},
        direction="vertical",
    )
    builder.text("detail-attach-empty", "暂无附件")
    builder.column("detail-attach-col", ["detail-attach-label", "detail-attach-list"])
    builder.card("detail-attach-card", "detail-attach-col")

    # History card
    builder.text("detail-history-label", "变更历史", usage_hint="h4")
    builder.text("detail-history-type", builder.path("changeTypeLabel"))
    builder.text("detail-history-time", builder.path("created_at"))
    builder.text("detail-history-old", builder.path("old_value"))
    builder.text("detail-history-arrow", "→")
    builder.text("detail-history-new", builder.path("new_value"))
    builder.row("detail-history-change", ["detail-history-old", "detail-history-arrow", "detail-history-new"], alignment="center")
    builder.column("detail-history-item", ["detail-history-type", "detail-history-time", "detail-history-change"])
    builder.list_component(
        "detail-history-list",
        template={"componentId": "detail-history-item", "dataBinding": "/app/ticket/history"},
        direction="vertical",
    )
    builder.column("detail-history-col", ["detail-history-label", "detail-history-list"])
    builder.card("detail-history-card", "detail-history-col")

    # Left column (main content)
    main_cards = ["detail-desc-card"]
    if ticket.get("resolution"):
        main_cards.append("detail-resolution-card")
    main_cards.append("detail-attach-card")
    builder.column("detail-main", main_cards)

    # Right column (sidebar)
    builder.column("detail-sidebar", [
        "detail-status-card",
        "detail-priority-card",
        "detail-tags-card",
        "detail-time-card",
        "detail-history-card",
    ])

    # Layout
    builder.row("detail-body", ["detail-main", "detail-sidebar"], distribution="start")
    builder.column("detail-page", ["detail-header", "detail-body"])

    # Delete confirmation modal
    builder.text("delete-modal-title", "确认删除", usage_hint="h3")
    builder.text("delete-modal-desc", "确定要删除这个票据吗？此操作无法撤销。")
    builder.text("delete-modal-cancel-text", "取消")
    builder.button("delete-modal-cancel", "delete-modal-cancel-text", "dismiss_dialog", [])
    builder.text("delete-modal-confirm-text", "确认删除")
    builder.button(
        "delete-modal-confirm",
        "delete-modal-confirm-text",
        "delete_ticket",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )
    builder.row("delete-modal-actions", ["delete-modal-cancel", "delete-modal-confirm"], distribution="end")
    builder.column("delete-modal-content", ["delete-modal-title", "delete-modal-desc", "delete-modal-actions"])

    return "detail-page", []


def build_ticket_detail_data(ticket: dict, attachments: list, history: list) -> list[str]:
    """Build data model updates for ticket detail page."""
    messages = []
    builder = A2UIBuilder()

    # Ticket detail
    detail_data = build_value_map_from_dict({
        "id": ticket["id"],
        "title": ticket["title"],
        "description": ticket.get("description") or "无描述",
        "status": ticket["status"],
        "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
        "priority": ticket["priority"],
        "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
        "resolution": ticket.get("resolution") or "",
        "created_at": ticket["created_at"][:19].replace("T", " "),
        "updated_at": ticket["updated_at"][:19].replace("T", " "),
    })
    messages.append(builder.build_data_model_update("/app/ticket/detail", detail_data))

    # Tags
    tags = ticket.get("tags", [])
    tags_data = []
    for i, tag in enumerate(tags):
        tags_data.append(value_map(f"tag{i}", build_value_map_from_dict({
            "id": tag["id"],
            "name": tag["name"],
            "color": tag["color"],
        })))
    messages.append(builder.build_data_model_update("/app/ticket/tags", tags_data))

    # Attachments
    attach_data = []
    for i, att in enumerate(attachments):
        size_bytes = att["size_bytes"]
        if size_bytes < 1024:
            size_formatted = f"{size_bytes} B"
        elif size_bytes < 1024 * 1024:
            size_formatted = f"{size_bytes / 1024:.1f} KB"
        else:
            size_formatted = f"{size_bytes / (1024 * 1024):.1f} MB"
        attach_data.append(value_map(f"att{i}", build_value_map_from_dict({
            "id": att["id"],
            "filename": att["filename"],
            "sizeFormatted": size_formatted,
        })))
    messages.append(builder.build_data_model_update("/app/ticket/attachments", attach_data))

    # History
    change_type_labels = {
        "status": "状态变更",
        "priority": "优先级变更",
        "resolution": "处理结果",
        "tag_added": "添加标签",
        "tag_removed": "移除标签",
    }
    history_data = []
    for i, h in enumerate(history):
        history_data.append(value_map(f"h{i}", build_value_map_from_dict({
            "changeTypeLabel": change_type_labels.get(h["change_type"], h["change_type"]),
            "old_value": h.get("old_value") or "-",
            "new_value": h.get("new_value") or "-",
            "created_at": h["created_at"][:19].replace("T", " "),
        })))
    messages.append(builder.build_data_model_update("/app/ticket/history", history_data))

    return messages


def build_ticket_create_page(builder: A2UIBuilder, tags: list) -> tuple[str, list[str]]:
    """Build the ticket create page."""
    # Back button
    builder.text("create-back-text", "← 返回列表")
    builder.button(
        "create-back-btn",
        "create-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    builder.text("create-title", "新建票据", usage_hint="h1")
    builder.row("create-header", ["create-back-btn", "create-title"], alignment="center")

    # Form
    builder.text("create-title-label", "标题 *", usage_hint="h4")
    builder.text_field("create-title-input", "请输入票据标题", builder.path("/app/form/create/title"))

    builder.text("create-desc-label", "描述", usage_hint="h4")
    builder.text_field("create-desc-input", "请输入详细描述...", builder.path("/app/form/create/description"), text_field_type="multiline")

    builder.text("create-priority-label", "优先级", usage_hint="h4")
    # Priority selection buttons
    builder.text("create-priority-low-text", "低")
    builder.button("create-priority-low", "create-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("create-priority-medium-text", "中")
    builder.button("create-priority-medium", "create-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("create-priority-high-text", "高")
    builder.button("create-priority-high", "create-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("create-priority-urgent-text", "紧急")
    builder.button("create-priority-urgent", "create-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("create-priority-btns", ["create-priority-low", "create-priority-medium", "create-priority-high", "create-priority-urgent"], alignment="center")

    # Tags selection - multi-select dropdown
    tag_options = [
        {"id": tag.get("id", ""), "name": tag.get("name", ""), "color": tag.get("color", "#3B82F6")}
        for tag in tags
    ]
    builder.multi_select(
        "create-tags-select",
        "标签（可多选）",
        tag_options,
        "/app/form/create/selectedTagIds",
        "toggle_multi_select",
    )

    builder.column("create-form-fields", [
        "create-title-label", "create-title-input",
        "create-desc-label", "create-desc-input",
        "create-priority-label", "create-priority-btns",
        "create-tags-select",
    ])

    # Actions
    builder.divider("create-divider")
    builder.text("create-cancel-text", "取消")
    builder.button(
        "create-cancel-btn",
        "create-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )
    builder.text("create-submit-text", "创建票据")
    builder.button(
        "create-submit-btn",
        "create-submit-text",
        "create_ticket",
        [{"key": "form", "value": {"path": "/app/form/create"}}],
    )
    builder.row("create-actions", ["create-cancel-btn", "create-submit-btn"], distribution="end", alignment="center")

    builder.column("create-form", ["create-form-fields", "create-divider", "create-actions"])
    builder.card("create-form-card", "create-form")
    builder.column("create-page", ["create-header", "create-form-card"])

    return "create-page", []


def build_ticket_create_data(tags: list) -> list[str]:
    """Build data model updates for ticket create page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ""),
        value_string("description", ""),
        value_string("priority", "medium"),
        value_string("selectedTagIds", ""),  # Comma-separated tag IDs
    ]
    messages.append(builder.build_data_model_update("/app/form/create", form_data))

    # Store available tags for reference
    tags_data = []
    for i, tag in enumerate(tags):
        tags_data.append(value_map(f"tag{i}", build_value_map_from_dict({
            "id": tag.get("id", ""),
            "name": tag.get("name", ""),
            "color": tag.get("color", "#3B82F6"),
        })))
    messages.append(builder.build_data_model_update("/app/form/create/availableTags", tags_data))

    return messages


def build_ticket_edit_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket edit page."""
    ticket_id = ticket["id"]

    # Back button
    builder.text("edit-back-text", "← 返回详情")
    builder.button(
        "edit-back-btn",
        "edit-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )

    builder.text("edit-title", "编辑票据", usage_hint="h1")
    builder.row("edit-header", ["edit-back-btn", "edit-title"], alignment="center")

    # Form
    builder.text("edit-title-label", "标题 *", usage_hint="h4")
    builder.text_field("edit-title-input", "请输入票据标题", builder.path("/app/form/edit/title"))

    builder.text("edit-desc-label", "描述", usage_hint="h4")
    builder.text_field("edit-desc-input", "请输入详细描述...", builder.path("/app/form/edit/description"), text_field_type="multiline")

    builder.text("edit-priority-label", "优先级", usage_hint="h4")
    builder.text("edit-priority-low-text", "低")
    builder.button("edit-priority-low", "edit-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("edit-priority-medium-text", "中")
    builder.button("edit-priority-medium", "edit-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("edit-priority-high-text", "高")
    builder.button("edit-priority-high", "edit-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("edit-priority-urgent-text", "紧急")
    builder.button("edit-priority-urgent", "edit-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("edit-priority-btns", ["edit-priority-low", "edit-priority-medium", "edit-priority-high", "edit-priority-urgent"], alignment="center")

    builder.column("edit-form-fields", [
        "edit-title-label", "edit-title-input",
        "edit-desc-label", "edit-desc-input",
        "edit-priority-label", "edit-priority-btns",
    ])

    # Actions
    builder.divider("edit-divider")
    builder.text("edit-cancel-text", "取消")
    builder.button(
        "edit-cancel-btn",
        "edit-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )
    builder.text("edit-submit-text", "保存更改")
    builder.button(
        "edit-submit-btn",
        "edit-submit-text",
        "update_ticket",
        [
            {"key": "id", "value": {"literalString": ticket_id}},
            {"key": "form", "value": {"path": "/app/form/edit"}},
        ],
    )
    builder.row("edit-actions", ["edit-cancel-btn", "edit-submit-btn"], distribution="end", alignment="center")

    builder.column("edit-form", ["edit-form-fields", "edit-divider", "edit-actions"])
    builder.card("edit-form-card", "edit-form")
    builder.column("edit-page", ["edit-header", "edit-form-card"])

    return "edit-page", []


def build_ticket_edit_data(ticket: dict) -> list[str]:
    """Build data model updates for ticket edit page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ticket["title"]),
        value_string("description", ticket.get("description") or ""),
        value_string("priority", ticket["priority"]),
    ]
    messages.append(builder.build_data_model_update("/app/form/edit", form_data))

    return messages

```

```python
"""Ticket page builders."""
from typing import Any, Optional
from a2ui_builder import A2UIBuilder, value_string, value_number, value_map, build_value_map_from_dict
from models import (
    STATUS_LABELS, PRIORITY_LABELS, STATUS_TRANSITIONS,
    TicketStatus, Priority
)


def build_tickets_page(builder: A2UIBuilder) -> tuple[str, list[str]]:
    """Build the tickets list page."""
    # Page header
    builder.text("tickets-title", "票据列表", usage_hint="h1")
    builder.text("tickets-add-text", "+ 新建票据")
    builder.button(
        "tickets-add-btn",
        "tickets-add-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets/new"}}],
    )
    builder.row("tickets-header", ["tickets-title", "tickets-add-btn"], distribution="spaceBetween", alignment="center")

    # Search
    builder.text_field("tickets-search", "搜索票据...", builder.path("/app/tickets/query/search"))
    builder.text("tickets-search-btn-text", "搜索")
    builder.button(
        "tickets-search-btn",
        "tickets-search-btn-text",
        "search_tickets",
        [
            {"key": "search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-search-row", ["tickets-search", "tickets-search-btn"], alignment="center")

    # Status filter buttons
    builder.text("filter-all-text", "全部")
    builder.button("filter-all", "filter-all-text", "filter_status", [
        {"key": "status", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-open-text", "待处理")
    builder.button("filter-open", "filter-open-text", "filter_status", [
        {"key": "status", "value": {"literalString": "open"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-progress-text", "处理中")
    builder.button("filter-progress", "filter-progress-text", "filter_status", [
        {"key": "status", "value": {"literalString": "in_progress"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-completed-text", "已完成")
    builder.button("filter-completed", "filter-completed-text", "filter_status", [
        {"key": "status", "value": {"literalString": "completed"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-cancelled-text", "已取消")
    builder.button("filter-cancelled", "filter-cancelled-text", "filter_status", [
        {"key": "status", "value": {"literalString": "cancelled"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-status-filters", ["filter-all", "filter-open", "filter-progress", "filter-completed", "filter-cancelled"], alignment="center")

    # Priority filter buttons
    builder.text("priority-all-text", "全部优先级")
    builder.button("priority-all", "priority-all-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-low-text", "低")
    builder.button("priority-low", "priority-low-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "low"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-medium-text", "中")
    builder.button("priority-medium", "priority-medium-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "medium"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-high-text", "高")
    builder.button("priority-high", "priority-high-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "high"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-urgent-text", "紧急")
    builder.button("priority-urgent", "priority-urgent-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "urgent"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-priority-filters", ["priority-all", "priority-low", "priority-medium", "priority-high", "priority-urgent"], alignment="center")

    builder.column("tickets-filters", ["tickets-search-row", "tickets-status-filters", "tickets-priority-filters"])
    builder.card("tickets-filters-card", "tickets-filters")

    # Ticket list template - simplified without icons
    builder.text("ticket-item-title", builder.path("title"), usage_hint="h3")
    builder.text("ticket-item-status", builder.path("statusLabel"))
    builder.text("ticket-item-priority", builder.path("priorityLabel"))
    builder.text("ticket-item-date", builder.path("created_at"))
    builder.row("ticket-item-meta", ["ticket-item-status", "ticket-item-priority", "ticket-item-date"], alignment="center")
    builder.column("ticket-item-content", ["ticket-item-title", "ticket-item-meta"])
    builder.text("ticket-item-arrow", "→")
    builder.row("ticket-item-row", ["ticket-item-content", "ticket-item-arrow"], distribution="spaceBetween", alignment="center")
    builder.button(
        "ticket-item-btn",
        "ticket-item-row",
        "view_ticket",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.card("ticket-item-card", "ticket-item-btn")

    # Ticket list
    builder.list_component(
        "tickets-list",
        template={"componentId": "ticket-item-card", "dataBinding": "/app/tickets/list"},
        direction="vertical",
    )

    # Empty state
    builder.text("tickets-empty-title", "暂无票据", usage_hint="h3")
    builder.text("tickets-empty-desc", "点击上方按钮创建第一个票据")
    builder.column("tickets-empty", ["tickets-empty-title", "tickets-empty-desc"], alignment="center")

    # Pagination - use literalNumber for page values since they're numbers
    builder.text("pagination-prev-text", "← 上一页")
    builder.button(
        "pagination-prev",
        "pagination-prev-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/prevPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.text("pagination-info", builder.path("/app/tickets/pagination/info"))
    builder.text("pagination-next-text", "下一页 →")
    builder.button(
        "pagination-next",
        "pagination-next-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/nextPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-pagination", ["pagination-prev", "pagination-info", "pagination-next"], distribution="center", alignment="center")

    # Main content
    builder.column("tickets-content", ["tickets-list", "tickets-pagination"])
    builder.column("tickets-page", ["tickets-header", "tickets-filters-card", "tickets-content"])

    return "tickets-page", []


def build_tickets_data(tickets_response: dict, search: str = "", status: str = "", priority: str = "", page: int = 1) -> list[str]:
    """Build data model updates for tickets page."""
    messages = []
    builder = A2UIBuilder()

    # Query state - use actual values from URL params
    query_data = [
        value_string("search", search),
        value_string("status", status),
        value_string("priority", priority),
        value_number("page", page),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/query", query_data))

    # Tickets list
    tickets = tickets_response.get("data", [])
    list_data = []
    for i, ticket in enumerate(tickets):
        ticket_map = build_value_map_from_dict({
            "id": ticket["id"],
            "title": ticket["title"],
            "status": ticket["status"],
            "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
            "priority": ticket["priority"],
            "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
            "created_at": ticket["created_at"][:10],  # Date only
        })
        list_data.append(value_map(f"ticket{i}", ticket_map))
    messages.append(builder.build_data_model_update("/app/tickets/list", list_data))

    # Pagination
    page = tickets_response.get("page", 1)
    total_pages = tickets_response.get("total_pages", 0)
    total_count = tickets_response.get("total", 0)
    
    # If no data, show "第0页/共0页"
    if total_count == 0 or total_pages == 0:
        display_page = 0
        display_total = 0
    else:
        display_page = page
        display_total = total_pages
    
    pagination_data = [
        value_number("page", display_page),
        value_number("totalPages", display_total),
        value_number("prevPage", max(1, page - 1) if total_pages > 0 else 0),
        value_number("nextPage", min(total_pages, page + 1) if total_pages > 0 else 0),
        value_string("info", f"第 {display_page} 页 / 共 {display_total} 页"),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/pagination", pagination_data))

    return messages


def build_ticket_detail_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket detail page."""
    ticket_id = ticket["id"]
    status = ticket["status"]

    # Back button
    builder.text("detail-back-text", "← 返回列表")
    builder.button(
        "detail-back-btn",
        "detail-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    # Title
    builder.text("detail-title", builder.path("/app/ticket/detail/title"), usage_hint="h1")

    # Actions
    builder.text("detail-edit-text", "编辑")
    builder.button(
        "detail-edit-btn",
        "detail-edit-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}/edit"}}],
    )

    builder.text("detail-delete-text", "删除")
    builder.button(
        "detail-delete-btn",
        "detail-delete-text",
        "show_delete_dialog",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )

    builder.row("detail-actions", ["detail-edit-btn", "detail-delete-btn"], alignment="center")
    builder.row("detail-header", ["detail-back-btn", "detail-title", "detail-actions"], distribution="spaceBetween", alignment="center")

    # Description card
    builder.text("detail-desc-label", "描述", usage_hint="h4")
    builder.text("detail-desc-content", builder.path("/app/ticket/detail/description"))
    builder.column("detail-desc-col", ["detail-desc-label", "detail-desc-content"])
    builder.card("detail-desc-card", "detail-desc-col")

    # Resolution card (if exists)
    builder.text("detail-resolution-label", "处理结果", usage_hint="h4")
    builder.text("detail-resolution-content", builder.path("/app/ticket/detail/resolution"))
    builder.column("detail-resolution-col", ["detail-resolution-label", "detail-resolution-content"])
    builder.card("detail-resolution-card", "detail-resolution-col")

    # Status card
    builder.text("detail-status-label", "状态", usage_hint="h4")
    builder.text("detail-status-value", builder.path("/app/ticket/detail/statusLabel"))

    # Status transition buttons
    allowed_transitions = STATUS_TRANSITIONS.get(TicketStatus(status), [])
    status_btns = []
    for target_status in allowed_transitions:
        btn_id = f"status-btn-{target_status.value}"
        text_id = f"status-btn-text-{target_status.value}"
        builder.text(text_id, f"→ {STATUS_LABELS[target_status]}")
        builder.button(
            btn_id,
            text_id,
            "change_status",
            [
                {"key": "id", "value": {"literalString": ticket_id}},
                {"key": "status", "value": {"literalString": target_status.value}},
            ],
        )
        status_btns.append(btn_id)

    builder.row("detail-status-btns", status_btns, alignment="center")
    builder.column("detail-status-col", ["detail-status-label", "detail-status-value", "detail-status-btns"])
    builder.card("detail-status-card", "detail-status-col")

    # Priority card
    builder.text("detail-priority-label", "优先级", usage_hint="h4")
    builder.text("detail-priority-value", builder.path("/app/ticket/detail/priorityLabel"))
    builder.column("detail-priority-col", ["detail-priority-label", "detail-priority-value"])
    builder.card("detail-priority-card", "detail-priority-col")

    # Tags card
    builder.text("detail-tags-label", "标签", usage_hint="h4")
    builder.text("detail-tag-name", builder.path("name"))
    builder.list_component(
        "detail-tags-list",
        template={"componentId": "detail-tag-name", "dataBinding": "/app/ticket/tags"},
        direction="horizontal",
    )
    builder.column("detail-tags-col", ["detail-tags-label", "detail-tags-list"])
    builder.card("detail-tags-card", "detail-tags-col")

    # Timestamps card
    builder.text("detail-time-label", "时间信息", usage_hint="h4")
    builder.text("detail-created-label", "创建时间")
    builder.text("detail-created-value", builder.path("/app/ticket/detail/created_at"))
    builder.row("detail-created-row", ["detail-created-label", "detail-created-value"], distribution="spaceBetween")
    builder.text("detail-updated-label", "更新时间")
    builder.text("detail-updated-value", builder.path("/app/ticket/detail/updated_at"))
    builder.row("detail-updated-row", ["detail-updated-label", "detail-updated-value"], distribution="spaceBetween")
    builder.column("detail-time-col", ["detail-time-label", "detail-created-row", "detail-updated-row"])
    builder.card("detail-time-card", "detail-time-col")

    # Attachments card
    builder.text("detail-attach-label", "附件", usage_hint="h4")
    builder.text("detail-attach-filename", builder.path("filename"))
    builder.text("detail-attach-size", builder.path("sizeFormatted"))
    builder.row("detail-attach-info", ["detail-attach-filename", "detail-attach-size"], distribution="spaceBetween")
    builder.text("detail-attach-download-text", "下载")
    builder.button(
        "detail-attach-download",
        "detail-attach-download-text",
        "download_attachment",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.row("detail-attach-item", ["detail-attach-info", "detail-attach-download"], distribution="spaceBetween", alignment="center")
    builder.list_component(
        "detail-attach-list",
        template={"componentId": "detail-attach-item", "dataBinding": "/app/ticket/attachments"},
        direction="vertical",
    )
    builder.text("detail-attach-empty", "暂无附件")
    builder.column("detail-attach-col", ["detail-attach-label", "detail-attach-list"])
    builder.card("detail-attach-card", "detail-attach-col")

    # History card
    builder.text("detail-history-label", "变更历史", usage_hint="h4")
    builder.text("detail-history-type", builder.path("changeTypeLabel"))
    builder.text("detail-history-time", builder.path("created_at"))
    builder.text("detail-history-old", builder.path("old_value"))
    builder.text("detail-history-arrow", "→")
    builder.text("detail-history-new", builder.path("new_value"))
    builder.row("detail-history-change", ["detail-history-old", "detail-history-arrow", "detail-history-new"], alignment="center")
    builder.column("detail-history-item", ["detail-history-type", "detail-history-time", "detail-history-change"])
    builder.list_component(
        "detail-history-list",
        template={"componentId": "detail-history-item", "dataBinding": "/app/ticket/history"},
        direction="vertical",
    )
    builder.column("detail-history-col", ["detail-history-label", "detail-history-list"])
    builder.card("detail-history-card", "detail-history-col")

    # Left column (main content)
    main_cards = ["detail-desc-card"]
    if ticket.get("resolution"):
        main_cards.append("detail-resolution-card")
    main_cards.append("detail-attach-card")
    builder.column("detail-main", main_cards)

    # Right column (sidebar)
    builder.column("detail-sidebar", [
        "detail-status-card",
        "detail-priority-card",
        "detail-tags-card",
        "detail-time-card",
        "detail-history-card",
    ])

    # Layout
    builder.row("detail-body", ["detail-main", "detail-sidebar"], distribution="start")
    builder.column("detail-page", ["detail-header", "detail-body"])

    # Delete confirmation modal
    builder.text("delete-modal-title", "确认删除", usage_hint="h3")
    builder.text("delete-modal-desc", "确定要删除这个票据吗？此操作无法撤销。")
    builder.text("delete-modal-cancel-text", "取消")
    builder.button("delete-modal-cancel", "delete-modal-cancel-text", "dismiss_dialog", [])
    builder.text("delete-modal-confirm-text", "确认删除")
    builder.button(
        "delete-modal-confirm",
        "delete-modal-confirm-text",
        "delete_ticket",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )
    builder.row("delete-modal-actions", ["delete-modal-cancel", "delete-modal-confirm"], distribution="end")
    builder.column("delete-modal-content", ["delete-modal-title", "delete-modal-desc", "delete-modal-actions"])

    return "detail-page", []


def build_ticket_detail_data(ticket: dict, attachments: list, history: list) -> list[str]:
    """Build data model updates for ticket detail page."""
    messages = []
    builder = A2UIBuilder()

    # Ticket detail
    detail_data = build_value_map_from_dict({
        "id": ticket["id"],
        "title": ticket["title"],
        "description": ticket.get("description") or "无描述",
        "status": ticket["status"],
        "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
        "priority": ticket["priority"],
        "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
        "resolution": ticket.get("resolution") or "",
        "created_at": ticket["created_at"][:19].replace("T", " "),
        "updated_at": ticket["updated_at"][:19].replace("T", " "),
    })
    messages.append(builder.build_data_model_update("/app/ticket/detail", detail_data))

    # Tags
    tags = ticket.get("tags", [])
    tags_data = []
    for i, tag in enumerate(tags):
        tags_data.append(value_map(f"tag{i}", build_value_map_from_dict({
            "id": tag["id"],
            "name": tag["name"],
            "color": tag["color"],
        })))
    messages.append(builder.build_data_model_update("/app/ticket/tags", tags_data))

    # Attachments
    attach_data = []
    for i, att in enumerate(attachments):
        size_bytes = att["size_bytes"]
        if size_bytes < 1024:
            size_formatted = f"{size_bytes} B"
        elif size_bytes < 1024 * 1024:
            size_formatted = f"{size_bytes / 1024:.1f} KB"
        else:
            size_formatted = f"{size_bytes / (1024 * 1024):.1f} MB"
        attach_data.append(value_map(f"att{i}", build_value_map_from_dict({
            "id": att["id"],
            "filename": att["filename"],
            "sizeFormatted": size_formatted,
        })))
    messages.append(builder.build_data_model_update("/app/ticket/attachments", attach_data))

    # History
    change_type_labels = {
        "status": "状态变更",
        "priority": "优先级变更",
        "resolution": "处理结果",
        "tag_added": "添加标签",
        "tag_removed": "移除标签",
    }
    history_data = []
    for i, h in enumerate(history):
        history_data.append(value_map(f"h{i}", build_value_map_from_dict({
            "changeTypeLabel": change_type_labels.get(h["change_type"], h["change_type"]),
            "old_value": h.get("old_value") or "-",
            "new_value": h.get("new_value") or "-",
            "created_at": h["created_at"][:19].replace("T", " "),
        })))
    messages.append(builder.build_data_model_update("/app/ticket/history", history_data))

    return messages


def build_ticket_create_page(builder: A2UIBuilder, tags: list) -> tuple[str, list[str]]:
    """Build the ticket create page."""
    # Back button
    builder.text("create-back-text", "← 返回列表")
    builder.button(
        "create-back-btn",
        "create-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    builder.text("create-title", "新建票据", usage_hint="h1")
    builder.row("create-header", ["create-back-btn", "create-title"], alignment="center")

    # Form
    builder.text("create-title-label", "标题 *", usage_hint="h4")
    builder.text_field("create-title-input", "请输入票据标题", builder.path("/app/form/create/title"))

    builder.text("create-desc-label", "描述", usage_hint="h4")
    builder.text_field("create-desc-input", "请输入详细描述...", builder.path("/app/form/create/description"), text_field_type="multiline")

    builder.text("create-priority-label", "优先级", usage_hint="h4")
    # Priority selection buttons
    builder.text("create-priority-low-text", "低")
    builder.button("create-priority-low", "create-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("create-priority-medium-text", "中")
    builder.button("create-priority-medium", "create-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("create-priority-high-text", "高")
    builder.button("create-priority-high", "create-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("create-priority-urgent-text", "紧急")
    builder.button("create-priority-urgent", "create-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("create-priority-btns", ["create-priority-low", "create-priority-medium", "create-priority-high", "create-priority-urgent"], alignment="center")

    # Tags selection - multi-select dropdown
    tag_options = [
        {"id": tag.get("id", ""), "name": tag.get("name", ""), "color": tag.get("color", "#3B82F6")}
        for tag in tags
    ]
    builder.multi_select(
        "create-tags-select",
        "标签（可多选）",
        tag_options,
        "/app/form/create/selectedTagIds",
        "toggle_multi_select",
    )

    builder.column("create-form-fields", [
        "create-title-label", "create-title-input",
        "create-desc-label", "create-desc-input",
        "create-priority-label", "create-priority-btns",
        "create-tags-select",
    ])

    # Actions
    builder.divider("create-divider")
    builder.text("create-cancel-text", "取消")
    builder.button(
        "create-cancel-btn",
        "create-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )
    builder.text("create-submit-text", "创建票据")
    builder.button(
        "create-submit-btn",
        "create-submit-text",
        "create_ticket",
        [{"key": "form", "value": {"path": "/app/form/create"}}],
    )
    builder.row("create-actions", ["create-cancel-btn", "create-submit-btn"], distribution="end", alignment="center")

    builder.column("create-form", ["create-form-fields", "create-divider", "create-actions"])
    builder.card("create-form-card", "create-form")
    builder.column("create-page", ["create-header", "create-form-card"])

    return "create-page", []


def build_ticket_create_data(tags: list) -> list[str]:
    """Build data model updates for ticket create page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ""),
        value_string("description", ""),
        value_string("priority", "medium"),
        value_string("selectedTagIds", ""),  # Comma-separated tag IDs
    ]
    messages.append(builder.build_data_model_update("/app/form/create", form_data))

    return messages


def build_ticket_edit_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket edit page."""
    ticket_id = ticket["id"]

    # Back button
    builder.text("edit-back-text", "← 返回详情")
    builder.button(
        "edit-back-btn",
        "edit-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )

    builder.text("edit-title", "编辑票据", usage_hint="h1")
    builder.row("edit-header", ["edit-back-btn", "edit-title"], alignment="center")

    # Form
    builder.text("edit-title-label", "标题 *", usage_hint="h4")
    builder.text_field("edit-title-input", "请输入票据标题", builder.path("/app/form/edit/title"))

    builder.text("edit-desc-label", "描述", usage_hint="h4")
    builder.text_field("edit-desc-input", "请输入详细描述...", builder.path("/app/form/edit/description"), text_field_type="multiline")

    builder.text("edit-priority-label", "优先级", usage_hint="h4")
    builder.text("edit-priority-low-text", "低")
    builder.button("edit-priority-low", "edit-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("edit-priority-medium-text", "中")
    builder.button("edit-priority-medium", "edit-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("edit-priority-high-text", "高")
    builder.button("edit-priority-high", "edit-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("edit-priority-urgent-text", "紧急")
    builder.button("edit-priority-urgent", "edit-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("edit-priority-btns", ["edit-priority-low", "edit-priority-medium", "edit-priority-high", "edit-priority-urgent"], alignment="center")

    builder.column("edit-form-fields", [
        "edit-title-label", "edit-title-input",
        "edit-desc-label", "edit-desc-input",
        "edit-priority-label", "edit-priority-btns",
    ])

    # Actions
    builder.divider("edit-divider")
    builder.text("edit-cancel-text", "取消")
    builder.button(
        "edit-cancel-btn",
        "edit-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )
    builder.text("edit-submit-text", "保存更改")
    builder.button(
        "edit-submit-btn",
        "edit-submit-text",
        "update_ticket",
        [
            {"key": "id", "value": {"literalString": ticket_id}},
            {"key": "form", "value": {"path": "/app/form/edit"}},
        ],
    )
    builder.row("edit-actions", ["edit-cancel-btn", "edit-submit-btn"], distribution="end", alignment="center")

    builder.column("edit-form", ["edit-form-fields", "edit-divider", "edit-actions"])
    builder.card("edit-form-card", "edit-form")
    builder.column("edit-page", ["edit-header", "edit-form-card"])

    return "edit-page", []


def build_ticket_edit_data(ticket: dict) -> list[str]:
    """Build data model updates for ticket edit page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ticket["title"]),
        value_string("description", ticket.get("description") or ""),
        value_string("priority", ticket["priority"]),
    ]
    messages.append(builder.build_data_model_update("/app/form/edit", form_data))

    return messages

```

```python
"""A2UI Agent Server - Main entry point."""
import asyncio
import json
import logging
from datetime import datetime
from typing import AsyncGenerator, Optional
from urllib.parse import urlparse, parse_qs

from fastapi import FastAPI, Request, Query, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import StreamingResponse, FileResponse
from fastapi.staticfiles import StaticFiles
from sse_starlette.sse import EventSourceResponse

from config import settings
from models import UserAction
from api_client import api_client
from a2ui_builder import A2UIBuilder
from pages.layout import build_app_layout
from pages.tickets import (
    build_tickets_page, build_tickets_data,
    build_ticket_detail_page, build_ticket_detail_data,
    build_ticket_create_page, build_ticket_create_data,
    build_ticket_edit_page, build_ticket_edit_data,
)
from pages.tags import build_tags_page, build_tags_data
from pages.error import build_not_found_page, build_error_page

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(title="A2UI Agent Server", version="1.0.0")

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


def safe_int(value, default: int = 1) -> int:
    """Safely convert value to int with default fallback."""
    if value is None:
        return default
    try:
        return int(value)
    except (ValueError, TypeError):
        return default


async def generate_page_messages(path: str, query_params: dict) -> AsyncGenerator[str, None]:
    """Generate A2UI messages for a given page path."""
    builder = A2UIBuilder("main")

    try:
        # Route to appropriate page builder
        if path == "/" or path == "/tickets":
            # Tickets list page
            search = query_params.get("search", "")
            status = query_params.get("status", "")
            priority = query_params.get("priority", "")
            page = safe_int(query_params.get("page"), 1)
            
            tickets_data = await api_client.list_tickets(
                search=search if search else None,
                status=status if status else None,
                priority=priority if priority else None,
                page=page,
            )
            page_id, _ = build_tickets_page(builder)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_tickets_data(tickets_data, search, status, priority, page):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tickets/new":
            # Ticket create page - fetch tags for selection
            tags = await api_client.list_tags()
            page_id, _ = build_ticket_create_page(builder, tags)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_create_data(tags):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/") and path.endswith("/edit"):
            # Ticket edit page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            page_id, _ = build_ticket_edit_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_edit_data(ticket):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path.startswith("/tickets/"):
            # Ticket detail page
            ticket_id = path.split("/")[2]
            ticket = await api_client.get_ticket(ticket_id)
            attachments = await api_client.get_ticket_attachments(ticket_id)
            history_response = await api_client.get_ticket_history(ticket_id)
            history = history_response.get("data", [])

            page_id, _ = build_ticket_detail_page(builder, ticket)
            build_app_layout(builder, page_id, "tickets")

            yield builder.build_surface_update()
            for msg in build_ticket_detail_data(ticket, attachments, history):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        elif path == "/tags":
            # Tags page
            tags = await api_client.list_tags()
            page_id, _ = build_tags_page(builder)
            build_app_layout(builder, page_id, "tags")

            yield builder.build_surface_update()
            for msg in build_tags_data(tags):
                yield msg
            yield builder.build_begin_rendering("app-layout")

        else:
            # 404 page
            page_id, _ = build_not_found_page(builder)
            build_app_layout(builder, page_id, "")

            yield builder.build_surface_update()
            yield builder.build_begin_rendering("app-layout")

    except Exception as e:
        logger.exception(f"Error generating page: {e}")
        builder.reset()
        page_id, _ = build_error_page(builder, str(e))
        build_app_layout(builder, page_id, "")

        yield builder.build_surface_update()
        yield builder.build_begin_rendering("app-layout")


@app.get("/api/a2ui/stream")
async def stream_ui(
    request: Request,
    path: str = Query("/", description="Page path to render"),
):
    """SSE endpoint for A2UI messages."""
    # Parse query params from the path parameter itself (e.g., /tickets?page=2)
    parsed = urlparse(path)
    actual_path = parsed.path
    path_query_params = parse_qs(parsed.query)

    # Also get query params from the request URL (excluding 'path')
    request_params = dict(request.query_params)
    request_params.pop("path", None)

    # Merge query params (path params take precedence)
    query_params = request_params.copy()
    for key, values in path_query_params.items():
        if values:
            query_params[key] = values[0]  # Take first value

    # Use actual_path for routing
    path = actual_path

    async def event_generator():
        async for message in generate_page_messages(path, query_params):
            if await request.is_disconnected():
                break
            yield {"event": "message", "data": message}

    return EventSourceResponse(event_generator())


@app.post("/api/a2ui/action")
async def handle_action(action: UserAction):
    """Handle userAction from client."""
    logger.info(f"Received action: {action.name} with context: {action.context}")

    try:
        result = await process_action(action)
        return {"success": True, "result": result}
    except Exception as e:
        logger.exception(f"Error processing action: {e}")
        # Return error as JSON instead of raising HTTPException
        # This allows the client to display the error message
        error_message = str(e)
        if "409" in error_message or "Conflict" in error_message:
            error_message = "操作失败：该名称已存在，请使用其他名称"
        elif "400" in error_message or "Bad Request" in error_message:
            error_message = "操作失败：请检查输入内容"
        elif "404" in error_message or "Not Found" in error_message:
            error_message = "操作失败：资源未找到"
        else:
            error_message = f"操作失败：{error_message}"
        return {"success": False, "error": error_message}


async def process_action(action: UserAction) -> dict:
    """Process a userAction and return the result."""
    name = action.name
    context = action.context
    logger.info(f"Processing action '{name}' with context: {context}")

    if name == "navigate":
        # Navigation is handled client-side by reconnecting to SSE
        return {"navigate": context.get("to", "/tickets")}

    elif name in ["search_tickets", "filter_status", "filter_priority", "paginate"]:
        # Get current query params from context (passed from client)
        # Client should pass current query state
        # Handle None/null values from data model
        current_search = context.get("current_search") or ""
        current_status = context.get("current_status") or ""
        current_priority = context.get("current_priority") or ""
        current_page = safe_int(context.get("current_page"), 1)
        
        logger.info(f"Current state: search={current_search}, status={current_status}, priority={current_priority}, page={current_page}")

        # Initialize new values
        new_search = current_search
        new_status = current_status
        new_priority = current_priority
        new_page = current_page

        # Update based on action
        if name == "search_tickets":
            search_term = context.get('search') or ''
            new_search = search_term
            new_page = 1  # Reset to page 1 on new search
        elif name == "filter_status":
            status = context.get("status")
            if status is None:
                status = ""
            new_status = status
            new_page = 1  # Reset to page 1 on filter change
        elif name == "filter_priority":
            priority = context.get("priority")
            if priority is None:
                priority = ""
            new_priority = priority
            new_page = 1  # Reset to page 1 on filter change
        elif name == "paginate":
            page = safe_int(context.get("page"), 1)
            new_page = page

        logger.info(f"New state: search={new_search}, status={new_status}, priority={new_priority}, page={new_page}")

        # Build query string
        query_parts = []
        if new_search:
            query_parts.append(f"search={new_search}")
        if new_status:
            query_parts.append(f"status={new_status}")
        if new_priority:
            query_parts.append(f"priority={new_priority}")
        if new_page > 1:
            query_parts.append(f"page={new_page}")

        query_string = "?" + "&".join(query_parts) if query_parts else ""
        return {"navigate": f"/tickets{query_string}"}

    elif name == "view_ticket":
        ticket_id = context.get("id")
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_ticket":
        form = context.get("form", {})
        ticket = await api_client.create_ticket({
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority", "medium"),
        })
        ticket_id = ticket['id']
        
        # Add selected tags to the ticket
        selected_tag_ids = form.get("selectedTagIds", "")
        if selected_tag_ids:
            tag_ids = [tid.strip() for tid in selected_tag_ids.split(",") if tid.strip()]
            for tag_id in tag_ids:
                try:
                    await api_client.add_tag_to_ticket(ticket_id, tag_id)
                except Exception as e:
                    logger.warning(f"Failed to add tag {tag_id} to ticket {ticket_id}: {e}")
        
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "update_ticket":
        ticket_id = context.get("id")
        form = context.get("form", {})
        await api_client.update_ticket(ticket_id, {
            "title": form.get("title"),
            "description": form.get("description"),
            "priority": form.get("priority"),
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "delete_ticket":
        ticket_id = context.get("id")
        await api_client.delete_ticket(ticket_id)
        return {"navigate": "/tickets"}

    elif name == "change_status":
        ticket_id = context.get("id")
        status = context.get("status")
        resolution = context.get("resolution")
        await api_client.update_ticket_status(ticket_id, {
            "status": status,
            "resolution": resolution,
        })
        return {"navigate": f"/tickets/{ticket_id}"}

    elif name == "create_tag":
        form = context.get("form", {})
        await api_client.create_tag({
            "name": form.get("name"),
            "color": form.get("color", "#3B82F6"),
        })
        return {"navigate": "/tags"}

    elif name == "delete_tag":
        tag_id = context.get("id")
        await api_client.delete_tag(tag_id)
        return {"navigate": "/tags"}

    elif name in ["show_create_tag_form", "hide_create_tag_form", "set_tag_color", "set_form_priority", "toggle_form_tag", "toggle_multi_select"]:
        # These are handled client-side via data model updates
        return {"handled": True}

    elif name in ["show_delete_dialog", "dismiss_dialog"]:
        # Dialog handling is client-side
        return {"handled": True}

    elif name == "retry":
        # Retry by refreshing current page
        return {"refresh": True}

    else:
        logger.warning(f"Unknown action: {name}")
        return {"unknown": True}


@app.get("/health")
async def health():
    """Health check endpoint."""
    return {"status": "healthy"}


# Serve static files for the client
try:
    app.mount("/", StaticFiles(directory="../client/dist", html=True), name="static")
except RuntimeError:
    # Client not built yet
    @app.get("/")
    async def root():
        return {"message": "A2UI Agent Server is running. Build the client to serve the UI."}


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host=settings.host, port=settings.port)

```

已完成！标签选择现在是一个多选下拉菜单了。

**主要改动：**

1. **新增 `MultiSelect` 组件** - 在 `a2ui_builder.py` 中添加了多选下拉菜单组件
2. **渲染逻辑** - 在 `renderer.ts` 中实现了 `renderMultiSelect` 方法和 `a2ui-multiselect` 自定义元素
3. **样式** - 下拉菜单具有以下特性：
   - 点击/悬停时展开选项列表
   - 显示已选择项目数量
   - 每个选项显示标签颜色圆点
   - 选中的选项有背景高亮
   - 支持多选（复选框形式）

4. **创建票据页面** - 使用新的下拉多选组件替换之前的按钮形式

**使用方式：**
- 鼠标悬停或点击下拉框会展开选项列表
- 点击选项可以选中/取消选中
- 下拉框会显示"已选择 X 项"

服务器已重启，请刷新页面访问新建票据页面测试多选下拉菜单功能。

---

**User**

整个页面撑的太宽了，需要再上下和左右两边都留出一定的间距，同时目前搜素列表的展现形式是否更换一个更加美观的形式

---

**Cursor**

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    return html`
      <a2ui-card id=${id}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      transition: box-shadow 200ms ease, transform 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - more compact and elegant */
    :host([data-ticket-card="true"]) {
      padding: 16px 20px;
      border-radius: 8px;
      background: linear-gradient(135deg, #FAFAFA 0%, #FFFFFF 100%);
      border: 1px solid #E5E7EB;
      cursor: pointer;
    }
    :host([data-ticket-card="true"]:hover) {
      background: linear-gradient(135deg, #FEF9C3 0%, #FEF3C7 100%);
      border-color: #FFD93D;
      transform: translateX(4px);
      box-shadow: 0 4px 12px -2px rgba(255, 217, 61, 0.3);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - more compact and elegant */
    :host([data-ticket-card="true"]) {
      padding: 16px 20px;
      border-radius: 8px;
      background: linear-gradient(135deg, #FAFAFA 0%, #FFFFFF 100%);
      border: 1px solid #E5E7EB;
      cursor: pointer;
    }
    :host([data-ticket-card="true"]:hover) {
      background: linear-gradient(135deg, #FEF9C3 0%, #FEF3C7 100%);
      border-color: #FFD93D;
      transform: translateX(4px);
      box-shadow: 0 4px 12px -2px rgba(255, 217, 61, 0.3);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - more compact and elegant */
    :host([data-ticket-card="true"]) {
      padding: 16px 20px;
      border-radius: 8px;
      background: linear-gradient(135deg, #FAFAFA 0%, #FFFFFF 100%);
      border: 1px solid #E5E7EB;
      cursor: pointer;
    }
    :host([data-ticket-card="true"]:hover) {
      background: linear-gradient(135deg, #FEF9C3 0%, #FEF3C7 100%);
      border-color: #FFD93D;
      transform: translateX(4px);
      box-shadow: 0 4px 12px -2px rgba(255, 217, 61, 0.3);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';
    const isMetaRow = id === 'ticket-item-meta';
    const isTicketItemRow = id === 'ticket-item-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
        data-meta-row=${isMetaRow ? 'true' : nothing}
        data-ticket-row=${isTicketItemRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 48px !important;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - more compact and elegant */
    :host([data-ticket-card="true"]) {
      padding: 16px 20px;
      border-radius: 8px;
      background: linear-gradient(135deg, #FAFAFA 0%, #FFFFFF 100%);
      border: 1px solid #E5E7EB;
      cursor: pointer;
    }
    :host([data-ticket-card="true"]:hover) {
      background: linear-gradient(135deg, #FEF9C3 0%, #FEF3C7 100%);
      border-color: #FFD93D;
      transform: translateX(4px);
      box-shadow: 0 4px 12px -2px rgba(255, 217, 61, 0.3);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';
    const isMetaRow = id === 'ticket-item-meta';
    const isTicketItemRow = id === 'ticket-item-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
        data-meta-row=${isMetaRow ? 'true' : nothing}
        data-ticket-row=${isTicketItemRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    return html`
      <a2ui-list id=${id} data-direction=${direction}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 24px;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-meta-row="true"]) {
      gap: 12px;
    }
    :host([data-ticket-row="true"]) {
      width: 100%;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - more compact and elegant */
    :host([data-ticket-card="true"]) {
      padding: 16px 20px;
      border-radius: 8px;
      background: linear-gradient(135deg, #FAFAFA 0%, #FFFFFF 100%);
      border: 1px solid #E5E7EB;
      cursor: pointer;
    }
    :host([data-ticket-card="true"]:hover) {
      background: linear-gradient(135deg, #FEF9C3 0%, #FEF3C7 100%);
      border-color: #FFD93D;
      transform: translateX(4px);
      box-shadow: 0 4px 12px -2px rgba(255, 217, 61, 0.3);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';
    const isMetaRow = id === 'ticket-item-meta';
    const isTicketItemRow = id === 'ticket-item-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
        data-meta-row=${isMetaRow ? 'true' : nothing}
        data-ticket-row=${isTicketItemRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    const isTicketsList = id === 'tickets-list';

    return html`
      <a2ui-list id=${id} data-direction=${direction} data-tickets=${isTicketsList ? 'true' : nothing}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 24px;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-meta-row="true"]) {
      gap: 12px;
    }
    :host([data-ticket-row="true"]) {
      width: 100%;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - more compact and elegant */
    :host([data-ticket-card="true"]) {
      padding: 16px 20px;
      border-radius: 8px;
      background: linear-gradient(135deg, #FAFAFA 0%, #FFFFFF 100%);
      border: 1px solid #E5E7EB;
      cursor: pointer;
    }
    :host([data-ticket-card="true"]:hover) {
      background: linear-gradient(135deg, #FEF9C3 0%, #FEF3C7 100%);
      border-color: #FFD93D;
      transform: translateX(4px);
      box-shadow: 0 4px 12px -2px rgba(255, 217, 61, 0.3);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';
    const isMetaRow = id === 'ticket-item-meta';
    const isTicketItemRow = id === 'ticket-item-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
        data-meta-row=${isMetaRow ? 'true' : nothing}
        data-ticket-row=${isTicketItemRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    const isTicketsList = id === 'tickets-list';

    return html`
      <a2ui-list id=${id} data-direction=${direction} data-tickets=${isTicketsList ? 'true' : nothing}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 24px;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-meta-row="true"]) {
      gap: 12px;
    }
    :host([data-ticket-row="true"]) {
      width: 100%;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - more compact and elegant */
    :host([data-ticket-card="true"]) {
      padding: 16px 20px;
      border-radius: 8px;
      background: linear-gradient(135deg, #FAFAFA 0%, #FFFFFF 100%);
      border: 1px solid #E5E7EB;
      cursor: pointer;
    }
    :host([data-ticket-card="true"]:hover) {
      background: linear-gradient(135deg, #FEF9C3 0%, #FEF3C7 100%);
      border-color: #FFD93D;
      transform: translateX(4px);
      box-shadow: 0 4px 12px -2px rgba(255, 217, 61, 0.3);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
    :host([data-tickets="true"]) {
      gap: 8px;
      background: #F9FAFB;
      border-radius: 12px;
      padding: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

效果已经很好了！改进包括：

**页面布局改进：**
- 页面现在有了左右和上下的边距（最大宽度 1200px，水平内边距 48px，垂直内边距 24px）
- 整体居中显示，更加美观

**票据列表改进：**
- 列表项使用了更紧凑的卡片设计
- 状态和优先级显示为圆角标签样式（badge）
- 状态标签使用蓝色背景，优先级使用黄色背景
- 日期使用淡灰色文字
- 鼠标悬停时卡片会向右轻微移动并显示黄色渐变背景
- 列表区域有浅灰色背景，视觉上更加分离

**筛选按钮改进：**
- 选中的筛选按钮有黄色高亮
- 按钮使用圆角胶囊样式

服务器已重启完成，请刷新页面查看效果！如果还需要进一步调整样式，请告诉我。

---

**User**

整个列表很长，但是其中的数据只是一小块内容，这样非常不美观，请调整

---

**Cursor**

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';
    const isMetaRow = id === 'ticket-item-meta';
    const isTicketItemRow = id === 'ticket-item-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
        data-meta-row=${isMetaRow ? 'true' : nothing}
        data-ticket-row=${isTicketItemRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    const isTicketsList = id === 'tickets-list';

    return html`
      <a2ui-list id=${id} data-direction=${direction} data-tickets=${isTicketsList ? 'true' : nothing}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 24px;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-meta-row="true"]) {
      gap: 12px;
    }
    :host([data-ticket-row="true"]) {
      width: 100%;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - full width, compact */
    :host([data-ticket-card="true"]) {
      width: 100%;
      padding: 16px 24px;
      border-radius: 8px;
      background: white;
      border: 1px solid #E5E7EB;
      cursor: pointer;
      box-sizing: border-box;
    }
    :host([data-ticket-card="true"]:hover) {
      background: #FFFBEB;
      border-color: #FFD93D;
      box-shadow: 0 2px 8px -2px rgba(255, 217, 61, 0.4);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
    :host([data-tickets="true"]) {
      gap: 8px;
      background: #F9FAFB;
      border-radius: 12px;
      padding: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';
    const isMetaRow = id === 'ticket-item-meta';
    const isTicketItemRow = id === 'ticket-item-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
        data-meta-row=${isMetaRow ? 'true' : nothing}
        data-ticket-row=${isTicketItemRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    const isTicketsList = id === 'tickets-list';

    return html`
      <a2ui-list id=${id} data-direction=${direction} data-tickets=${isTicketsList ? 'true' : nothing}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 24px;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-meta-row="true"]) {
      gap: 12px;
    }
    :host([data-ticket-row="true"]) {
      width: 100%;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - full width, compact */
    :host([data-ticket-card="true"]) {
      width: 100%;
      padding: 16px 24px;
      border-radius: 8px;
      background: white;
      border: 1px solid #E5E7EB;
      cursor: pointer;
      box-sizing: border-box;
    }
    :host([data-ticket-card="true"]:hover) {
      background: #FFFBEB;
      border-color: #FFD93D;
      box-shadow: 0 2px 8px -2px rgba(255, 217, 61, 0.4);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
    :host([data-tickets="true"]) {
      gap: 0;
      background: transparent;
      border-radius: 0;
      padding: 0;
    }
    :host([data-tickets="true"]) ::slotted(*) {
      border-bottom: 1px solid #F3F4F6;
    }
    :host([data-tickets="true"]) ::slotted(*:last-child) {
      border-bottom: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';
    const isMetaRow = id === 'ticket-item-meta';
    const isTicketItemRow = id === 'ticket-item-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
        data-meta-row=${isMetaRow ? 'true' : nothing}
        data-ticket-row=${isTicketItemRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    const isTicketsList = id === 'tickets-list';

    return html`
      <a2ui-list id=${id} data-direction=${direction} data-tickets=${isTicketsList ? 'true' : nothing}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
    /* Ticket item button - full width, transparent */
    :host([data-ticket-button="true"]) {
      display: block;
      width: 100%;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
    }
    :host([data-ticket-button="true"]:hover) {
      background: transparent;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 24px;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-meta-row="true"]) {
      gap: 12px;
    }
    :host([data-ticket-row="true"]) {
      width: 100%;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - full width, compact */
    :host([data-ticket-card="true"]) {
      width: 100%;
      padding: 16px 24px;
      border-radius: 8px;
      background: white;
      border: 1px solid #E5E7EB;
      cursor: pointer;
      box-sizing: border-box;
    }
    :host([data-ticket-card="true"]:hover) {
      background: #FFFBEB;
      border-color: #FFD93D;
      box-shadow: 0 2px 8px -2px rgba(255, 217, 61, 0.4);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
    :host([data-tickets="true"]) {
      gap: 0;
      background: transparent;
      border-radius: 0;
      padding: 0;
    }
    :host([data-tickets="true"]) ::slotted(*) {
      border-bottom: 1px solid #F3F4F6;
    }
    :host([data-tickets="true"]) ::slotted(*:last-child) {
      border-bottom: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    // Check if this is a ticket item button
    const isTicketButton = id === 'ticket-item-btn';

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        data-ticket-button=${isTicketButton ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';
    const isMetaRow = id === 'ticket-item-meta';
    const isTicketItemRow = id === 'ticket-item-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
        data-meta-row=${isMetaRow ? 'true' : nothing}
        data-ticket-row=${isTicketItemRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    const isTicketsList = id === 'tickets-list';

    return html`
      <a2ui-list id=${id} data-direction=${direction} data-tickets=${isTicketsList ? 'true' : nothing}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
    /* Ticket item button - full width, transparent */
    :host([data-ticket-button="true"]) {
      display: block;
      width: 100%;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
    }
    :host([data-ticket-button="true"]:hover) {
      background: transparent;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 24px;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-meta-row="true"]) {
      gap: 12px;
    }
    :host([data-ticket-row="true"]) {
      width: 100%;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - full width, compact */
    :host([data-ticket-card="true"]) {
      width: 100%;
      padding: 16px 24px;
      border-radius: 8px;
      background: white;
      border: 1px solid #E5E7EB;
      cursor: pointer;
      box-sizing: border-box;
    }
    :host([data-ticket-card="true"]:hover) {
      background: #FFFBEB;
      border-color: #FFD93D;
      box-shadow: 0 2px 8px -2px rgba(255, 217, 61, 0.4);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
    :host([data-tickets="true"]) {
      gap: 0;
      background: transparent;
      border-radius: 0;
      padding: 0;
    }
    :host([data-tickets="true"]) ::slotted(*) {
      border-bottom: 1px solid #F3F4F6;
    }
    :host([data-tickets="true"]) ::slotted(*:last-child) {
      border-bottom: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    // Check if this is a ticket item button
    const isTicketButton = id === 'ticket-item-btn';

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        data-ticket-button=${isTicketButton ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';
    const isMetaRow = id === 'ticket-item-meta';
    const isTicketItemRow = id === 'ticket-item-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
        data-meta-row=${isMetaRow ? 'true' : nothing}
        data-ticket-row=${isTicketItemRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    const isTicketsList = id === 'tickets-list';

    return html`
      <a2ui-list id=${id} data-direction=${direction} data-tickets=${isTicketsList ? 'true' : nothing}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
    /* Ticket item button - full width, transparent */
    :host([data-ticket-button="true"]) {
      display: block;
      width: 100%;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
    }
    :host([data-ticket-button="true"]:hover) {
      background: transparent;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 24px;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-meta-row="true"]) {
      gap: 12px;
    }
    :host([data-ticket-row="true"]) {
      width: 100%;
      flex: 1;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - full width, compact */
    :host([data-ticket-card="true"]) {
      width: 100%;
      padding: 16px 24px;
      border-radius: 8px;
      background: white;
      border: 1px solid #E5E7EB;
      cursor: pointer;
      box-sizing: border-box;
    }
    :host([data-ticket-card="true"]:hover) {
      background: #FFFBEB;
      border-color: #FFD93D;
      box-shadow: 0 2px 8px -2px rgba(255, 217, 61, 0.4);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
    :host([data-tickets="true"]) {
      gap: 0;
      background: transparent;
      border-radius: 0;
      padding: 0;
    }
    :host([data-tickets="true"]) ::slotted(*) {
      border-bottom: 1px solid #F3F4F6;
    }
    :host([data-tickets="true"]) ::slotted(*:last-child) {
      border-bottom: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    // Check if this is a ticket item button
    const isTicketButton = id === 'ticket-item-btn';

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        data-ticket-button=${isTicketButton ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';
    const isMetaRow = id === 'ticket-item-meta';
    const isTicketItemRow = id === 'ticket-item-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
        data-meta-row=${isMetaRow ? 'true' : nothing}
        data-ticket-row=${isTicketItemRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    const isTicketsList = id === 'tickets-list';

    return html`
      <a2ui-list id=${id} data-direction=${direction} data-tickets=${isTicketsList ? 'true' : nothing}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
    /* Ticket item button - full width, transparent */
    :host([data-ticket-button="true"]) {
      display: block;
      width: 100%;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
    }
    :host([data-ticket-button="true"]:hover) {
      background: transparent;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 24px;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-meta-row="true"]) {
      gap: 12px;
    }
    :host([data-ticket-row="true"]) {
      width: 100%;
      flex: 1;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - full width row style */
    :host([data-ticket-card="true"]) {
      width: 100%;
      padding: 16px 20px;
      border-radius: 0;
      background: white;
      border: none;
      border-left: 3px solid transparent;
      cursor: pointer;
      box-sizing: border-box;
      box-shadow: none;
    }
    :host([data-ticket-card="true"]:hover) {
      background: #FEFCE8;
      border-left-color: #FFD93D;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
    :host([data-tickets="true"]) {
      gap: 0;
      background: transparent;
      border-radius: 0;
      padding: 0;
    }
    :host([data-tickets="true"]) ::slotted(*) {
      border-bottom: 1px solid #F3F4F6;
    }
    :host([data-tickets="true"]) ::slotted(*:last-child) {
      border-bottom: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    // Check if this is a ticket item button
    const isTicketButton = id === 'ticket-item-btn';

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        data-ticket-button=${isTicketButton ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';
    const isMetaRow = id === 'ticket-item-meta';
    const isTicketItemRow = id === 'ticket-item-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
        data-meta-row=${isMetaRow ? 'true' : nothing}
        data-ticket-row=${isTicketItemRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    const isTicketsList = id === 'tickets-list';

    return html`
      <a2ui-list id=${id} data-direction=${direction} data-tickets=${isTicketsList ? 'true' : nothing}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
    /* Ticket item button - full width, transparent */
    :host([data-ticket-button="true"]) {
      display: block;
      width: 100%;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
    }
    :host([data-ticket-button="true"]:hover) {
      background: transparent;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 24px;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-meta-row="true"]) {
      gap: 12px;
    }
    :host([data-ticket-row="true"]) {
      width: 100%;
      flex: 1;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - full width row style */
    :host([data-ticket-card="true"]) {
      width: 100%;
      padding: 16px 20px;
      border-radius: 0;
      background: white;
      border: none;
      border-left: 3px solid transparent;
      cursor: pointer;
      box-sizing: border-box;
      box-shadow: none;
    }
    :host([data-ticket-card="true"]:hover) {
      background: #FEFCE8;
      border-left-color: #FFD93D;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
    :host([data-tickets="true"]) {
      gap: 0;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 0;
      overflow: hidden;
    }
    :host([data-tickets="true"]) ::slotted(*) {
      border-bottom: 1px solid #F3F4F6;
    }
    :host([data-tickets="true"]) ::slotted(*:last-child) {
      border-bottom: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

已完成调整！现在票据列表使用了更简洁美观的样式：

**改进内容：**

1. **列表项全宽** - 每个票据项现在填满整个容器宽度
2. **简洁行样式** - 使用分隔线区分各项，而不是独立卡片
3. **左侧边框高亮** - 鼠标悬停时左侧出现黄色边框，背景变为淡黄色
4. **统一容器** - 整个列表放在一个圆角容器中，有边框
5. **箭头指示器** - 每行右侧有箭头指示可点击进入详情

现在列表看起来更加紧凑、整洁，不再有之前那种"数据只占一小块，容器却很大"的问题。

---

**User**

列表中是否可以把标签也显示出来？

---

**Cursor**

```python
"""Ticket page builders."""
from typing import Any, Optional
from a2ui_builder import A2UIBuilder, value_string, value_number, value_map, build_value_map_from_dict
from models import (
    STATUS_LABELS, PRIORITY_LABELS, STATUS_TRANSITIONS,
    TicketStatus, Priority
)


def build_tickets_page(builder: A2UIBuilder) -> tuple[str, list[str]]:
    """Build the tickets list page."""
    # Page header
    builder.text("tickets-title", "票据列表", usage_hint="h1")
    builder.text("tickets-add-text", "+ 新建票据")
    builder.button(
        "tickets-add-btn",
        "tickets-add-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets/new"}}],
    )
    builder.row("tickets-header", ["tickets-title", "tickets-add-btn"], distribution="spaceBetween", alignment="center")

    # Search
    builder.text_field("tickets-search", "搜索票据...", builder.path("/app/tickets/query/search"))
    builder.text("tickets-search-btn-text", "搜索")
    builder.button(
        "tickets-search-btn",
        "tickets-search-btn-text",
        "search_tickets",
        [
            {"key": "search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-search-row", ["tickets-search", "tickets-search-btn"], alignment="center")

    # Status filter buttons
    builder.text("filter-all-text", "全部")
    builder.button("filter-all", "filter-all-text", "filter_status", [
        {"key": "status", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-open-text", "待处理")
    builder.button("filter-open", "filter-open-text", "filter_status", [
        {"key": "status", "value": {"literalString": "open"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-progress-text", "处理中")
    builder.button("filter-progress", "filter-progress-text", "filter_status", [
        {"key": "status", "value": {"literalString": "in_progress"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-completed-text", "已完成")
    builder.button("filter-completed", "filter-completed-text", "filter_status", [
        {"key": "status", "value": {"literalString": "completed"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-cancelled-text", "已取消")
    builder.button("filter-cancelled", "filter-cancelled-text", "filter_status", [
        {"key": "status", "value": {"literalString": "cancelled"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-status-filters", ["filter-all", "filter-open", "filter-progress", "filter-completed", "filter-cancelled"], alignment="center")

    # Priority filter buttons
    builder.text("priority-all-text", "全部优先级")
    builder.button("priority-all", "priority-all-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-low-text", "低")
    builder.button("priority-low", "priority-low-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "low"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-medium-text", "中")
    builder.button("priority-medium", "priority-medium-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "medium"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-high-text", "高")
    builder.button("priority-high", "priority-high-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "high"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-urgent-text", "紧急")
    builder.button("priority-urgent", "priority-urgent-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "urgent"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-priority-filters", ["priority-all", "priority-low", "priority-medium", "priority-high", "priority-urgent"], alignment="center")

    builder.column("tickets-filters", ["tickets-search-row", "tickets-status-filters", "tickets-priority-filters"])
    builder.card("tickets-filters-card", "tickets-filters")

    # Ticket list template - simplified without icons
    builder.text("ticket-item-title", builder.path("title"), usage_hint="h3")
    builder.text("ticket-item-status", builder.path("statusLabel"))
    builder.text("ticket-item-priority", builder.path("priorityLabel"))
    builder.text("ticket-item-date", builder.path("created_at"))
    builder.row("ticket-item-meta", ["ticket-item-status", "ticket-item-priority", "ticket-item-date"], alignment="center")
    builder.column("ticket-item-content", ["ticket-item-title", "ticket-item-meta"])
    builder.text("ticket-item-arrow", "→")
    builder.row("ticket-item-row", ["ticket-item-content", "ticket-item-arrow"], distribution="spaceBetween", alignment="center")
    builder.button(
        "ticket-item-btn",
        "ticket-item-row",
        "view_ticket",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.card("ticket-item-card", "ticket-item-btn")

    # Ticket list
    builder.list_component(
        "tickets-list",
        template={"componentId": "ticket-item-card", "dataBinding": "/app/tickets/list"},
        direction="vertical",
    )

    # Empty state
    builder.text("tickets-empty-title", "暂无票据", usage_hint="h3")
    builder.text("tickets-empty-desc", "点击上方按钮创建第一个票据")
    builder.column("tickets-empty", ["tickets-empty-title", "tickets-empty-desc"], alignment="center")

    # Pagination - use literalNumber for page values since they're numbers
    builder.text("pagination-prev-text", "← 上一页")
    builder.button(
        "pagination-prev",
        "pagination-prev-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/prevPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.text("pagination-info", builder.path("/app/tickets/pagination/info"))
    builder.text("pagination-next-text", "下一页 →")
    builder.button(
        "pagination-next",
        "pagination-next-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/nextPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-pagination", ["pagination-prev", "pagination-info", "pagination-next"], distribution="center", alignment="center")

    # Main content
    builder.column("tickets-content", ["tickets-list", "tickets-pagination"])
    builder.column("tickets-page", ["tickets-header", "tickets-filters-card", "tickets-content"])

    return "tickets-page", []


def build_tickets_data(tickets_response: dict, search: str = "", status: str = "", priority: str = "", page: int = 1) -> list[str]:
    """Build data model updates for tickets page."""
    messages = []
    builder = A2UIBuilder()

    # Query state - use actual values from URL params
    query_data = [
        value_string("search", search),
        value_string("status", status),
        value_string("priority", priority),
        value_number("page", page),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/query", query_data))

    # Tickets list
    tickets = tickets_response.get("data", [])
    list_data = []
    for i, ticket in enumerate(tickets):
        # Build tags display string
        tags = ticket.get("tags", [])
        tags_display = ", ".join([t.get("name", "") for t in tags[:3]])  # Show first 3 tags
        if len(tags) > 3:
            tags_display += f" +{len(tags) - 3}"
        
        ticket_map = build_value_map_from_dict({
            "id": ticket["id"],
            "title": ticket["title"],
            "status": ticket["status"],
            "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
            "priority": ticket["priority"],
            "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
            "created_at": ticket["created_at"][:10],  # Date only
            "tagsDisplay": tags_display,
            "hasTags": len(tags) > 0,
        })
        list_data.append(value_map(f"ticket{i}", ticket_map))
    messages.append(builder.build_data_model_update("/app/tickets/list", list_data))

    # Pagination
    page = tickets_response.get("page", 1)
    total_pages = tickets_response.get("total_pages", 0)
    total_count = tickets_response.get("total", 0)
    
    # If no data, show "第0页/共0页"
    if total_count == 0 or total_pages == 0:
        display_page = 0
        display_total = 0
    else:
        display_page = page
        display_total = total_pages
    
    pagination_data = [
        value_number("page", display_page),
        value_number("totalPages", display_total),
        value_number("prevPage", max(1, page - 1) if total_pages > 0 else 0),
        value_number("nextPage", min(total_pages, page + 1) if total_pages > 0 else 0),
        value_string("info", f"第 {display_page} 页 / 共 {display_total} 页"),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/pagination", pagination_data))

    return messages


def build_ticket_detail_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket detail page."""
    ticket_id = ticket["id"]
    status = ticket["status"]

    # Back button
    builder.text("detail-back-text", "← 返回列表")
    builder.button(
        "detail-back-btn",
        "detail-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    # Title
    builder.text("detail-title", builder.path("/app/ticket/detail/title"), usage_hint="h1")

    # Actions
    builder.text("detail-edit-text", "编辑")
    builder.button(
        "detail-edit-btn",
        "detail-edit-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}/edit"}}],
    )

    builder.text("detail-delete-text", "删除")
    builder.button(
        "detail-delete-btn",
        "detail-delete-text",
        "show_delete_dialog",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )

    builder.row("detail-actions", ["detail-edit-btn", "detail-delete-btn"], alignment="center")
    builder.row("detail-header", ["detail-back-btn", "detail-title", "detail-actions"], distribution="spaceBetween", alignment="center")

    # Description card
    builder.text("detail-desc-label", "描述", usage_hint="h4")
    builder.text("detail-desc-content", builder.path("/app/ticket/detail/description"))
    builder.column("detail-desc-col", ["detail-desc-label", "detail-desc-content"])
    builder.card("detail-desc-card", "detail-desc-col")

    # Resolution card (if exists)
    builder.text("detail-resolution-label", "处理结果", usage_hint="h4")
    builder.text("detail-resolution-content", builder.path("/app/ticket/detail/resolution"))
    builder.column("detail-resolution-col", ["detail-resolution-label", "detail-resolution-content"])
    builder.card("detail-resolution-card", "detail-resolution-col")

    # Status card
    builder.text("detail-status-label", "状态", usage_hint="h4")
    builder.text("detail-status-value", builder.path("/app/ticket/detail/statusLabel"))

    # Status transition buttons
    allowed_transitions = STATUS_TRANSITIONS.get(TicketStatus(status), [])
    status_btns = []
    for target_status in allowed_transitions:
        btn_id = f"status-btn-{target_status.value}"
        text_id = f"status-btn-text-{target_status.value}"
        builder.text(text_id, f"→ {STATUS_LABELS[target_status]}")
        builder.button(
            btn_id,
            text_id,
            "change_status",
            [
                {"key": "id", "value": {"literalString": ticket_id}},
                {"key": "status", "value": {"literalString": target_status.value}},
            ],
        )
        status_btns.append(btn_id)

    builder.row("detail-status-btns", status_btns, alignment="center")
    builder.column("detail-status-col", ["detail-status-label", "detail-status-value", "detail-status-btns"])
    builder.card("detail-status-card", "detail-status-col")

    # Priority card
    builder.text("detail-priority-label", "优先级", usage_hint="h4")
    builder.text("detail-priority-value", builder.path("/app/ticket/detail/priorityLabel"))
    builder.column("detail-priority-col", ["detail-priority-label", "detail-priority-value"])
    builder.card("detail-priority-card", "detail-priority-col")

    # Tags card
    builder.text("detail-tags-label", "标签", usage_hint="h4")
    builder.text("detail-tag-name", builder.path("name"))
    builder.list_component(
        "detail-tags-list",
        template={"componentId": "detail-tag-name", "dataBinding": "/app/ticket/tags"},
        direction="horizontal",
    )
    builder.column("detail-tags-col", ["detail-tags-label", "detail-tags-list"])
    builder.card("detail-tags-card", "detail-tags-col")

    # Timestamps card
    builder.text("detail-time-label", "时间信息", usage_hint="h4")
    builder.text("detail-created-label", "创建时间")
    builder.text("detail-created-value", builder.path("/app/ticket/detail/created_at"))
    builder.row("detail-created-row", ["detail-created-label", "detail-created-value"], distribution="spaceBetween")
    builder.text("detail-updated-label", "更新时间")
    builder.text("detail-updated-value", builder.path("/app/ticket/detail/updated_at"))
    builder.row("detail-updated-row", ["detail-updated-label", "detail-updated-value"], distribution="spaceBetween")
    builder.column("detail-time-col", ["detail-time-label", "detail-created-row", "detail-updated-row"])
    builder.card("detail-time-card", "detail-time-col")

    # Attachments card
    builder.text("detail-attach-label", "附件", usage_hint="h4")
    builder.text("detail-attach-filename", builder.path("filename"))
    builder.text("detail-attach-size", builder.path("sizeFormatted"))
    builder.row("detail-attach-info", ["detail-attach-filename", "detail-attach-size"], distribution="spaceBetween")
    builder.text("detail-attach-download-text", "下载")
    builder.button(
        "detail-attach-download",
        "detail-attach-download-text",
        "download_attachment",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.row("detail-attach-item", ["detail-attach-info", "detail-attach-download"], distribution="spaceBetween", alignment="center")
    builder.list_component(
        "detail-attach-list",
        template={"componentId": "detail-attach-item", "dataBinding": "/app/ticket/attachments"},
        direction="vertical",
    )
    builder.text("detail-attach-empty", "暂无附件")
    builder.column("detail-attach-col", ["detail-attach-label", "detail-attach-list"])
    builder.card("detail-attach-card", "detail-attach-col")

    # History card
    builder.text("detail-history-label", "变更历史", usage_hint="h4")
    builder.text("detail-history-type", builder.path("changeTypeLabel"))
    builder.text("detail-history-time", builder.path("created_at"))
    builder.text("detail-history-old", builder.path("old_value"))
    builder.text("detail-history-arrow", "→")
    builder.text("detail-history-new", builder.path("new_value"))
    builder.row("detail-history-change", ["detail-history-old", "detail-history-arrow", "detail-history-new"], alignment="center")
    builder.column("detail-history-item", ["detail-history-type", "detail-history-time", "detail-history-change"])
    builder.list_component(
        "detail-history-list",
        template={"componentId": "detail-history-item", "dataBinding": "/app/ticket/history"},
        direction="vertical",
    )
    builder.column("detail-history-col", ["detail-history-label", "detail-history-list"])
    builder.card("detail-history-card", "detail-history-col")

    # Left column (main content)
    main_cards = ["detail-desc-card"]
    if ticket.get("resolution"):
        main_cards.append("detail-resolution-card")
    main_cards.append("detail-attach-card")
    builder.column("detail-main", main_cards)

    # Right column (sidebar)
    builder.column("detail-sidebar", [
        "detail-status-card",
        "detail-priority-card",
        "detail-tags-card",
        "detail-time-card",
        "detail-history-card",
    ])

    # Layout
    builder.row("detail-body", ["detail-main", "detail-sidebar"], distribution="start")
    builder.column("detail-page", ["detail-header", "detail-body"])

    # Delete confirmation modal
    builder.text("delete-modal-title", "确认删除", usage_hint="h3")
    builder.text("delete-modal-desc", "确定要删除这个票据吗？此操作无法撤销。")
    builder.text("delete-modal-cancel-text", "取消")
    builder.button("delete-modal-cancel", "delete-modal-cancel-text", "dismiss_dialog", [])
    builder.text("delete-modal-confirm-text", "确认删除")
    builder.button(
        "delete-modal-confirm",
        "delete-modal-confirm-text",
        "delete_ticket",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )
    builder.row("delete-modal-actions", ["delete-modal-cancel", "delete-modal-confirm"], distribution="end")
    builder.column("delete-modal-content", ["delete-modal-title", "delete-modal-desc", "delete-modal-actions"])

    return "detail-page", []


def build_ticket_detail_data(ticket: dict, attachments: list, history: list) -> list[str]:
    """Build data model updates for ticket detail page."""
    messages = []
    builder = A2UIBuilder()

    # Ticket detail
    detail_data = build_value_map_from_dict({
        "id": ticket["id"],
        "title": ticket["title"],
        "description": ticket.get("description") or "无描述",
        "status": ticket["status"],
        "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
        "priority": ticket["priority"],
        "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
        "resolution": ticket.get("resolution") or "",
        "created_at": ticket["created_at"][:19].replace("T", " "),
        "updated_at": ticket["updated_at"][:19].replace("T", " "),
    })
    messages.append(builder.build_data_model_update("/app/ticket/detail", detail_data))

    # Tags
    tags = ticket.get("tags", [])
    tags_data = []
    for i, tag in enumerate(tags):
        tags_data.append(value_map(f"tag{i}", build_value_map_from_dict({
            "id": tag["id"],
            "name": tag["name"],
            "color": tag["color"],
        })))
    messages.append(builder.build_data_model_update("/app/ticket/tags", tags_data))

    # Attachments
    attach_data = []
    for i, att in enumerate(attachments):
        size_bytes = att["size_bytes"]
        if size_bytes < 1024:
            size_formatted = f"{size_bytes} B"
        elif size_bytes < 1024 * 1024:
            size_formatted = f"{size_bytes / 1024:.1f} KB"
        else:
            size_formatted = f"{size_bytes / (1024 * 1024):.1f} MB"
        attach_data.append(value_map(f"att{i}", build_value_map_from_dict({
            "id": att["id"],
            "filename": att["filename"],
            "sizeFormatted": size_formatted,
        })))
    messages.append(builder.build_data_model_update("/app/ticket/attachments", attach_data))

    # History
    change_type_labels = {
        "status": "状态变更",
        "priority": "优先级变更",
        "resolution": "处理结果",
        "tag_added": "添加标签",
        "tag_removed": "移除标签",
    }
    history_data = []
    for i, h in enumerate(history):
        history_data.append(value_map(f"h{i}", build_value_map_from_dict({
            "changeTypeLabel": change_type_labels.get(h["change_type"], h["change_type"]),
            "old_value": h.get("old_value") or "-",
            "new_value": h.get("new_value") or "-",
            "created_at": h["created_at"][:19].replace("T", " "),
        })))
    messages.append(builder.build_data_model_update("/app/ticket/history", history_data))

    return messages


def build_ticket_create_page(builder: A2UIBuilder, tags: list) -> tuple[str, list[str]]:
    """Build the ticket create page."""
    # Back button
    builder.text("create-back-text", "← 返回列表")
    builder.button(
        "create-back-btn",
        "create-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    builder.text("create-title", "新建票据", usage_hint="h1")
    builder.row("create-header", ["create-back-btn", "create-title"], alignment="center")

    # Form
    builder.text("create-title-label", "标题 *", usage_hint="h4")
    builder.text_field("create-title-input", "请输入票据标题", builder.path("/app/form/create/title"))

    builder.text("create-desc-label", "描述", usage_hint="h4")
    builder.text_field("create-desc-input", "请输入详细描述...", builder.path("/app/form/create/description"), text_field_type="multiline")

    builder.text("create-priority-label", "优先级", usage_hint="h4")
    # Priority selection buttons
    builder.text("create-priority-low-text", "低")
    builder.button("create-priority-low", "create-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("create-priority-medium-text", "中")
    builder.button("create-priority-medium", "create-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("create-priority-high-text", "高")
    builder.button("create-priority-high", "create-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("create-priority-urgent-text", "紧急")
    builder.button("create-priority-urgent", "create-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("create-priority-btns", ["create-priority-low", "create-priority-medium", "create-priority-high", "create-priority-urgent"], alignment="center")

    # Tags selection - multi-select dropdown
    tag_options = [
        {"id": tag.get("id", ""), "name": tag.get("name", ""), "color": tag.get("color", "#3B82F6")}
        for tag in tags
    ]
    builder.multi_select(
        "create-tags-select",
        "标签（可多选）",
        tag_options,
        "/app/form/create/selectedTagIds",
        "toggle_multi_select",
    )

    builder.column("create-form-fields", [
        "create-title-label", "create-title-input",
        "create-desc-label", "create-desc-input",
        "create-priority-label", "create-priority-btns",
        "create-tags-select",
    ])

    # Actions
    builder.divider("create-divider")
    builder.text("create-cancel-text", "取消")
    builder.button(
        "create-cancel-btn",
        "create-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )
    builder.text("create-submit-text", "创建票据")
    builder.button(
        "create-submit-btn",
        "create-submit-text",
        "create_ticket",
        [{"key": "form", "value": {"path": "/app/form/create"}}],
    )
    builder.row("create-actions", ["create-cancel-btn", "create-submit-btn"], distribution="end", alignment="center")

    builder.column("create-form", ["create-form-fields", "create-divider", "create-actions"])
    builder.card("create-form-card", "create-form")
    builder.column("create-page", ["create-header", "create-form-card"])

    return "create-page", []


def build_ticket_create_data(tags: list) -> list[str]:
    """Build data model updates for ticket create page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ""),
        value_string("description", ""),
        value_string("priority", "medium"),
        value_string("selectedTagIds", ""),  # Comma-separated tag IDs
    ]
    messages.append(builder.build_data_model_update("/app/form/create", form_data))

    return messages


def build_ticket_edit_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket edit page."""
    ticket_id = ticket["id"]

    # Back button
    builder.text("edit-back-text", "← 返回详情")
    builder.button(
        "edit-back-btn",
        "edit-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )

    builder.text("edit-title", "编辑票据", usage_hint="h1")
    builder.row("edit-header", ["edit-back-btn", "edit-title"], alignment="center")

    # Form
    builder.text("edit-title-label", "标题 *", usage_hint="h4")
    builder.text_field("edit-title-input", "请输入票据标题", builder.path("/app/form/edit/title"))

    builder.text("edit-desc-label", "描述", usage_hint="h4")
    builder.text_field("edit-desc-input", "请输入详细描述...", builder.path("/app/form/edit/description"), text_field_type="multiline")

    builder.text("edit-priority-label", "优先级", usage_hint="h4")
    builder.text("edit-priority-low-text", "低")
    builder.button("edit-priority-low", "edit-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("edit-priority-medium-text", "中")
    builder.button("edit-priority-medium", "edit-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("edit-priority-high-text", "高")
    builder.button("edit-priority-high", "edit-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("edit-priority-urgent-text", "紧急")
    builder.button("edit-priority-urgent", "edit-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("edit-priority-btns", ["edit-priority-low", "edit-priority-medium", "edit-priority-high", "edit-priority-urgent"], alignment="center")

    builder.column("edit-form-fields", [
        "edit-title-label", "edit-title-input",
        "edit-desc-label", "edit-desc-input",
        "edit-priority-label", "edit-priority-btns",
    ])

    # Actions
    builder.divider("edit-divider")
    builder.text("edit-cancel-text", "取消")
    builder.button(
        "edit-cancel-btn",
        "edit-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )
    builder.text("edit-submit-text", "保存更改")
    builder.button(
        "edit-submit-btn",
        "edit-submit-text",
        "update_ticket",
        [
            {"key": "id", "value": {"literalString": ticket_id}},
            {"key": "form", "value": {"path": "/app/form/edit"}},
        ],
    )
    builder.row("edit-actions", ["edit-cancel-btn", "edit-submit-btn"], distribution="end", alignment="center")

    builder.column("edit-form", ["edit-form-fields", "edit-divider", "edit-actions"])
    builder.card("edit-form-card", "edit-form")
    builder.column("edit-page", ["edit-header", "edit-form-card"])

    return "edit-page", []


def build_ticket_edit_data(ticket: dict) -> list[str]:
    """Build data model updates for ticket edit page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ticket["title"]),
        value_string("description", ticket.get("description") or ""),
        value_string("priority", ticket["priority"]),
    ]
    messages.append(builder.build_data_model_update("/app/form/edit", form_data))

    return messages

```

```python
"""Ticket page builders."""
from typing import Any, Optional
from a2ui_builder import A2UIBuilder, value_string, value_number, value_map, build_value_map_from_dict
from models import (
    STATUS_LABELS, PRIORITY_LABELS, STATUS_TRANSITIONS,
    TicketStatus, Priority
)


def build_tickets_page(builder: A2UIBuilder) -> tuple[str, list[str]]:
    """Build the tickets list page."""
    # Page header
    builder.text("tickets-title", "票据列表", usage_hint="h1")
    builder.text("tickets-add-text", "+ 新建票据")
    builder.button(
        "tickets-add-btn",
        "tickets-add-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets/new"}}],
    )
    builder.row("tickets-header", ["tickets-title", "tickets-add-btn"], distribution="spaceBetween", alignment="center")

    # Search
    builder.text_field("tickets-search", "搜索票据...", builder.path("/app/tickets/query/search"))
    builder.text("tickets-search-btn-text", "搜索")
    builder.button(
        "tickets-search-btn",
        "tickets-search-btn-text",
        "search_tickets",
        [
            {"key": "search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-search-row", ["tickets-search", "tickets-search-btn"], alignment="center")

    # Status filter buttons
    builder.text("filter-all-text", "全部")
    builder.button("filter-all", "filter-all-text", "filter_status", [
        {"key": "status", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-open-text", "待处理")
    builder.button("filter-open", "filter-open-text", "filter_status", [
        {"key": "status", "value": {"literalString": "open"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-progress-text", "处理中")
    builder.button("filter-progress", "filter-progress-text", "filter_status", [
        {"key": "status", "value": {"literalString": "in_progress"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-completed-text", "已完成")
    builder.button("filter-completed", "filter-completed-text", "filter_status", [
        {"key": "status", "value": {"literalString": "completed"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-cancelled-text", "已取消")
    builder.button("filter-cancelled", "filter-cancelled-text", "filter_status", [
        {"key": "status", "value": {"literalString": "cancelled"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-status-filters", ["filter-all", "filter-open", "filter-progress", "filter-completed", "filter-cancelled"], alignment="center")

    # Priority filter buttons
    builder.text("priority-all-text", "全部优先级")
    builder.button("priority-all", "priority-all-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-low-text", "低")
    builder.button("priority-low", "priority-low-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "low"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-medium-text", "中")
    builder.button("priority-medium", "priority-medium-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "medium"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-high-text", "高")
    builder.button("priority-high", "priority-high-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "high"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-urgent-text", "紧急")
    builder.button("priority-urgent", "priority-urgent-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "urgent"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-priority-filters", ["priority-all", "priority-low", "priority-medium", "priority-high", "priority-urgent"], alignment="center")

    builder.column("tickets-filters", ["tickets-search-row", "tickets-status-filters", "tickets-priority-filters"])
    builder.card("tickets-filters-card", "tickets-filters")

    # Ticket list template - with tags display
    builder.text("ticket-item-title", builder.path("title"), usage_hint="h3")
    builder.text("ticket-item-status", builder.path("statusLabel"))
    builder.text("ticket-item-priority", builder.path("priorityLabel"))
    builder.text("ticket-item-tags", builder.path("tagsDisplay"))
    builder.text("ticket-item-date", builder.path("created_at"))
    builder.row("ticket-item-meta", ["ticket-item-status", "ticket-item-priority", "ticket-item-tags", "ticket-item-date"], alignment="center")
    builder.column("ticket-item-content", ["ticket-item-title", "ticket-item-meta"])
    builder.text("ticket-item-arrow", "→")
    builder.row("ticket-item-row", ["ticket-item-content", "ticket-item-arrow"], distribution="spaceBetween", alignment="center")
    builder.button(
        "ticket-item-btn",
        "ticket-item-row",
        "view_ticket",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.card("ticket-item-card", "ticket-item-btn")

    # Ticket list
    builder.list_component(
        "tickets-list",
        template={"componentId": "ticket-item-card", "dataBinding": "/app/tickets/list"},
        direction="vertical",
    )

    # Empty state
    builder.text("tickets-empty-title", "暂无票据", usage_hint="h3")
    builder.text("tickets-empty-desc", "点击上方按钮创建第一个票据")
    builder.column("tickets-empty", ["tickets-empty-title", "tickets-empty-desc"], alignment="center")

    # Pagination - use literalNumber for page values since they're numbers
    builder.text("pagination-prev-text", "← 上一页")
    builder.button(
        "pagination-prev",
        "pagination-prev-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/prevPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.text("pagination-info", builder.path("/app/tickets/pagination/info"))
    builder.text("pagination-next-text", "下一页 →")
    builder.button(
        "pagination-next",
        "pagination-next-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/nextPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-pagination", ["pagination-prev", "pagination-info", "pagination-next"], distribution="center", alignment="center")

    # Main content
    builder.column("tickets-content", ["tickets-list", "tickets-pagination"])
    builder.column("tickets-page", ["tickets-header", "tickets-filters-card", "tickets-content"])

    return "tickets-page", []


def build_tickets_data(tickets_response: dict, search: str = "", status: str = "", priority: str = "", page: int = 1) -> list[str]:
    """Build data model updates for tickets page."""
    messages = []
    builder = A2UIBuilder()

    # Query state - use actual values from URL params
    query_data = [
        value_string("search", search),
        value_string("status", status),
        value_string("priority", priority),
        value_number("page", page),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/query", query_data))

    # Tickets list
    tickets = tickets_response.get("data", [])
    list_data = []
    for i, ticket in enumerate(tickets):
        # Build tags display string
        tags = ticket.get("tags", [])
        tags_display = ", ".join([t.get("name", "") for t in tags[:3]])  # Show first 3 tags
        if len(tags) > 3:
            tags_display += f" +{len(tags) - 3}"
        
        ticket_map = build_value_map_from_dict({
            "id": ticket["id"],
            "title": ticket["title"],
            "status": ticket["status"],
            "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
            "priority": ticket["priority"],
            "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
            "created_at": ticket["created_at"][:10],  # Date only
            "tagsDisplay": tags_display,
            "hasTags": len(tags) > 0,
        })
        list_data.append(value_map(f"ticket{i}", ticket_map))
    messages.append(builder.build_data_model_update("/app/tickets/list", list_data))

    # Pagination
    page = tickets_response.get("page", 1)
    total_pages = tickets_response.get("total_pages", 0)
    total_count = tickets_response.get("total", 0)
    
    # If no data, show "第0页/共0页"
    if total_count == 0 or total_pages == 0:
        display_page = 0
        display_total = 0
    else:
        display_page = page
        display_total = total_pages
    
    pagination_data = [
        value_number("page", display_page),
        value_number("totalPages", display_total),
        value_number("prevPage", max(1, page - 1) if total_pages > 0 else 0),
        value_number("nextPage", min(total_pages, page + 1) if total_pages > 0 else 0),
        value_string("info", f"第 {display_page} 页 / 共 {display_total} 页"),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/pagination", pagination_data))

    return messages


def build_ticket_detail_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket detail page."""
    ticket_id = ticket["id"]
    status = ticket["status"]

    # Back button
    builder.text("detail-back-text", "← 返回列表")
    builder.button(
        "detail-back-btn",
        "detail-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    # Title
    builder.text("detail-title", builder.path("/app/ticket/detail/title"), usage_hint="h1")

    # Actions
    builder.text("detail-edit-text", "编辑")
    builder.button(
        "detail-edit-btn",
        "detail-edit-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}/edit"}}],
    )

    builder.text("detail-delete-text", "删除")
    builder.button(
        "detail-delete-btn",
        "detail-delete-text",
        "show_delete_dialog",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )

    builder.row("detail-actions", ["detail-edit-btn", "detail-delete-btn"], alignment="center")
    builder.row("detail-header", ["detail-back-btn", "detail-title", "detail-actions"], distribution="spaceBetween", alignment="center")

    # Description card
    builder.text("detail-desc-label", "描述", usage_hint="h4")
    builder.text("detail-desc-content", builder.path("/app/ticket/detail/description"))
    builder.column("detail-desc-col", ["detail-desc-label", "detail-desc-content"])
    builder.card("detail-desc-card", "detail-desc-col")

    # Resolution card (if exists)
    builder.text("detail-resolution-label", "处理结果", usage_hint="h4")
    builder.text("detail-resolution-content", builder.path("/app/ticket/detail/resolution"))
    builder.column("detail-resolution-col", ["detail-resolution-label", "detail-resolution-content"])
    builder.card("detail-resolution-card", "detail-resolution-col")

    # Status card
    builder.text("detail-status-label", "状态", usage_hint="h4")
    builder.text("detail-status-value", builder.path("/app/ticket/detail/statusLabel"))

    # Status transition buttons
    allowed_transitions = STATUS_TRANSITIONS.get(TicketStatus(status), [])
    status_btns = []
    for target_status in allowed_transitions:
        btn_id = f"status-btn-{target_status.value}"
        text_id = f"status-btn-text-{target_status.value}"
        builder.text(text_id, f"→ {STATUS_LABELS[target_status]}")
        builder.button(
            btn_id,
            text_id,
            "change_status",
            [
                {"key": "id", "value": {"literalString": ticket_id}},
                {"key": "status", "value": {"literalString": target_status.value}},
            ],
        )
        status_btns.append(btn_id)

    builder.row("detail-status-btns", status_btns, alignment="center")
    builder.column("detail-status-col", ["detail-status-label", "detail-status-value", "detail-status-btns"])
    builder.card("detail-status-card", "detail-status-col")

    # Priority card
    builder.text("detail-priority-label", "优先级", usage_hint="h4")
    builder.text("detail-priority-value", builder.path("/app/ticket/detail/priorityLabel"))
    builder.column("detail-priority-col", ["detail-priority-label", "detail-priority-value"])
    builder.card("detail-priority-card", "detail-priority-col")

    # Tags card
    builder.text("detail-tags-label", "标签", usage_hint="h4")
    builder.text("detail-tag-name", builder.path("name"))
    builder.list_component(
        "detail-tags-list",
        template={"componentId": "detail-tag-name", "dataBinding": "/app/ticket/tags"},
        direction="horizontal",
    )
    builder.column("detail-tags-col", ["detail-tags-label", "detail-tags-list"])
    builder.card("detail-tags-card", "detail-tags-col")

    # Timestamps card
    builder.text("detail-time-label", "时间信息", usage_hint="h4")
    builder.text("detail-created-label", "创建时间")
    builder.text("detail-created-value", builder.path("/app/ticket/detail/created_at"))
    builder.row("detail-created-row", ["detail-created-label", "detail-created-value"], distribution="spaceBetween")
    builder.text("detail-updated-label", "更新时间")
    builder.text("detail-updated-value", builder.path("/app/ticket/detail/updated_at"))
    builder.row("detail-updated-row", ["detail-updated-label", "detail-updated-value"], distribution="spaceBetween")
    builder.column("detail-time-col", ["detail-time-label", "detail-created-row", "detail-updated-row"])
    builder.card("detail-time-card", "detail-time-col")

    # Attachments card
    builder.text("detail-attach-label", "附件", usage_hint="h4")
    builder.text("detail-attach-filename", builder.path("filename"))
    builder.text("detail-attach-size", builder.path("sizeFormatted"))
    builder.row("detail-attach-info", ["detail-attach-filename", "detail-attach-size"], distribution="spaceBetween")
    builder.text("detail-attach-download-text", "下载")
    builder.button(
        "detail-attach-download",
        "detail-attach-download-text",
        "download_attachment",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.row("detail-attach-item", ["detail-attach-info", "detail-attach-download"], distribution="spaceBetween", alignment="center")
    builder.list_component(
        "detail-attach-list",
        template={"componentId": "detail-attach-item", "dataBinding": "/app/ticket/attachments"},
        direction="vertical",
    )
    builder.text("detail-attach-empty", "暂无附件")
    builder.column("detail-attach-col", ["detail-attach-label", "detail-attach-list"])
    builder.card("detail-attach-card", "detail-attach-col")

    # History card
    builder.text("detail-history-label", "变更历史", usage_hint="h4")
    builder.text("detail-history-type", builder.path("changeTypeLabel"))
    builder.text("detail-history-time", builder.path("created_at"))
    builder.text("detail-history-old", builder.path("old_value"))
    builder.text("detail-history-arrow", "→")
    builder.text("detail-history-new", builder.path("new_value"))
    builder.row("detail-history-change", ["detail-history-old", "detail-history-arrow", "detail-history-new"], alignment="center")
    builder.column("detail-history-item", ["detail-history-type", "detail-history-time", "detail-history-change"])
    builder.list_component(
        "detail-history-list",
        template={"componentId": "detail-history-item", "dataBinding": "/app/ticket/history"},
        direction="vertical",
    )
    builder.column("detail-history-col", ["detail-history-label", "detail-history-list"])
    builder.card("detail-history-card", "detail-history-col")

    # Left column (main content)
    main_cards = ["detail-desc-card"]
    if ticket.get("resolution"):
        main_cards.append("detail-resolution-card")
    main_cards.append("detail-attach-card")
    builder.column("detail-main", main_cards)

    # Right column (sidebar)
    builder.column("detail-sidebar", [
        "detail-status-card",
        "detail-priority-card",
        "detail-tags-card",
        "detail-time-card",
        "detail-history-card",
    ])

    # Layout
    builder.row("detail-body", ["detail-main", "detail-sidebar"], distribution="start")
    builder.column("detail-page", ["detail-header", "detail-body"])

    # Delete confirmation modal
    builder.text("delete-modal-title", "确认删除", usage_hint="h3")
    builder.text("delete-modal-desc", "确定要删除这个票据吗？此操作无法撤销。")
    builder.text("delete-modal-cancel-text", "取消")
    builder.button("delete-modal-cancel", "delete-modal-cancel-text", "dismiss_dialog", [])
    builder.text("delete-modal-confirm-text", "确认删除")
    builder.button(
        "delete-modal-confirm",
        "delete-modal-confirm-text",
        "delete_ticket",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )
    builder.row("delete-modal-actions", ["delete-modal-cancel", "delete-modal-confirm"], distribution="end")
    builder.column("delete-modal-content", ["delete-modal-title", "delete-modal-desc", "delete-modal-actions"])

    return "detail-page", []


def build_ticket_detail_data(ticket: dict, attachments: list, history: list) -> list[str]:
    """Build data model updates for ticket detail page."""
    messages = []
    builder = A2UIBuilder()

    # Ticket detail
    detail_data = build_value_map_from_dict({
        "id": ticket["id"],
        "title": ticket["title"],
        "description": ticket.get("description") or "无描述",
        "status": ticket["status"],
        "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
        "priority": ticket["priority"],
        "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
        "resolution": ticket.get("resolution") or "",
        "created_at": ticket["created_at"][:19].replace("T", " "),
        "updated_at": ticket["updated_at"][:19].replace("T", " "),
    })
    messages.append(builder.build_data_model_update("/app/ticket/detail", detail_data))

    # Tags
    tags = ticket.get("tags", [])
    tags_data = []
    for i, tag in enumerate(tags):
        tags_data.append(value_map(f"tag{i}", build_value_map_from_dict({
            "id": tag["id"],
            "name": tag["name"],
            "color": tag["color"],
        })))
    messages.append(builder.build_data_model_update("/app/ticket/tags", tags_data))

    # Attachments
    attach_data = []
    for i, att in enumerate(attachments):
        size_bytes = att["size_bytes"]
        if size_bytes < 1024:
            size_formatted = f"{size_bytes} B"
        elif size_bytes < 1024 * 1024:
            size_formatted = f"{size_bytes / 1024:.1f} KB"
        else:
            size_formatted = f"{size_bytes / (1024 * 1024):.1f} MB"
        attach_data.append(value_map(f"att{i}", build_value_map_from_dict({
            "id": att["id"],
            "filename": att["filename"],
            "sizeFormatted": size_formatted,
        })))
    messages.append(builder.build_data_model_update("/app/ticket/attachments", attach_data))

    # History
    change_type_labels = {
        "status": "状态变更",
        "priority": "优先级变更",
        "resolution": "处理结果",
        "tag_added": "添加标签",
        "tag_removed": "移除标签",
    }
    history_data = []
    for i, h in enumerate(history):
        history_data.append(value_map(f"h{i}", build_value_map_from_dict({
            "changeTypeLabel": change_type_labels.get(h["change_type"], h["change_type"]),
            "old_value": h.get("old_value") or "-",
            "new_value": h.get("new_value") or "-",
            "created_at": h["created_at"][:19].replace("T", " "),
        })))
    messages.append(builder.build_data_model_update("/app/ticket/history", history_data))

    return messages


def build_ticket_create_page(builder: A2UIBuilder, tags: list) -> tuple[str, list[str]]:
    """Build the ticket create page."""
    # Back button
    builder.text("create-back-text", "← 返回列表")
    builder.button(
        "create-back-btn",
        "create-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    builder.text("create-title", "新建票据", usage_hint="h1")
    builder.row("create-header", ["create-back-btn", "create-title"], alignment="center")

    # Form
    builder.text("create-title-label", "标题 *", usage_hint="h4")
    builder.text_field("create-title-input", "请输入票据标题", builder.path("/app/form/create/title"))

    builder.text("create-desc-label", "描述", usage_hint="h4")
    builder.text_field("create-desc-input", "请输入详细描述...", builder.path("/app/form/create/description"), text_field_type="multiline")

    builder.text("create-priority-label", "优先级", usage_hint="h4")
    # Priority selection buttons
    builder.text("create-priority-low-text", "低")
    builder.button("create-priority-low", "create-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("create-priority-medium-text", "中")
    builder.button("create-priority-medium", "create-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("create-priority-high-text", "高")
    builder.button("create-priority-high", "create-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("create-priority-urgent-text", "紧急")
    builder.button("create-priority-urgent", "create-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("create-priority-btns", ["create-priority-low", "create-priority-medium", "create-priority-high", "create-priority-urgent"], alignment="center")

    # Tags selection - multi-select dropdown
    tag_options = [
        {"id": tag.get("id", ""), "name": tag.get("name", ""), "color": tag.get("color", "#3B82F6")}
        for tag in tags
    ]
    builder.multi_select(
        "create-tags-select",
        "标签（可多选）",
        tag_options,
        "/app/form/create/selectedTagIds",
        "toggle_multi_select",
    )

    builder.column("create-form-fields", [
        "create-title-label", "create-title-input",
        "create-desc-label", "create-desc-input",
        "create-priority-label", "create-priority-btns",
        "create-tags-select",
    ])

    # Actions
    builder.divider("create-divider")
    builder.text("create-cancel-text", "取消")
    builder.button(
        "create-cancel-btn",
        "create-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )
    builder.text("create-submit-text", "创建票据")
    builder.button(
        "create-submit-btn",
        "create-submit-text",
        "create_ticket",
        [{"key": "form", "value": {"path": "/app/form/create"}}],
    )
    builder.row("create-actions", ["create-cancel-btn", "create-submit-btn"], distribution="end", alignment="center")

    builder.column("create-form", ["create-form-fields", "create-divider", "create-actions"])
    builder.card("create-form-card", "create-form")
    builder.column("create-page", ["create-header", "create-form-card"])

    return "create-page", []


def build_ticket_create_data(tags: list) -> list[str]:
    """Build data model updates for ticket create page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ""),
        value_string("description", ""),
        value_string("priority", "medium"),
        value_string("selectedTagIds", ""),  # Comma-separated tag IDs
    ]
    messages.append(builder.build_data_model_update("/app/form/create", form_data))

    return messages


def build_ticket_edit_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket edit page."""
    ticket_id = ticket["id"]

    # Back button
    builder.text("edit-back-text", "← 返回详情")
    builder.button(
        "edit-back-btn",
        "edit-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )

    builder.text("edit-title", "编辑票据", usage_hint="h1")
    builder.row("edit-header", ["edit-back-btn", "edit-title"], alignment="center")

    # Form
    builder.text("edit-title-label", "标题 *", usage_hint="h4")
    builder.text_field("edit-title-input", "请输入票据标题", builder.path("/app/form/edit/title"))

    builder.text("edit-desc-label", "描述", usage_hint="h4")
    builder.text_field("edit-desc-input", "请输入详细描述...", builder.path("/app/form/edit/description"), text_field_type="multiline")

    builder.text("edit-priority-label", "优先级", usage_hint="h4")
    builder.text("edit-priority-low-text", "低")
    builder.button("edit-priority-low", "edit-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("edit-priority-medium-text", "中")
    builder.button("edit-priority-medium", "edit-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("edit-priority-high-text", "高")
    builder.button("edit-priority-high", "edit-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("edit-priority-urgent-text", "紧急")
    builder.button("edit-priority-urgent", "edit-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("edit-priority-btns", ["edit-priority-low", "edit-priority-medium", "edit-priority-high", "edit-priority-urgent"], alignment="center")

    builder.column("edit-form-fields", [
        "edit-title-label", "edit-title-input",
        "edit-desc-label", "edit-desc-input",
        "edit-priority-label", "edit-priority-btns",
    ])

    # Actions
    builder.divider("edit-divider")
    builder.text("edit-cancel-text", "取消")
    builder.button(
        "edit-cancel-btn",
        "edit-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )
    builder.text("edit-submit-text", "保存更改")
    builder.button(
        "edit-submit-btn",
        "edit-submit-text",
        "update_ticket",
        [
            {"key": "id", "value": {"literalString": ticket_id}},
            {"key": "form", "value": {"path": "/app/form/edit"}},
        ],
    )
    builder.row("edit-actions", ["edit-cancel-btn", "edit-submit-btn"], distribution="end", alignment="center")

    builder.column("edit-form", ["edit-form-fields", "edit-divider", "edit-actions"])
    builder.card("edit-form-card", "edit-form")
    builder.column("edit-page", ["edit-header", "edit-form-card"])

    return "edit-page", []


def build_ticket_edit_data(ticket: dict) -> list[str]:
    """Build data model updates for ticket edit page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ticket["title"]),
        value_string("description", ticket.get("description") or ""),
        value_string("priority", ticket["priority"]),
    ]
    messages.append(builder.build_data_model_update("/app/form/edit", form_data))

    return messages

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isTagsText = id === 'ticket-item-tags';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    // Don't render tags text if empty
    if (isTagsText && !text) {
      return html``;
    }

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-tags=${isTagsText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    // Check if this is a ticket item button
    const isTicketButton = id === 'ticket-item-btn';

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        data-ticket-button=${isTicketButton ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';
    const isMetaRow = id === 'ticket-item-meta';
    const isTicketItemRow = id === 'ticket-item-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
        data-meta-row=${isMetaRow ? 'true' : nothing}
        data-ticket-row=${isTicketItemRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    const isTicketsList = id === 'tickets-list';

    return html`
      <a2ui-list id=${id} data-direction=${direction} data-tickets=${isTicketsList ? 'true' : nothing}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
    /* Ticket item button - full width, transparent */
    :host([data-ticket-button="true"]) {
      display: block;
      width: 100%;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
    }
    :host([data-ticket-button="true"]:hover) {
      background: transparent;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 24px;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-meta-row="true"]) {
      gap: 12px;
    }
    :host([data-ticket-row="true"]) {
      width: 100%;
      flex: 1;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - full width row style */
    :host([data-ticket-card="true"]) {
      width: 100%;
      padding: 16px 20px;
      border-radius: 0;
      background: white;
      border: none;
      border-left: 3px solid transparent;
      cursor: pointer;
      box-sizing: border-box;
      box-shadow: none;
    }
    :host([data-ticket-card="true"]:hover) {
      background: #FEFCE8;
      border-left-color: #FFD93D;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
    :host([data-tickets="true"]) {
      gap: 0;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 0;
      overflow: hidden;
    }
    :host([data-tickets="true"]) ::slotted(*) {
      border-bottom: 1px solid #F3F4F6;
    }
    :host([data-tickets="true"]) ::slotted(*:last-child) {
      border-bottom: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isTagsText = id === 'ticket-item-tags';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    // Don't render tags text if empty
    if (isTagsText && !text) {
      return html``;
    }

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-tags=${isTagsText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    // Check if this is a ticket item button
    const isTicketButton = id === 'ticket-item-btn';

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        data-ticket-button=${isTicketButton ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';
    const isMetaRow = id === 'ticket-item-meta';
    const isTicketItemRow = id === 'ticket-item-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
        data-meta-row=${isMetaRow ? 'true' : nothing}
        data-ticket-row=${isTicketItemRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    const isTicketsList = id === 'tickets-list';

    return html`
      <a2ui-list id=${id} data-direction=${direction} data-tickets=${isTicketsList ? 'true' : nothing}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Tags text styling */
    :host([data-tags="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 400;
      border-radius: 9999px;
      background: #E0E7FF;
      color: #4338CA;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
    /* Ticket item button - full width, transparent */
    :host([data-ticket-button="true"]) {
      display: block;
      width: 100%;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
    }
    :host([data-ticket-button="true"]:hover) {
      background: transparent;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 24px;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-meta-row="true"]) {
      gap: 12px;
    }
    :host([data-ticket-row="true"]) {
      width: 100%;
      flex: 1;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - full width row style */
    :host([data-ticket-card="true"]) {
      width: 100%;
      padding: 16px 20px;
      border-radius: 0;
      background: white;
      border: none;
      border-left: 3px solid transparent;
      cursor: pointer;
      box-sizing: border-box;
      box-shadow: none;
    }
    :host([data-ticket-card="true"]:hover) {
      background: #FEFCE8;
      border-left-color: #FFD93D;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
    :host([data-tickets="true"]) {
      gap: 0;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 0;
      overflow: hidden;
    }
    :host([data-tickets="true"]) ::slotted(*) {
      border-bottom: 1px solid #F3F4F6;
    }
    :host([data-tickets="true"]) ::slotted(*:last-child) {
      border-bottom: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

已完成！现在票据列表中可以显示标签了。

**效果：**
- 每个票据项会显示其关联的标签
- 标签使用淡紫色胶囊样式，与状态和优先级标签区分开
- 最多显示前3个标签，如果超过3个会显示 "+N"
- 没有标签的票据不会显示标签区域

从截图可以看到，第一个票据"快看看"现在显示了它的标签 "Critical, Database, lll"。

---

**User**

票据这个描述不是很贴切对于这个系统来说，所有的地方都将票据改成任务

---

**Cursor**

```python
"""Ticket page builders."""
from typing import Any, Optional
from a2ui_builder import A2UIBuilder, value_string, value_number, value_map, build_value_map_from_dict
from models import (
    STATUS_LABELS, PRIORITY_LABELS, STATUS_TRANSITIONS,
    TicketStatus, Priority
)


def build_tickets_page(builder: A2UIBuilder) -> tuple[str, list[str]]:
    """Build the tickets list page."""
    # Page header
    builder.text("tickets-title", "任务列表", usage_hint="h1")
    builder.text("tickets-add-text", "+ 新建任务")
    builder.button(
        "tickets-add-btn",
        "tickets-add-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets/new"}}],
    )
    builder.row("tickets-header", ["tickets-title", "tickets-add-btn"], distribution="spaceBetween", alignment="center")

    # Search
    builder.text_field("tickets-search", "搜索任务...", builder.path("/app/tickets/query/search"))
    builder.text("tickets-search-btn-text", "搜索")
    builder.button(
        "tickets-search-btn",
        "tickets-search-btn-text",
        "search_tickets",
        [
            {"key": "search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-search-row", ["tickets-search", "tickets-search-btn"], alignment="center")

    # Status filter buttons
    builder.text("filter-all-text", "全部")
    builder.button("filter-all", "filter-all-text", "filter_status", [
        {"key": "status", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-open-text", "待处理")
    builder.button("filter-open", "filter-open-text", "filter_status", [
        {"key": "status", "value": {"literalString": "open"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-progress-text", "处理中")
    builder.button("filter-progress", "filter-progress-text", "filter_status", [
        {"key": "status", "value": {"literalString": "in_progress"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-completed-text", "已完成")
    builder.button("filter-completed", "filter-completed-text", "filter_status", [
        {"key": "status", "value": {"literalString": "completed"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("filter-cancelled-text", "已取消")
    builder.button("filter-cancelled", "filter-cancelled-text", "filter_status", [
        {"key": "status", "value": {"literalString": "cancelled"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-status-filters", ["filter-all", "filter-open", "filter-progress", "filter-completed", "filter-cancelled"], alignment="center")

    # Priority filter buttons
    builder.text("priority-all-text", "全部优先级")
    builder.button("priority-all", "priority-all-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": ""}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-low-text", "低")
    builder.button("priority-low", "priority-low-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "low"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-medium-text", "中")
    builder.button("priority-medium", "priority-medium-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "medium"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-high-text", "高")
    builder.button("priority-high", "priority-high-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "high"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.text("priority-urgent-text", "紧急")
    builder.button("priority-urgent", "priority-urgent-text", "filter_priority", [
        {"key": "priority", "value": {"literalString": "urgent"}},
        {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
        {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
        {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
        {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
    ])
    builder.row("tickets-priority-filters", ["priority-all", "priority-low", "priority-medium", "priority-high", "priority-urgent"], alignment="center")

    builder.column("tickets-filters", ["tickets-search-row", "tickets-status-filters", "tickets-priority-filters"])
    builder.card("tickets-filters-card", "tickets-filters")

    # Ticket list template - with tags display
    builder.text("ticket-item-title", builder.path("title"), usage_hint="h3")
    builder.text("ticket-item-status", builder.path("statusLabel"))
    builder.text("ticket-item-priority", builder.path("priorityLabel"))
    builder.text("ticket-item-tags", builder.path("tagsDisplay"))
    builder.text("ticket-item-date", builder.path("created_at"))
    builder.row("ticket-item-meta", ["ticket-item-status", "ticket-item-priority", "ticket-item-tags", "ticket-item-date"], alignment="center")
    builder.column("ticket-item-content", ["ticket-item-title", "ticket-item-meta"])
    builder.text("ticket-item-arrow", "→")
    builder.row("ticket-item-row", ["ticket-item-content", "ticket-item-arrow"], distribution="spaceBetween", alignment="center")
    builder.button(
        "ticket-item-btn",
        "ticket-item-row",
        "view_ticket",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.card("ticket-item-card", "ticket-item-btn")

    # Ticket list
    builder.list_component(
        "tickets-list",
        template={"componentId": "ticket-item-card", "dataBinding": "/app/tickets/list"},
        direction="vertical",
    )

    # Empty state
    builder.text("tickets-empty-title", "暂无任务", usage_hint="h3")
    builder.text("tickets-empty-desc", "点击上方按钮创建第一个任务")
    builder.column("tickets-empty", ["tickets-empty-title", "tickets-empty-desc"], alignment="center")

    # Pagination - use literalNumber for page values since they're numbers
    builder.text("pagination-prev-text", "← 上一页")
    builder.button(
        "pagination-prev",
        "pagination-prev-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/prevPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.text("pagination-info", builder.path("/app/tickets/pagination/info"))
    builder.text("pagination-next-text", "下一页 →")
    builder.button(
        "pagination-next",
        "pagination-next-text",
        "paginate",
        [
            {"key": "page", "value": {"path": "/app/tickets/pagination/nextPage"}},
            {"key": "current_search", "value": {"path": "/app/tickets/query/search"}},
            {"key": "current_status", "value": {"path": "/app/tickets/query/status"}},
            {"key": "current_priority", "value": {"path": "/app/tickets/query/priority"}},
            {"key": "current_page", "value": {"path": "/app/tickets/query/page"}},
        ],
    )
    builder.row("tickets-pagination", ["pagination-prev", "pagination-info", "pagination-next"], distribution="center", alignment="center")

    # Main content
    builder.column("tickets-content", ["tickets-list", "tickets-pagination"])
    builder.column("tickets-page", ["tickets-header", "tickets-filters-card", "tickets-content"])

    return "tickets-page", []


def build_tickets_data(tickets_response: dict, search: str = "", status: str = "", priority: str = "", page: int = 1) -> list[str]:
    """Build data model updates for tickets page."""
    messages = []
    builder = A2UIBuilder()

    # Query state - use actual values from URL params
    query_data = [
        value_string("search", search),
        value_string("status", status),
        value_string("priority", priority),
        value_number("page", page),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/query", query_data))

    # Tickets list
    tickets = tickets_response.get("data", [])
    list_data = []
    for i, ticket in enumerate(tickets):
        # Build tags display string
        tags = ticket.get("tags", [])
        tags_display = ", ".join([t.get("name", "") for t in tags[:3]])  # Show first 3 tags
        if len(tags) > 3:
            tags_display += f" +{len(tags) - 3}"
        
        ticket_map = build_value_map_from_dict({
            "id": ticket["id"],
            "title": ticket["title"],
            "status": ticket["status"],
            "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
            "priority": ticket["priority"],
            "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
            "created_at": ticket["created_at"][:10],  # Date only
            "tagsDisplay": tags_display,
            "hasTags": len(tags) > 0,
        })
        list_data.append(value_map(f"ticket{i}", ticket_map))
    messages.append(builder.build_data_model_update("/app/tickets/list", list_data))

    # Pagination
    page = tickets_response.get("page", 1)
    total_pages = tickets_response.get("total_pages", 0)
    total_count = tickets_response.get("total", 0)
    
    # If no data, show "第0页/共0页"
    if total_count == 0 or total_pages == 0:
        display_page = 0
        display_total = 0
    else:
        display_page = page
        display_total = total_pages
    
    pagination_data = [
        value_number("page", display_page),
        value_number("totalPages", display_total),
        value_number("prevPage", max(1, page - 1) if total_pages > 0 else 0),
        value_number("nextPage", min(total_pages, page + 1) if total_pages > 0 else 0),
        value_string("info", f"第 {display_page} 页 / 共 {display_total} 页"),
    ]
    messages.append(builder.build_data_model_update("/app/tickets/pagination", pagination_data))

    return messages


def build_ticket_detail_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket detail page."""
    ticket_id = ticket["id"]
    status = ticket["status"]

    # Back button
    builder.text("detail-back-text", "← 返回列表")
    builder.button(
        "detail-back-btn",
        "detail-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    # Title
    builder.text("detail-title", builder.path("/app/ticket/detail/title"), usage_hint="h1")

    # Actions
    builder.text("detail-edit-text", "编辑")
    builder.button(
        "detail-edit-btn",
        "detail-edit-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}/edit"}}],
    )

    builder.text("detail-delete-text", "删除")
    builder.button(
        "detail-delete-btn",
        "detail-delete-text",
        "show_delete_dialog",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )

    builder.row("detail-actions", ["detail-edit-btn", "detail-delete-btn"], alignment="center")
    builder.row("detail-header", ["detail-back-btn", "detail-title", "detail-actions"], distribution="spaceBetween", alignment="center")

    # Description card
    builder.text("detail-desc-label", "描述", usage_hint="h4")
    builder.text("detail-desc-content", builder.path("/app/ticket/detail/description"))
    builder.column("detail-desc-col", ["detail-desc-label", "detail-desc-content"])
    builder.card("detail-desc-card", "detail-desc-col")

    # Resolution card (if exists)
    builder.text("detail-resolution-label", "处理结果", usage_hint="h4")
    builder.text("detail-resolution-content", builder.path("/app/ticket/detail/resolution"))
    builder.column("detail-resolution-col", ["detail-resolution-label", "detail-resolution-content"])
    builder.card("detail-resolution-card", "detail-resolution-col")

    # Status card
    builder.text("detail-status-label", "状态", usage_hint="h4")
    builder.text("detail-status-value", builder.path("/app/ticket/detail/statusLabel"))

    # Status transition buttons
    allowed_transitions = STATUS_TRANSITIONS.get(TicketStatus(status), [])
    status_btns = []
    for target_status in allowed_transitions:
        btn_id = f"status-btn-{target_status.value}"
        text_id = f"status-btn-text-{target_status.value}"
        builder.text(text_id, f"→ {STATUS_LABELS[target_status]}")
        builder.button(
            btn_id,
            text_id,
            "change_status",
            [
                {"key": "id", "value": {"literalString": ticket_id}},
                {"key": "status", "value": {"literalString": target_status.value}},
            ],
        )
        status_btns.append(btn_id)

    builder.row("detail-status-btns", status_btns, alignment="center")
    builder.column("detail-status-col", ["detail-status-label", "detail-status-value", "detail-status-btns"])
    builder.card("detail-status-card", "detail-status-col")

    # Priority card
    builder.text("detail-priority-label", "优先级", usage_hint="h4")
    builder.text("detail-priority-value", builder.path("/app/ticket/detail/priorityLabel"))
    builder.column("detail-priority-col", ["detail-priority-label", "detail-priority-value"])
    builder.card("detail-priority-card", "detail-priority-col")

    # Tags card
    builder.text("detail-tags-label", "标签", usage_hint="h4")
    builder.text("detail-tag-name", builder.path("name"))
    builder.list_component(
        "detail-tags-list",
        template={"componentId": "detail-tag-name", "dataBinding": "/app/ticket/tags"},
        direction="horizontal",
    )
    builder.column("detail-tags-col", ["detail-tags-label", "detail-tags-list"])
    builder.card("detail-tags-card", "detail-tags-col")

    # Timestamps card
    builder.text("detail-time-label", "时间信息", usage_hint="h4")
    builder.text("detail-created-label", "创建时间")
    builder.text("detail-created-value", builder.path("/app/ticket/detail/created_at"))
    builder.row("detail-created-row", ["detail-created-label", "detail-created-value"], distribution="spaceBetween")
    builder.text("detail-updated-label", "更新时间")
    builder.text("detail-updated-value", builder.path("/app/ticket/detail/updated_at"))
    builder.row("detail-updated-row", ["detail-updated-label", "detail-updated-value"], distribution="spaceBetween")
    builder.column("detail-time-col", ["detail-time-label", "detail-created-row", "detail-updated-row"])
    builder.card("detail-time-card", "detail-time-col")

    # Attachments card
    builder.text("detail-attach-label", "附件", usage_hint="h4")
    builder.text("detail-attach-filename", builder.path("filename"))
    builder.text("detail-attach-size", builder.path("sizeFormatted"))
    builder.row("detail-attach-info", ["detail-attach-filename", "detail-attach-size"], distribution="spaceBetween")
    builder.text("detail-attach-download-text", "下载")
    builder.button(
        "detail-attach-download",
        "detail-attach-download-text",
        "download_attachment",
        [{"key": "id", "value": {"path": "id"}}],
    )
    builder.row("detail-attach-item", ["detail-attach-info", "detail-attach-download"], distribution="spaceBetween", alignment="center")
    builder.list_component(
        "detail-attach-list",
        template={"componentId": "detail-attach-item", "dataBinding": "/app/ticket/attachments"},
        direction="vertical",
    )
    builder.text("detail-attach-empty", "暂无附件")
    builder.column("detail-attach-col", ["detail-attach-label", "detail-attach-list"])
    builder.card("detail-attach-card", "detail-attach-col")

    # History card
    builder.text("detail-history-label", "变更历史", usage_hint="h4")
    builder.text("detail-history-type", builder.path("changeTypeLabel"))
    builder.text("detail-history-time", builder.path("created_at"))
    builder.text("detail-history-old", builder.path("old_value"))
    builder.text("detail-history-arrow", "→")
    builder.text("detail-history-new", builder.path("new_value"))
    builder.row("detail-history-change", ["detail-history-old", "detail-history-arrow", "detail-history-new"], alignment="center")
    builder.column("detail-history-item", ["detail-history-type", "detail-history-time", "detail-history-change"])
    builder.list_component(
        "detail-history-list",
        template={"componentId": "detail-history-item", "dataBinding": "/app/ticket/history"},
        direction="vertical",
    )
    builder.column("detail-history-col", ["detail-history-label", "detail-history-list"])
    builder.card("detail-history-card", "detail-history-col")

    # Left column (main content)
    main_cards = ["detail-desc-card"]
    if ticket.get("resolution"):
        main_cards.append("detail-resolution-card")
    main_cards.append("detail-attach-card")
    builder.column("detail-main", main_cards)

    # Right column (sidebar)
    builder.column("detail-sidebar", [
        "detail-status-card",
        "detail-priority-card",
        "detail-tags-card",
        "detail-time-card",
        "detail-history-card",
    ])

    # Layout
    builder.row("detail-body", ["detail-main", "detail-sidebar"], distribution="start")
    builder.column("detail-page", ["detail-header", "detail-body"])

    # Delete confirmation modal
    builder.text("delete-modal-title", "确认删除", usage_hint="h3")
    builder.text("delete-modal-desc", "确定要删除这个任务吗？此操作无法撤销。")
    builder.text("delete-modal-cancel-text", "取消")
    builder.button("delete-modal-cancel", "delete-modal-cancel-text", "dismiss_dialog", [])
    builder.text("delete-modal-confirm-text", "确认删除")
    builder.button(
        "delete-modal-confirm",
        "delete-modal-confirm-text",
        "delete_ticket",
        [{"key": "id", "value": {"literalString": ticket_id}}],
    )
    builder.row("delete-modal-actions", ["delete-modal-cancel", "delete-modal-confirm"], distribution="end")
    builder.column("delete-modal-content", ["delete-modal-title", "delete-modal-desc", "delete-modal-actions"])

    return "detail-page", []


def build_ticket_detail_data(ticket: dict, attachments: list, history: list) -> list[str]:
    """Build data model updates for ticket detail page."""
    messages = []
    builder = A2UIBuilder()

    # Ticket detail
    detail_data = build_value_map_from_dict({
        "id": ticket["id"],
        "title": ticket["title"],
        "description": ticket.get("description") or "无描述",
        "status": ticket["status"],
        "statusLabel": STATUS_LABELS.get(TicketStatus(ticket["status"]), ticket["status"]),
        "priority": ticket["priority"],
        "priorityLabel": PRIORITY_LABELS.get(Priority(ticket["priority"]), ticket["priority"]),
        "resolution": ticket.get("resolution") or "",
        "created_at": ticket["created_at"][:19].replace("T", " "),
        "updated_at": ticket["updated_at"][:19].replace("T", " "),
    })
    messages.append(builder.build_data_model_update("/app/ticket/detail", detail_data))

    # Tags
    tags = ticket.get("tags", [])
    tags_data = []
    for i, tag in enumerate(tags):
        tags_data.append(value_map(f"tag{i}", build_value_map_from_dict({
            "id": tag["id"],
            "name": tag["name"],
            "color": tag["color"],
        })))
    messages.append(builder.build_data_model_update("/app/ticket/tags", tags_data))

    # Attachments
    attach_data = []
    for i, att in enumerate(attachments):
        size_bytes = att["size_bytes"]
        if size_bytes < 1024:
            size_formatted = f"{size_bytes} B"
        elif size_bytes < 1024 * 1024:
            size_formatted = f"{size_bytes / 1024:.1f} KB"
        else:
            size_formatted = f"{size_bytes / (1024 * 1024):.1f} MB"
        attach_data.append(value_map(f"att{i}", build_value_map_from_dict({
            "id": att["id"],
            "filename": att["filename"],
            "sizeFormatted": size_formatted,
        })))
    messages.append(builder.build_data_model_update("/app/ticket/attachments", attach_data))

    # History
    change_type_labels = {
        "status": "状态变更",
        "priority": "优先级变更",
        "resolution": "处理结果",
        "tag_added": "添加标签",
        "tag_removed": "移除标签",
    }
    history_data = []
    for i, h in enumerate(history):
        history_data.append(value_map(f"h{i}", build_value_map_from_dict({
            "changeTypeLabel": change_type_labels.get(h["change_type"], h["change_type"]),
            "old_value": h.get("old_value") or "-",
            "new_value": h.get("new_value") or "-",
            "created_at": h["created_at"][:19].replace("T", " "),
        })))
    messages.append(builder.build_data_model_update("/app/ticket/history", history_data))

    return messages


def build_ticket_create_page(builder: A2UIBuilder, tags: list) -> tuple[str, list[str]]:
    """Build the ticket create page."""
    # Back button
    builder.text("create-back-text", "← 返回列表")
    builder.button(
        "create-back-btn",
        "create-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    builder.text("create-title", "新建任务", usage_hint="h1")
    builder.row("create-header", ["create-back-btn", "create-title"], alignment="center")

    # Form
    builder.text("create-title-label", "标题 *", usage_hint="h4")
    builder.text_field("create-title-input", "请输入任务标题", builder.path("/app/form/create/title"))

    builder.text("create-desc-label", "描述", usage_hint="h4")
    builder.text_field("create-desc-input", "请输入详细描述...", builder.path("/app/form/create/description"), text_field_type="multiline")

    builder.text("create-priority-label", "优先级", usage_hint="h4")
    # Priority selection buttons
    builder.text("create-priority-low-text", "低")
    builder.button("create-priority-low", "create-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("create-priority-medium-text", "中")
    builder.button("create-priority-medium", "create-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("create-priority-high-text", "高")
    builder.button("create-priority-high", "create-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("create-priority-urgent-text", "紧急")
    builder.button("create-priority-urgent", "create-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("create-priority-btns", ["create-priority-low", "create-priority-medium", "create-priority-high", "create-priority-urgent"], alignment="center")

    # Tags selection - multi-select dropdown
    tag_options = [
        {"id": tag.get("id", ""), "name": tag.get("name", ""), "color": tag.get("color", "#3B82F6")}
        for tag in tags
    ]
    builder.multi_select(
        "create-tags-select",
        "标签（可多选）",
        tag_options,
        "/app/form/create/selectedTagIds",
        "toggle_multi_select",
    )

    builder.column("create-form-fields", [
        "create-title-label", "create-title-input",
        "create-desc-label", "create-desc-input",
        "create-priority-label", "create-priority-btns",
        "create-tags-select",
    ])

    # Actions
    builder.divider("create-divider")
    builder.text("create-cancel-text", "取消")
    builder.button(
        "create-cancel-btn",
        "create-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )
    builder.text("create-submit-text", "创建任务")
    builder.button(
        "create-submit-btn",
        "create-submit-text",
        "create_ticket",
        [{"key": "form", "value": {"path": "/app/form/create"}}],
    )
    builder.row("create-actions", ["create-cancel-btn", "create-submit-btn"], distribution="end", alignment="center")

    builder.column("create-form", ["create-form-fields", "create-divider", "create-actions"])
    builder.card("create-form-card", "create-form")
    builder.column("create-page", ["create-header", "create-form-card"])

    return "create-page", []


def build_ticket_create_data(tags: list) -> list[str]:
    """Build data model updates for ticket create page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ""),
        value_string("description", ""),
        value_string("priority", "medium"),
        value_string("selectedTagIds", ""),  # Comma-separated tag IDs
    ]
    messages.append(builder.build_data_model_update("/app/form/create", form_data))

    return messages


def build_ticket_edit_page(builder: A2UIBuilder, ticket: dict) -> tuple[str, list[str]]:
    """Build the ticket edit page."""
    ticket_id = ticket["id"]

    # Back button
    builder.text("edit-back-text", "← 返回详情")
    builder.button(
        "edit-back-btn",
        "edit-back-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )

    builder.text("edit-title", "编辑任务", usage_hint="h1")
    builder.row("edit-header", ["edit-back-btn", "edit-title"], alignment="center")

    # Form
    builder.text("edit-title-label", "标题 *", usage_hint="h4")
    builder.text_field("edit-title-input", "请输入任务标题", builder.path("/app/form/edit/title"))

    builder.text("edit-desc-label", "描述", usage_hint="h4")
    builder.text_field("edit-desc-input", "请输入详细描述...", builder.path("/app/form/edit/description"), text_field_type="multiline")

    builder.text("edit-priority-label", "优先级", usage_hint="h4")
    builder.text("edit-priority-low-text", "低")
    builder.button("edit-priority-low", "edit-priority-low-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "low"}}])
    builder.text("edit-priority-medium-text", "中")
    builder.button("edit-priority-medium", "edit-priority-medium-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "medium"}}])
    builder.text("edit-priority-high-text", "高")
    builder.button("edit-priority-high", "edit-priority-high-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "high"}}])
    builder.text("edit-priority-urgent-text", "紧急")
    builder.button("edit-priority-urgent", "edit-priority-urgent-text", "set_form_priority", [{"key": "priority", "value": {"literalString": "urgent"}}])
    builder.row("edit-priority-btns", ["edit-priority-low", "edit-priority-medium", "edit-priority-high", "edit-priority-urgent"], alignment="center")

    builder.column("edit-form-fields", [
        "edit-title-label", "edit-title-input",
        "edit-desc-label", "edit-desc-input",
        "edit-priority-label", "edit-priority-btns",
    ])

    # Actions
    builder.divider("edit-divider")
    builder.text("edit-cancel-text", "取消")
    builder.button(
        "edit-cancel-btn",
        "edit-cancel-text",
        "navigate",
        [{"key": "to", "value": {"literalString": f"/tickets/{ticket_id}"}}],
    )
    builder.text("edit-submit-text", "保存更改")
    builder.button(
        "edit-submit-btn",
        "edit-submit-text",
        "update_ticket",
        [
            {"key": "id", "value": {"literalString": ticket_id}},
            {"key": "form", "value": {"path": "/app/form/edit"}},
        ],
    )
    builder.row("edit-actions", ["edit-cancel-btn", "edit-submit-btn"], distribution="end", alignment="center")

    builder.column("edit-form", ["edit-form-fields", "edit-divider", "edit-actions"])
    builder.card("edit-form-card", "edit-form")
    builder.column("edit-page", ["edit-header", "edit-form-card"])

    return "edit-page", []


def build_ticket_edit_data(ticket: dict) -> list[str]:
    """Build data model updates for ticket edit page."""
    messages = []
    builder = A2UIBuilder()

    form_data = [
        value_string("title", ticket["title"]),
        value_string("description", ticket.get("description") or ""),
        value_string("priority", ticket["priority"]),
    ]
    messages.append(builder.build_data_model_update("/app/form/edit", form_data))

    return messages

```

```typescript
/**
 * A2UI Client Shell - Main entry point
 */
import './renderer';
import type { A2UIMessage, Action, UserAction, SurfaceUpdate, DataModelUpdate, BeginRendering } from './types';
import type { A2UISurface } from './renderer';

class A2UIClient {
  private surface: A2UISurface | null = null;
  private eventSource: EventSource | null = null;
  private currentPath: string = '/';
  private lastConnectedPath: string = '';

  constructor() {
    this.init();
  }

  private async init(): Promise<void> {
    // Create surface element
    const app = document.getElementById('app');
    if (!app) {
      console.error('App container not found');
      return;
    }

    // Clear loading state
    app.innerHTML = '';

    // Create surface
    this.surface = document.createElement('a2ui-surface') as A2UISurface;
    this.surface.surfaceId = 'main';
    this.surface.setActionHandler((action, sourceId, contextPath) => this.handleAction(action, sourceId, contextPath));
    app.appendChild(this.surface);

    // Get initial path from URL
    this.currentPath = window.location.pathname + window.location.search;

    // Handle browser navigation
    window.addEventListener('popstate', () => {
      this.currentPath = window.location.pathname + window.location.search;
      this.connect();
    });

    // Connect to server
    this.connect();
  }

  private connect(): void {
    // Close existing connection
    if (this.eventSource) {
      this.eventSource.close();
    }

    // Only clear data model when path changes (navigation), not on reconnect
    if (this.surface && this.currentPath !== this.lastConnectedPath) {
      this.surface.dataModel.clear();
      this.lastConnectedPath = this.currentPath;
    }

    // Build SSE URL
    const sseUrl = `/api/a2ui/stream?path=${encodeURIComponent(this.currentPath)}`;
    console.log(`Connecting to: ${sseUrl}`);

    this.eventSource = new EventSource(sseUrl);

    this.eventSource.onmessage = (event) => {
      this.handleMessage(event.data);
    };

    this.eventSource.onerror = (error) => {
      console.error('SSE error:', error);
      // Attempt to reconnect after delay
      setTimeout(() => {
        if (this.eventSource?.readyState === EventSource.CLOSED) {
          this.connect();
        }
      }, 3000);
    };

    this.eventSource.onopen = () => {
      console.log('SSE connection established');
    };
  }

  private handleMessage(data: string): void {
    try {
      const message: A2UIMessage = JSON.parse(data);

      if ('surfaceUpdate' in message) {
        this.handleSurfaceUpdate(message as SurfaceUpdate);
      } else if ('dataModelUpdate' in message) {
        this.handleDataModelUpdate(message as DataModelUpdate);
      } else if ('beginRendering' in message) {
        this.handleBeginRendering(message as BeginRendering);
      } else if ('deleteSurface' in message) {
        console.log('Surface deleted');
      }
    } catch (error) {
      console.error('Error parsing message:', error, data);
    }
  }

  private handleSurfaceUpdate(message: SurfaceUpdate): void {
    if (this.surface && message.surfaceUpdate.surfaceId === this.surface.surfaceId) {
      this.surface.setComponents(message.surfaceUpdate.components);
    }
  }

  private handleDataModelUpdate(message: DataModelUpdate): void {
    if (this.surface && message.dataModelUpdate.surfaceId === this.surface.surfaceId) {
      const path = message.dataModelUpdate.path || '/';
      this.surface.dataModel.update(path, message.dataModelUpdate.contents);
    }
  }

  private handleBeginRendering(message: BeginRendering): void {
    if (this.surface && message.beginRendering.surfaceId === this.surface.surfaceId) {
      this.surface.setRoot(message.beginRendering.root);
    }
  }

  private async handleAction(action: Action, sourceId: string, contextPath?: string): Promise<void> {
    console.log(`Action: ${action.name} from ${sourceId}`, action.context, `contextPath: ${contextPath}`);

    // Build context object from action.context array
    // Pass contextPath to resolve relative paths (e.g., "id" -> "/app/tickets/list/ticket0/id")
    const context: Record<string, unknown> = {};
    if (action.context) {
      for (const item of action.context) {
        const value = this.surface?.dataModel.resolve(item.value, contextPath);
        // Convert undefined to null to ensure it's included in JSON
        context[item.key] = value !== undefined ? value : null;
        console.log(`  Context ${item.key}:`, value, 'from', item.value);
      }
    }

    // Build userAction
    const userAction: UserAction = {
      name: action.name,
      surfaceId: this.surface?.surfaceId || 'main',
      sourceComponentId: sourceId,
      timestamp: new Date().toISOString(),
      context,
    };

    try {
      const response = await fetch('/api/a2ui/action', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(userAction),
      });

      const result = await response.json();
      console.log('Action result:', result);

      // Check for error response
      if (!result.success && result.error) {
        // Show error message to user
        alert(result.error);
        return;
      }

      // Show success message for certain actions
      const successMessages: Record<string, string> = {
        'create_tag': '标签创建成功！',
        'create_ticket': '任务创建成功！',
        'update_ticket': '任务更新成功！',
        'delete_ticket': '任务删除成功！',
        'delete_tag': '标签删除成功！',
        'change_status': '状态更新成功！',
      };
      
      if (successMessages[action.name] && result.result?.navigate) {
        alert(successMessages[action.name]);
      }

      // Handle navigation
      if (result.result?.navigate) {
        this.navigate(result.result.navigate);
      } else if (result.result?.refresh) {
        this.connect();
      } else if (result.result?.handled) {
        // Handle client-side actions
        this.handleClientSideAction(action.name, context);
      }
    } catch (error) {
      console.error('Error sending action:', error);
      alert('操作失败，请稍后重试');
    }
  }

  private navigate(path: string): void {
    // Update URL without reload
    window.history.pushState({}, '', path);
    // Store full path including query string for SSE reconnection
    this.currentPath = path;

    // Force clear data model on navigation (even if path is the same)
    // This ensures fresh data is loaded after create/delete operations
    if (this.surface) {
      this.surface.dataModel.clear();
    }
    // Reset lastConnectedPath to force data refresh
    this.lastConnectedPath = '';

    // Reconnect to get new page
    this.connect();
  }

  private handleClientSideAction(name: string, context: Record<string, unknown>): void {
    if (!this.surface) return;
    
    console.log(`[Client] Handling client-side action: ${name}`, context);
    
    let needsUpdate = false;
    
    if (name === 'set_form_priority') {
      // Determine the form path based on current page
      const priority = context.priority as string;
      const isEditPage = this.currentPath.includes('/edit');
      const formPath = isEditPage ? '/app/form/edit/priority' : '/app/form/create/priority';
      this.surface.dataModel.set(formPath, priority);
      console.log(`[Client] Set ${formPath} = ${priority}`);
      needsUpdate = true;
    } else if (name === 'set_tag_color') {
      // Set tag form color
      const color = context.color as string;
      this.surface.dataModel.set('/app/tags/form/color', color);
      console.log(`[Client] Set /app/tags/form/color = ${color}`);
      needsUpdate = true;
    } else if (name === 'show_create_tag_form') {
      this.surface.dataModel.set('/app/tags/showForm', true);
      console.log(`[Client] Set /app/tags/showForm = true`);
      needsUpdate = true;
    } else if (name === 'hide_create_tag_form') {
      this.surface.dataModel.set('/app/tags/showForm', false);
      console.log(`[Client] Set /app/tags/showForm = false`);
      needsUpdate = true;
    } else if (name === 'show_delete_dialog') {
      // Show delete confirmation dialog
      const id = context.id as string;
      this.surface.dataModel.set('/app/dialog/deleteId', id);
      this.surface.dataModel.set('/app/dialog/show', true);
      console.log(`[Client] Show delete dialog for id: ${id}`);
      needsUpdate = true;
    } else if (name === 'dismiss_dialog') {
      this.surface.dataModel.set('/app/dialog/show', false);
      console.log(`[Client] Dismiss dialog`);
      needsUpdate = true;
    } else if (name === 'toggle_form_tag' || name === 'toggle_multi_select') {
      // Toggle selection in multi-select (works for tags and other multi-selects)
      const optionId = (context.optionId || context.tagId) as string;
      const selectedPath = context.selectedPath as string | undefined;
      
      // Determine path - use explicit selectedPath or infer from context
      let formPath: string;
      if (selectedPath) {
        formPath = selectedPath;
      } else {
        const isEditPage = this.currentPath.includes('/edit');
        formPath = isEditPage ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      }
      
      const currentSelected = (this.surface.dataModel.get(formPath) as string) || '';
      const selectedIds = currentSelected ? currentSelected.split(',').filter(id => id.trim()) : [];
      
      const index = selectedIds.indexOf(optionId);
      if (index >= 0) {
        // Remove option
        selectedIds.splice(index, 1);
      } else {
        // Add option
        selectedIds.push(optionId);
      }
      
      this.surface.dataModel.set(formPath, selectedIds.join(','));
      console.log(`[Client] Toggle ${optionId} in ${formPath}, selected: ${selectedIds.join(',')}`);
      needsUpdate = true;
    }
    
    // Trigger re-render to update UI (e.g., button selection states)
    if (needsUpdate) {
      this.surface.requestUpdate();
    }
  }
}

// Initialize client
new A2UIClient();

```

```python
"""App layout components."""
from a2ui_builder import A2UIBuilder


def build_app_layout(builder: A2UIBuilder, content_id: str, active_nav: str = "tickets"):
    """Build the main app layout with navigation."""
    # Navigation header - simplified without icons
    builder.text("nav-logo-text", "Ticket System", usage_hint="h2")

    # Nav items - simple text buttons
    builder.text("nav-tickets-text", "任务管理")
    builder.button(
        "nav-tickets",
        "nav-tickets-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    builder.text("nav-tags-text", "标签管理")
    builder.button(
        "nav-tags",
        "nav-tags-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tags"}}],
    )

    builder.row("nav-items", ["nav-tickets", "nav-tags"], alignment="center")
    builder.row("nav-header", ["nav-logo-text", "nav-items"], distribution="spaceBetween", alignment="center")

    # Main layout
    builder.divider("divider-nav")
    builder.column("app-layout", ["nav-header", "divider-nav", content_id])

    return builder

```

```html
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task System - A2UI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <style>
      :root {
        /* MotherDuck Theme Colors */
        --color-primary: #FFD93D;
        --color-primary-hover: #FFE566;
        --color-secondary: #1E3A5F;
        --color-accent: #D5E8F0;

        /* Functional Colors */
        --color-success: #10B981;
        --color-warning: #F59E0B;
        --color-error: #EF4444;
        --color-info: #3B82F6;

        /* Neutral Colors */
        --color-white: #FFFFFF;
        --color-gray-50: #F9FAFB;
        --color-gray-100: #F3F4F6;
        --color-gray-200: #E5E7EB;
        --color-gray-300: #D1D5DB;
        --color-gray-400: #9CA3AF;
        --color-gray-500: #6B7280;
        --color-gray-600: #4B5563;
        --color-gray-700: #374151;
        --color-gray-800: #1F2937;
        --color-gray-900: #111827;

        /* Typography */
        --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
        --font-mono: 'JetBrains Mono', monospace;

        /* Font Sizes */
        --text-xs: 12px;
        --text-sm: 14px;
        --text-base: 16px;
        --text-lg: 18px;
        --text-xl: 20px;
        --text-2xl: 24px;
        --text-3xl: 30px;
        --text-4xl: 36px;

        /* Spacing */
        --space-1: 4px;
        --space-2: 8px;
        --space-3: 12px;
        --space-4: 16px;
        --space-5: 20px;
        --space-6: 24px;
        --space-8: 32px;
        --space-10: 40px;
        --space-12: 48px;

        /* Border Radius */
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-xl: 16px;
        --radius-full: 9999px;

        /* Shadows */
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

        /* Transitions */
        --transition-fast: 150ms ease;
        --transition-normal: 200ms ease;
        --transition-slow: 300ms ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-sans);
        font-size: var(--text-base);
        line-height: 1.5;
        color: var(--color-gray-900);
        background-color: var(--color-gray-50);
        min-height: 100vh;
      }

      #app {
        min-height: 100vh;
      }

      /* Loading state */
      .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        gap: var(--space-4);
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--color-gray-200);
        border-top-color: var(--color-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* A2UI Component Styles */
      a2ui-surface {
        display: block;
        min-height: 100vh;
      }

      /* Navigation */
      [data-component="nav-header"] {
        background: var(--color-white);
        border-bottom: 1px solid var(--color-gray-200);
        padding: var(--space-4) var(--space-6);
        position: sticky;
        top: 0;
        z-index: 50;
      }

      /* Cards */
      a2ui-card {
        background: var(--color-white);
        border: 1px solid var(--color-gray-200);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        box-shadow: var(--shadow-md);
        transition: box-shadow var(--transition-normal), transform var(--transition-normal);
      }

      a2ui-card:hover {
        box-shadow: var(--shadow-lg);
      }

      /* Buttons */
      a2ui-button {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-md);
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition-fast);
        border: 1px solid transparent;
      }

      a2ui-button[data-variant="primary"] {
        background: var(--color-primary);
        color: var(--color-secondary);
      }

      a2ui-button[data-variant="primary"]:hover {
        background: var(--color-primary-hover);
        box-shadow: var(--shadow-md);
      }

      a2ui-button[data-variant="secondary"] {
        background: transparent;
        border-color: var(--color-gray-300);
        color: var(--color-gray-700);
      }

      a2ui-button[data-variant="secondary"]:hover {
        background: var(--color-gray-100);
        border-color: var(--color-primary);
      }

      a2ui-button[data-variant="danger"] {
        background: transparent;
        border-color: var(--color-error);
        color: var(--color-error);
      }

      a2ui-button[data-variant="danger"]:hover {
        background: var(--color-error);
        color: var(--color-white);
      }

      /* Small button variant for filters */
      a2ui-button[data-size="small"] {
        padding: var(--space-1) var(--space-3);
        font-size: var(--text-sm);
        border-radius: var(--radius-full);
      }

      /* Search row styling */
      #tickets-search-row {
        gap: var(--space-6);
      }

      #tickets-search-row a2ui-textfield {
        flex: 1;
      }

      /* Filter row styling */
      #tickets-status-filters,
      #tickets-priority-filters {
        gap: var(--space-2);
        flex-wrap: wrap;
      }

      #tickets-status-filters a2ui-button,
      #tickets-priority-filters a2ui-button {
        padding: var(--space-1) var(--space-3);
        font-size: var(--text-sm);
        border-radius: var(--radius-full);
        background: var(--color-gray-100);
        color: var(--color-gray-700);
        border: 1px solid var(--color-gray-300);
      }

      #tickets-status-filters a2ui-button:hover,
      #tickets-priority-filters a2ui-button:hover {
        background: var(--color-primary);
        color: var(--color-secondary);
        border-color: var(--color-primary);
      }

      /* Text Fields */
      a2ui-textfield {
        display: block;
      }

      a2ui-textfield input,
      a2ui-textfield textarea {
        width: 100%;
        padding: var(--space-3) var(--space-4);
        border: 1px solid var(--color-gray-300);
        border-radius: var(--radius-md);
        font-family: inherit;
        font-size: var(--text-base);
        transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
      }

      a2ui-textfield input:focus,
      a2ui-textfield textarea:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
      }

      /* Text styles */
      a2ui-text[data-usage-hint="h1"] {
        font-size: var(--text-4xl);
        font-weight: 700;
        color: var(--color-gray-900);
      }

      a2ui-text[data-usage-hint="h2"] {
        font-size: var(--text-2xl);
        font-weight: 600;
        color: var(--color-gray-900);
      }

      a2ui-text[data-usage-hint="h3"] {
        font-size: var(--text-xl);
        font-weight: 600;
        color: var(--color-gray-900);
      }

      a2ui-text[data-usage-hint="h4"] {
        font-size: var(--text-sm);
        font-weight: 500;
        color: var(--color-gray-500);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      /* Status badges */
      [data-status="open"] {
        background: var(--color-info);
        color: white;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
        font-weight: 500;
      }

      [data-status="in_progress"] {
        background: var(--color-warning);
        color: white;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
        font-weight: 500;
      }

      [data-status="completed"] {
        background: var(--color-success);
        color: white;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
        font-weight: 500;
      }

      [data-status="cancelled"] {
        background: var(--color-gray-400);
        color: white;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
        font-weight: 500;
      }

      /* Priority badges */
      [data-priority="low"] {
        background: var(--color-gray-200);
        color: var(--color-gray-700);
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
      }

      [data-priority="medium"] {
        background: var(--color-info);
        color: white;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
      }

      [data-priority="high"] {
        background: var(--color-warning);
        color: white;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
      }

      [data-priority="urgent"] {
        background: var(--color-error);
        color: white;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
      }

      /* Layout */
      a2ui-column {
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
      }

      a2ui-row {
        display: flex;
        flex-direction: row;
        gap: var(--space-4);
        align-items: center;
      }

      a2ui-row[data-distribution="spaceBetween"] {
        justify-content: space-between;
      }

      a2ui-row[data-distribution="center"] {
        justify-content: center;
      }

      a2ui-row[data-distribution="end"] {
        justify-content: flex-end;
      }

      a2ui-column[data-alignment="center"] {
        align-items: center;
      }

      /* List */
      a2ui-list {
        display: flex;
        gap: var(--space-3);
      }

      a2ui-list[data-direction="vertical"] {
        flex-direction: column;
      }

      a2ui-list[data-direction="horizontal"] {
        flex-direction: row;
        flex-wrap: wrap;
      }

      /* Divider */
      a2ui-divider {
        height: 1px;
        background: var(--color-gray-200);
        margin: var(--space-4) 0;
      }

      /* Icon */
      a2ui-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      a2ui-icon .material-icons {
        font-size: 24px;
        color: inherit;
      }

      /* Main content area */
      .main-content {
        max-width: 1280px;
        margin: 0 auto;
        padding: var(--space-8) var(--space-6);
      }

      /* Responsive */
      @media (max-width: 768px) {
        :root {
          --text-4xl: 28px;
          --text-3xl: 24px;
          --text-2xl: 20px;
        }

        .main-content {
          padding: var(--space-4);
        }

        a2ui-row {
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>加载中...</p>
      </div>
    </div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>

```

```python
"""App layout components."""
from a2ui_builder import A2UIBuilder


def build_app_layout(builder: A2UIBuilder, content_id: str, active_nav: str = "tickets"):
    """Build the main app layout with navigation."""
    # Navigation header - simplified without icons
    builder.text("nav-logo-text", "Task System", usage_hint="h2")

    # Nav items - simple text buttons
    builder.text("nav-tickets-text", "任务管理")
    builder.button(
        "nav-tickets",
        "nav-tickets-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tickets"}}],
    )

    builder.text("nav-tags-text", "标签管理")
    builder.button(
        "nav-tags",
        "nav-tags-text",
        "navigate",
        [{"key": "to", "value": {"literalString": "/tags"}}],
    )

    builder.row("nav-items", ["nav-tickets", "nav-tags"], alignment="center")
    builder.row("nav-header", ["nav-logo-text", "nav-items"], distribution="spaceBetween", alignment="center")

    # Main layout
    builder.divider("divider-nav")
    builder.column("app-layout", ["nav-header", "divider-nav", content_id])

    return builder

```

已完成！所有地方的"票据"都已改成"任务"：

**修改内容：**

1. **系统标题**：`Ticket System` → `Task System`
2. **导航栏**：`票据管理` → `任务管理`
3. **页面标题**：`任务列表`
4. **按钮**：`+ 新建任务`、`创建任务`
5. **搜索框占位符**：`搜索任务...`
6. **输入框占位符**：`请输入任务标题`
7. **提示文字**：`暂无任务`、`点击上方按钮创建第一个任务`
8. **成功提示**：`任务创建成功！`、`任务更新成功！`、`任务删除成功！`
9. **删除确认**：`确定要删除这个任务吗？`
10. **页面标题（编辑页）**：`新建任务`、`编辑任务`

---

**User**

搜索框和搜索按钮的位置又跌在一起了，他们之前应该有一些间距

---

**Cursor**

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isTagsText = id === 'ticket-item-tags';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    // Don't render tags text if empty
    if (isTagsText && !text) {
      return html``;
    }

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-tags=${isTagsText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    // Check if this is a ticket item button
    const isTicketButton = id === 'ticket-item-btn';

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        data-ticket-button=${isTicketButton ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';
    const isMetaRow = id === 'ticket-item-meta';
    const isTicketItemRow = id === 'ticket-item-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
        data-meta-row=${isMetaRow ? 'true' : nothing}
        data-ticket-row=${isTicketItemRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    const isTicketsList = id === 'tickets-list';

    return html`
      <a2ui-list id=${id} data-direction=${direction} data-tickets=${isTicketsList ? 'true' : nothing}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Tags text styling */
    :host([data-tags="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 400;
      border-radius: 9999px;
      background: #E0E7FF;
      color: #4338CA;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
    /* Ticket item button - full width, transparent */
    :host([data-ticket-button="true"]) {
      display: block;
      width: 100%;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
    }
    :host([data-ticket-button="true"]:hover) {
      background: transparent;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 32px;
    }
    :host([data-search-row="true"]) ::slotted(a2ui-textfield) {
      flex: 1;
      max-width: 400px;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-meta-row="true"]) {
      gap: 12px;
    }
    :host([data-ticket-row="true"]) {
      width: 100%;
      flex: 1;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - full width row style */
    :host([data-ticket-card="true"]) {
      width: 100%;
      padding: 16px 20px;
      border-radius: 0;
      background: white;
      border: none;
      border-left: 3px solid transparent;
      cursor: pointer;
      box-sizing: border-box;
      box-shadow: none;
    }
    :host([data-ticket-card="true"]:hover) {
      background: #FEFCE8;
      border-left-color: #FFD93D;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
    :host([data-tickets="true"]) {
      gap: 0;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 0;
      overflow: hidden;
    }
    :host([data-tickets="true"]) ::slotted(*) {
      border-bottom: 1px solid #F3F4F6;
    }
    :host([data-tickets="true"]) ::slotted(*:last-child) {
      border-bottom: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

现在搜索框和搜索按钮之间的间距已经增加了（从 24px 增加到 32px），看起来更加协调了。

---

**User**

还是跌在一起的

---

**Cursor**

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isTagsText = id === 'ticket-item-tags';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    // Don't render tags text if empty
    if (isTagsText && !text) {
      return html``;
    }

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-tags=${isTagsText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    // Check if this is a ticket item button
    const isTicketButton = id === 'ticket-item-btn';

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        data-ticket-button=${isTicketButton ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;
    const isSearchField = id === 'tickets-search';

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id} data-search-field=${isSearchField ? 'true' : nothing}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';
    const isMetaRow = id === 'ticket-item-meta';
    const isTicketItemRow = id === 'ticket-item-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
        data-meta-row=${isMetaRow ? 'true' : nothing}
        data-ticket-row=${isTicketItemRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    const isTicketsList = id === 'tickets-list';

    return html`
      <a2ui-list id=${id} data-direction=${direction} data-tickets=${isTicketsList ? 'true' : nothing}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Tags text styling */
    :host([data-tags="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 400;
      border-radius: 9999px;
      background: #E0E7FF;
      color: #4338CA;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
    /* Ticket item button - full width, transparent */
    :host([data-ticket-button="true"]) {
      display: block;
      width: 100%;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
    }
    :host([data-ticket-button="true"]:hover) {
      background: transparent;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 32px;
    }
    :host([data-search-row="true"]) ::slotted(a2ui-textfield) {
      flex: 1;
      max-width: 400px;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-meta-row="true"]) {
      gap: 12px;
    }
    :host([data-ticket-row="true"]) {
      width: 100%;
      flex: 1;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - full width row style */
    :host([data-ticket-card="true"]) {
      width: 100%;
      padding: 16px 20px;
      border-radius: 0;
      background: white;
      border: none;
      border-left: 3px solid transparent;
      cursor: pointer;
      box-sizing: border-box;
      box-shadow: none;
    }
    :host([data-ticket-card="true"]:hover) {
      background: #FEFCE8;
      border-left-color: #FFD93D;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
    :host([data-tickets="true"]) {
      gap: 0;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 0;
      overflow: hidden;
    }
    :host([data-tickets="true"]) ::slotted(*) {
      border-bottom: 1px solid #F3F4F6;
    }
    :host([data-tickets="true"]) ::slotted(*:last-child) {
      border-bottom: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

```typescript
/**
 * A2UI Renderer - Renders A2UI components to DOM
 */
import { LitElement, html, css, TemplateResult, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { Component, BoundValue, Action, Children, ExplicitChildren } from './types';
import { DataModel } from './data-model';

/**
 * Main A2UI Surface element
 */
@customElement('a2ui-surface')
export class A2UISurface extends LitElement {
  @property({ type: String }) surfaceId = 'main';
  @state() private components: Map<string, Component> = new Map();
  @state() private rootId: string | null = null;

  dataModel: DataModel = new DataModel();

  private actionHandler: ((action: Action, sourceId: string, contextPath?: string) => void) | null = null;

  static styles = css`
    :host {
      display: block;
    }
  `;

  setComponents(components: Component[]): void {
    this.components.clear();
    for (const comp of components) {
      this.components.set(comp.id, comp);
    }
    this.requestUpdate();
  }

  setRoot(rootId: string): void {
    this.rootId = rootId;
    this.requestUpdate();
  }

  setActionHandler(handler: (action: Action, sourceId: string, contextPath?: string) => void): void {
    this.actionHandler = handler;
  }

  handleAction(action: Action, sourceId: string, contextPath?: string): void {
    console.log(`[A2UISurface] handleAction called: ${action.name} from ${sourceId}`);
    
    // Log current data model state for debugging
    if (action.name === 'search_tickets') {
      const searchPath = '/app/tickets/query/search';
      const searchValue = this.dataModel.get(searchPath);
      console.log(`[A2UISurface] Before action, DataModel ${searchPath} = "${searchValue}"`);
      console.log(`[A2UISurface] Full DataModel dump:`, this.dataModel.dump());
    }
    
    if (this.actionHandler) {
      this.actionHandler(action, sourceId, contextPath);
    }
  }

  render() {
    if (!this.rootId) {
      return html`<slot></slot>`;
    }

    const rootComponent = this.components.get(this.rootId);
    if (!rootComponent) {
      return html`<div class="error">Root component not found: ${this.rootId}</div>`;
    }

    return this.renderComponent(rootComponent);
  }

  private renderComponent(comp: Component, contextPath?: string): TemplateResult | typeof nothing {
    const componentType = Object.keys(comp.component)[0];
    const props = comp.component[componentType] as Record<string, unknown>;

    switch (componentType) {
      case 'Text':
        return this.renderText(comp.id, props, contextPath);
      case 'Button':
        return this.renderButton(comp.id, props, contextPath);
      case 'TextField':
        return this.renderTextField(comp.id, props, contextPath);
      case 'Column':
        return this.renderColumn(comp.id, props, contextPath);
      case 'Row':
        return this.renderRow(comp.id, props, contextPath);
      case 'Card':
        return this.renderCard(comp.id, props, contextPath);
      case 'List':
        return this.renderList(comp.id, props, contextPath);
      case 'Icon':
        return this.renderIcon(comp.id, props, contextPath);
      case 'Divider':
        return this.renderDivider(comp.id);
      case 'Modal':
        return this.renderModal(comp.id, props, contextPath);
      case 'CheckBox':
        return this.renderCheckBox(comp.id, props, contextPath);
      case 'MultiSelect':
        return this.renderMultiSelect(comp.id, props, contextPath);
      default:
        console.warn(`Unknown component type: ${componentType}`);
        return html`<div class="unknown-component">[${componentType}]</div>`;
    }
  }

  private resolveValue(value: BoundValue | undefined, contextPath?: string): unknown {
    if (!value) return undefined;
    return this.dataModel.resolve(value, contextPath);
  }

  private renderText(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const usageHint = props.usageHint as string | undefined;
    
    // Detect special text types for styling
    const isStatusText = id === 'ticket-item-status';
    const isPriorityText = id === 'ticket-item-priority';
    const isTagsText = id === 'ticket-item-tags';
    const isDateText = id === 'ticket-item-date';
    const isBadge = isStatusText || isPriorityText;

    // Don't render tags text if empty
    if (isTagsText && !text) {
      return html``;
    }

    return html`
      <a2ui-text
        id=${id}
        data-usage-hint=${usageHint || nothing}
        data-badge=${isBadge ? 'true' : nothing}
        data-status=${isStatusText ? 'true' : nothing}
        data-priority=${isPriorityText ? 'true' : nothing}
        data-tags=${isTagsText ? 'true' : nothing}
        data-date=${isDateText ? 'true' : nothing}
      >${text}</a2ui-text>
    `;
  }

  private renderButton(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;
    const action = props.action as Action;

    const handleClick = () => {
      console.log(`[Button ${id}] clicked, action:`, action);
      if (action) {
        // Pass contextPath so relative paths in action.context can be resolved
        this.handleAction(action, id, contextPath);
      } else {
        console.warn(`[Button ${id}] No action defined!`);
      }
    };

    // Check if this is a filter button, form priority button, tag color button, or form tag button
    const isFilterButton = id.startsWith('filter-') || id.startsWith('priority-');
    const isFormPriorityButton = id.startsWith('create-priority-') || id.startsWith('edit-priority-');
    const isTagColorButton = id.startsWith('tag-color-');
    const isFormTagButton = id.startsWith('create-tag-') || id.startsWith('edit-tag-');
    const isSelectableButton = isFilterButton || isFormPriorityButton || isTagColorButton || isFormTagButton;
    
    // Check if this button is currently selected
    let isSelected = false;
    if (isFilterButton) {
      const currentStatus = this.dataModel.get('/app/tickets/query/status') as string || '';
      const currentPriority = this.dataModel.get('/app/tickets/query/priority') as string || '';
      
      // Status filter buttons
      if (id === 'filter-all' && currentStatus === '') isSelected = true;
      else if (id === 'filter-open' && currentStatus === 'open') isSelected = true;
      else if (id === 'filter-progress' && currentStatus === 'in_progress') isSelected = true;
      else if (id === 'filter-completed' && currentStatus === 'completed') isSelected = true;
      else if (id === 'filter-cancelled' && currentStatus === 'cancelled') isSelected = true;
      
      // Priority filter buttons
      else if (id === 'priority-all' && currentPriority === '') isSelected = true;
      else if (id === 'priority-low' && currentPriority === 'low') isSelected = true;
      else if (id === 'priority-medium' && currentPriority === 'medium') isSelected = true;
      else if (id === 'priority-high' && currentPriority === 'high') isSelected = true;
      else if (id === 'priority-urgent' && currentPriority === 'urgent') isSelected = true;
    } else if (isFormPriorityButton) {
      // Form priority buttons (create/edit ticket forms)
      const isEditForm = id.startsWith('edit-priority-');
      const formPath = isEditForm ? '/app/form/edit/priority' : '/app/form/create/priority';
      const currentFormPriority = this.dataModel.get(formPath) as string || 'medium';
      
      // Extract priority value from button id (e.g., 'create-priority-low' -> 'low')
      const buttonPriority = id.replace('create-priority-', '').replace('edit-priority-', '');
      isSelected = buttonPriority === currentFormPriority;
    } else if (isTagColorButton) {
      // Tag color buttons
      const currentColor = this.dataModel.get('/app/tags/form/color') as string || '#3B82F6';
      
      // Map button id to color value
      const colorMap: Record<string, string> = {
        'tag-color-blue': '#3B82F6',
        'tag-color-green': '#10B981',
        'tag-color-yellow': '#F59E0B',
        'tag-color-red': '#EF4444',
        'tag-color-purple': '#8B5CF6',
      };
      isSelected = colorMap[id] === currentColor;
    } else if (isFormTagButton) {
      // Form tag selection buttons (multi-select)
      const isEditForm = id.startsWith('edit-tag-');
      const formPath = isEditForm ? '/app/form/edit/selectedTagIds' : '/app/form/create/selectedTagIds';
      const selectedTagIds = (this.dataModel.get(formPath) as string) || '';
      
      // Get tag ID from action context
      const actionContext = action?.context || [];
      const tagIdEntry = actionContext.find((c: { key: string }) => c.key === 'tagId');
      if (tagIdEntry && 'literalString' in tagIdEntry.value) {
        const tagId = tagIdEntry.value.literalString;
        isSelected = selectedTagIds.split(',').includes(tagId);
      }
    }

    // Check if this is a ticket item button
    const isTicketButton = id === 'ticket-item-btn';

    return html`
      <a2ui-button 
        id=${id} 
        data-filter-button=${isSelectableButton ? 'true' : nothing} 
        data-selected=${isSelected ? 'true' : nothing}
        data-ticket-button=${isTicketButton ? 'true' : nothing}
        @click=${handleClick}
      >
        ${this.renderChildById(childId, contextPath)}
      </a2ui-button>
    `;
  }

  private renderTextField(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const text = this.resolveValue(props.text as BoundValue, contextPath) ?? '';
    const textFieldType = props.textFieldType as string | undefined;
    const isSearchField = id === 'tickets-search';

    // Get the path for this text field
    const textProp = props.text as BoundValue;
    const textPath = textProp && 'path' in textProp ? textProp.path : null;
    
    const handleInput = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      console.log(`[TextField ${id}] handleInput called, value: "${target.value}"`);
      
      if (textPath) {
        // Two-way binding: update data model with new value
        this.dataModel.set(textPath, target.value);
        console.log(`[TextField ${id}] DataModel updated: ${textPath} = "${target.value}"`);
        
        // Verify the value was stored
        const storedValue = this.dataModel.get(textPath);
        console.log(`[TextField ${id}] DataModel verification: ${textPath} = "${storedValue}"`);
      } else {
        console.log(`[TextField ${id}] No path binding, value not stored`);
      }
    };

    if (textFieldType === 'multiline') {
      return html`
        <a2ui-textfield id=${id}>
          <textarea
            placeholder=${label}
            .value=${text}
            @input=${handleInput}
            rows="4"
          ></textarea>
        </a2ui-textfield>
      `;
    }

    return html`
      <a2ui-textfield id=${id} data-search-field=${isSearchField ? 'true' : nothing}>
        <input
          type="text"
          placeholder=${label}
          .value=${text}
          @input=${handleInput}
        />
      </a2ui-textfield>
    `;
  }

  private renderColumn(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isAppLayout = id === 'app-layout';
    const isTicketsList = id === 'tickets-content';

    return html`
      <a2ui-column
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-app-layout=${isAppLayout ? 'true' : nothing}
        data-tickets-list=${isTicketsList ? 'true' : nothing}
      >
        ${children}
      </a2ui-column>
    `;
  }

  private renderRow(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = this.renderChildren(props.children as Children, contextPath);
    const alignment = props.alignment as string | undefined;
    const distribution = props.distribution as string | undefined;
    const isSearchRow = id === 'tickets-search-row';
    const isFilterRow = id === 'tickets-status-filters' || id === 'tickets-priority-filters';
    const isMetaRow = id === 'ticket-item-meta';
    const isTicketItemRow = id === 'ticket-item-row';

    return html`
      <a2ui-row
        id=${id}
        data-alignment=${alignment || nothing}
        data-distribution=${distribution || nothing}
        data-search-row=${isSearchRow ? 'true' : nothing}
        data-filter-row=${isFilterRow ? 'true' : nothing}
        data-meta-row=${isMetaRow ? 'true' : nothing}
        data-ticket-row=${isTicketItemRow ? 'true' : nothing}
      >
        ${children}
      </a2ui-row>
    `;
  }

  private renderCard(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const childId = props.child as string;

    // Check if this is a ticket item card (in the list)
    const isTicketCard = id === 'ticket-item-card';

    return html`
      <a2ui-card id=${id} data-ticket-card=${isTicketCard ? 'true' : nothing}>
        ${this.renderChildById(childId, contextPath)}
      </a2ui-card>
    `;
  }

  private renderList(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const children = props.children as Children;
    const direction = props.direction as string || 'vertical';

    let content: unknown;

    if ('template' in children) {
      // Template-based list
      const template = children.template;
      const dataBinding = template.dataBinding;
      const entries = this.dataModel.getEntries(dataBinding);

      content = entries.map(entry => {
        const itemContextPath = entry.path;
        const templateComponent = this.components.get(template.componentId);
        if (templateComponent) {
          return this.renderComponent(templateComponent, itemContextPath);
        }
        return html``;
      });
    } else {
      // Explicit list
      content = this.renderChildren(children, contextPath);
    }

    const isTicketsList = id === 'tickets-list';

    return html`
      <a2ui-list id=${id} data-direction=${direction} data-tickets=${isTicketsList ? 'true' : nothing}>
        ${content}
      </a2ui-list>
    `;
  }

  private renderIcon(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const name = this.resolveValue(props.name as BoundValue, contextPath) ?? '';

    return html`
      <a2ui-icon id=${id}>
        <span class="material-icons">${name}</span>
      </a2ui-icon>
    `;
  }

  private renderDivider(id: string): TemplateResult {
    return html`<a2ui-divider id=${id}></a2ui-divider>`;
  }

  private renderModal(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    // Modal rendering - simplified version
    const entryPointChild = props.entryPointChild as string;
    const contentChild = props.contentChild as string;

    return html`
      <a2ui-modal id=${id}>
        <div slot="entry">${this.renderChildById(entryPointChild, contextPath)}</div>
        <div slot="content">${this.renderChildById(contentChild, contextPath)}</div>
      </a2ui-modal>
    `;
  }

  private renderCheckBox(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const value = this.resolveValue(props.value as BoundValue, contextPath) ?? false;

    return html`
      <a2ui-checkbox id=${id}>
        <label>
          <input type="checkbox" .checked=${Boolean(value)} />
          ${label}
        </label>
      </a2ui-checkbox>
    `;
  }

  private renderMultiSelect(id: string, props: Record<string, unknown>, contextPath?: string): TemplateResult {
    const label = this.resolveValue(props.label as BoundValue, contextPath) ?? '';
    const options = props.options as Array<{id: string, name: string, color?: string}> || [];
    const selectedPath = props.selectedPath as string || '';
    const actionName = props.actionName as string || 'toggle_multi_select';
    
    // Get currently selected IDs
    const selectedIds = ((this.dataModel.get(selectedPath) as string) || '').split(',').filter(id => id.trim());
    
    const handleToggle = (optionId: string) => {
      const action: Action = {
        name: actionName,
        context: [
          { key: 'optionId', value: { literalString: optionId } },
          { key: 'selectedPath', value: { literalString: selectedPath } },
        ]
      };
      this.handleAction(action, id, contextPath);
    };

    return html`
      <a2ui-multiselect id=${id}>
        <div class="multiselect-label">${label}</div>
        <div class="multiselect-dropdown">
          <button class="multiselect-trigger" type="button">
            ${selectedIds.length > 0 
              ? `已选择 ${selectedIds.length} 项` 
              : '请选择...'}
            <span class="arrow">▼</span>
          </button>
          <div class="multiselect-options">
            ${options.map(opt => {
              const isSelected = selectedIds.includes(opt.id);
              return html`
                <label class="multiselect-option ${isSelected ? 'selected' : ''}" @click=${(e: Event) => { e.preventDefault(); handleToggle(opt.id); }}>
                  <input type="checkbox" .checked=${isSelected} />
                  ${opt.color ? html`<span class="color-dot" style="background: ${opt.color}"></span>` : nothing}
                  <span class="option-name">${opt.name}</span>
                </label>
              `;
            })}
            ${options.length === 0 ? html`<div class="no-options">暂无选项</div>` : nothing}
          </div>
        </div>
      </a2ui-multiselect>
    `;
  }

  private renderChildren(children: Children | undefined, contextPath?: string): unknown {
    if (!children) return nothing;

    if ('explicitList' in children) {
      return (children as ExplicitChildren).explicitList.map(childId =>
        this.renderChildById(childId, contextPath)
      );
    }

    // Template children are handled in renderList
    return nothing;
  }

  private renderChildById(childId: string, contextPath?: string): TemplateResult | typeof nothing {
    const child = this.components.get(childId);
    if (!child) {
      console.warn(`Child component not found: ${childId}`);
      return html``;
    }
    return this.renderComponent(child, contextPath);
  }
}

// Define custom elements for styling (exported to avoid unused warnings)
@customElement('a2ui-text')
export class A2UIText extends LitElement {
  static styles = css`
    :host {
      display: inline;
    }
    :host([data-usage-hint="h1"]) {
      display: block;
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
    }
    :host([data-usage-hint="h2"]) {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    :host([data-usage-hint="h3"]) {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    :host([data-usage-hint="h4"]) {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    /* Badge styles for status and priority */
    :host([data-badge="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
    }
    :host([data-status="true"]) {
      background: #DBEAFE;
      color: #1E40AF;
    }
    :host([data-priority="true"]) {
      background: #FEF3C7;
      color: #92400E;
    }
    /* Tags text styling */
    :host([data-tags="true"]) {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 400;
      border-radius: 9999px;
      background: #E0E7FF;
      color: #4338CA;
    }
    /* Date text styling */
    :host([data-date="true"]) {
      font-size: 13px;
      color: #9CA3AF;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-button')
export class A2UIButton extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #FFD93D;
      color: #1E3A5F;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }
    :host(:hover) {
      background: #FFE566;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"]) {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 9999px;
      background: #F3F4F6;
      color: #374151;
      border: 1px solid #D1D5DB;
      font-weight: 400;
    }
    :host([data-filter-button="true"]:hover) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      box-shadow: 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    :host([data-filter-button="true"][data-selected="true"]) {
      background: #FFD93D;
      color: #1E3A5F;
      border-color: #FFD93D;
      font-weight: 500;
    }
    /* Ticket item button - full width, transparent */
    :host([data-ticket-button="true"]) {
      display: block;
      width: 100%;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
    }
    :host([data-ticket-button="true"]:hover) {
      background: transparent;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-textfield')
export class A2UITextField extends LitElement {
  static styles = css`
    :host {
      display: block;
    }
    :host([data-search-field="true"]) {
      flex: 0 0 auto;
      width: 350px;
      margin-right: 16px;
    }
    ::slotted(input),
    ::slotted(textarea) {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
    }
    ::slotted(input:focus),
    ::slotted(textarea:focus) {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-column')
export class A2UIColumn extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    :host([data-alignment="center"]) {
      align-items: center;
    }
    :host([data-app-layout="true"]) {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 48px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    :host([data-tickets-list="true"]) {
      gap: 12px;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-row')
export class A2UIRow extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    :host([data-search-row="true"]) {
      gap: 32px;
    }
    :host([data-search-row="true"]) ::slotted(a2ui-textfield) {
      flex: 1;
      max-width: 400px;
    }
    :host([data-filter-row="true"]) {
      gap: 8px;
      flex-wrap: wrap;
    }
    :host([data-meta-row="true"]) {
      gap: 12px;
    }
    :host([data-ticket-row="true"]) {
      width: 100%;
      flex: 1;
    }
    :host([data-distribution="spaceBetween"]) {
      justify-content: space-between;
    }
    :host([data-distribution="center"]) {
      justify-content: center;
    }
    :host([data-distribution="end"]) {
      justify-content: flex-end;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-card')
export class A2UICard extends LitElement {
  static styles = css`
    :host {
      display: block;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 200ms ease;
    }
    :host(:hover) {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    /* Ticket list item card - full width row style */
    :host([data-ticket-card="true"]) {
      width: 100%;
      padding: 16px 20px;
      border-radius: 0;
      background: white;
      border: none;
      border-left: 3px solid transparent;
      cursor: pointer;
      box-sizing: border-box;
      box-shadow: none;
    }
    :host([data-ticket-card="true"]:hover) {
      background: #FEFCE8;
      border-left-color: #FFD93D;
      box-shadow: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-list')
export class A2UIList extends LitElement {
  static styles = css`
    :host {
      display: flex;
      gap: 12px;
    }
    :host([data-direction="vertical"]) {
      flex-direction: column;
    }
    :host([data-direction="horizontal"]) {
      flex-direction: row;
      flex-wrap: wrap;
    }
    :host([data-tickets="true"]) {
      gap: 0;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 0;
      overflow: hidden;
    }
    :host([data-tickets="true"]) ::slotted(*) {
      border-bottom: 1px solid #F3F4F6;
    }
    :host([data-tickets="true"]) ::slotted(*:last-child) {
      border-bottom: none;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-icon')
export class A2UIIcon extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-divider')
export class A2UIDivider extends LitElement {
  static styles = css`
    :host {
      display: block;
      height: 1px;
      background: #E5E7EB;
      margin: 16px 0;
    }
  `;

  render() {
    return html``;
  }
}

@customElement('a2ui-modal')
export class A2UIModal extends LitElement {
  static styles = css`
    :host {
      display: contents;
    }
  `;

  render() {
    return html`
      <slot name="entry"></slot>
      <slot name="content"></slot>
    `;
  }
}

@customElement('a2ui-checkbox')
export class A2UICheckBox extends LitElement {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FFD93D;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

@customElement('a2ui-multiselect')
export class A2UIMultiSelect extends LitElement {
  static styles = css`
    :host {
      display: block;
      width: 100%;
    }
    .multiselect-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
    }
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #F9FAFB;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.2s;
    }
    .multiselect-trigger:hover {
      border-color: #FFD93D;
    }
    .multiselect-trigger:focus {
      outline: none;
      border-color: #FFD93D;
      box-shadow: 0 0 0 3px rgba(255, 217, 61, 0.2);
    }
    .arrow {
      font-size: 10px;
      color: #6B7280;
    }
    .multiselect-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .multiselect-dropdown:focus-within .multiselect-options,
    .multiselect-dropdown:hover .multiselect-options {
      display: block;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .multiselect-option:hover {
      background: #FEF9C3;
    }
    .multiselect-option.selected {
      background: #FEF3C7;
    }
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FFD93D;
      pointer-events: none;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .option-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }
    .no-options {
      padding: 12px 14px;
      color: #9CA3AF;
      font-size: 14px;
      text-align: center;
    }
  `;

  render() {
    return html`<slot></slot>`;
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'a2ui-surface': A2UISurface;
  }
}

```

现在搜索框和搜索按钮之间已经有明显的间距了。我给搜索框设置了固定宽度 350px，并添加了 16px 的右边距，这样两者之间的间距更加明显。

---

**User**

目前 @project_alpha/a2ui_frontend/client/src/ 目录下有一些 .ts 代码有报错是什么原因？

---

**Cursor**

这些错误主要有两个原因：

1. **tsconfig.json 有重复的配置项** - `useDefineForClassFields` 在第 4 行和第 18 行重复定义了
2. **可能需要重新安装依赖** - `lit` 包的类型声明没有被正确识别

让我修复这些问题：

```jsonc
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "experimentalDecorators": true,
    "emitDecoratorMetadata": true
  },
  "include": ["src"]
}

```

错误仍然存在。这是因为项目使用了 Yarn PnP (Plug'n'Play) 模式，TypeScript 无法直接识别依赖。让我切换到传统的 `node_modules` 模式来解决这个问题：

所有错误都已解决！问题的原因是：

1. **Yarn PnP 模式兼容性问题** - 项目之前使用 Yarn PnP（Plug'n'Play）模式，这种模式不创建传统的 `node_modules` 目录，而是使用 `.pnp.cjs` 文件管理依赖。TypeScript 默认无法识别 PnP 模式下的依赖类型声明。

2. **tsconfig.json 重复配置** - `useDefineForClassFields` 被定义了两次，值还不同。

**修复措施：**

1. 修复了 `tsconfig.json`，移除了重复的配置项
2. 创建了 `.yarnrc.yml` 配置文件，设置 `nodeLinker: node-modules` 切换到传统模式
3. 重新安装依赖，现在 `lit` 包的类型声明可以被正确识别

现在代码没有任何 TypeScript 错误了。

