# Proposal: 添加票据变更历史记录和在编辑时设置状态

## Why

当前系统存在以下问题：

1. **缺少变更历史追踪**：当票据的状态、处理结果、优先级或标签发生变化时，系统无法记录这些变更的历史。这对于审计、问题追踪和了解票据的演变过程非常重要。

2. **状态变更流程不统一**：目前状态变更需要通过单独的 API 端点（`PATCH /api/tickets/:id/status`），而其他字段的编辑通过 `PUT /api/tickets/:id`。这种分离导致编辑页面无法同时修改状态，用户体验不够流畅。

## What Changes

### 1. 票据变更历史记录系统

**新增数据库表**：
- `ticket_history` 表：记录票据的所有变更历史
  - 记录字段：状态、优先级、处理结果、标签的变更
  - 记录变更时间、变更类型、变更前后的值
  - 支持查询特定票据的历史记录

**新增 API 端点**：
- `GET /api/tickets/:id/history` - 获取票据的变更历史

**前端功能**：
- 在票据详情页面显示变更历史时间线
- 支持查看历史记录的详细信息

### 2. 编辑时设置状态

**后端变更**：
- 修改 `PUT /api/tickets/:id` 接口，支持在更新时同时修改状态
- 保持状态变更的验证逻辑（状态转换规则、完成时必需的处理结果等）
- 状态变更时自动记录到历史表

**前端变更**：
- 在 `TicketEditPage` 中添加状态选择器
- 移除或简化单独的状态变更流程

## Impact

### 数据库
- 新增 `ticket_history` 表
- 新增迁移脚本 `003_add_ticket_history.sql`
- 在相关更新操作中添加历史记录逻辑

### 后端 API
- 新增历史查询接口
- 修改票据更新接口，支持状态字段
- 所有变更操作（状态、优先级、处理结果、标签）都会记录历史

### 前端
- 修改编辑页面，添加状态选择器
- 新增历史记录展示组件
- 更新 API 客户端以支持新的接口

### 测试
- 添加历史记录功能的单元测试和集成测试
- 更新编辑页面的测试用例

## New Specifications

1. **ticket-history** - 票据变更历史记录功能规范
2. **ticket-edit-with-status** - 编辑时设置状态功能规范

## Dependencies

- 依赖现有的 `init-ticket-system` change
- 需要先完成历史表的设计和实现，再实现编辑时设置状态功能

