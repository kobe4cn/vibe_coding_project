# Flow Debugger 能力规格

## ADDED Requirements

### Requirement: 断点管理

系统 SHALL 支持在流程节点上设置和管理断点。

#### Scenario: 设置节点断点
- **GIVEN** 用户在流程画布上
- **WHEN** 用户点击节点左侧的断点区域
- **THEN** 该节点显示红色断点标记
- **AND** 断点保存到调试状态中

#### Scenario: 移除断点
- **GIVEN** 节点上有断点
- **WHEN** 用户再次点击断点标记
- **THEN** 断点被移除
- **AND** 红色标记消失

#### Scenario: 禁用断点
- **GIVEN** 节点上有断点
- **WHEN** 用户右键点击断点选择"禁用"
- **THEN** 断点标记变为灰色
- **AND** 执行时不在此断点暂停

#### Scenario: 条件断点
- **GIVEN** 用户右键点击节点选择"添加条件断点"
- **WHEN** 弹出条件输入框
- **THEN** 用户可以输入 GML 条件表达式
- **AND** 断点标记显示为黄色（条件断点）
- **AND** 仅当条件为 true 时才暂停

#### Scenario: 查看所有断点
- **GIVEN** 流程中设置了多个断点
- **WHEN** 用户打开断点管理面板
- **THEN** 显示所有断点列表
- **AND** 包含节点名称、断点类型、条件表达式（若有）

### Requirement: 调试控制

系统 SHALL 提供调试工具栏控制流程执行。

#### Scenario: 调试模式启动
- **GIVEN** 用户点击"调试"按钮（或按 F5）
- **WHEN** 流程开始执行
- **THEN** 进入调试模式
- **AND** 工具栏切换为调试控制栏
- **AND** 画布显示执行状态

#### Scenario: 断点暂停
- **GIVEN** 流程在调试模式下执行
- **AND** 执行到设有断点的节点
- **WHEN** 即将执行该节点
- **THEN** 执行暂停
- **AND** 该节点高亮显示为黄色（当前暂停位置）
- **AND** 工具栏显示"已在断点暂停"

#### Scenario: 继续执行
- **GIVEN** 执行在断点暂停
- **WHEN** 用户点击"继续"按钮（或按 F5）
- **THEN** 继续执行直到下一个断点或流程结束

#### Scenario: 单步执行（Step Over）
- **GIVEN** 执行在断点暂停
- **WHEN** 用户点击"单步执行"按钮（或按 F10）
- **THEN** 执行当前节点
- **AND** 在下一个节点前暂停
- **AND** 若当前节点是 each/loop，整个子流程作为一步执行完

#### Scenario: 步入（Step Into）
- **GIVEN** 执行在 each/loop 节点前暂停
- **WHEN** 用户点击"步入"按钮（或按 F11）
- **THEN** 进入子流程
- **AND** 在子流程的第一个节点前暂停

#### Scenario: 步出（Step Out）
- **GIVEN** 执行在 each/loop 子流程内暂停
- **WHEN** 用户点击"步出"按钮（或按 Shift+F11）
- **THEN** 执行完当前子流程剩余部分
- **AND** 在子流程结束后的下一个节点前暂停

#### Scenario: 停止调试
- **GIVEN** 调试模式执行中
- **WHEN** 用户点击"停止"按钮（或按 Shift+F5）
- **THEN** 终止执行
- **AND** 退出调试模式
- **AND** 清理执行状态

### Requirement: 执行状态可视化

系统 SHALL 在流程画布上可视化显示节点的执行状态。

#### Scenario: 未执行节点
- **GIVEN** 流程在调试模式
- **AND** 节点尚未执行
- **THEN** 节点显示为默认样式（灰色边框）

#### Scenario: 当前执行节点
- **GIVEN** 节点正在执行中
- **THEN** 节点显示黄色边框
- **AND** 节点上显示加载动画

#### Scenario: 暂停位置节点
- **GIVEN** 执行在某节点断点暂停
- **THEN** 该节点显示黄色高亮背景
- **AND** 显示暂停图标

#### Scenario: 已完成节点
- **GIVEN** 节点已成功执行完成
- **THEN** 节点显示绿色边框
- **AND** 右上角显示绿色对勾图标

#### Scenario: 执行出错节点
- **GIVEN** 节点执行过程中发生错误
- **THEN** 节点显示红色边框
- **AND** 右上角显示红色错误图标
- **AND** 悬浮显示错误信息

#### Scenario: 执行路径高亮
- **GIVEN** 流程执行过程中
- **THEN** 已执行的连接线显示为绿色
- **AND** 未执行的连接线保持灰色

### Requirement: 变量监视

系统 SHALL 提供变量监视面板显示当前上下文变量。

#### Scenario: 显示上下文变量
- **GIVEN** 调试执行中或在断点暂停
- **WHEN** 用户查看变量监视面板
- **THEN** 显示当前作用域内的所有变量
- **AND** 包括：流程输入参数、已执行节点的输出、循环变量等

#### Scenario: 变量值展开
- **GIVEN** 变量值是对象或数组
- **WHEN** 用户点击展开箭头
- **THEN** 展开显示内部结构
- **AND** 支持多层嵌套展开

#### Scenario: 变量值变化高亮
- **GIVEN** 执行过程中变量值发生变化
- **WHEN** 单步执行后
- **THEN** 变化的变量行高亮显示（黄色背景）
- **AND** 2 秒后高亮消失

#### Scenario: 添加监视表达式
- **GIVEN** 变量监视面板
- **WHEN** 用户点击"添加监视"
- **AND** 输入 GML 表达式如 `orders.sum('amount')`
- **THEN** 表达式添加到监视列表
- **AND** 显示实时计算结果

#### Scenario: 监视表达式求值错误
- **GIVEN** 监视表达式引用了不存在的变量
- **WHEN** 尝试求值
- **THEN** 显示 `<error>` 标记
- **AND** 悬浮显示具体错误信息

### Requirement: 执行日志

系统 SHALL 记录并显示流程执行日志。

#### Scenario: 节点执行日志
- **GIVEN** 节点开始执行
- **THEN** 记录日志 "[时间] 开始执行: 节点名称"
- **WHEN** 节点执行完成
- **THEN** 记录日志 "[时间] 完成: 节点名称 (耗时 Xms)"

#### Scenario: 条件判断日志
- **GIVEN** 条件跳转节点执行
- **THEN** 记录日志 "[时间] 条件判断: {表达式} = {结果}"
- **AND** 记录选择的分支路径

#### Scenario: 变量更新日志
- **GIVEN** 节点执行导致变量更新
- **THEN** 记录日志 "[时间] 变量更新: {变量名} = {新值}"

#### Scenario: 错误日志
- **GIVEN** 节点执行出错
- **THEN** 记录日志 "[时间] 错误: 节点名称 - {错误信息}"
- **AND** 日志显示为红色

#### Scenario: 日志过滤
- **GIVEN** 执行日志面板
- **WHEN** 用户选择过滤选项
- **THEN** 支持按日志级别过滤（全部、信息、警告、错误）
- **AND** 支持按节点名称搜索

#### Scenario: 日志导出
- **GIVEN** 执行日志面板
- **WHEN** 用户点击"导出日志"
- **THEN** 下载完整的执行日志文件

### Requirement: 执行轨迹

系统 SHALL 记录执行轨迹并支持回放。

#### Scenario: 轨迹记录
- **GIVEN** 调试模式执行
- **THEN** 记录每个节点执行的：
  - 执行顺序序号
  - 开始/结束时间
  - 输入参数快照
  - 输出结果快照

#### Scenario: 轨迹回放
- **GIVEN** 流程执行完成或暂停
- **WHEN** 用户点击执行轨迹面板中的某个节点执行记录
- **THEN** 变量监视面板显示该时刻的变量状态
- **AND** 画布高亮显示该节点

#### Scenario: 轨迹时间线
- **GIVEN** 执行轨迹面板
- **THEN** 显示时间线视图
- **AND** 并行执行的节点在时间线上并排显示
- **AND** 可拖动时间线查看不同时刻的状态

### Requirement: 异常断点

系统 SHALL 支持在异常发生时自动暂停。

#### Scenario: 启用异常断点
- **GIVEN** 用户在断点管理面板勾选"异常时暂停"
- **WHEN** 节点执行发生异常
- **THEN** 立即暂停执行
- **AND** 高亮显示出错节点
- **AND** 变量监视显示错误对象

#### Scenario: 异常后继续
- **GIVEN** 因异常暂停
- **AND** 节点配置了 fail 目标
- **WHEN** 用户点击"继续"
- **THEN** 跳转到 fail 目标节点继续执行

### Requirement: 调用栈视图

系统 SHALL 显示子流程的调用栈。

#### Scenario: 显示调用栈
- **GIVEN** 执行在 each/loop 子流程内暂停
- **WHEN** 查看调用栈面板
- **THEN** 显示从主流程到当前位置的调用链
- **AND** 包括：主流程 → each节点(迭代#2) → 当前节点

#### Scenario: 调用栈导航
- **GIVEN** 调用栈面板显示多层调用
- **WHEN** 用户点击调用栈中的某一层
- **THEN** 画布滚动到该层的上下文
- **AND** 变量监视切换到该层的作用域

### Requirement: 调试快捷键

系统 SHALL 提供调试相关的快捷键操作。

#### Scenario: 快捷键绑定
- **GIVEN** 应用处于调试模式
- **THEN** 支持以下快捷键：
  - F5: 开始调试 / 继续执行
  - Shift+F5: 停止调试
  - F6: 暂停执行
  - F9: 切换当前节点断点
  - F10: 单步执行（Step Over）
  - F11: 步入（Step Into）
  - Shift+F11: 步出（Step Out）

#### Scenario: 快捷键冲突处理
- **GIVEN** 调试快捷键与浏览器快捷键冲突
- **WHEN** 用户按下冲突的快捷键
- **THEN** 优先执行调试操作
- **AND** 阻止浏览器默认行为
