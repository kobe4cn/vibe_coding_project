name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Backend tests
  backend:
    name: Backend
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: ticket_db_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            project_alpha/backend/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('project_alpha/**/Cargo.lock') }}

      - name: Check formatting
        working-directory: project_alpha/backend
        run: cargo fmt --check

      - name: Clippy
        working-directory: project_alpha/backend
        run: cargo clippy -- -D warnings

      - name: Build
        working-directory: project_alpha/backend
        run: cargo build

      - name: Run tests
        working-directory: project_alpha/backend
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/ticket_db_test
          TEST_DATABASE_URL: postgres://postgres:postgres@localhost:5432/ticket_db_test
        run: cargo test -- --test-threads=1

  # Frontend tests
  frontend:
    name: Frontend
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: project_alpha/frontend/package-lock.json

      - name: Install dependencies
        working-directory: project_alpha/frontend
        run: npm ci

      - name: Type check
        working-directory: project_alpha/frontend
        run: npx tsc --noEmit

      - name: Lint
        working-directory: project_alpha/frontend
        run: npm run lint

      - name: Run tests
        working-directory: project_alpha/frontend
        run: npm run test:run

      - name: Build
        working-directory: project_alpha/frontend
        run: npm run build

  # A2UI Front tests
  a2ui_front:
    name: A2UI Front
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'
          cache-dependency-path: project_alpha/a2ui_front/yarn.lock

      - name: Install dependencies
        working-directory: project_alpha/a2ui_front
        run: yarn install --frozen-lockfile

      - name: Lint
        working-directory: project_alpha/a2ui_front
        run: yarn lint

      - name: Run tests
        working-directory: project_alpha/a2ui_front
        run: yarn test:run

      - name: Build
        working-directory: project_alpha/a2ui_front
        run: yarn build

  # Docker build test
  docker:
    name: Project Alpha Images
    runs-on: ubuntu-latest
    needs: [backend, frontend, a2ui_front]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Backend image
      - name: Extract backend image metadata
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/ticket-backend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./project_alpha/backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

      # Frontend image
      - name: Extract frontend image metadata
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/ticket-frontend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./project_alpha/frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

      # A2UI Front image
      - name: Extract a2ui-front image metadata
        id: meta-a2ui-front
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/ticket-a2ui-front
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push a2ui-front image
        uses: docker/build-push-action@v5
        with:
          context: ./project_alpha/a2ui_front
          push: true
          tags: ${{ steps.meta-a2ui-front.outputs.tags }}
          labels: ${{ steps.meta-a2ui-front.outputs.labels }}
          cache-from: type=gha,scope=a2ui-front
          cache-to: type=gha,mode=max,scope=a2ui-front

  # FlowEngine 前端
  flowengine_frontend:
    name: FlowEngine Frontend
    runs-on: ubuntu-latest
    env:
      CI: true
    defaults:
      run:
        working-directory: flowengine/flow-editor
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: flowengine/flow-editor/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm run test:run

      - name: Build
        run: npm run build

  # FlowEngine 后端
  flowengine_backend:
    name: FlowEngine Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: flowengine/packages/fdl-rust
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry and build
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: flowengine/packages/fdl-rust -> target

      - name: Format check
        run: cargo fmt --all -- --check

      - name: Tests
        run: cargo test --workspace --locked

      - name: Build release
        run: cargo build --workspace --locked --release

  # FlowEngine 镜像构建
  flowengine_images:
    name: FlowEngine Images
    runs-on: ubuntu-latest
    needs:
      - flowengine_frontend
      - flowengine_backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build flow-editor image
        uses: docker/build-push-action@v6
        with:
          context: flowengine/flow-editor
          file: flowengine/flow-editor/Dockerfile
          tags: flowengine/flow-editor:ci-${{ github.sha }}
          outputs: type=docker,dest=/tmp/flowengine-frontend.tar
          cache-from: type=gha,scope=flowengine-frontend
          cache-to: type=gha,mode=max,scope=flowengine-frontend

      - name: Upload flow-editor image
        uses: actions/upload-artifact@v4
        with:
          name: flowengine-frontend-image
          path: /tmp/flowengine-frontend.tar

      - name: Build fdl-runtime image
        uses: docker/build-push-action@v6
        with:
          context: flowengine/packages/fdl-rust
          file: flowengine/packages/fdl-rust/Dockerfile
          tags: flowengine/fdl-runtime:ci-${{ github.sha }}
          outputs: type=docker,dest=/tmp/flowengine-backend.tar
          cache-from: type=gha,scope=flowengine-backend
          cache-to: type=gha,mode=max,scope=flowengine-backend

      - name: Upload fdl-runtime image
        uses: actions/upload-artifact@v4
        with:
          name: flowengine-backend-image
          path: /tmp/flowengine-backend.tar
